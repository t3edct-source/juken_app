# 問題配置順番調整手順

## 1. 調整ルール

### 1.1 基本原則

1. **時系列順（古い順）**
   - 歴史的事象は発生順に配置
   - 例：古墳時代 → 飛鳥時代 → 奈良時代

2. **関連項目のまとめ**
   - 同じテーマ・人物・制度の関連問題は近くに配置
   - 例：国分寺建立の詔 → 国分寺、鑑真 → 唐招提寺

3. **基礎から応用へ**
   - 基本概念を先に、応用・発展を後に
   - 例：前方後円墳（基本形）→ 箸墓古墳（最古級）→ 大仙古墳（後の巨大古墳）

4. **論理的な流れ**
   - 政治制度 → 経済・社会制度 → 文化・宗教
   - 例：大宝律令 → 班田収授法 → 租・調・庸 → 墾田永年私財法

### 1.2 具体的な配置パターン

#### 時代区分の順序
```
古墳時代（3-6世紀前半）
  ↓
飛鳥時代（6-7世紀）
  ↓
奈良時代（8世紀）
```

#### 政治制度の順序
```
1. 基本制度（律令、政権）
2. 政治組織（太政官など）
3. 地方制度（郡衙、駅制など）
```

#### 文化・宗教の順序
```
1. 基本概念（鎮護国家など）
2. 政策（国分寺建立の詔など）
3. 具体的事例（国分寺、東大寺など）
4. 関連施設（正倉院など）
```

#### 税制の順序
```
1. 基本制度（班田収授法）
2. 税の種類（租・調・庸）
3. 制度の変化（墾田永年私財法）
```

## 2. 更新手順

### 2.1 準備

1. **対象ファイルの確認**
   ```bash
   # 対象ファイルを検索
   glob_file_search "*単元名*"
   ```

2. **現在の順序を確認**
   - ファイルを読み込んで、各問題のqnumとtextを確認
   - 時系列や論理的な流れの問題点を洗い出す

### 2.2 新しい順序の設計

1. **問題を分類**
   - 時系列で分類（古い順）
   - テーマで分類（政治、経済、文化など）
   - 関連項目でグループ化

2. **新しい順序を決定**
   - 元のqnumのリストを作成
   - 例：`NEW_ORDER = [1, 2, 19, 21, 3, 20, ...]`

### 2.3 Pythonスクリプトの作成

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
単元名の問題を時系列順に再配置
"""

import re
import json
from pathlib import Path

# 新しい順序（元のqnum）
NEW_ORDER = [
    1,   # 問題1の説明
    2,   # 問題2の説明
    # ... 30問分
]

def extract_questions_json(content):
    """JSONとして問題を抽出（空のカンマを除去）"""
    # window.questions = [...] の部分を抽出
    pattern = r'window\.questions\s*=\s*(\[.*?\]);'
    match = re.search(pattern, content, re.DOTALL)
    if not match:
        return None, None
    
    questions_str = match.group(1)
    
    # 空のカンマを削除
    questions_str = re.sub(r'}\s*,\s*\n\s*,\s*\n\s*{', '},\n  {', questions_str)
    questions_str = re.sub(r'}\s*,\s*,\s*{', '},\n  {', questions_str)
    questions_str = re.sub(r',\s*,', '', questions_str)
    questions_str = re.sub(r',\s*\n\s*,', '', questions_str)
    
    try:
        questions = json.loads(questions_str)
        return questions, match
    except json.JSONDecodeError as e:
        print(f"JSON解析エラー: {e}")
        return None, None

def reorder_questions(filepath):
    """問題を時系列順に再配置"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
    except Exception as e:
        print(f"エラー: ファイル読み込み失敗 - {e}")
        return False
    
    # 問題を抽出
    questions, match = extract_questions_json(content)
    if not questions:
        print(f"エラー: 問題の抽出に失敗しました")
        return False
    
    # 問題数を確認
    if len(questions) != 30:
        print(f"警告: 問題数が30ではありません（見つかった問題数: {len(questions)}）")
        return False
    
    # 新しい順序で問題を並べ替え
    reordered_questions = []
    for new_qnum, old_qnum in enumerate(NEW_ORDER, 1):
        old_question = questions[old_qnum - 1].copy()
        old_question['qnum'] = new_qnum
        reordered_questions.append(old_question)
    
    # JSONとして整形
    questions_json = json.dumps(reordered_questions, ensure_ascii=False, indent=2)
    # インデントを調整
    lines = questions_json.split('\n')
    formatted_lines = []
    for i, line in enumerate(lines):
        if i == 0:  # [
            formatted_lines.append(line)
        elif i == len(lines) - 1:  # ]
            formatted_lines.append('  ' + line)
        else:
            formatted_lines.append('  ' + line)
    
    questions_formatted = '\n'.join(formatted_lines)
    
    # ファイルの内容を置き換え
    new_content = content[:match.start()] + f'window.questions = {questions_formatted};' + content[match.end():]
    
    # バックアップを作成
    backup_path = filepath.with_suffix('.js.backup')
    with open(backup_path, 'w', encoding='utf-8') as f:
        f.write(content)
    print(f"バックアップを作成: {backup_path}")
    
    # 新しい内容を書き込み
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(new_content)
    
    return True

def main():
    files = [
        Path('lessons/soc/modular/wakaru/単元名.js'),
        Path('lessons/soc/modular/oboeru/単元名.js')
    ]
    
    for filepath in files:
        print(f"\n処理中: {filepath}")
        if reorder_questions(filepath):
            print(f"[OK] 再配置完了: {filepath}")
        else:
            print(f"[NG] 再配置失敗: {filepath}")

if __name__ == '__main__':
    main()
```

### 2.4 実行

1. **スクリプトを実行**
   ```bash
   python reorder_単元名.py
   ```

2. **結果を確認**
   - バックアップファイルが作成されているか確認
   - 再配置後のファイルを読み込んで順序を確認
   - 最初の数問と最後の数問を確認

3. **エラーが発生した場合**
   - JSON解析エラー：空のカンマの除去パターンを確認
   - 問題数が合わない：NEW_ORDERのリストを確認
   - ファイルが見つからない：パスを確認

### 2.5 確認項目

1. **時系列の確認**
   - 古い順になっているか
   - 関連する項目がまとまっているか

2. **論理的な流れの確認**
   - 基礎概念から応用へ
   - 政治制度 → 経済・社会制度 → 文化・宗教

3. **qnumの確認**
   - 1から30まで連番になっているか
   - 重複や欠番がないか

## 3. 実例

### 3.1 4201_kofun_asuka_with_sources（古墳・飛鳥時代）

**調整前の問題点：**
- Q3（大仙古墳）がQ21（箸墓古墳）より前
- Q19（石室）が後半
- Q27（群集墳）が後半
- Q29（渡来人の技術）が後半

**調整後の順序：**
1. 前方後円墳（基本形）
2. 埴輪
3. 石室（前へ移動）
4. 箸墓古墳（最古級、前へ移動）
5. 大仙古墳
6. 稲荷山古墳
7. 群集墳（前へ移動）
8. 大和政権
9. 大王（おおきみ）
10. 渡来人の技術（前へ移動）
11. 蘇我氏
12. 聖徳太子（前へ移動）
13. 冠位十二階
14. 十七条憲法
15. 遣隋使の相手（隋、前へ移動）
16. 遣隋使（小野妹子）
17. 法隆寺
18. 鞍作止利
19. 法隆寺式伽藍配置
20. 飛鳥仏（前へ移動）
21. 白鳳文化・飛鳥文化の仏像
22. 飛鳥時代の仏教文化
23. 乙巳の変（前へ移動）
24. 大化の改新
25. 改新の詔
26. 庚午年籍
27. 白村江の戦い
28. 白村江の戦い後の国防施設（前へ移動）
29. 藤原京・飛鳥浄御原宮
30. 日本書紀

### 3.2 4202_nara_period_with_sources（奈良時代）

**調整前の問題点：**
- Q4（国分寺建立の詔）とQ6（国分寺）が分離
- Q5（大仏の開眼供養）とQ20（東大寺）が分離
- Q12（鑑真）とQ28（唐招提寺）が分離
- Q18（鎮護国家）とQ27（仏教による鎮護国家）が分離

**調整後の順序：**
1. 平城京（都）
2. 大宝律令（701年）
3. 太政官（前へ移動）
4. 条坊制（前へ移動）
5. 和同開珎（708年）
6. 古事記（712年）
7. 日本書紀（720年）
8. 万葉集
9. 懐風藻（前へ移動）
10. 班田収授法
11. 租（税制）
12. 調（税制）
13. 庸（税制）
14. 墾田永年私財法（後へ移動）
15. 郡衙・駅家・悲田院
16. 駅制（前へ移動）
17. 国学
18. 健児・防人
19. 遣唐使（唐）
20. 鑑真
21. 唐招提寺（前へ移動）
22. 鎮護国家
23. 国分寺建立の詔
24. 国分寺（前へ移動）
25. 東大寺大仏の開眼供養（前へ移動）
26. 東大寺（前へ移動）
27. 正倉院（前へ移動）
28. 南都六宗の寺院
29. 南都六宗
30. 仏教による鎮護国家（前へ移動）

## 4. 注意事項

1. **バックアップの作成**
   - 必ずバックアップファイルを作成
   - 元のファイル名に`.backup`を付加

2. **両方のファイルを更新**
   - `wakaru`版と`oboeru`版の両方を更新
   - 順序は同じだが、sourceフィールドの内容が異なる場合がある

3. **空のカンマの処理**
   - 元のファイルに空のカンマ（`, ,`）がある場合がある
   - 正規表現で除去してからJSON解析

4. **qnumの更新**
   - 新しい順序に合わせてqnumを1から30まで更新
   - 重複や欠番がないか確認

5. **テスト**
   - 再配置後、ファイルが正しく読み込めるか確認
   - 最初と最後の数問を確認して順序が正しいか確認

## 5. トラブルシューティング

### 5.1 JSON解析エラー

**症状：** `JSONDecodeError`が発生

**原因：**
- 空のカンマが残っている
- 文字エンコーディングの問題
- 不正なJSON構造

**対処：**
- 空のカンマの除去パターンを追加
- エラー位置を確認して手動で修正
- バックアップから復元して再試行

### 5.2 問題数が合わない

**症状：** `問題数が30ではありません`という警告

**原因：**
- NEW_ORDERのリストが30個でない
- 元のファイルの問題数が30でない

**対処：**
- NEW_ORDERのリストを確認
- 元のファイルの問題数を確認
- 不足している問題を追加

### 5.3 順序が正しくない

**症状：** 再配置後の順序が期待と異なる

**原因：**
- NEW_ORDERのリストが間違っている
- 元のqnumと新しいqnumの対応が間違っている

**対処：**
- NEW_ORDERのリストを再確認
- バックアップから復元して再設計
- 1つずつ確認しながら修正

