

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ステップナビ | 中学受験理科・社会</title>
  <meta name="description" content="中学受験専門 理科・社会学習アプリ（分野別学習＋暗記ドリル＋過去問対策）" />
  
  <!-- PWA対応 -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ステップナビ" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-gradient-to-br from-yellow-50 via-orange-50 to-pink-50 text-slate-800 min-h-screen relative overflow-x-hidden">
  <!-- 背景装飾要素 -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="absolute top-20 left-10 w-32 h-32 bg-gradient-to-br from-yellow-200/30 to-orange-300/30 rounded-full blur-xl"></div>
    <div class="absolute top-40 right-20 w-24 h-24 bg-gradient-to-br from-pink-200/30 to-red-300/30 rounded-full blur-xl"></div>
    <div class="absolute bottom-40 left-20 w-28 h-28 bg-gradient-to-br from-orange-200/30 to-yellow-300/30 rounded-full blur-xl"></div>
    <div class="absolute bottom-20 right-10 w-20 h-20 bg-gradient-to-br from-pink-200/30 to-orange-300/30 rounded-full blur-xl"></div>
  </div>
  
  <a href="#view" class="sr-only focus:not-sr-only focus:fixed focus:top-3 focus:left-3 focus:bg-white focus:px-3 focus:py-2 focus:rounded">本編へスキップ</a>

  <header class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-orange-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <a href="#/home" class="flex items-center gap-2 group">
        <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-orange-400 to-pink-500 shadow-md transform group-hover:scale-105 transition-transform duration-200 flex items-center justify-center text-lg">🎮</div>
        <span class="font-bold text-xl text-slate-800">ステップナビ</span>
      </a>
      <nav class="flex items-center gap-3 text-sm">
        <!-- PWAインストールボタン -->
        <button id="installBtn" class="px-3 py-2 rounded-lg bg-orange-500 text-white hover:bg-orange-600 hidden shadow-sm transition-colors duration-200">
          📱 アプリに追加
        </button>
        <button id="purchaseBtn" class="px-3 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 shadow-sm transition-colors duration-200">💳 購入</button>
        <button id="btnLogin" class="px-3 py-2 rounded-lg bg-orange-500 text-white hover:bg-orange-600 shadow-sm transition-colors duration-200">ログイン</button>
        <button id="btnLogout" class="px-3 py-2 rounded-lg bg-gray-500 text-white hover:bg-gray-600 shadow-sm transition-colors duration-200 hidden">ログアウト</button>
      </nav>
    </div>
  </header>

  <main id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 relative z-10">
    <div id="view" aria-live="polite"></div>

    <!-- Firebase認証ボックス -->
    <div id="authBox" class="auth-container">
      <div class="auth-header">
        <h3 class="auth-title" id="authTitle">ログイン</h3>
        <p class="auth-subtitle" id="authSubtitle">アカウントにサインインしてください</p>
      </div>
      
      <form id="authForm" class="auth-form">
        <div class="input-group">
          <label for="email" class="input-label">メールアドレス</label>
          <input id="email" type="email" placeholder="example@email.com" 
                 class="auth-input" required autocomplete="email"
                 aria-describedby="email-error">
          <div id="email-error" class="input-error hidden"></div>
        </div>
        
        <div class="input-group">
          <label for="pw" class="input-label">パスワード</label>
          <div class="password-input-wrapper">
            <input id="pw" type="password" placeholder="パスワードを入力" 
                   class="auth-input" required autocomplete="current-password"
                   aria-describedby="pw-error">
            <button type="button" id="togglePassword" class="password-toggle" 
                    aria-label="パスワードを表示/非表示">
              👁️
            </button>
          </div>
          <div id="pw-error" class="input-error hidden"></div>
        </div>
        
        <button type="submit" id="loginEmail" class="auth-btn auth-btn-primary">
          <span class="btn-content">
            <span class="btn-text" id="submitBtnText">ログイン</span>
            <span class="btn-spinner hidden">⏳</span>
          </span>
        </button>
      </form>
      
      <div class="auth-toggle">
        <p id="toggleText">アカウントをお持ちでない方</p>
        <button type="button" id="authToggle" class="link-btn">
          新規登録はこちら
        </button>
      </div>
      
      <div class="auth-divider">
        <span>または</span>
      </div>
      
      <button id="loginGoogle" class="auth-btn auth-btn-google">
        <span class="btn-content">
          <span class="google-icon">🔍</span>
          <span class="btn-text">Googleでログイン</span>
          <span class="btn-spinner hidden">⏳</span>
        </span>
      </button>
      
      <div class="auth-links">
        <button type="button" id="resetPassword" class="link-btn">
          パスワードを忘れた方
        </button>
      </div>
      
      <button id="logout" class="auth-btn auth-btn-secondary" style="display:none">
        <span class="btn-content">
          <span class="btn-text">ログアウト</span>
        </span>
      </button>
      
      <div id="who" class="auth-status"></div>
    </div>

    <!-- メール確認待ち画面 -->
    <div id="emailVerificationBox" class="auth-container hidden">
      <div class="verification-header">
        <div class="verification-icon">📧</div>
        <h3 class="verification-title">メール確認が必要です</h3>
        <p class="verification-subtitle">アカウントを安全に利用するため、メールアドレスの確認をお願いします</p>
      </div>
      
      <div class="verification-content">
        <div class="verification-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <p><strong id="verificationEmail">your@email.com</strong> に確認メールを送信しました</p>
          </div>
        </div>
        
        <div class="verification-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <p>メールボックスを確認し、認証リンクをクリックしてください</p>
          </div>
        </div>
        
        <div class="verification-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <p>確認完了後、自動的に購入機能が利用可能になります</p>
          </div>
        </div>
      </div>
      
      <div class="verification-status">
        <div id="verificationProgress" class="verification-progress">
          <div class="progress-dot active">📧</div>
          <div class="progress-line"></div>
          <div class="progress-dot" id="progressCheck">⏳</div>
          <div class="progress-line"></div>
          <div class="progress-dot">✅</div>
        </div>
        <p id="verificationStatusText" class="verification-status-text">確認メールの送信完了</p>
      </div>
      
      <div class="verification-actions">
        <button id="resendVerificationEmail" class="auth-btn auth-btn-primary">
          <span class="btn-content">
            <span class="btn-text">確認メールを再送信</span>
            <span class="btn-spinner hidden">⏳</span>
          </span>
        </button>
        
        <button id="checkVerificationStatus" class="auth-btn auth-btn-secondary">
          確認状態をチェック
        </button>
        
        <button id="backToAuth" class="link-btn">
          別のアカウントでログイン
        </button>
      </div>
      
      <div class="verification-help">
        <details class="help-section">
          <summary>📮 メールが届かない場合</summary>
          <div class="help-content">
            <ul>
              <li>迷惑メールフォルダをご確認ください</li>
              <li>メールアドレスに入力ミスがないかご確認ください</li>
              <li>「再送信」ボタンをクリックしてもう一度お試しください</li>
              <li>それでも届かない場合は、別のメールアドレスで登録をお試しください</li>
            </ul>
          </div>
        </details>
      </div>
    </div>

    <!-- ▼ 必須ビュー群（JSが表示/非表示を切り替えます） -->
    <section id="homeView" class="section-gap">
      <!-- 横長イラストエリア -->
      <div class="w-full h-44 mb-6 overflow-hidden relative">
        <!-- イラスト表示エリア -->
        <div class="relative z-10 text-center">
          <img id="subjectHero" src="./images/hero/hero-main.png" alt="楽しい学習イラスト" class="h-44 w-full object-cover transition-all duration-500">
          <div class="absolute inset-0 flex items-center justify-center">
            <p id="subjectMessage" class="text-white font-bold text-xl drop-shadow-lg bg-black/20 px-4 py-2 rounded-full">中学受験合格に向けて、理科・社会を徹底攻略！</p>
          </div>
        </div>
      </div>
      
      <!-- 教科別タブ -->
      <div class="subject-tabs mb-6">
        <button class="subject-tab active" data-subject="recommended">⭐ おすすめ学習</button>
        <button class="subject-tab" data-subject="sci">🔬 理科わかる</button>
        <button class="subject-tab" data-subject="science_drill">🧪 理科おぼえる</button>
        <button class="subject-tab" data-subject="soc">🌍 社会わかる</button>
        <button class="subject-tab" data-subject="social_drill">📍 社会おぼえる</button>
      </div>
      
      <div id="lessonList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <section id="lessonView" class="section-gap hidden">
      <div class="flex items-center justify-between mb-4 px-6 sm:px-8 lg:px-10">
        <h2 id="lessonTitle" class="text-2xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">🎓 レッスン</h2>
        <div class="flex items-center gap-3">
          <button id="memoToggleBtn" class="px-4 py-2 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">📝 メモ</button>
          <button id="fullscreenBtn" class="px-3 py-2 rounded-full bg-gradient-to-r from-green-500 to-blue-600 text-white hover:from-green-600 hover:to-blue-700 text-xs font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
            📱 全画面
          </button>
          <a href="#/home" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white text-sm font-bold rounded-full transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">← もどる</a>
        </div>
      </div>
      <div class="lesson-area card p-0 overflow-hidden mx-0">
        <iframe id="lessonFrame" title="レッスン" style="width:100%;height:88vh;border:0;"></iframe>
        <div id="lessonContainer"></div>
      </div>
    </section>

    <section id="purchaseView" class="section-gap hidden">
      <h2 class="text-xl font-bold mb-2">ご購入</h2>
      <p id="purchaseText" class="mb-4">この教材の購入が必要です。</p>
      <button class="btn">購入手続きへ</button>
    </section>

    <section id="resultView" class="section-gap hidden">
      <h2 class="text-xl font-bold mb-2">学習結果</h2>
      <div id="resultBox"></div>
    </section>
    <!-- ▲ 必須ビュー群 -->
  </main>

  <footer class="border-t border-orange-200 bg-white/95 mt-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center">
      <p class="text-slate-600 text-sm">© <span id="year"></span> T3エデュケーション</p>
    </div>
  </footer>

  <!-- Service Worker登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker登録成功:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker登録失敗:', error);
          });
      });
    }
  </script>

  <!-- 購入モーダル -->
  <div id="purchaseModal" class="modal-overlay hidden">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">📚 コンテンツ詳細・購入</h2>
        <button id="closePurchaseModal" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-intro">
          <p>各学年の理科・社会の詳細内容をご確認いただけます。気になるパックをお選びください。</p>
        </div>
        <div id="modalPackGrid" class="modal-pack-grid">
          <!-- JSで学年別パック詳細を描画 -->
        </div>
      </div>
      <div class="modal-footer">
        <button id="modalCloseBtn" class="btn-secondary">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 購入確認モーダル -->
  <div id="purchaseConfirmModal" class="modal-overlay hidden">
    <div class="modal-container purchase-confirm-modal">
      <div class="modal-header">
        <h2 class="modal-title">💳 購入確認</h2>
        <button id="closePurchaseConfirmModal" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="purchase-confirm-content">
          <div class="purchase-item-info">
            <div class="purchase-item-icon">📚</div>
            <div class="purchase-item-details">
              <h3 id="purchaseItemTitle" class="purchase-item-title">小6 理科</h3>
              <p id="purchaseItemDescription" class="purchase-item-description">物理・化学・生物・地学の全分野を学習できます</p>
              <div class="purchase-price">
                <span class="price-label">価格：</span>
                <span class="price-amount">¥2,980</span>
                <span class="price-note">（税込）</span>
              </div>
            </div>
          </div>
          <div class="purchase-confirm-message">
            <p>上記のコンテンツを購入しますか？</p>
            <small>※このボタンは仮実装です。実際の決済は行われません。</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelPurchaseBtn" class="btn-secondary">キャンセル</button>
        <button id="confirmPurchaseBtn" class="btn-primary">購入する</button>
      </div>
    </div>
  </div>

  <!-- 購入処理中モーダル -->
  <div id="purchaseProcessingModal" class="modal-overlay hidden">
    <div class="modal-container purchase-processing-modal">
      <div class="modal-body">
        <div class="processing-content">
          <div class="processing-spinner"></div>
          <h3 class="processing-title">購入処理中...</h3>
          <p class="processing-message">しばらくお待ちください</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 購入完了モーダル -->
  <div id="purchaseCompleteModal" class="modal-overlay hidden">
    <div class="modal-container purchase-complete-modal">
      <div class="modal-header">
        <h2 class="modal-title">🎉 購入完了</h2>
        <button id="closePurchaseCompleteModal" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="purchase-complete-content">
          <div class="success-icon">✅</div>
          <h3 id="completedItemTitle" class="completed-item-title">小6 理科</h3>
          <p class="completion-message">購入が完了しました！<br>すぐに学習を始められます。</p>
          <div class="purchase-benefits">
            <h4>利用可能になった機能：</h4>
            <ul>
              <li>📖 すべての理科レッスン</li>
              <li>📝 練習問題・テスト</li>
              <li>📊 学習進捗の記録</li>
              <li>🎯 苦手分野の分析</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="startLearningFromPurchase" class="btn-primary">学習を始める</button>
        <button id="continueBrowsingBtn" class="btn-secondary">他のコンテンツを見る</button>
      </div>
    </div>
  </div>

  <!-- Firebase認証 + メインアプリケーション -->
  <script type="module">
  // Firebase認証機能は app.js から取得
  const $ = (s)=>document.querySelector(s);

  // app.js の初期化完了を待つ
  function waitForFirebaseAuth() {
    return new Promise((resolve) => {
      const checkAuth = () => {
        if (window.firebaseAuth) {
          resolve(window.firebaseAuth);
        } else {
          setTimeout(checkAuth, 100);
        }
      };
      checkAuth();
    });
  }

  // 認証機能の初期化
  waitForFirebaseAuth().then(({ auth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
           signInWithEmailAndPassword, signOut, sendPasswordResetEmail, createUserWithEmailAndPassword, sendEmailVerification }) => {

  // 認証モード管理
  let isSignupMode = false;
  let verificationCheckInterval = null;

  // メール確認関連の状態管理
  const verificationState = {
    user: null,
    isWaitingForVerification: false,
    lastCheckTime: null
  };

  function toggleAuthMode() {
    isSignupMode = !isSignupMode;
    
    const title = $("#authTitle");
    const subtitle = $("#authSubtitle");
    const submitBtn = $("#submitBtnText");
    const toggleText = $("#toggleText");
    const authToggle = $("#authToggle");
    const resetPassword = $("#resetPassword");
    
    if (isSignupMode) {
      // 新規登録モード
      title.textContent = "新規登録";
      subtitle.textContent = "新しいアカウントを作成してください";
      submitBtn.textContent = "アカウント作成";
      toggleText.textContent = "既にアカウントをお持ちの方";
      authToggle.textContent = "ログインはこちら";
      resetPassword.style.display = "none";
    } else {
      // ログインモード
      title.textContent = "ログイン";
      subtitle.textContent = "アカウントにサインインしてください";
      submitBtn.textContent = "ログイン";
      toggleText.textContent = "アカウントをお持ちでない方";
      authToggle.textContent = "新規登録はこちら";
      resetPassword.style.display = "";
    }
    
    // エラーをクリア
    hideError('email');
    hideError('pw');
  }

  // メール確認画面の表示/非表示制御
  function showEmailVerificationScreen(user) {
    const authBox = $("#authBox");
    const verificationBox = $("#emailVerificationBox");
    const verificationEmail = $("#verificationEmail");
    
    if (authBox) authBox.classList.add('hidden');
    if (verificationBox) verificationBox.classList.remove('hidden');
    if (verificationEmail) verificationEmail.textContent = user.email;
    
    verificationState.user = user;
    verificationState.isWaitingForVerification = true;
    
    startVerificationCheck();
  }

  function hideEmailVerificationScreen() {
    const authBox = $("#authBox");
    const verificationBox = $("#emailVerificationBox");
    
    if (verificationBox) verificationBox.classList.add('hidden');
    if (authBox) authBox.classList.remove('hidden');
    
    verificationState.isWaitingForVerification = false;
    stopVerificationCheck();
  }

  function updateVerificationProgress(isVerified) {
    const progressCheck = $("#progressCheck");
    const statusText = $("#verificationStatusText");
    const progressLines = document.querySelectorAll('.progress-line');
    
    if (isVerified) {
      if (progressCheck) {
        progressCheck.textContent = "✅";
        progressCheck.classList.add('completed');
      }
      if (statusText) {
        statusText.textContent = "メール確認が完了しました！";
      }
      progressLines.forEach(line => line.classList.add('completed'));
      
      // 3秒後に自動的に画面を切り替え
      setTimeout(() => {
        hideEmailVerificationScreen();
      }, 3000);
    } else {
      if (progressCheck) {
        progressCheck.textContent = "⏳";
        progressCheck.classList.remove('completed');
      }
      if (statusText) {
        statusText.textContent = "メール確認をお待ちしています...";
      }
    }
  }

  // バリデーション関数
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  function showError(fieldId, message) {
    const errorEl = $(`#${fieldId}-error`);
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }
  }

  function hideError(fieldId) {
    const errorEl = $(`#${fieldId}-error`);
    if (errorEl) {
      errorEl.classList.add('hidden');
    }
  }

  function setLoading(buttonId, isLoading) {
    const btn = $(`#${buttonId}`);
    if (!btn) return;
    
    const spinner = btn.querySelector('.btn-spinner');
    const text = btn.querySelector('.btn-text');
    
    if (isLoading) {
      btn.disabled = true;
      spinner?.classList.remove('hidden');
      if (text) {
        if (buttonId === 'resendVerificationEmail') {
          text.textContent = '送信中...';
        } else {
          text.textContent = '処理中...';
        }
      }
    } else {
      btn.disabled = false;
      spinner?.classList.add('hidden');
      if (buttonId === 'loginEmail' && text) text.textContent = 'ログイン';
      if (buttonId === 'loginGoogle' && text) text.textContent = 'Googleでログイン';
      if (buttonId === 'resendVerificationEmail' && text) text.textContent = '確認メールを再送信';
    }
  }

  // 確認状態の自動チェック機能
  function startVerificationCheck() {
    if (verificationCheckInterval) {
      clearInterval(verificationCheckInterval);
    }
    
    // 5秒ごとに確認状態をチェック
    verificationCheckInterval = setInterval(async () => {
      if (verificationState.user) {
        try {
          // ユーザー情報を再読み込み
          await verificationState.user.reload();
          
          if (verificationState.user.emailVerified) {
            updateVerificationProgress(true);
            stopVerificationCheck();
            
            // 確認完了通知
            setTimeout(() => {
              alert('メール確認が完了しました！購入機能をご利用いただけます。');
            }, 500);
          }
        } catch (error) {
          console.error('確認状態チェックエラー:', error);
        }
      }
    }, 5000);
  }

  function stopVerificationCheck() {
    if (verificationCheckInterval) {
      clearInterval(verificationCheckInterval);
      verificationCheckInterval = null;
    }
  }

  // 手動確認チェック
  async function checkVerificationStatus() {
    if (!verificationState.user) return;
    
    try {
      await verificationState.user.reload();
      
      if (verificationState.user.emailVerified) {
        updateVerificationProgress(true);
        alert('メール確認が完了しました！');
      } else {
        alert('まだメール確認が完了していません。メールボックスをご確認ください。');
      }
    } catch (error) {
      alert('確認状態の取得に失敗しました。しばらく待ってから再度お試しください。');
    }
  }

  // リアルタイムバリデーション
  $("#email")?.addEventListener("input", (e) => {
    const email = e.target.value.trim();
    if (email && !validateEmail(email)) {
      showError('email', '正しいメールアドレスを入力してください');
    } else {
      hideError('email');
    }
  });

  $("#pw")?.addEventListener("input", (e) => {
    const password = e.target.value;
    if (password && password.length < 6) {
      showError('pw', 'パスワードは6文字以上で入力してください');
    } else {
      hideError('pw');
    }
  });

  // パスワード表示/非表示切り替え
  $("#togglePassword")?.addEventListener("click", () => {
    const pwInput = $("#pw");
    const toggle = $("#togglePassword");
    if (pwInput && toggle) {
      if (pwInput.type === "password") {
        pwInput.type = "text";
        toggle.textContent = "🙈";
      } else {
        pwInput.type = "password";
        toggle.textContent = "👁️";
      }
    }
  });

  // 認証モード切り替え
  $("#authToggle")?.addEventListener("click", () => {
    toggleAuthMode();
  });

  // メール確認画面のイベントハンドラ
  $("#resendVerificationEmail")?.addEventListener("click", async () => {
    if (!verificationState.user) return;
    
    setLoading('resendVerificationEmail', true);
    
    try {
      // メール確認設定（日本語、続行URL設定）
      const actionCodeSettings = {
        url: window.location.origin, // 現在のサイトに戻る
        handleCodeInApp: false
      };
      
      // 言語設定を確実に適用
      auth.languageCode = 'ja';
      
      await sendEmailVerification(verificationState.user, actionCodeSettings);
      alert('確認メールを再送信しました。メールボックスをご確認ください。');
      console.log("確認メール再送信成功（日本語設定）");
    } catch (error) {
      let errorMessage = "確認メールの再送信に失敗しました";
      if (error.code === 'auth/too-many-requests') {
        errorMessage = "短時間で多くの要求が送信されました。しばらく待ってから再度お試しください。";
      }
      alert(errorMessage);
    } finally {
      setLoading('resendVerificationEmail', false);
    }
  });

  $("#checkVerificationStatus")?.addEventListener("click", () => {
    checkVerificationStatus();
  });

  $("#backToAuth")?.addEventListener("click", () => {
    // 現在のユーザーをログアウトして認証画面に戻る
    signOut(auth);
    hideEmailVerificationScreen();
  });

  // フォーム送信処理
  $("#authForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const email = $("#email").value.trim();
    const pw = $("#pw").value;
    
    // バリデーション
    let hasError = false;
    
    if (!email) {
      showError('email', 'メールアドレスを入力してください');
      hasError = true;
    } else if (!validateEmail(email)) {
      showError('email', '正しいメールアドレスを入力してください');
      hasError = true;
    } else {
      hideError('email');
    }
    
    if (!pw) {
      showError('pw', 'パスワードを入力してください');
      hasError = true;
    } else if (pw.length < 6) {
      showError('pw', 'パスワードは6文字以上で入力してください');
      hasError = true;
    } else {
      hideError('pw');
    }
    
    if (hasError) return;
    
    setLoading('loginEmail', true);
    
    try {
      if (isSignupMode) {
        // 新規登録処理
        const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
        console.log("アカウント作成成功");
        
        // メール確認を送信（日本語設定付き）
        try {
          // メール確認設定（日本語、続行URL設定）
          const actionCodeSettings = {
            url: window.location.origin, // 現在のサイトに戻る
            handleCodeInApp: false
          };
          
          // 言語設定を確実に適用
          auth.languageCode = 'ja';
          
          await sendEmailVerification(userCredential.user, actionCodeSettings);
          console.log("確認メール送信成功（日本語設定）");
          
          // 確認画面を表示
          showEmailVerificationScreen(userCredential.user);
        } catch (verificationError) {
          console.error("確認メール送信エラー:", verificationError);
          alert("アカウントは作成されましたが、確認メールの送信に失敗しました。後で再送信してください。");
        }
      } else {
        // ログイン処理
        await signInWithEmailAndPassword(auth, email, pw);
        console.log("ログイン成功");
      }
      // 成功時はonAuthStateChangedで自動的にUI更新される
    } catch(err) {
      let errorMessage = isSignupMode ? "アカウント作成に失敗しました" : "ログインに失敗しました";
      
      if (isSignupMode) {
        // 新規登録時のエラー
        if (err.code === 'auth/email-already-in-use') {
          errorMessage = "このメールアドレスは既に使用されています";
        } else if (err.code === 'auth/weak-password') {
          errorMessage = "パスワードが弱すぎます。より強力なパスワードを設定してください";
        } else if (err.code === 'auth/invalid-email') {
          errorMessage = "メールアドレスの形式が正しくありません";
        }
      } else {
        // ログイン時のエラー
        if (err.code === 'auth/user-not-found') {
          errorMessage = "このメールアドレスは登録されていません";
        } else if (err.code === 'auth/wrong-password') {
          errorMessage = "パスワードが間違っています";
        } else if (err.code === 'auth/too-many-requests') {
          errorMessage = "試行回数が多すぎます。しばらく待ってから再試行してください";
        }
      }
      showError('pw', errorMessage);
    } finally {
      setLoading('loginEmail', false);
    }
  });

  $("#loginGoogle")?.addEventListener("click", async ()=>{
    setLoading('loginGoogle', true);
    
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
      // ログイン成功時はonAuthStateChangedで自動的にUI更新される
      console.log("Googleログイン成功");
    } catch(err) {
      let errorMessage = "Googleログインに失敗しました";
      if (err.code === 'auth/popup-closed-by-user') {
        errorMessage = "ログインがキャンセルされました";
      } else if (err.code === 'auth/popup-blocked') {
        errorMessage = "ポップアップがブロックされました。ブラウザの設定を確認してください";
      }
      showError('pw', errorMessage);
    } finally {
      setLoading('loginGoogle', false);
    }
  });

  // パスワードリセット機能
  $("#resetPassword")?.addEventListener("click", async () => {
    const email = $("#email").value.trim();
    
    if (!email) {
      showError('email', 'メールアドレスを入力してください');
      return;
    }
    
    if (!validateEmail(email)) {
      showError('email', '正しいメールアドレスを入力してください');
      return;
    }
    
    try {
      // パスワードリセット設定（日本語、続行URL設定）
      const actionCodeSettings = {
        url: window.location.origin + '?mode=resetPassword',
        handleCodeInApp: false
      };
      
      // 言語設定を確実に適用
      auth.languageCode = 'ja';
      
      await sendPasswordResetEmail(auth, email, actionCodeSettings);
      alert(`パスワードリセットメールを ${email} に送信しました。\nメールボックスを確認してください。`);
      console.log("パスワードリセットメール送信成功（日本語設定）");
      hideError('email');
    } catch(err) {
      let errorMessage = "パスワードリセットメールの送信に失敗しました";
      if (err.code === 'auth/user-not-found') {
        errorMessage = "このメールアドレスは登録されていません";
      } else if (err.code === 'auth/too-many-requests') {
        errorMessage = "リクエストが多すぎます。しばらく待ってから再試行してください";
      }
      showError('email', errorMessage);
    }
  });

  $("#logout")?.addEventListener("click", ()=>{
    signOut(auth);
  });

  // Firebase認証状態の監視とUI更新（エラーハンドリング強化）
  try {
    onAuthStateChanged(auth, (user)=>{
      console.log("🔥 Firebase認証状態変化:", user ? "ログイン" : "ログアウト");
      
      const authBox = $("#authBox");
      const verificationBox = $("#emailVerificationBox");
      
      if(user){
        console.log("📋 ユーザー情報:", {
          uid: user.uid,
          email: user.email,
          emailVerified: user.emailVerified,
          displayName: user.displayName,
          providerData: user.providerData?.map(p => ({ providerId: p.providerId }))
        });
        
        // メール確認状態をチェック
        if (!user.emailVerified && !verificationState.isWaitingForVerification) {
          // 未確認かつ確認待ち画面でない場合は確認画面を表示
          if (user.providerData.some(provider => provider.providerId === 'password')) {
            // メール/パスワードログインの場合のみ確認が必要
            console.log("📧 メール確認画面を表示");
            showEmailVerificationScreen(user);
            return;
          }
        }
        
        // 確認済みまたはGoogleログインの場合
        $("#who").textContent = `ログイン中: ${user.email || user.displayName}`;
        $("#logout").style.display = "";
        
        // 認証フォームを非表示、確認画面も非表示
        if(authBox) authBox.style.display = "none";
        if(verificationBox) verificationBox.classList.add('hidden');
        
        // 確認完了の場合は自動チェックを停止
        if (user.emailVerified && verificationState.isWaitingForVerification) {
          stopVerificationCheck();
          verificationState.isWaitingForVerification = false;
        }
        
        // アプリ側の状態も更新（確実に実行されるよう遅延処理）
        console.log("🔄 syncFirebaseAuth 呼び出し準備...");
        const syncUser = () => {
          if (window.syncFirebaseAuth) {
            console.log("✅ syncFirebaseAuth を呼び出します:", user.uid);
            try {
              window.syncFirebaseAuth(user);
              console.log("✅ syncFirebaseAuth 完了");
            } catch (error) {
              console.error("❌ syncFirebaseAuth エラー:", error);
            }
          } else {
            console.error("❌ window.syncFirebaseAuth が見つかりません - 再試行します");
            // 再試行（最大5回）
            let retryCount = 0;
            const retrySync = () => {
              if (retryCount < 5 && !window.syncFirebaseAuth) {
                retryCount++;
                console.log(`🔄 syncFirebaseAuth 再試行 ${retryCount}/5`);
                setTimeout(retrySync, 200);
              } else if (window.syncFirebaseAuth) {
                console.log("✅ syncFirebaseAuth 見つかりました - 呼び出します:", user.uid);
                try {
                  window.syncFirebaseAuth(user);
                  console.log("✅ syncFirebaseAuth 完了（再試行）");
                } catch (error) {
                  console.error("❌ syncFirebaseAuth エラー（再試行）:", error);
                }
              } else {
                console.error("❌ syncFirebaseAuth の読み込みに失敗しました");
              }
            };
            retrySync();
          }
        };
        setTimeout(syncUser, 100);
      } else {
        console.log("🚪 ログアウト状態");
        $("#who").textContent = "未ログイン";
        $("#logout").style.display = "none";
        
        // ログアウト時：認証フォームを表示、確認画面は非表示
        if(authBox) authBox.style.display = "block";
        if(verificationBox) verificationBox.classList.add('hidden');
        
        // 確認状態をリセット
        stopVerificationCheck();
        verificationState.user = null;
        verificationState.isWaitingForVerification = false;
        
        // アプリ側の状態も更新
        const syncLogout = () => {
          if (window.syncFirebaseAuth) {
            console.log("🔄 syncFirebaseAuth null を呼び出します");
            try {
              window.syncFirebaseAuth(null);
              console.log("✅ syncFirebaseAuth null 完了");
            } catch (error) {
              console.error("❌ syncFirebaseAuth null エラー:", error);
            }
          } else {
            console.error("❌ window.syncFirebaseAuth が見つかりません - 再試行します");
            // 再試行（最大5回）
            let retryCount = 0;
            const retrySync = () => {
              if (retryCount < 5 && !window.syncFirebaseAuth) {
                retryCount++;
                console.log(`🔄 syncFirebaseAuth null 再試行 ${retryCount}/5`);
                setTimeout(retrySync, 200);
              } else if (window.syncFirebaseAuth) {
                console.log("✅ syncFirebaseAuth 見つかりました - null を呼び出します");
                try {
                  window.syncFirebaseAuth(null);
                  console.log("✅ syncFirebaseAuth null 完了（再試行）");
                } catch (error) {
                  console.error("❌ syncFirebaseAuth null エラー（再試行）:", error);
                }
              } else {
                console.error("❌ syncFirebaseAuth の読み込みに失敗しました（ログアウト）");
              }
            };
            retrySync();
          }
        };
        setTimeout(syncLogout, 100);
      }
    }, (error) => {
      console.error("🚨 Firebase認証状態監視エラー:", error);
      // エラーが発生した場合でも基本的なUI状態は設定
      $("#who").textContent = "認証エラー";
      const authBox = $("#authBox");
      if(authBox) authBox.style.display = "block";
    });
    console.log("🔥 Firebase認証監視を開始しました");
  } catch (error) {
    console.error("🚨 onAuthStateChanged 初期化エラー:", error);
  }

  }); // waitForFirebaseAuth().then() の終了
  </script>

<script type="module" src="./app.js?v=20241219-001" onload="console.log('✅ app.js 読み込み完了')" onerror="console.error('❌ app.js 読み込み失敗')"></script>

<!-- 開発・テスト用：直接購入ボタン（社会小5） -->
<div id="devPurchaseSection" style="position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid #e5e7eb; z-index: 1000;">
  <div style="margin-bottom: 10px; font-size: 0.875rem; color: #6b7280;">開発・テスト用</div>
  <button id="buy-shakai" style="background: #2563eb; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">社会小5（¥2,980）を購入</button>
</div>

<script type="module">
  // 開発・テスト用の直接購入ボタン
  document.getElementById("buy-shakai")?.addEventListener("click", () => {
    if (window.startPurchase) {
      window.startPurchase("shakai_gakushu_5", "社会小5");
    } else {
      console.error("startPurchase 関数が見つかりません");
    }
  });
  
  // 開発環境でのみ表示
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    document.getElementById("devPurchaseSection").style.display = "block";
  }
</script>

</body>
</html>
