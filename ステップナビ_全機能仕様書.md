# ステップナビ 全機能仕様書

## 📋 目次

1. [アプリケーション概要](#アプリケーション概要)
2. [アーキテクチャ・ファイル構成](#アーキテクチャファイル構成)
3. [認証システム](#認証システム)
4. [購入・課金システム](#購入課金システム)
5. [学習システム](#学習システム)
6. [進捗管理システム](#進捗管理システム)
7. [レッスンごとの正答率管理](#レッスンごとの正答率管理)
8. [学習履歴システム](#学習履歴システム)
9. [繰り返し・再出題機能](#繰り返し再出題機能)
10. [毎日のレッスン推薦機能](#毎日のレッスン推薦機能)
11. [チェックポイント機能](#チェックポイント機能)
12. [特殊問題タイプ](#特殊問題タイプ)
13. [タイマー機能](#タイマー機能)
14. [コンテンツ面の特徴](#コンテンツ面の特徴)
15. [オフライン対応・PWA機能](#オフライン対応pwa機能)
16. [アクセシビリティ機能](#アクセシビリティ機能)
17. [UI/UXシステム](#uiuxシステム)
18. [データエクスポート/インポート機能](#データエクスポートインポート機能)
19. [連続学習日数・レベルシステム](#連続学習日数レベルシステム)
20. [背景テーマシステム](#背景テーマシステム)
21. [学習統計ページ](#学習統計ページ)
22. [連続学習記録ページ](#連続学習記録ページ)
23. [アカウント情報ページ](#アカウント情報ページ)
24. [エラーハンドリング・フォールバック](#エラーハンドリングフォールバック)
25. [パフォーマンス最適化](#パフォーマンス最適化)
26. [デバッグ・開発者向け機能](#デバッグ開発者向け機能)

---

## アプリケーション概要

**アプリ名**: ステップナビ  
**提供元**: T3エデュケーション  
**対象**: 小4・小5・小6向け 学校準拠＋中学受験 理科・社会 学習アプリ  
**技術スタック**: 
- フロントエンド: HTML5, CSS3, JavaScript (ES6+)
- バックエンド: Netlify Functions
- 認証・データベース: Firebase Authentication, Firestore
- 決済: Stripe Checkout
- PWA: Service Worker対応

---

## アーキテクチャ・ファイル構成

### ファイル構成

```
juken/
├── index.html              # メインHTMLファイル
├── app.js                   # メインアプリケーションロジック（約10000行）
├── styles.css               # スタイルシート
├── sw.js                    # Service Worker（PWA用）
├── manifest.json            # PWAマニフェスト
├── catalog.json             # レッスンカタログ（全レッスンのメタデータ）
├── firebaseconfig.js        # Firebase設定
├── package.json             # 依存関係
├── netlify.toml             # Netlify設定
├── netlify/
│   └── functions/
│       ├── create-checkout-session.js  # Stripe決済セッション作成
│       └── stripe-webhook.js          # Stripe Webhook処理
├── data/
│   └── encouragement-messages.json   # 励ましメッセージデータ
├── images/
│   ├── hero/                # ヒーロー画像
│   ├── subjects/          # 教科アイコン
│   └── character/         # キャラクター画像
├── offline.html           # オフライン時のフォールバックページ
└── lessons/
    ├── sci/               # 理科レッスン
    │   ├── biology/       # 生物
    │   ├── chemistry/     # 化学
    │   ├── physics/       # 物理
    │   ├── earth/         # 地学
    │   ├── comprehensive/ # 総合問題
    │   └── modular/       # モジュール形式
    │       ├── wakaru/    # わかる編
    │       └── oboeru/    # おぼえる編
    └── soc/               # 社会レッスン
        └── modular/       # モジュール形式
            ├── wakaru/    # わかる編
            └── oboeru/    # おぼえる編
```

### 画面構成

#### メインビュー

- **`homeView`**: ホーム画面
  - 教科タブ（⭐ おすすめ学習、🔬 理科わかる、🧪 理科おぼえる、🌍 社会わかる、📍 社会おぼえる）
  - レッスン一覧（グリッド形式または単元別表示）
  - おすすめレッスン表示
  - ルートマップ表示

- **`lessonView`**: レッスン実行画面
  - `iframe`でレッスンHTMLを読み込み
  - または直接DOMにレンダリング
  - 戻るボタン、進捗表示

#### モーダル・補助画面

- **学習統計モーダル**: 総学習時間、完了レッスン数、平均正答率、教科別/学年別統計
- **連続学習記録モーダル**: 連続学習日数、レベル、カレンダー、テーマ一覧
- **テーマ選択モーダル**: 背景テーマの変更
- **学習データエクスポート/インポートモーダル**: データの保存・読み込み
- **アカウント情報モーダル**: ユーザー情報、購入済みコンテンツ
- **メニューパネル**: 右側からスライドインするメニュー

---

## 認証システム

### Firebase Authentication

**実装方法**:
- Firebase Authenticationを使用
- 対応ログイン方法:
  - Googleアカウント（`signInWithPopup`）
  - メール/パスワード（`signInWithEmailAndPassword`, `createUserWithEmailAndPassword`）
- メール確認機能あり（`sendEmailVerification`）

**状態管理**:
- `state.user`: 現在のユーザー情報
  - `uid` / `id`: ユーザーID
  - `email`: メールアドレス
  - `displayName`: 表示名
  - `emailVerified`: メール確認状態
  - `providerData`: ログインプロバイダー情報

**認証状態の監視**:
- `onAuthStateChanged`で認証状態を監視
- `syncFirebaseAuth(user)`関数でアプリ状態を同期
- ログイン/ログアウト時にUIを自動更新

**認証フロー**:
1. アプリ起動時に`onAuthStateChanged`で認証状態を監視開始
2. ログイン状態が確定したら`syncFirebaseAuth(user)`を呼び出し
3. `state.user`を更新
4. ヘッダーボタン、購入ボタン、メニューの表示を更新
5. ログイン画面の表示/非表示を切り替え

**ログイン画面の制御**:
- 初期状態ではログイン画面を非表示（ゲートとして機能させない）
- 認証状態が確定した後（`data-auth-determined`属性が設定された後）のみ、ログアウト状態の場合はログイン画面を表示
- ログイン状態の場合は常に非表示

---

## 購入・課金システム

### Stripe Checkout統合

**パック構成**:
- 小4理科、小4社会
- 小5理科、小5社会
- 小6理科、小6社会
- 各パック: 2,980円

**購入フロー**:
1. ユーザーが「購入」ボタンをクリック
2. ログイン状態を確認（未ログインの場合はログイン要求）
3. メール確認状態をチェック（メール/パスワードログインの場合）
4. Netlify Function (`create-checkout-session`) を呼び出し
5. Stripe Checkoutセッションを作成
6. Stripe Checkoutページにリダイレクト
7. 決済完了後、Webhook (`stripe-webhook`) でFirestoreにentitlementを保存
8. 購入完了画面を表示

**Entitlements管理**:
- Firestore: `users/{userId}/entitlements/{productId}`
- `state.userEntitlements`: Set形式でメモリに保持
- リアルタイム監視: `onSnapshot`で変更を検知
- ローカルフォールバック: `localStorage`の`purchases`キー

**アクセス制御**:
- `hasEntitlement(sku)`: パックIDまたはproductIdでentitlementをチェック
- 未購入コンテンツは「🔒 購入が必要」バッジを表示
- レッスンカードに購入状態を表示

**購入成功・キャンセル処理**:
- URLパラメータ（`?success=true&product=...`）で結果を判定
- 成功時: 成功メッセージを表示、entitlementsを更新、UIを更新
- キャンセル時: キャンセルメッセージを表示

---

## 学習システム

### レッスン構造

**カタログ形式**: `catalog.json`
- 各レッスンは以下の情報を持つ:
  ```json
  {
    "id": "sci.physics.motion",
    "grade": 6,
    "subject": "sci",
    "title": "物体の運動とてこ",
    "duration_min": 15,
    "sku_required": null,
    "path": "lessons/sci/physics/motion/output.html",
    "format": "html",
    "tags": ["物理", "運動", "てこ"]
  }
  ```

**教科分類**:
- `sci`: 理科わかる編
- `science_drill`: 理科おぼえる編
- `soc`: 社会わかる編
- `social_drill`: 社会おぼえる編

**学年分類**:
- `grade`: 4, 5, 6

**理科の分類**:
- 小4: 基礎現象 × 自然観察
- 小5: 実験・数値・計測
- 小6: 発展分野（発展・総合に分かれる）

### レッスン表示

**タブ構成**:
- ⭐ おすすめ学習
- 🔬 理科わかる
- 🧪 理科おぼえる
- 🌍 社会わかる
- 📍 社会おぼえる

**表示モード**:
1. **通常表示**: グリッド形式でレッスンカードを表示
2. **単元別表示**: 社会おぼえる編、理科（全学年）は単元別にグループ化
   - 左側: 単元一覧（アイコン付き）
   - 右側: 選択された単元のレッスン一覧
   - モバイル: 単元一覧はアイコン帯に縮約

**レッスンカード**:
- タイトル、アイコン、進捗バー、完了バッジ
- 完了済みレッスンはグレースケール表示
- 未購入レッスンは「🔒 購入が必要」バッジ
- おすすめレッスンは特別なスタイル（緑系・オレンジ系のボーダー）

**おすすめ学習**:
- 復習レッスン（現在は無効化）
- 各教科から1つずつ推薦
- わかる編→おぼえる編の順で処理
- 最後に学習したレッスンの次を推薦

### レッスン実行

**レッスン読み込み**:
- `iframe`でレッスンHTMLを読み込み
- または直接DOMにレンダリング
- モジュール形式: `index_modular.html?era=レッスンID&mode=wakaru/oboeru`

**進捗保存**:
- レッスン完了時に`saveLessonProgress(id, correct, total, seconds)`を呼び出し
- `localStorage`に統合形式で保存
- データ形式:
  ```json
  {
    "lessonId": "sci.physics.motion",
    "score": 0.9,
    "detail": {
      "correct": 9,
      "total": 10,
      "timeSec": 720
    },
    "at": 1705123456789
  }
  ```

**完了判定**:
- `isLessonCompleted(lessonId)`: `detail.correct > 0`で判定

---

## 進捗管理システム

### データ保存

**統合形式の進捗データ**:
- `localStorage`の`progress`キーに全レッスン分をまとめて保存
- データ構造:
  ```json
  {
    "version": "2.0",
    "data": {
      "sci.physics.motion": {
        "lessonId": "sci.physics.motion",
        "score": 0.9,
        "detail": {
          "correct": 9,
          "total": 10,
          "timeSec": 720
        },
        "at": 1705123456789
      },
      ...
    },
    "updatedAt": 1705123456789
  }
  ```

**後方互換性**:
- 古い形式（`progress:{lessonId}`）が残っている場合は、読み込み時に自動で統合形式へ移行
- `getLessonProgress()`内で自動移行処理を実行

**進捗データの取得**:
- `getUnifiedProgress()`: 統合形式の進捗データを取得
- `saveUnifiedProgress()`: 統合形式の進捗データを保存
- `getLessonProgress(lessonId)`: 特定レッスンの進捗を取得
- `isLessonCompleted(lessonId)`: レッスン完了判定

**進捗表示**:
- レッスンカード: 進捗バーで完了率を表示、完了済みはチェックマーク表示
- 単元別表示: 各単元の完了レッスン数/総レッスン数、進捗パーセンテージ、プログレスバー

---

## レッスンごとの正答率管理

### 正答率の計算

**スコア計算**:
- `score = correct / total`（total=0の場合は1）
- 0.0〜1.0の範囲（0%〜100%）

**保存タイミング**:
- 各レッスンの最後で、レッスン側スクリプトが`window.parent.saveLessonProgress(lessonId, correct, total, timeSec)`を呼び出し
- レッスン側から`lessonCompleteMessage`を送信、または直接関数呼び出し

**保存処理**:
1. `saveLessonProgress(id, correct, total, seconds)`が呼ばれる
2. `score = correct / total`を計算
3. `detail = { correct, total, timeSec }`を作成
4. `saveProgress(lessonId, score, detail)`経由で統合形式として保存
5. 連続学習日数`learningStreak`を更新（`updateStreakDays()`呼び出し）

**利用箇所**:
- レッスンカードの進捗バー／完了バッジ／%表示
- 学習統計ページ（総レッスン数・完了数・平均正答率・学年別/教科別の集計）
- レッスン別進捗一覧（歴史地理などの単元別統計）
- おすすめタブの「⭐おすすめ」「🔄おさらい」カード
- 連続学習カレンダー（どの日に何かしらのレッスン進捗が付いたか）

---

## 学習履歴システム

### レッスン内のトラッカー（LearningTrackerクラス）

**各モジュールレッスンの`script.js`内に`LearningTracker`クラス**:
- 1回の学習セッションの中で、各問題ごとの回答履歴を記録

**記録内容**:
- `recordAnswer(questionId, selectedAnswer, correctAnswer, timeSpent, excludeFromTotal)`
  - `questionId`: 問題ID
  - `selectedAnswer`: ユーザーの選択した回答
  - `correctAnswer`: 正解
  - `isCorrect`: 正解/不正解
  - `timeSpent`: 回答にかかった時間
  - `timestamp`: 回答時刻
  - `excludeFromTotal`: 問題数に含めるかどうか（大きな問いや回収問題は除外）

**セッション管理**:
- `currentSession`: 現在のセッション情報
  - `startTime`: セッション開始時刻
  - `questions`: 回答履歴の配列
  - `score`: 正答数
  - `totalQuestions`: 総問題数
  - `totalTime`: 総学習時間

**保存処理**:
- `saveSession()`: セッションを保存
  - `endTime`: セッション終了時刻
  - `duration`: セッション時間
  - 統計情報を更新（`calculateStats()`）

### 学習履歴の保存

**保存先と形式**:
- キー: `learningHistory_{mode}`（`wakaru` / `oboeru`など）
- 値の形式:
  ```json
  {
    "sessions": [
      {
        "startTime": 1705123456789,
        "endTime": 1705124156789,
        "duration": 700000,
        "totalTime": 700000,
        "questions": [
          {
            "questionId": 1,
            "selectedAnswer": 0,
            "correctAnswer": 0,
            "isCorrect": true,
            "timeSpent": 5000,
            "timestamp": 1705123500000
          },
          ...
        ],
        "score": 8,
        "totalQuestions": 10,
        "mode": "wakaru"
      },
      ...
    ],
    "stats": {
      "totalSessions": 5,
      "totalQuestions": 50,
      "correctAnswers": 42,
      "averageScore": 84.0,
      "bestScore": 10
    }
  }
  ```

**統計情報**:
- `calculateStats(sessions)`: セッション配列から統計を計算
  - `totalSessions`: 総セッション数
  - `totalQuestions`: 総問題数
  - `correctAnswers`: 総正答数
  - `averageScore`: 平均正答率（%）
  - `bestScore`: 最高正答数

**利用箇所**:
- 学習の詳細ログとして保持
- エクスポート/インポート対象
- セッション結果の表示

---

## 繰り返し・再出題機能

### レッスン単位の「おさらい」推薦（現在有効）

**基本アイデア**:
- すでに一度完了したレッスンの中から、
  - **正答率が低い**もの
  - **最後に解いてから日数が経っている**もの
- を優先度付きで候補にして、「🔄 おさらい」としておすすめカードに出す

**候補抽出（`getReviewLessons`）**:
1. 全教科（`sci`, `science_drill`, `soc`, `social_drill`）のレッスンを走査
2. `getLessonProgress`が存在するものだけを見る
3. `isLessonCompleted`が`true`（＝`correct > 0`）のものだけを完了レッスンとして採用
4. `score`と`at`（最終学習日時）から`daysSince`を計算
5. **満点かつ30日未満**は一旦除外（直近で満点のものはおさらい対象にしない）

**優先度ロジック（`calculateReviewPriority`）**:
- **優先1**: スコア < 85% かつ 3日以上経過
- **優先2**: スコア < 90% かつ 7日以上経過
- **優先3**: 満点以外 かつ 14日以上経過
- **優先4**: 満点でも 30日以上経過
- **優先5**: 完了済みで 1日以上経過していればとりあえず候補
- それ以外は 99（候補外）

**ソート**:
- 優先度の小さい順（1が最優先）→ 同じ優先度なら日数が多い順
- `maxCount`件（デフォルト1〜3件）だけ返す

**おすすめタブでの表示（`getRecommendedLessons`）**:
1. 各教科グループ（理科・社会）について、
   - まず「ルートマップ的な次のレッスン（未完了レッスン）」を1件ずつ候補に
2. さらに`getReviewLesson()`で「おさらい対象レッスン」を1件取得し、  
   `type: 'review', reviewType: 'osaarai'`として一覧に追加
3. カード側では`reviewType === 'osaarai'`のとき
   - バッジを「🔄 おさらい」として表示
   - `getLessonProgress`から**前回の正答率（%）と経過日数**を説明文として表示

### レッスン全体の「再挑戦」

**UI操作**:
- 結果画面などから`data-action="retry-lesson"`を押すと、
- その`lessonId`で`setHash('lesson', lessonId)`を呼び、同じレッスンを最初から再ロード

**ポイント**:
- これは**「同じレッスンをもう一度最初から解き直す」**シンプルな再挑戦機能
- 問題単位の選別は行わず、「全問を再度出す」形

### 間違えた問題ベースの「復習レッスン」（現在は**無効化**）

**データ構造（`state.wrongQuestions`）**:
- 本来は`recordWrongAnswer(lessonId, questionData, userAnswer)`で、
  - `lessonId`（正規化済み）
  - `questionId`（`qnum`）
  - `questionData`（問題文・選択肢など）
  - `userAnswer`（誤答内容）
  - `wrongAt`（ミスした時刻）
  - `reviewCount`（復習した回数）
- を`state.wrongQuestions`に蓄積し、`localStorage`＋Firestoreにも同期する設計

**復習レッスン生成**:
- `pickForReview(baseId)`: 特定レッスンの間違い問題から最大10問を選出
- `checkReviewLessonGeneration(baseId)`: 間違い問題が一定数（`REVIEW_SYSTEM_CONFIG.MIN_WRONG_FOR_GENERATION`）以上になったら復習レッスンを自動生成
- 特別な「復習レッスン（reviewLesson）」を自動生成→通知→開始

**現在の状態**:
- `recordWrongAnswer`冒頭で「復習システムが無効化されているため、何もしない」とログを出して**即return**
- `pickForReview` / `checkReviewLessonGeneration`も同様に最初でreturn
- `startup()`でも「🚫 復習システムは無効化されています」と出して初期化をスキップ
- **コードとUIテンプレートは残っているが、実際には動かない状態**

### レッスン内での「その場での出し直し」

**各レッスンの`script.js`では、`LearningTracker`を使って**:
- その場で間違えた問題を**同一セッション内で再出題**したり、
- セッションの最後に「今回の正答率」「まちがえた問題の確認」などを行うロジックが入っている
- これは**「1回のレッスン中の繰り返し」**であり、  
  上で説明した`progress` / `learningHistory` / `wrongQuestions`とは別レイヤーで動いている

---

## 毎日のレッスン推薦機能

### おすすめ学習タブ（⭐ おすすめ学習）

**表示場所**: ホーム画面の「⭐ おすすめ学習」タブ  
**機能**: 進捗に基づいて「今日やるべきレッスン」を自動提示

### ルートマップ表示（`renderRouteMap`）

**表示内容**:
- 理科・社会それぞれに「学習ルート」を横スクロール形式で表示
- 現在位置（`isCurrent: true`）を中央に表示
- 前1つ・後2つ（計4件）を表示
- 各レッスンカードに「→」で接続

**ルートの決定ロジック（`getRecommendedRouteMap`）**:

1. **単元順序の定義**:
   - 理科: 小4 → 小5 → 小6
   - 社会: 地理 → 歴史 → 公民 → 総合

2. **各単元内で「わかる編 → おぼえる編」の順に並べる**

3. **現在位置の特定**:
   - 最後に完了したレッスン（`isLessonCompleted` + `getLessonProgress(...at)`で最新）を探す
   - その次の未完了レッスンを「現在位置」とする
   - 完了レッスンがない場合は最初のレッスンから開始

4. **表示範囲**:
   - 現在位置の前1つ・後2つ（計4件）を表示
   - 現在位置のカードは強調表示（`data-current-lesson="true"`）
   - 完了済みレッスンは視覚的に区別

**視覚的な特徴**:
- 横スクロール可能なトラック
- 現在位置が中央に来るように自動スクロール（`adjustRouteMapScroll`）
- カードに「完了」バッジ、ロック状態、教科色（理科=緑、社会=オレンジ）を表示

### おさらいレッスンセクション（`renderReviewSection`）

**表示内容**:
- ルートマップの下に「おさらい」セクションを表示
- 完了済みレッスンから、優先度の高い1件を選んで表示
- カードに「🔄 おさらい」バッジと「前回のスコア: XX% ・ Y日前に学習」を表示

**選出ロジック**:
- `getReviewLessons(1)`で1件だけ取得
- `calculateReviewPriority`で優先度を計算
- 優先度の低い順（1が最優先）→ 同じ優先度なら古い順でソート

### 従来版のおすすめ（`getRecommendedLessons`）

**機能**:
- ルートマップとは別に、各教科から1件ずつ「次のレッスン」を選ぶ機能（現在はルートマップが優先）

**ロジック**:
1. 理科・社会それぞれで、わかる編 → おぼえる編の順で処理
2. 最後に完了したレッスンの次の未完了レッスンを探す
3. 見つかったら推薦として採用（わかる編で見つかったらおぼえる編は見ない）
4. おさらいレッスンも1件追加

---

## チェックポイント機能

### 機能概要

**途中保存・再開機能**:
- レッスン中、10問・20問完了時に自動でチェックポイントを保存
- 保存内容: 現在の問題番号（`current`）、スコア、タイムスタンプ
- 保存先: `localStorage`の`checkpoint:{lessonId}`キー

### 動作フロー

1. **チェックポイント検出**:
   - 10問・20問完了時に`current % 10 === 0`で検出
   - `saveCheckpoint()`で自動保存
   - `showCheckpointDialog(current)`でモーダルを表示

2. **モーダル表示**:
   - 「続ける」「中断する」を選択可能
   - ユーザーが選択するまで待つ

3. **再開処理**:
   - 中断した場合、次回同じレッスンを開くと`loadCheckpoint()`でチェックポイントを読み込み
   - 保存された問題番号から再開

4. **削除処理**:
   - レッスン完了時に`clearCheckpoint()`でチェックポイントを自動削除

### 実装箇所

- `lessons/.../script.js`の`saveCheckpoint()`, `loadCheckpoint()`, `showCheckpointDialog()`
- `app.js`の`hasCheckpoint(lessonId)`でチェックポイントの有無を確認
- レッスンカードにチェックポイントアイコンを表示（実装予定）

---

## 特殊問題タイプ

### 「大きな問い」・「回収問題」・「話し合い問題」

**問題タイプ**:
- `bigQuestion`（大きな問い）: 1レッスンに1問。通常問題とは別にモーダルで表示
- `summaryQuestion`（回収問題）: 間違えた問題をまとめて再出題
- `discussionQuestion`（話し合い問題）: 対話形式の問題

**処理ロジック**:
1. わかる編では、通常問題から`bigQuestion`, `summaryQuestion`, `discussionQuestion`を除外
2. これらは`window.bigQuestion`, `window.summaryQuestions`, `window.discussionQuestions`に保存
3. 通常問題が終わった後、回収問題を表示
4. 大きな問いは別途モーダルで表示（`uiClass: "big-question"`でスタイル適用）

**視覚的特徴**:
- 大きな問いは専用モーダル（`big-question-modal`）で全画面表示
- 回収問題は通常問題の後に自動で表示
- 回収問題は問題数に含めない（`excludeFromTotal = true`）

---

## タイマー機能

### 機能概要

**おぼえる編専用**:
- おぼえる編（`mode === "oboeru"`）でのみ有効
- 各問題に20秒の制限時間を設定
- タイマー表示: 画面にカウントダウンを表示（赤色、太字）

### 動作フロー

1. **タイマー開始**:
   - 問題読み込み時に`timeLeft = 20`でタイマー開始
   - `timer = setInterval(...)`で1秒ごとにカウントダウン

2. **タイマー表示**:
   - `timerDisplay`要素に残り時間を表示
   - 0秒に近づくと色を変える（視覚的警告）

3. **タイムアウト処理**:
   - 0秒になると自動で次の問題へ（またはタイムアウト処理）
   - タイマーをクリア

4. **わかる編ではタイマーなし**:
   - `mode === "wakaru"`の場合は`timerDisplay`は非表示

### 実装箇所

- `lessons/.../script.js`のタイマー関連コード
- `mode === "oboeru"`の条件分岐でタイマー表示/非表示を切り替え

---

## コンテンツ面の特徴

### 問題画面のレイアウト（理科モジュール）

**`source`エリア**:
- 解説文・箇条書き・表・強調テキストなどを自由なHTMLで配置できる枠
- ここに「本文原稿」を入れていく想定

**`visual`エリア**:
- `visual-diagram`クラス付きの専用ボックス
- 回路図・表・タイムライン・計算式などの「図解・模式図」を、  
  等幅フォント＋枠付きで見やすく表示できるようになっている
- 必要に応じてここにテキスト図や画像を出す設計

**`choices`＋`explanation`**:
- 選択肢と詳しい解説を別ブロックで表示
- 「本文 → 図 → 選択肢 → 解説」が一画面に収まる構造

### 社会・歴史「史料つき」レッスンの構造

**`sources`配列**:
- 各レッスンに`sources`配列があり、1つずつ
  - 原文（例：万葉集の和歌・正倉院文書の本文）
  - 現代語訳
  - 時代・背景説明
  - 出典名
- をまとめて持たせている

**`sourceTextId`による紐付け**:
- `questions`側で`sourceTextId`を指定し、「どの史料を見て答える問題か」をひもづける
- 1つのレッスン内で複数の史料を比較させる問題（万葉集 vs 正倉院文書 など）が作れる

**効果**:
- 単なる暗記問題ではなく「史料を読ませて考えさせる」タイプのコンテンツを構造的に扱える

### イラスト・キャラクター周りのコンテンツ

**教科アイコン・ヒーロー画像**:
- 各教科ごとにヘッダー部分で背景色やアイコン（理科・社会）を切り替える
- タブを変えると「見た目からどの教科かすぐ分かる」ようになっている

**キャラクター画像＋励ましメッセージ**:
- `images/character/`配下のキャラクターPNGを使う
- 「おすすめ」タブのヒーローエリアに、吹き出し付きで応援メッセージを表示
- 日付・季節・トーンに応じてメッセージが切り替わる
- 画像が無い場合は自動で🎓などの絵文字にフォールバック

### 原稿／問題データ側の設計の特徴

**問題データ構造**:
- `question`（問い）
- `choices`（選択肢）
- `explanation`（解説）
- 必要に応じて`sourceTextId`（史料）や`visual`（図表）

**編集のしやすさ**:
- 後から図版だけ差し替える
- 史料テキストだけ修正する
- 同じ史料を使った別問題を追加する
- といった編集がしやすい構造

---

## オフライン対応・PWA機能

### オフラインページ

**`/offline.html`**:
- ネットワークエラー時に自動表示
- 「再読み込み」ボタンで接続回復を待機
- グラデーション背景、中央配置のカード形式

### Service Worker（`sw.js`）

**キャッシュ戦略**:
- キャッシュ優先、ネットワークフォールバック
- GETリクエストのみキャッシュ
- POST/PUT等はキャッシュしない

**プリキャッシュ**:
- コアファイル（HTML, JS, CSS, JSON）を事前キャッシュ
- レッスンファイル（モジュール形式）もプリキャッシュ

**動的キャッシュ**:
- レッスンファイルを動的にキャッシュ
- ネットワークから取得したリソースを自動でキャッシュに追加

**Firebase予約パス**:
- `/__/`で始まるパスは素通し（認証で重要）
- Service Workerでキャッシュしない

**バージョン管理**:
- `CACHE_NAME`でキャッシュバージョンを管理
- バージョン更新時に古いキャッシュを自動削除

**キャッシュ対象**:
- コアファイル: `index.html`, `app.js`, `styles.css`, `catalog.json`など
- レッスンファイル: モジュール形式のHTML/JS/CSS
- アイコン: PWA用アイコン画像
- オフラインページ: `/offline.html`

### マニフェスト（`manifest.json`）

**設定**:
- アプリ名: 「ステップナビ」
- 表示モード: `standalone`
- 背景色: `#f8fafc`
- テーマ色: `#2563eb`
- アイコン: `favicon.png` (192x192)

**インストール**:
- ブラウザが自動検出
- 「アプリに追加」ボタンでインストール可能
- メニューからもアクセス可能

---

## アクセシビリティ機能

### 実装済み

**ARIA属性**:
- `aria-label`: ボタンやUI要素に追加（特にアイコンボタン）
- `aria-hidden="true"`: 絵文字の読み上げを防止
- `role="dialog"`, `aria-modal="true"`: モーダルに追加
- `role="tablist"`, `role="tab"`: タブに追加
- `aria-selected`, `aria-controls`: タブの状態管理
- `role="alert"`, `aria-live="assertive"`: エラーメッセージに追加

**フォーカス管理**:
- `:focus-visible`: キーボード操作時のみフォーカス表示
- すべてのボタン、リンク、入力要素にフォーカスインジケーターを追加

**キーボード操作**:
- 基本的なキーボード操作は実装済み
- エスケープキーでモーダルを閉じる

### 改善余地

**モーダルのフォーカストラップ**:
- Tabキーでモーダル内にフォーカスを閉じ込める（未実装）

**色のコントラスト比**:
- WCAG 2.1 AA基準: テキストは4.5:1以上
- 大きなテキスト（18pt以上）は3:1以上
- 背景テーマの色の組み合わせ（特に薄い色）の確認が必要

**最小フォントサイズ**:
- モバイル向けの最小フォントサイズの調整が必要

**キーボードショートカット**:
- 追加のキーボードショートカットの実装（検討中）

---

## UI/UXシステム

### メニューシステム

**メニューボタン**:
- ヘッダー右端に「☰ メニュー」ボタン
- クリックでサイドパネルを表示

**メニュー項目**:
1. 📊 学習統計
2. 🔥 連続学習記録
3. 🎨 背景テーマ
4. 💾 学習データを保存
5. 📥 学習データを読み込み
6. 👤 アカウント情報（ログイン時のみ）
7. 📱 アプリに追加（PWAインストール可能時のみ）
8. ❓ ヘルプ（準備中）

**メニューパネル**:
- 右側からスライドイン
- 背景オーバーレイ
- エスケープキーまたは背景クリックで閉じる

### 励ましメッセージシステム

**データ管理**:
- `data/encouragement-messages.json`から読み込み
- フォールバック: `getDefaultEncouragementData()`

**メッセージタイプ**:
1. **日付対応メッセージ** (`dailyMessages`):
   - 特定の日付に表示されるメッセージ
   - 例: 1月1日「🎍 新年あけましておめでとうございます！」
2. **ランダムメッセージ** (`randomMessages`):
   - ランダムに選択されるメッセージ

**キャラクター画像**:
- 各メッセージに対応するキャラクター画像を指定
- `images/character/`ディレクトリに配置
- 画像読み込み失敗時は🎓絵文字でフォールバック

**表示場所**:
- おすすめタブ選択時、ヒーロー画像エリア内に表示
- マンガ風の吹き出しスタイル
- キャラクター画像とメッセージを組み合わせて表示

### レスポンシブデザイン

**ブレークポイント**:
- モバイル: `max-width: 768px`
- デスクトップ: `min-width: 769px`

**モバイル対応**:
- 単元一覧をアイコン帯に縮約
- タブ名を短縮表示（例：「小4理科：基礎現象 × 自然観察」→「小4」）
- カードを縦に並べる
- メニューパネルを全画面表示

---

## データエクスポート/インポート機能

### エクスポート機能

**保存対象データ**:
- `progress`: 全レッスンの進捗データ（統合形式）
- `progress:*`: 進捗データ（旧形式：後方互換性のため）
- `learningHistory_*`: 学習履歴
- `checkpoint:*`: チェックポイント
- `learningStreak`: 連続学習日数
- `unlockedThemes`: アンロック済みテーマ
- `currentTheme`: 現在のテーマ
- `purchases`: 購入情報
- `currentGrade`: 現在の学年

**除外データ**:
- `lessonCompleteMessage`: 一時メッセージ
- `questionAnswers`: 一時回答データ
- 移行フラグなど

**エクスポート方法**:
1. ファイルとして自動ダウンロード（推奨）
2. クリップボードにもコピー（同じ端末内での一時保存用）

**ファイル形式**:
- JSON形式
- ファイル名: `学習データ_YYYY-MM-DDTHH-mm-ss.json`
- メタデータを含む:
  ```json
  {
    "version": "1.0",
    "exportDate": "2025-01-15T10:30:00.000Z",
    "data": { ... }
  }
  ```

### インポート機能

**読み込み方法**:
1. ファイルを選択（推奨：別端末から移す場合）
2. クリップボードから貼り付け（同じ端末内の場合）

**処理フロー**:
1. 現在のデータをバックアップ提案
2. データ形式の検証（JSON）
3. バージョンチェック
4. データ内容の確認ダイアログ
5. localStorageにインポート
6. UIを自動更新

**エラーハンドリング**:
- 不正なJSON形式の検出
- データサイズ制限の警告
- 部分的なインポート失敗の通知

---

## 連続学習日数・レベルシステム

### 連続学習日数の管理

**データ保存**:
- `localStorage`の`learningStreak`キー
- データ形式:
  ```json
  {
    "days": 7,
    "lastDate": "2025-01-15"
  }
  ```

**更新ロジック** (`updateStreakDays()`):
1. 今日の日付を取得（YYYY-MM-DD形式）
2. 前回の学習日と比較
3. 昨日学習していた場合: 連続日数を+1
4. 連続が途切れた場合: リセットして1日から
5. レベルアップをチェック
6. テーマをアンロック

**レベル定義**:
```javascript
const LEVEL_DEFINITIONS = [
  { days: 0, level: 1, theme: 'default' },
  { days: 3, level: 2, theme: 'spring' },
  { days: 7, level: 3, theme: 'summer' },
  { days: 14, level: 4, theme: 'autumn' },
  { days: 30, level: 5, theme: 'winter' },
  { days: 60, level: 6, theme: 'night' },
  { days: 100, level: 7, theme: 'starry' }
];
```

**レベル計算**:
- `getLevelFromDays(days)`: 連続日数からレベルを計算
- `getStreakInfo()`: 現在の連続日数とレベルを取得

---

## 背景テーマシステム

### テーマ定義

**テーマ一覧**:
```javascript
const THEME_DEFINITIONS = [
  { id: 'default', name: 'デフォルト', icon: '🌻', requiredLevel: 1 },
  { id: 'spring', name: '春', icon: '🌸', requiredLevel: 2 },
  { id: 'summer', name: '夏', icon: '☀️', requiredLevel: 3 },
  { id: 'autumn', name: '秋', icon: '🍂', requiredLevel: 4 },
  { id: 'winter', name: '冬', icon: '❄️', requiredLevel: 5 },
  { id: 'night', name: '夜', icon: '🌙', requiredLevel: 6 },
  { id: 'starry', name: '星空', icon: '⭐', requiredLevel: 7 }
];
```

**アンロックシステム**:
- レベルアップ時に自動でテーマをアンロック
- `unlockThemeForLevel(level)`: レベルに応じたテーマをアンロック
- `localStorage`の`unlockedThemes`に保存

**テーマ適用**:
- `applyCurrentTheme()`: 現在のテーマを適用
- `body`要素に`theme-{themeId}`クラスを追加
- 背景装飾要素にもクラスを適用

**テーマ選択UI**:
- モーダル形式で表示
- アンロック済みテーマは選択可能
- 未アンロックテーマはグレーアウト
- 現在のテーマは強調表示

---

## 学習統計ページ

### 表示内容

**総合統計**:
- 総学習時間（秒単位、フォーマット表示）
- 完了レッスン数（完了/全体）
- 平均正答率（%）
- 連続学習日数とレベル

**教科別統計**:
- 理科わかる編、理科おぼえる編
- 社会わかる編、社会おぼえる編
- 各教科の完了数、進捗率、平均正答率、学習時間
- プログレスバーで進捗を可視化

**学年別統計**:
- 小4、小5、小6
- 各学年の完了数と平均正答率

**最近の学習履歴**:
- 直近10件の学習記録
- レッスン名、日時、正答率、問題数、学習時間

### UI特徴

**アニメーション**:
- 数値のカウントアップアニメーション
- パーセンテージのカウントアップ
- プログレスバーのスムーズな伸び
- カードの順次フェードイン

**達成度に応じた色とメッセージ**:
- 80%以上: 緑「完璧です！🎉」⭐⭐⭐⭐⭐
- 60-80%: オレンジ「順調です！✨」⭐⭐⭐⭐
- 30-60%: 黄色「頑張っています！💪」⭐⭐⭐
- 30%未満: グレー「これからです！🎯」⭐

**励ましメッセージと次の目標**:
- 総合進捗に応じたメッセージ表示
- 次の目標の提示（例：「あと5レッスンで50%達成！」）
- 連続学習目標の表示

---

## 連続学習記録ページ

### 表示内容

**メインヘッダー**:
- 大きな連続日数表示（アニメーション付き）
- 達成度に応じた色とメッセージ
- レベルとスター評価

**次のレベルまでの進捗**:
- 次のレベルまでの残り日数
- プログレスバーで進捗を可視化
- 達成率のパーセンテージ
- 最高レベル達成時の特別表示

**学習カレンダー（過去30日間）**:
- 7列×約4週間のカレンダー表示
- 学習日は緑色で表示
- 今日はオレンジ色で強調
- ホバーで拡大
- 実際の学習履歴を反映

**アンロック済みテーマ**:
- 全テーマを一覧表示
- アンロック済み/未アンロックを色分け
- 現在使用中のテーマを強調表示
- 未アンロックテーマには必要なレベルを表示

**モチベーションメッセージ**:
- 連続日数に応じたメッセージ
  - 0日: 「今日から始めましょう！🚀」
  - 3日: 「3日連続！習慣がついてきました！💪」
  - 7日: 「1週間達成！素晴らしい継続力です！✨」
  - 14日: 「2週間達成！学習が習慣になっています！🎉」
  - 30日: 「1ヶ月達成！本当に素晴らしいです！👑」
  - 60日: 「2ヶ月達成！あなたは学習の達人です！🔥」
  - 100日: 「100日達成！伝説的な継続力です！💎」

### UI特徴

- アニメーション効果（カウントアップ、プログレスバー）
- カラフルなグラデーション背景
- インタラクティブなカレンダー

---

## アカウント情報ページ

### 表示内容（ログイン時のみ表示）

**ユーザー情報カード**:
- ユーザー名（表示名またはメールアドレス）
- メールアドレス
- メール確認状態（確認済み/未確認）
- アバター（名前の頭文字を円形アイコンで表示）

**学習サマリー**:
- 連続学習日数
- 現在のレベル
- アンロック済みテーマ数

**購入済みコンテンツ**:
- 購入済みパックの一覧表示
- 各パックのラベルとステータス
- 購入済みコンテンツがない場合のメッセージ

**アカウント設定**:
- アカウントID（Firebase UID）
- ログイン方法（Googleアカウント/メール・パスワード）
- 将来の拡張機能への案内

---

## エラーハンドリング・フォールバック

### ネットワークエラー

**Service Worker**:
- ネットワークエラー時にオフラインページを表示
- キャッシュからフォールバック

### データ読み込みエラー

**エラーハンドリング**:
- `try-catch`でエラーを捕捉
- エラーメッセージを`role="alert"`で表示
- フォールバックデータを提供（例: 励ましメッセージのデフォルトデータ）

### ストレージ容量不足

**QuotaExceededError**:
- `QuotaExceededError`を検出
- 古いデータを削除して再試行
- ユーザーに警告を表示

### データ移行・後方互換性

**進捗データの移行**:
- 古い形式（`progress:{lessonId}`）から統合形式（`progress`）への自動移行
- `migrateProgressData()`で既存データを統合形式に変換
- 読み込み時に自動で移行（`getLessonProgress()`内）

**レッスンIDの正規化**:
- `normalizeLessonId()`でレッスンIDを正規化
- 旧IDと新IDの互換性を保つ

---

## パフォーマンス最適化

### イベント委譲

**グローバルイベント委譲**:
- `setupGlobalEventDelegation()`でドキュメント全体のイベントを一元管理
- `data-action`属性でアクションを指定
- クリックイベントを一元管理

### 遅延読み込み

**レッスンカタログ**:
- レッスンカタログの遅延読み込み
- 必要になった時点で読み込み

**画像**:
- 画像の`loading="lazy"`属性（実装予定）

### キャッシュ戦略

**Service Worker**:
- リソースをキャッシュ
- 動的なキャッシュ更新
- バージョン管理による古いキャッシュの削除

### データ構造の最適化

**統合形式の進捗データ**:
- 分散形式（`progress:{lessonId}`）から統合形式（`progress`）への移行
- localStorageのキー数を大幅に削減
- 全進捗データの一括取得が高速化

---

## デバッグ・開発者向け機能

### グローバル関数の公開

**進捗管理**:
- `window.saveLessonProgress`: レッスン進捗を保存
- `window.getLessonProgress`: レッスン進捗を取得
- `window.isLessonCompleted`: レッスン完了判定
- `window.saveLearningHistory`: 学習履歴を保存

**UI更新**:
- `window.renderHome`: ホーム画面を描画
- `window.renderAppView`: アプリビューを描画

### テスト用関数

**テスト用完了メッセージ**:
- `window.testLessonComplete()`: テスト用の完了メッセージ送信

**デバッグ情報表示**:
- `showReviewSystemDebugInfo()`: 復習システムのデバッグ情報表示
- `getReviewSystemStatus()`: 復習システムの状態を取得

### ログ出力

**コンソールログ**:
- 詳細なログをコンソールに出力
- エラー時の適切なエラーハンドリング
- 開発モードでのみ詳細ログを出力（実装予定）

---

## まとめ

この仕様書は、ステップナビアプリケーションの全機能を網羅的にまとめたものです。各機能の詳細な実装方法、データ構造、UI/UXの特徴、エラーハンドリング、パフォーマンス最適化など、開発・保守に必要な情報を包括的に記載しています。

### 主要な機能カテゴリ

1. **認証・課金**: Firebase認証、Stripe決済、Entitlements管理
2. **学習システム**: レッスン表示、実行、進捗管理
3. **推薦システム**: ルートマップ、おさらいレッスン、おすすめ機能
4. **進捗管理**: 正答率、学習履歴、チェックポイント
5. **モチベーション**: 連続学習、レベル、テーマ、励ましメッセージ
6. **データ管理**: エクスポート/インポート、移行、最適化
7. **PWA機能**: Service Worker、オフライン対応、インストール
8. **アクセシビリティ**: ARIA属性、キーボード操作、フォーカス管理
9. **UI/UX**: メニュー、レスポンシブ、アニメーション
10. **特殊機能**: タイマー、大きな問い、回収問題、チェックポイント

### 今後の拡張予定

- 復習システムの再有効化
- ヘルプ機能の実装
- キーボードショートカットの追加
- さらなるアクセシビリティ改善
- パフォーマンス最適化の継続

---

**最終更新**: 2025年1月27日  
**バージョン**: 1.0

