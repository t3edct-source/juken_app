# セキュリティ監査レポート

**日付**: 2025-01-27  
**対象ファイル**: `4205_muromachi_period.js` および関連コンテンツ  
**監査範囲**: XSS脆弱性、データ処理、外部リソースアクセス

## 実行サマリー

このレポートは、教育用クイズアプリケーションのコンテンツファイルとその使用箇所の安全性を評価したものです。

## 発見された問題

### 🔴 高リスク: XSS（クロスサイトスクリプティング）脆弱性

**問題箇所**:
1. `lessons/soc/modular/wakaru/script.js` (line 199)
   ```javascript
   questionEl.innerHTML = q.text || q.question;
   ```

2. `lessons/soc/modular/wakaru/script.js` (line 210)
   ```javascript
   sourceEl.innerHTML = mode === "wakaru" ? q.source : "";
   ```

3. `app.js` (line 7080-7108) - `displayReviewQuestion`関数
   ```javascript
   homeView.innerHTML = `
     ...
     <h2 class="question-text">${currentQ.text}</h2>
     ...
     <span class="choice-text">${choice}</span>
   `;
   ```

**リスク評価**:
- **現在のリスクレベル**: 🟡 **中程度**
  - データは静的なJavaScriptファイルから読み込まれており、信頼できるソースからのみ供給されている
  - データファイル自体に悪意のあるスクリプトは含まれていない
- **潜在的なリスクレベル**: 🔴 **高**
  - 将来的に外部APIやユーザー入力からデータを読み込む場合、重大なセキュリティリスクとなる
  - `source`フィールドにはHTMLが含まれており、適切にサニタイズされていない

**推奨される対策**:
1. HTMLエスケープ関数を使用（`app.js`には既に`escapeHtml`関数が存在: line 4372）
2. 信頼できるHTMLのみを許可する場合は、DOMPurifyなどのライブラリを使用
3. `textContent`を使用するか、HTMLが必要な場合は適切にサニタイズ

### 🟡 中リスク: localStorage の使用

**問題箇所**:
- `lessons/soc/modular/wakaru/script.js` (複数箇所)
  - 学習進捗データの保存
  - 回答履歴の保存

**リスク評価**:
- **現在のリスクレベル**: 🟢 **低**
  - 機密情報（パスワード、認証トークンなど）は保存されていない
  - 学習データのみが保存されている
- **潜在的なリスク**:
  - 機密情報が誤って保存される可能性
  - XSS攻撃が成功した場合、localStorageからデータが盗まれる可能性

**推奨される対策**:
1. localStorageに保存するデータの種類を明確に定義
2. 機密情報が保存されないことを確認するコードレビュー
3. 必要に応じてデータの暗号化を検討

## 良好な実装

### ✅ HTMLエスケープ関数の存在

`app.js`には`escapeHtml`関数が定義されており、一部の箇所で使用されています：
```javascript
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}
```

### ✅ 悪意のあるコードの不在

- `eval()`、`Function()`、`new Function()`の使用は確認されませんでした
- 外部スクリプトの動的読み込みは適切に管理されています

### ✅ データソースの信頼性

- クイズデータは静的なJavaScriptファイルから読み込まれており、信頼できるソースからのみ供給されている
- データファイル自体に悪意のあるコンテンツは含まれていない

## データコンテンツの確認

### 確認した内容

1. **HTMLコンテンツ**: `source`フィールドにHTMLが含まれているが、教育目的の図解表示用であり、悪意のあるスクリプトは含まれていない
2. **絵文字の使用**: 教育目的で使用されており、問題なし
3. **特殊文字**: 日本語文字が適切に処理されている

### データ構造

```javascript
{
  "qnum": 1,
  "text": "問題文",
  "choices": ["選択肢1", "選択肢2", ...],
  "answer": 0,
  "source": "解説（HTML含む）",
  "tags": [],
  "difficulty": 1,
  "asof": "2025-09-23"
}
```

## 推奨される改善策

### 優先度: 高

1. **XSS対策の実装**
   - `lessons/soc/modular/wakaru/script.js`で`innerHTML`の代わりに適切なサニタイズを実装
   - `escapeHtml`関数を共通モジュールとして使用可能にする
   - HTMLが必要な場合はDOMPurifyなどのライブラリを検討

2. **コードレビューの実施**
   - 新しいデータファイルを追加する際のセキュリティチェックリストを作成
   - 外部データソースを使用する場合のセキュリティガイドラインを策定

### 優先度: 中

3. **Content Security Policy (CSP) の実装**
   - XSS攻撃をさらに防ぐためのCSPヘッダーの設定を検討

4. **データ検証の強化**
   - データファイルの構造を検証するスキーマチェックを実装

## 結論

現在のコンテンツファイル自体は安全ですが、**データをDOMに挿入する際のXSS対策が不十分**です。データは信頼できるソースからのみ供給されているため、即座のリスクは低いですが、将来的な拡張や外部データソースの使用を考慮すると、早期の対策が推奨されます。

**総合評価**: 🟡 **中程度のリスク** - 改善が必要

## 次のステップ

1. XSS対策の実装（優先度: 高）
2. セキュリティガイドラインの作成
3. 定期的なセキュリティ監査の実施
















