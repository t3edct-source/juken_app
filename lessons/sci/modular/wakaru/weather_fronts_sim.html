<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - ç©ºæ°—ã®ä¸Šæ˜‡ã¨é›²</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:"Hiragino Sans","Yu Gothic",sans-serif;
      background:linear-gradient(135deg,#bbdefb 0%,#e3f2fd 40%,#fff8e1 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .header {
      background:rgba(255,255,255,0.95);
      padding:10px 15px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    .home-btn {
      background:#42a5f5;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:20px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .home-btn:hover { background:#1e88e5; transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.98); }

    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#333;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
      text-align:center;
    }

    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
      gap:15px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ */
    .sim-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      overflow:hidden;
    }
    .sim-header {
      background:linear-gradient(135deg,#42a5f5 0%,#64b5f6 40%,#81d4fa 100%);
      color:white;
      padding:15px;
      text-align:center;
    }
    .sim-header h2 { font-size:20px; margin-bottom:4px; }
    .sim-header p { font-size:14px; opacity:0.95; }

    .sim-area {
      padding:12px 12px 16px;
      background:#e3f2fd;
    }

    .sim-field {
      position:relative;
      background:linear-gradient(to top,#ffe0b2 0%,#ffecb3 14%,#bbdefb 40%,#90caf9 100%);
      border-radius:12px;
      padding:12px;
      min-height:240px;
      overflow:hidden;
    }

    /* â–¼ åœ°é¢ã¨ç©º */
    .ground {
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      height:40px;
      background:linear-gradient(to top,#8d6e63,#a1887f);
    }
    .ground::before {
      content:"";
      position:absolute;
      top:-8px;
      left:0;
      right:0;
      height:10px;
      background:repeating-linear-gradient(
        90deg,
        #a5d6a7 0,
        #a5d6a7 20px,
        #81c784 20px,
        #81c784 40px
      );
      opacity:0.8;
    }
    .mountain {
      position:absolute;
      bottom:40px;
      left:8%;
      width:40%;
      height:90px;
      background:linear-gradient(135deg,#8d6e63 0%,#4e342e 100%);
      clip-path:polygon(50% 0,0 100%,100% 100%);
      opacity:0.9;
    }
    .mountain::after {
      content:"";
      position:absolute;
      top:15%;
      left:25%;
      width:50%;
      height:30%;
      background:linear-gradient(to bottom,#fafafa,#cfd8dc);
      clip-path:polygon(50% 0,0 100%,100% 100%);
      opacity:0.9;
    }

    /* â–¼ ç©ºæ°—ã®ã‹ãŸã¾ã‚Š */
    .air-parcel {
      position:absolute;
      width:80px;
      height:60px;
      border-radius:20px;
      background:radial-gradient(circle at 30% 20%,#ffffff 0%,#e3f2fd 45%,#bbdefb 100%);
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
      left:52%;
      transform:translateX(-50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      transition:transform 0.3s ease,background 0.3s ease;
    }
    .air-parcel-label {
      font-size:11px;
      color:#1e3a5f;
      font-weight:bold;
      margin-bottom:2px;
    }
    .air-parcel-temp {
      font-size:13px;
      color:#1e88e5;
      font-weight:bold;
    }

    /* â–¼ é›² */
    .cloud-layer {
      position:absolute;
      top:15%;
      left:50%;
      transform:translateX(-50%);
      width:70%;
      height:60px;
      pointer-events:none;
    }
    .cloud {
      position:absolute;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      width:140px;
      height:55px;
      background:radial-gradient(circle at 30% 30%,#ffffff 0%,#fafafa 40%,#e0e0e0 100%);
      border-radius:40px;
      filter:drop-shadow(0 4px 10px rgba(0,0,0,0.25));
      opacity:0;
      transition:opacity 0.3s ease, transform 0.3s ease;
    }
    .cloud::before,
    .cloud::after {
      content:"";
      position:absolute;
      bottom:10px;
      width:70px;
      height:45px;
      background:inherit;
      border-radius:50px;
    }
    .cloud::before {
      left:-20px;
    }
    .cloud::after {
      right:-20px;
    }
    .cloud.visible {
      opacity:0.35;
    }
    .cloud.medium {
      opacity:0.65;
      transform:translateX(-50%) scale(1.05);
    }
    .cloud.thick {
      opacity:1;
      transform:translateX(-50%) scale(1.12);
    }
    @keyframes cloudGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.5) drop-shadow(0 0 20px rgba(255,255,255,0.8)); }
    }
    /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .cloud-particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(200,220,255,0.6) 100%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 20;
      animation: particleFloat var(--duration) ease-out forwards;
    }

    /* â–¼ é£½å’Œãƒ©ã‚¤ãƒ³è¡¨ç¤º */
    .saturation-line {
      position:absolute;
      left:6px;
      right:6px;
      border-top:2px dashed rgba(255,255,255,0.8);
    }
    .saturation-label {
      position:absolute;
      left:10px;
      font-size:11px;
      font-weight:bold;
      color:#333;
      white-space:normal;
      line-height:1.4;
      max-width:140px;
      z-index:15;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
    }

    /* â–¼ æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆæ¸©åº¦ãƒ»æ¹¿åº¦ãªã©ï¼‰ */
    .sim-info-panel {
      margin-top:10px;
      background:rgba(255,255,255,0.92);
      border-radius:10px;
      padding:8px 10px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:6px;
      font-size:12px;
      color:#37474f;
    }
    .sim-info-item span.label {
      font-weight:bold;
      color:#0277bd;
    }

    .sim-comment {
      font-size:13px;
      line-height:1.6;
      color:#37474f;
      background:#e1f5fe;
      border-radius:12px;
      padding:10px 12px;
      border-left:4px solid #42a5f5;
      margin-top:8px;
      position:relative;
    }
    .sim-comment strong { color:#0277bd; }
    .sim-comment-toggle {
      display:none;
    }
    @media (max-width:768px) {
      .sim-comment {
        max-height:60px;
        overflow:hidden;
        transition:max-height 0.3s ease;
      }
      .sim-comment.expanded {
        max-height:200px;
      }
      .sim-comment-toggle {
        display:block;
        position:absolute;
        bottom:4px;
        right:8px;
        background:rgba(66,165,245,0.2);
        border:none;
        border-radius:4px;
        padding:2px 6px;
        font-size:10px;
        color:#0277bd;
        cursor:pointer;
      }
    }

    /* â–¼ æ“ä½œUI */
    .sim-control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    .sim-control-label {
      font-size:13px;
      font-weight:bold;
      color:#37474f;
      min-width:120px;
    }
    .slider {
      flex:1;
      -webkit-appearance:none;
      appearance:none;
      height:6px;
      border-radius:999px;
      background:#bbdefb;
      outline:none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      background:#42a5f5;
      box-shadow:0 0 0 4px rgba(66,165,245,0.35);
      cursor:pointer;
    }
    .slider::-moz-range-thumb {
      width:22px;
      height:22px;
      border-radius:50%;
      background:#42a5f5;
      box-shadow:0 0 0 4px rgba(66,165,245,0.35);
      cursor:pointer;
    }
    .value-display {
      font-size:13px;
      font-weight:bold;
      color:#1e3a5f;
      min-width:80px;
      text-align:right;
    }

    .toggle-group {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .toggle-btn {
      padding:8px 14px;
      border-radius:999px;
      border:2px solid #bbdefb;
      background:#e3f2fd;
      font-size:13px;
      cursor:pointer;
      transition:all 0.2s ease;
      min-height:36px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .toggle-btn.selected {
      background:#42a5f5;
      border-color:#1e88e5;
      color:white;
      font-weight:bold;
    }

    /* â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒãƒ« */
    .info-panel {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
    }
    .info-panel h3 {
      color:#1e3a5f;
      margin-bottom:15px;
      font-size:18px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:15px;
    }
    .info-item {
      background:#f5f9ff;
      padding:14px;
      border-radius:10px;
      border-left:4px solid #42a5f5;
      font-size:13px;
      color:#37474f;
      line-height:1.5;
    }
    .info-item h4 {
      color:#1e88e5;
      margin-bottom:6px;
      font-size:14px;
    }

    .start-learning-btn {
      background:linear-gradient(135deg,#42a5f5 0%,#29b6f6 50%,#26c6da 100%);
      color:white;
      border:none;
      padding:16px 30px;
      border-radius:25px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      margin:20px auto 0;
      display:block;
      min-height:52px;
      width:100%;
      max-width:400px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .start-learning-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(66,165,245,0.4);
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      display:none;
    }
    .progress-bar {
      background:#e3f2fd;
      border-radius:10px;
      height:8px;
      margin-bottom:15px;
      overflow:hidden;
    }
    .progress-fill {
      background:linear-gradient(135deg,#42a5f5 0%,#29b6f6 50%,#26c6da 100%);
      height:100%;
      width:0;
      transition:width 0.3s ease;
    }
    .question-text {
      font-size:16px;
      font-weight:bold;
      color:#333;
      margin-bottom:15px;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choice {
      padding:14px 16px;
      background:#f5f9ff;
      border:2px solid #e3f2fd;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:14px;
      min-height:48px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .choice:hover {
      background:#e3f2fd;
      border-color:#42a5f5;
    }
    .choice.selected {
      background:#42a5f5;
      color:white;
      border-color:#1e88e5;
    }
    .choice.correct {
      background:#43a047;
      color:white;
      border-color:#2e7d32;
      animation:correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background:#e53935;
      color:white;
      border-color:#b71c1c;
      animation:wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100% { transform:scale(1); }
      50% { transform:scale(1.05); }
    }
    @keyframes wrongShake {
      0%,100% { transform:translateX(0); }
      25% { transform:translateX(-8px); }
      75% { transform:translateX(8px); }
    }
    .explanation {
      margin-top:15px;
      padding:15px;
      background:#f5f9ff;
      border-radius:10px;
      border-left:4px solid #43a047;
      display:none;
      font-size:13px;
      color:#37474f;
      line-height:1.6;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#2e7d32;
      margin-bottom:6px;
      font-size:14px;
    }
    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:20px;
      gap:12px;
    }
    .nav-btn {
      padding:12px 20px;
      border:none;
      border-radius:25px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#90a4ae;
      color:white;
    }
    .prev-btn:hover:not(:disabled) { background:#78909c; }
    .next-btn {
      background:#42a5f5;
      color:white;
    }
    .next-btn:hover:not(:disabled) { background:#1e88e5; }

    * { touch-action:manipulation; }

    @media (max-width:768px){
      .header { padding:6px 10px; }
      .home-btn { padding:6px 12px; font-size:12px; }
      .lesson-title { font-size:13px; margin:0 6px; }
      .main-container { padding:8px; gap:10px; }
      .sim-header { padding:10px 12px; }
      .sim-header h2 { font-size:16px; margin-bottom:2px; }
      .sim-header p { font-size:12px; }
      .sim-area { padding:8px 10px 12px; }
      .sim-field { min-height:160px; padding:8px; }
      .saturation-label { 
        font-size:10px; 
        left:6px; 
        max-width:120px;
      }
      .sim-info-panel { 
        margin-top:6px; 
        padding:6px 8px; 
        grid-template-columns:repeat(2,1fr); 
        gap:4px; 
        font-size:11px; 
      }
      .sim-comment { 
        margin-top:6px; 
        padding:8px 10px; 
        font-size:12px; 
        line-height:1.5; 
      }
      .sim-control-row { margin-top:6px; gap:6px; }
      .sim-control-label { font-size:12px; min-width:100px; }
      .info-panel { padding:12px; }
      .info-grid { grid-template-columns:1fr; gap:10px; }
      .question-container { padding:12px; }
      .question-text { font-size:14px; }
      .choice { font-size:13px; min-height:48px; }
      .navigation { flex-direction:column; }
      .nav-btn { width:100%; }
    }
    @media (max-width:480px){
      .header { padding:5px 8px; }
      .home-btn { padding:6px 10px; font-size:11px; }
      .lesson-title { font-size:11px; margin:0 4px; }
      .main-container { padding:6px; gap:8px; }
      .sim-header { padding:8px 10px; }
      .sim-header h2 { font-size:14px; }
      .sim-header p { font-size:11px; }
      .sim-area { padding:6px 8px 10px; }
      .sim-field { min-height:140px; padding:6px; }
      .saturation-label { 
        font-size:9px; 
        left:4px; 
        max-width:100px;
      }
      .sim-info-panel { 
        margin-top:4px; 
        padding:5px 6px; 
        grid-template-columns:repeat(2,1fr); 
        gap:3px; 
        font-size:10px; 
      }
      .sim-info-item { line-height:1.3; }
      .sim-comment { 
        margin-top:4px; 
        padding:6px 8px; 
        font-size:11px; 
        line-height:1.4; 
      }
      .sim-control-row { margin-top:4px; gap:4px; }
      .sim-control-label { font-size:11px; min-width:80px; }
      .slider { height:5px; }
      .slider::-webkit-slider-thumb { width:18px; height:18px; }
      .slider::-moz-range-thumb { width:18px; height:18px; }
      .value-display { font-size:11px; }
      .toggle-btn { font-size:11px; padding:6px 10px; }
      .info-panel { padding:10px; }
      .question-container { padding:10px; }
      .choice { padding:10px 12px; font-size:12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - ç©ºæ°—ã®ä¸Šæ˜‡ã¨é›²</div>
    <div style="width:80px;"></div>
  </div>

  <div class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="sim-container">
      <div class="sim-header">
        <h2>ğŸŒ¥ ç©ºæ°—ã®ä¸Šæ˜‡ã¨é›²ã®ç™ºç”Ÿ</h2>
        <p>ç©ºæ°—ã®ã‹ãŸã¾ã‚Šã‚’ä¸Šã«å‹•ã‹ã—ã¦ã€ã©ã®é«˜ã•ã§é›²ãŒã§ãã‚‹ã‹ä½“é¨“ã—ã¦ã¿ã‚ˆã†</p>
      </div>
      <div class="sim-area">
        <div class="sim-field">
          <!-- å±±ã¨åœ°é¢ -->
          <div class="mountain"></div>
          <div class="ground"></div>

          <!-- é£½å’Œãƒ©ã‚¤ãƒ³ï¼ˆé›²ã®ã§ãå§‹ã‚é«˜ã•ã®ç›®å®‰ï¼‰ -->
          <div class="saturation-line" id="saturationLine"></div>
          <div class="saturation-label" id="saturationLabel">ã“ã“ã‚ˆã‚Šä¸Šã§ã€<br>æ°´è’¸æ°—ãŒã‚ãã‚„ã™ã„</div>

          <!-- é›² -->
          <div class="cloud-layer">
            <div class="cloud" id="cloud"></div>
          </div>

          <!-- ç©ºæ°—ã®ã‹ãŸã¾ã‚Š -->
          <div class="air-parcel" id="airParcel">
            <div class="air-parcel-label">ç©ºæ°—ã®ã‹ãŸã¾ã‚Š</div>
            <div class="air-parcel-temp" id="airTempLabel">25â„ƒ</div>
          </div>
        </div>

        <div class="sim-info-panel">
          <div class="sim-info-item">
            <span class="label">åœ°ä¸Šã®æ°—æ¸©ï¼š</span>
            <span id="groundTempInfo">25â„ƒ</span>
          </div>
          <div class="sim-info-item">
            <span class="label">åœ°ä¸Šã®ã—ã¤ã©ï¼š</span>
            <span id="groundHumidityInfo">80%</span>
          </div>
          <div class="sim-info-item">
            <span class="label">é«˜ã•ï¼š</span>
            <span id="heightInfo">0 m</span>
          </div>
          <div class="sim-info-item">
            <span class="label">ç©ºæ°—ã®æ¸©åº¦ï¼š</span>
            <span id="parcelTempInfo">25â„ƒ</span>
          </div>
          <div class="sim-info-item">
            <span class="label">é›²ã®ã§ãã‚„ã™ã•ï¼š</span>
            <span id="cloudChanceInfo">ã¾ã é›²ã¯ã§ããªã„</span>
          </div>
        </div>

        <div class="sim-comment" id="simComment">
          ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§<strong>ç©ºæ°—ã®é«˜ã•</strong>ã‚’å¤‰ãˆã¦ã¿ã‚ˆã†ã€‚<br>
          ç©ºæ°—ã¯<strong>é«˜ã„ã¨ã“ã‚ã¸è¡Œãã»ã©å†·ãˆ</strong>ã¦ã„ãã‚ˆã€‚å†·ãˆã‚‹ã¨ã€ãµãã‚“ã§ã„ã‚‰ã‚Œã‚‹<strong>æ°´è’¸æ°—ã®é‡ãŒã¸ã‚‹</strong>ã®ã§ã€ã‚ã¾ã£ãŸæ°´è’¸æ°—ãŒ<strong>ã¤ã¶</strong>ã«ãªã£ã¦é›²ãŒã§ãã¾ã™ã€‚
          <button class="sim-comment-toggle" id="commentToggle" onclick="toggleComment()">ã‚‚ã£ã¨è¦‹ã‚‹</button>
        </div>

        <!-- æ“ä½œUI -->
        <div class="sim-control-row">
          <div class="sim-control-label">ç©ºæ°—ã®é«˜ã•</div>
          <input type="range" id="heightSlider" class="slider" min="0" max="10" step="1" value="0">
          <div class="value-display" id="heightDisplay">0 m</div>
        </div>

        <div class="sim-control-row">
          <div class="sim-control-label">åœ°ä¸Šã®ã—ã¤ã©</div>
          <input type="range" id="humiditySlider" class="slider" min="0" max="100" step="5" value="0">
          <div class="value-display" id="humidityDisplay">0%</div>
        </div>

        <div class="sim-control-row">
          <div class="sim-control-label">ãƒ¢ãƒ¼ãƒ‰</div>
          <div class="toggle-group">
            <button class="toggle-btn selected" id="modeNormal">ãµã¤ã†ã®æ—¥</button>
            <button class="toggle-btn" id="modeSummer">å¤ã®ã˜ã‚ã˜ã‚ã®æ—¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="info-panel" id="info-panel">
      <h3>â˜ é›²ã¯ã©ã†ã—ã¦ã§ãã‚‹ã®ï¼Ÿ</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>â‘  ç©ºæ°—ã®ä¸­ã«ã¯ç›®ã«è¦‹ãˆãªã„æ°´è’¸æ°—ãŒãµãã¾ã‚Œã¦ã„ã‚‹</h4>
          <p>
            ç©ºæ°—ã®ä¸­ã«ã¯ã€ç›®ã«è¦‹ãˆãªã„ã€Œæ°´è’¸æ°—ã€ãŒãµãã¾ã‚Œã¦ã„ã¾ã™ã€‚ã‚ãŸãŸã‹ã„ç©ºæ°—ã»ã©ã€
            ãŸãã•ã‚“ã®æ°´è’¸æ°—ã‚’ãµãã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’<strong>ã—ã¤ã©</strong>ã§è¡¨ã—ã¾ã™ã€‚
          </p>
        </div>
        <div class="info-item">
          <h4>â‘¡ ä¸Šã«è¡Œãã»ã©ç©ºæ°—ã¯å†·ãˆã‚‹</h4>
          <p>
            ç©ºæ°—ã®ã‹ãŸã¾ã‚ŠãŒ<strong>ä¸Šã®ã»ã†ã¸ã†ã‹ã¶</strong>ã¨ã€ã¾ã‚ã‚Šã®ç©ºæ°—ã‚ˆã‚Šã‚‚åºƒãŒã£ã¦<strong>å†·ã‚„ã•ã‚Œ</strong>ã¾ã™ã€‚
            é«˜ã•ãŒ100mé«˜ããªã‚‹ã”ã¨ã«ã€æ°—æ¸©ã¯å°‘ã—ãšã¤ä¸‹ãŒã£ã¦ã„ãã¾ã™ã€‚
          </p>
        </div>
        <div class="info-item">
          <h4>â‘¢ ã²ãˆãŸç©ºæ°—ã§ã¯æ°´è’¸æ°—ãŒã‚ã¾ã‚‹</h4>
          <p>
            ç©ºæ°—ãŒå†·ãˆã‚‹ã¨ã€ãã®ç©ºæ°—ãŒ<strong>ãµãã‚“ã§ã„ã‚‰ã‚Œã‚‹æ°´è’¸æ°—ã®é‡</strong>ãŒã¸ã‚Šã¾ã™ã€‚
            ã™ã‚‹ã¨ã€å…¥ã‚Šãã‚‰ãªããªã£ãŸæ°´è’¸æ°—ãŒ<strong>å°ã•ãªæ°´ã®ã¤ã¶</strong>ã‚„<strong>ã“ãŠã‚Šã®ã¤ã¶</strong>ã«ãªã£ã¦ã‚ã‚‰ã‚ã‚Œã¦ãã¾ã™ã€‚
            ãã‚ŒãŒãŸãã•ã‚“ã‚ã¤ã¾ã‚‹ã¨<strong>é›²</strong>ã«ãªã‚Šã¾ã™ã€‚
          </p>
        </div>
      </div>
      <button class="start-learning-btn" onclick="startLearning()">å•é¡Œã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹</button>
    </div>

    <!-- â–¼ å•é¡Œã‚¨ãƒªã‚¢ -->
    <div class="question-container" id="question-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="explanation" id="explanation"></div>
      <div class="navigation">
        <button class="nav-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>å‰ã®å•é¡Œ</button>
        <button class="nav-btn next-btn" id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    ================================= */
    const heightSlider = document.getElementById('heightSlider');
    const humiditySlider = document.getElementById('humiditySlider');
    const heightDisplay = document.getElementById('heightDisplay');
    const humidityDisplay = document.getElementById('humidityDisplay');

    const modeNormalBtn = document.getElementById('modeNormal');
    const modeSummerBtn = document.getElementById('modeSummer');

    const airParcelEl = document.getElementById('airParcel');
    const airTempLabelEl = document.getElementById('airTempLabel');
    const cloudEl = document.getElementById('cloud');

    const saturationLineEl = document.getElementById('saturationLine');
    const saturationLabelEl = document.getElementById('saturationLabel');

    const groundTempInfoEl = document.getElementById('groundTempInfo');
    const groundHumidityInfoEl = document.getElementById('groundHumidityInfo');
    const heightInfoEl = document.getElementById('heightInfo');
    const parcelTempInfoEl = document.getElementById('parcelTempInfo');
    const cloudChanceInfoEl = document.getElementById('cloudChanceInfo');
    const simCommentEl = document.getElementById('simComment');

    let mode = 'normal'; // 'normal' or 'summer'
    let groundTemp = 25; // â„ƒ
    let lapseRate = 0.6; // â„ƒ / 100m ï¼ˆç°¡ç•¥ãƒ¢ãƒ‡ãƒ«ï¼‰
    let previousCloudState = 'none'; // å‰å›ã®é›²ã®çŠ¶æ…‹ã‚’ä¿å­˜

    function updateMode() {
      if (mode === 'normal') {
        groundTemp = 25;
        groundTempInfoEl.textContent = groundTemp + 'â„ƒ';
        simCommentEl.innerHTML =
          'ãµã¤ã†ã®æ—¥ã®ç©ºæ°—ã®ã‚ˆã†ã™ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚<strong>ç©ºæ°—ã®é«˜ã•</strong>ã¨<strong>åœ°ä¸Šã®ã—ã¤ã©</strong>ã‚’å¤‰ãˆã¦ã€ã©ã‚“ãªã¨ãã«é›²ãŒã§ãã‚‹ã‹ãŸã‚ã—ã¦ã¿ã‚ˆã†ã€‚';
      } else {
        groundTemp = 30;
        groundTempInfoEl.textContent = groundTemp + 'â„ƒ';
        simCommentEl.innerHTML =
          'å¤ã®ã˜ã‚ã˜ã‚ã—ãŸæ—¥ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚åœ°ä¸Šã®ç©ºæ°—ãŒ<strong>ã‚ãŸãŸã‹ãã¦ã€ã—ã¤ã©ã‚‚é«˜ã„</strong>ã¨ã€å°‘ã—é«˜ã„ã¨ã“ã‚ã§ã‚‚<strong>ãŸãã•ã‚“é›²ãŒã§ãã‚„ã™ã</strong>ãªã‚Šã¾ã™ã€‚';
      }
      updateSimulation();
    }

    function calcParcelTemp(height) {
      // height: 0ã€œ10 (0ã€œ1000mã«è¦‹ç«‹ã¦)
      const hMeters = height * 100; // 1ã‚¹ãƒ†ãƒƒãƒ—=100m
      const temp = groundTemp - lapseRate * (hMeters / 100);
      return Math.round(temp * 10) / 10;
    }

    function calcCloudAmount(height, groundHumidity) {
      // ã‚ã¡ã‚ƒãã¡ã‚ƒç°¡ç•¥åŒ–ã—ãŸãƒ¢ãƒ‡ãƒ«
      // åœ°ä¸Šã®ã—ã¤ã©ã¨ä¸Šç©ºã§ã®å†·ãˆå…·åˆã‹ã‚‰ã€ã€Œã‚ã¾ã£ãŸã€æ°´è’¸æ°—ã®ã‚¤ãƒ¡ãƒ¼ã‚¸å€¤ã‚’è¿”ã™
      const parcelTemp = calcParcelTemp(height);
      const saturationAtGround = 100; // åœ°ä¸Šã®é£½å’Œæ°´è’¸æ°—é‡ã‚’100ã¨ã—ãŸã¨ãã®ç›¸å¯¾
      // æ¸©åº¦ãŒ10â„ƒä¸‹ãŒã‚‹ã¨ã€ãµãã‚ã‚‹æ°´è’¸æ°—é‡ãŒã–ã£ãã‚Š30ã€œ40ï¼…æ¸›ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
      const tempDrop = groundTemp - parcelTemp;
      const saturationAtHeight = saturationAtGround * (1 - 0.035 * (tempDrop)); // ã‹ãªã‚Šã–ã£ãã‚Š

      // å®Ÿéš›ã«ãµãã‚“ã§ã„ã‚‹æ°´è’¸æ°—é‡ï¼ˆçµ¶å¯¾é‡ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
      const actualVapor = saturationAtGround * (groundHumidity / 100);

      const surplus = actualVapor - saturationAtHeight;
      return surplus; // surplus > 0 ã§é›²ãŒã§ãã‚„ã™ã„
    }

    function updateCloudVisual(height, groundHumidity) {
      const surplus = calcCloudAmount(height, groundHumidity);
      let state = 'none';

      if (surplus <= 0) {
        state = 'none';
        cloudChanceInfoEl.textContent = 'ã¾ã é›²ã¯ã§ããªã„';
      } else if (surplus > 0 && surplus < 20) {
        state = 'thin';
        cloudChanceInfoEl.textContent = 'ã†ã™ã„é›²ãŒã§ãã¯ã˜ã‚ã¦ã„ã‚‹';
      } else if (surplus >= 20 && surplus < 40) {
        state = 'medium';
        cloudChanceInfoEl.textContent = 'ã¯ã£ãã‚Šã—ãŸé›²ãŒã§ãã¦ã„ã‚‹';
      } else {
        state = 'thick';
        cloudChanceInfoEl.textContent = 'ã¨ã¦ã‚‚åšã„é›²ãŒç™ºé”ã—ã¦ã„ã‚‹';
      }

      // é›²ãŒã§ããŸã¨ãã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆnoneã‹ã‚‰thinä»¥ä¸Šã«å¤‰åŒ–ã—ãŸã¨ãï¼‰
      if (previousCloudState === 'none' && state !== 'none') {
        triggerCloudFormationEffect();
      }

      cloudEl.classList.remove('visible','medium','thick');
      if (state === 'thin') {
        cloudEl.classList.add('visible');
      } else if (state === 'medium') {
        cloudEl.classList.add('visible','medium');
      } else if (state === 'thick') {
        cloudEl.classList.add('visible','thick');
      }

      previousCloudState = state;
    }

    // é›²ãŒã§ããŸã¨ãã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨SE
    function triggerCloudFormationEffect() {
      // è¦–è¦šã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      createParticleEffect();
      
      // éŸ³å£°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      playCloudFormationSound();
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function createParticleEffect() {
      const simField = document.querySelector('.sim-field');
      const airParcel = document.getElementById('airParcel');
      const rect = airParcel.getBoundingClientRect();
      const fieldRect = simField.getBoundingClientRect();
      
      const centerX = rect.left - fieldRect.left + rect.width / 2;
      const centerY = rect.top - fieldRect.top + rect.height / 2;

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’ç”Ÿæˆ
      for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'cloud-particle';
        
        const angle = (Math.PI * 2 * i) / 15;
        const distance = 30 + Math.random() * 40;
        const duration = 800 + Math.random() * 400;
        const endX = Math.cos(angle) * distance;
        const endY = Math.sin(angle) * distance;
        
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        
        simField.appendChild(particle);
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const startTime = Date.now();
        const animate = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          
          particle.style.transform = `translate(${endX * easeOut}px, ${endY * easeOut}px) scale(${1 - progress})`;
          particle.style.opacity = 1 - progress;
          
          if (progress < 1) {
            requestAnimationFrame(animate);
          } else {
            particle.remove();
          }
        };
        requestAnimationFrame(animate);
      }

      // é›²ã®å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      cloudEl.style.animation = 'cloudGlow 0.6s ease-out';
      setTimeout(() => {
        cloudEl.style.animation = '';
      }, 600);
    }

    // éŸ³å£°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆWeb Audio APIã§ç”Ÿæˆï¼‰
    function playCloudFormationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // æŸ”ã‚‰ã‹ã„éŸ³è‰²
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.3);
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.05);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        // éŸ³å£°ãŒå†ç”Ÿã§ããªã„å ´åˆã¯ç„¡è¦–
        console.log('Audio not available');
      }
    }

    function updateParcelPosition(height) {
      // sim-field å†…ã®é«˜ã•ã‚’ 0ã€œ1 ã§
      const minY = 65;  // åœ°é¢ã¡ã‚‡ã„ä¸Š
      const maxY = 40;  // ä¸Šå´
      const ratio = height / 10; // 0ã€œ1
      const y = minY - (minY - maxY) * ratio;
      airParcelEl.style.transform = `translate(-50%, ${y}%)`;
    }

    function updateSaturationLine(groundHumidity) {
      // é£½å’Œãƒ©ã‚¤ãƒ³ã£ã½ã„é«˜ã•ã‚’ã€åœ°ä¸Šã—ã¤ã©ã‹ã‚‰ã–ã£ãã‚Šæ±ºã‚ã‚‹
      // ã—ã¤ã©ãŒé«˜ã„ã»ã©ã€ä½ã„ã¨ã“ã‚ã§é›²ãŒã§ãã‚„ã™ã„
      const base = 55; // %
      const diff = groundHumidity - base; // é«˜ã„ã»ã©æ—©ãé£½å’Œ
      let lineHeightRatio = 0.5; // 0ã€œ1ã§ä¸Šã‹ã‚‰ã®ä½ç½®ï¼ˆã ã„ãŸã„ä¸­é–“ï¼‰

      if (diff >= 20) {
        lineHeightRatio = 0.35;
      } else if (diff >= 10) {
        lineHeightRatio = 0.4;
      } else if (diff >= 0) {
        lineHeightRatio = 0.45;
      } else {
        lineHeightRatio = 0.55;
      }

      // sim-field å†…ã®çµ¶å¯¾ä½ç½®
      const topPercent = 25 + (lineHeightRatio * 40); // å°‘ã—ä¸‹å¯„ã‚Šã«
      saturationLineEl.style.top = topPercent + '%';
      saturationLabelEl.style.top = (topPercent - 10) + '%';
    }

    function updateSimulation() {
      const height = parseInt(heightSlider.value, 10);      // 0ã€œ10
      const groundHumidity = parseInt(humiditySlider.value, 10); // 0ã€œ100

      // é«˜ã•è¡¨ç¤º
      const heightMeters = height * 100;
      heightDisplay.textContent = heightMeters + ' m';
      heightInfoEl.textContent = heightMeters + ' m';

      // ã—ã¤ã©è¡¨ç¤º
      humidityDisplay.textContent = groundHumidity + '%';
      groundHumidityInfoEl.textContent = groundHumidity + '%';

      // ç©ºæ°—ã®æ¸©åº¦
      const temp = calcParcelTemp(height);
      airTempLabelEl.textContent = temp + 'â„ƒ';
      parcelTempInfoEl.textContent = temp + 'â„ƒ';

      // ç©ºæ°—ã®è¦‹ãŸç›®ï¼ˆå†·ãˆã‚‹ã¨å°‘ã—é’ã£ã½ãï¼‰
      const coolness = Math.min(1, Math.max(0, (groundTemp - temp) / 10));
      const blueAmount = 220 + Math.round(20 * coolness);
      airParcelEl.style.background =
        `radial-gradient(circle at 30% 20%, #ffffff 0%, rgb(205,225,${blueAmount}) 45%, rgb(180,200,${blueAmount}) 100%)`;

      // ä½ç½®ãƒ»é›²ãƒ»é£½å’Œãƒ©ã‚¤ãƒ³æ›´æ–°
      updateParcelPosition(height);
      updateCloudVisual(height, groundHumidity);
      updateSaturationLine(groundHumidity);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    heightSlider.addEventListener('input', updateSimulation);
    humiditySlider.addEventListener('input', updateSimulation);

    modeNormalBtn.addEventListener('click', () => {
      mode = 'normal';
      modeNormalBtn.classList.add('selected');
      modeSummerBtn.classList.remove('selected');
      updateMode();
    });
    modeSummerBtn.addEventListener('click', () => {
      mode = 'summer';
      modeSummerBtn.classList.add('selected');
      modeNormalBtn.classList.remove('selected');
      // å¤ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã—ã¤ã©ã‚‚å°‘ã—é«˜ã‚ã‚¹ã‚¿ãƒ¼ãƒˆã«
      humiditySlider.value = 100;
      updateMode();
    });

    // åˆæœŸåŒ–ï¼ˆãµã¤ã†ã®æ—¥ãƒ¢ãƒ¼ãƒ‰ã§æ¹¿åº¦0%ï¼‰
    humiditySlider.value = 0;
    updateMode();

    // èª¬æ˜æ–‡ã®æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
    function toggleComment() {
      const commentEl = document.getElementById('simComment');
      const toggleBtn = document.getElementById('commentToggle');
      if (commentEl && toggleBtn) {
        commentEl.classList.toggle('expanded');
        if (commentEl.classList.contains('expanded')) {
          toggleBtn.textContent = 'é–‰ã˜ã‚‹';
        } else {
          toggleBtn.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
        }
      }
    }
    window.toggleComment = toggleComment;

    /* ================================
       â–¼ å•é¡Œãƒ‡ãƒ¼ã‚¿
    ================================= */
    const lessonData = {
      id: 'sci.weather.cloud_from_rising_air_sim',
      questions: [
        {
          id: 1,
          question: "ç©ºæ°—ã®ã‹ãŸã¾ã‚ŠãŒé«˜ã„ã¨ã“ã‚ã¸ä¸ŠãŒã‚‹ã¨ã€ã©ã®ã‚ˆã†ãªå¤‰åŒ–ãŒãŠã“ã‚Šã¾ã™ã‹ï¼Ÿ",
          choices: [
            "æ°—æ¸©ãŒä¸ŠãŒã‚Šã€ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ãŒãµãˆã‚‹",
            "æ°—æ¸©ãŒä¸‹ãŒã‚Šã€ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ãŒã¸ã‚‹",
            "æ°—æ¸©ãŒä¸‹ãŒã‚Šã€ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ãŒãµãˆã‚‹",
            "æ°—æ¸©ãŒä¸ŠãŒã‚Šã€ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ãŒã¸ã‚‹"
          ],
          correct: 1,
          explanation: "ç©ºæ°—ã®ã‹ãŸã¾ã‚ŠãŒé«˜ã„ã¨ã“ã‚ã¸è¡Œãã¨ã€ã¾ã‚ã‚Šã‚ˆã‚ŠåºƒãŒã£ã¦<strong>å†·ãˆã¾ã™</strong>ã€‚å†·ãˆãŸç©ºæ°—ã¯ã€ã‚ãŸãŸã‹ã„ã¨ãã»ã©ãŸãã•ã‚“ã®æ°´è’¸æ°—ã‚’ãµãã‚€ã“ã¨ãŒã§ããªã„ã®ã§ã€ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ã¯<strong>ã¸ã‚Šã¾ã™</strong>ã€‚"
        },
        {
          id: 2,
          question: "ç©ºæ°—ãŒå†·ãˆã¦ã€ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ã‚ˆã‚Šã‚‚å®Ÿéš›ã®æ°´è’¸æ°—ã®é‡ãŒå¤šããªã‚‹ã¨ã€ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ",
          choices: [
            "æ°´è’¸æ°—ãŒè¦‹ãˆãªããªã‚Šã€ç©ºã¯ã‹ã‚‰ã£ã¨æ™´ã‚Œã‚‹",
            "æ°´è’¸æ°—ãŒç©ºæ°—ã‹ã‚‰å‡ºã¦ã€å°ã•ãªæ°´ã‚„ã“ãŠã‚Šã®ã¤ã¶ã«ãªã‚Šé›²ãŒã§ãã‚‹",
            "ç©ºæ°—ä¸­ã®æ°´è’¸æ°—ãŒã™ã¹ã¦åœ°é¢ã«ã—ã¿ã“ã‚€",
            "æ°´è’¸æ°—ãŒé‡ããªã£ã¦ä¸‹ã¸è½ã¡ã€é›²ã¯ã§ããªã„"
          ],
          correct: 1,
          explanation: "å†·ãˆãŸç©ºæ°—ã¯ãµãã‚ã‚‹æ°´è’¸æ°—ã®é‡ãŒã¸ã‚‹ãŸã‚ã€å…¥ã‚Šãã‚‰ãªããªã£ãŸã¶ã‚“ã®æ°´è’¸æ°—ãŒç©ºæ°—ã‹ã‚‰å‡ºã¦<strong>å°ã•ãªæ°´ã®ã¤ã¶ã‚„ã“ãŠã‚Šã®ã¤ã¶</strong>ã«ãªã‚Šã¾ã™ã€‚ã“ã‚ŒãŒãŸãã•ã‚“é›†ã¾ã£ãŸã‚‚ã®ãŒ<strong>é›²</strong>ã§ã™ã€‚"
        },
        {
          id: 3,
          question: "åœ°ä¸Šã®ã—ã¤ã©ãŒé«˜ã„ã»ã©ã€ã©ã®ã‚ˆã†ãªã¨ãã«é›²ãŒã§ãã‚„ã™ããªã‚Šã¾ã™ã‹ï¼Ÿ",
          choices: [
            "ç©ºæ°—ã‚’ã‚ã¾ã‚Šä¸Šã’ãªãã¦ã‚‚ã€ä½ã„é«˜ã•ã‹ã‚‰é›²ãŒã§ãã‚„ã™ããªã‚‹",
            "ã¨ã¦ã‚‚é«˜ã„ã¨ã“ã‚ã¾ã§ä¸Šã’ãªã„ã¨ã€é›²ãŒã§ããªããªã‚‹",
            "ã—ã¤ã©ãŒé«˜ã„ã»ã©ã€é›²ãŒã§ãã«ãããªã‚‹",
            "ã—ã¤ã©ã¯é›²ã®ã§ãã‚„ã™ã•ã«é–¢ä¿‚ã—ãªã„"
          ],
          correct: 0,
          explanation: "åœ°ä¸Šã®ã—ã¤ã©ãŒé«˜ã„ã¨ã„ã†ã“ã¨ã¯ã€ã‚‚ã¨ã‚‚ã¨<strong>ãŸãã•ã‚“ã®æ°´è’¸æ°—</strong>ãŒãµãã¾ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãã®ç©ºæ°—ãŒå°‘ã—å†·ãˆãŸã ã‘ã§ã‚‚ã€ãµãã¿ãã‚Œãªããªã£ãŸæ°´è’¸æ°—ãŒã‚ã‚‰ã‚ã‚Œã¦ã€<strong>ä½ã„é«˜ã•ã‹ã‚‰é›²ãŒã§ãã‚„ã™ã</strong>ãªã‚Šã¾ã™ã€‚"
        }
      ]
    };

    /* ================================
       â–¼ å•é¡Œè¡¨ç¤ºãƒ»æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯
    ================================= */
    let currentQuestion = 0;
    let score = 0;
    let questionStartTime = Date.now();

    function generateShuffledIndices(length) {
      const idx = Array.from({ length }, (_, i) => i);
      for (let i = idx.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
      return idx;
    }

    function showQuestion(index) {
      const q = lessonData.questions[index];
      questionStartTime = Date.now();

      const expEl = document.getElementById('explanation');
      expEl.classList.remove('show');
      expEl.innerHTML = '';

      document.getElementById('question-text').textContent = q.question;
      const choicesContainer = document.getElementById('choices');
      choicesContainer.innerHTML = '';

      const order = generateShuffledIndices(q.choices.length);
      order.forEach(originalIndex => {
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = q.choices[originalIndex];
        div.dataset.originalIndex = String(originalIndex);
        div.onclick = () => selectAnswer(originalIndex);
        choicesContainer.appendChild(div);
      });

      const progress = ((index + 1) / lessonData.questions.length) * 100;
      document.getElementById('progress-fill').style.width = progress + '%';

      document.getElementById('prev-btn').disabled = index === 0;
      const nextBtn = document.getElementById('next-btn');
      if (index === lessonData.questions.length - 1) {
        nextBtn.textContent = 'å­¦ç¿’å®Œäº†';
      } else {
        nextBtn.textContent = 'æ¬¡ã®å•é¡Œ';
      }
    }

    function selectAnswer(choiceIndex) {
      const q = lessonData.questions[currentQuestion];
      const choices = document.querySelectorAll('.choice');
      const timeSpent = Date.now() - questionStartTime;

      choices.forEach(c => { c.style.pointerEvents = 'none'; });

      choices.forEach(c => {
        c.classList.remove('selected','correct','incorrect');
        const originalIndex = parseInt(c.dataset.originalIndex || "-1", 10);
        if (originalIndex === choiceIndex) {
          c.classList.add('selected');
        }
      });

      setTimeout(() => {
        const isCorrect = choiceIndex === q.correct;
        choices.forEach(c => {
          const originalIndex = parseInt(c.dataset.originalIndex || "-1", 10);
          if (originalIndex === q.correct) {
            c.classList.add('correct');
          } else if (originalIndex === choiceIndex && !isCorrect) {
            c.classList.add('incorrect');
          }
        });

        const expEl = document.getElementById('explanation');
        expEl.innerHTML = '<h4>è§£èª¬</h4><p>' + q.explanation + '</p>';
        expEl.classList.add('show');

        if (isCorrect) score++;

        // å¿…è¦ãªã‚‰ã“ã“ã§ parent.postMessage ãªã©é€£æºã‚‚å¯èƒ½
        console.log('Q', q.id, 'answer', choiceIndex, 'correct?', isCorrect, 'time(ms)', timeSpent);
      }, 400);
    }

    function previousQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion(currentQuestion);
      }
    }

    function nextQuestion() {
      if (currentQuestion === lessonData.questions.length - 1) {
        // å®Œäº†å‡¦ç†ï¼ˆç°¡æ˜“ï¼‰
        alert('ãŠã¤ã‹ã‚Œã•ã¾ï¼ ' + lessonData.questions.length + 'å•ä¸­ ' + score + 'å•æ­£è§£ã§ã—ãŸã€‚');
        // å¿…è¦ãªã‚‰ã“ã“ã§å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ªãƒ•ãƒ¬ãƒ¼ãƒ ã¸é€ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
        return;
      }
      currentQuestion++;
      showQuestion(currentQuestion);
    }

    function startLearning() {
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('question-container').style.display = 'block';
      if (lessonData.questions.length > 0) {
        showQuestion(0);
      }
    }

    function goHome() {
      // åŸ‹ã‚è¾¼ã¿ç’°å¢ƒãªã‚‰ postMessage ã§æˆ»ã‚‹æŒ‡ç¤ºãªã©ã«å¤‰æ›´å¯èƒ½
      window.location.href = '/';
    }
  </script>
</body>
</html>
