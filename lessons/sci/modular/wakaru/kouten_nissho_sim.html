<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - åœ°çƒã®å…¬è»¢ã¨æ—¥ç…§æ™‚é–“</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: linear-gradient(135deg, #c9ffbf 0%, #ffafbd 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .home-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .home-btn:hover { background:#ff5252; transform: translateY(-1px); }
    .home-btn:active { transform: scale(0.98); }
    .lesson-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      margin: 0 10px;
    }
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .sim-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
    }
    .sim-header {
      background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
      color: white;
      padding: 15px;
      text-align: center;
    }
    .sim-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }
    .sim-header p {
      font-size: 14px;
      opacity: 0.9;
    }
    .sim-area {
      padding: 12px 12px 16px;
      background: #e0f7fa;
    }
    .sim-control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .sim-control-label {
      font-size: 13px;
      font-weight: bold;
      color: #004d40;
    }
    .year-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 999px;
      background: #b2ebf2;
      outline: none;
    }
    .year-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #0288d1;
      box-shadow: 0 0 0 4px rgba(2,136,209,0.3);
      cursor: pointer;
    }
    .year-slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #0288d1;
      box-shadow: 0 0 0 4px rgba(2,136,209,0.3);
      cursor: pointer;
    }
    .season-display {
      font-size: 13px;
      font-weight: bold;
      color: #01579b;
      min-width: 110px;
      text-align: right;
    }

    /* â–¼ å…¬è»¢ï¼‹æ—¥ç…§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    .sim-field {
      position: relative;
      margin-top: 6px;
      background: radial-gradient(circle at 50% 0%, #fffde7 0%, #e3f2fd 40%, #b3e5fc 100%);
      border-radius: 12px;
      padding: 12px;
      overflow: hidden;
      height: 230px;
      perspective: 500px;
      perspective-origin: center center;
    }
    .season-label {
      position: absolute;
      font-size: 16px;
      font-weight: bold;
      color: rgba(0,0,0,0.6);
      z-index: 1;
      pointer-events: none;
      text-shadow: 0 0 4px rgba(255,255,255,0.8);
    }
    .season-label.spring {
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #4caf50;
    }
    .season-label.summer {
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      color: #ff9800;
    }
    .season-label.autumn {
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #ff5722;
    }
    .season-label.winter {
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      color: #2196f3;
    }
    .sun {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle at 30% 30%, #fffde7 0%, #ffeb3b 40%, #ffca28 70%);
      box-shadow: 0 0 25px rgba(255,235,59,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #f57f17;
      z-index: 2;
    }
    .orbit {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 80%;
      height: 70%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.8);
    }
    .earth {
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #29b6f6;
      border: 2px solid #01579b;
      z-index: 3;
      overflow: visible;
    }
    .earth-day {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
    }
    .earth-night {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
    }
    .japan-marker {
      position: absolute;
      width: 5px;
      height: 5px;
      background: #ff5722;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 
        0 0 6px rgba(255,87,34,1),
        inset 0 0 3px rgba(255,255,255,0.5);
      z-index: 5;
      pointer-events: none;
    }
    .japan-label {
      position: absolute;
      font-size: 9px;
      color: #ff5722;
      font-weight: bold;
      white-space: nowrap;
      text-shadow: 
        0 0 4px white, 
        0 0 4px white,
        0 1px 2px rgba(0,0,0,0.3);
      z-index: 5;
      pointer-events: none;
    }
    .earth-axis {
      position: absolute;
      width: 2px;
      height: 50px;
      background: rgba(255,255,255,0.9);
      transform-origin: center center;
      z-index: 2;
    }
    .earth-label {
      position: absolute;
      font-size: 11px;
      color: #004d40;
      font-weight: bold;
      transform: translate(-50%, -120%);
      white-space: nowrap;
    }

    /* â–¼ æ—¥ç…§ãƒãƒ¼ */
    .daylength-panel {
      margin-top: 10px;
      background: rgba(255,255,255,0.8);
      border-radius: 10px;
      padding: 8px 10px;
    }
    .daylength-title {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 4px;
      color: #004d40;
    }
    .daylength-bar {
      position: relative;
      height: 16px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      margin-bottom: 4px;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .day-part {
      background: linear-gradient(90deg, #fff59d, #ffe082);
      height: 100%;
    }
    .night-part {
      background: linear-gradient(90deg, #283593, #1a237e);
      height: 100%;
    }
    .daylength-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #333;
    }
    .sim-comment {
      font-size: 13px;
      line-height: 1.6;
      color: #004d40;
      background: #e0f2f1;
      border-radius: 12px;
      padding: 10px 12px;
      border-left: 4px solid #00897b;
      margin-top: 8px;
    }
    .sim-comment strong {
      color: #00695c;
    }

    /* â–¼ infoãƒ‘ãƒãƒ« */
    .info-panel {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 20px;
      margin-bottom: 15px;
    }
    .info-panel h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .info-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #66bb6a;
    }
    .info-item h4 {
      color: #43a047;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .info-item p {
      color: #555;
      font-size: 13px;
      line-height: 1.4;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 20px;
      margin-bottom: 15px;
    }
    .question-text {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .choice {
      padding: 14px 16px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      min-height: 48px;
      display: flex;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .choice:hover {
      background: #e9ecef;
      border-color: #66bb6a;
    }
    .choice.selected {
      background: #66bb6a;
      color: white;
      border-color: #66bb6a;
    }
    .choice.correct {
      background: #28a745;
      color: white;
      border-color: #28a745;
      animation: correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
      animation: wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    .explanation {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #28a745;
      display: none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color: #28a745;
      margin-bottom: 10px;
    }
    .explanation p {
      color: #666;
      line-height: 1.5;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }
    .nav-btn {
      padding: 14px 24px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 48px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .prev-btn {
      background: #6c757d;
      color: white;
    }
    .prev-btn:hover:not(:disabled) { background:#5a6268; }
    .next-btn {
      background: #66bb6a;
      color: white;
    }
    .next-btn:hover:not(:disabled) { background:#43a047; }

    .start-learning-btn {
      background: linear-gradient(135deg, #66bb6a 0%, #26a69a 100%);
      color: white;
      border: none;
      padding: 16px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 20px auto;
      display: block;
      min-height: 52px;
      width: 100%;
      max-width: 400px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .start-learning-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102,187,106,0.35);
    }
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      height: 8px;
      margin: 15px 0;
      overflow: hidden;
    }
    .progress-fill {
      background: linear-gradient(135deg, #66bb6a 0%, #26a69a 100%);
      height: 100%;
      transition: width 0.3s ease;
    }

    * { touch-action: manipulation; }
    .choice, .nav-btn, .home-btn, .start-learning-btn {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    @media (max-width: 768px) {
      body { overflow-x: hidden; }
      .header { padding:8px 12px; }
      .home-btn { padding:10px 16px; font-size:13px; }
      .lesson-title { font-size:14px; margin:0 8px; text-align:center; }
      .header > div:last-child { width:80px; }
      .main-container { padding:10px; }
      .info-grid { grid-template-columns:1fr; gap:12px; }
      .info-panel { padding:16px; }
      .info-item { padding:12px; }
      .info-item h4 { font-size:13px; }
      .info-item p { font-size:12px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { height:240px; }
      .question-container { padding:16px; }
      .question-text { font-size:15px; margin-bottom:12px; }
      .choice { padding:14px 16px; font-size:14px; min-height:52px; }
      .navigation { flex-direction:column; gap:12px; margin-top:16px; }
      .nav-btn { width:100%; padding:14px 20px; font-size:15px; }
      .start-learning-btn { padding:16px 24px; font-size:15px; max-width:100%; }
      .explanation { padding:12px; font-size:13px; margin-top:12px; }
      .progress-bar { margin:12px 0; }
    }
    @media (max-width: 480px) {
      .header { padding:6px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:12px; margin:0 6px; }
      .header > div:last-child { width:70px; }
      .main-container { padding:8px; }
      .question-container { padding:12px; }
      .question-text { font-size:14px; }
      .choice { padding:12px 14px; font-size:13px; min-height:48px; }
      .info-panel { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - åœ°çƒã®å…¬è»¢ã¨æ—¥ç…§æ™‚é–“</div>
    <div style="width: 80px;"></div>
  </div>

  <div class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="sim-container">
      <div class="sim-header">
        <h2>ğŸŒ åœ°çƒã®å…¬è»¢ã¨æ˜¼ã®é•·ã•</h2>
        <p>1å¹´ã®ä¸­ã§ã€å¤ªé™½ã®å½“ãŸã‚Šæ–¹ã¨æ˜¼ã®é•·ã•ãŒã©ã†å¤‰ã‚ã‚‹ã‹ä½“é¨“ã—ã‚ˆã†</p>
      </div>
      <div class="sim-area">
        <div class="sim-control-row">
          <div class="sim-control-label">1å¹´ã®ä¸­ã®ä½ç½®ï¼ˆ0ã€œ360Â°ï¼‰</div>
          <input type="range" id="yearSlider" class="year-slider" min="0" max="360" step="5" value="0">
          <div class="season-display" id="seasonDisplay">æ˜¥åˆ†ã”ã‚</div>
        </div>

        <div class="sim-field" id="orbitField">
          <div class="season-label spring">æ˜¥</div>
          <div class="season-label summer">å¤</div>
          <div class="season-label autumn">ç§‹</div>
          <div class="season-label winter">å†¬</div>
          <div class="sun">â˜€</div>
          <div class="orbit"></div>
          <div class="earth" id="earth">
            <div class="earth-day" id="earthDay"></div>
            <div class="earth-night" id="earthNight"></div>
            <div class="japan-marker" id="japanMarker"></div>
            <div class="japan-label" id="japanLabel">æ—¥æœ¬</div>
            <div class="earth-axis" id="earthAxis"></div>
          </div>
        </div>

        <div class="daylength-panel">
          <div class="daylength-title">æ—¥æœ¬ï¼ˆä¸­ç·¯åº¦ï¼‰ã®ãŠã‚ˆãã®æ˜¼ã¨å¤œã®é•·ã•</div>
          <div class="daylength-bar">
            <div class="day-part" id="dayPart" style="width: 50%;"></div>
            <div class="night-part" id="nightPart" style="width: 50%;"></div>
          </div>
          <div class="daylength-labels">
            <div id="dayInfo">æ˜¼ï¼šç´„12æ™‚é–“</div>
            <div id="nightInfo">å¤œï¼šç´„12æ™‚é–“</div>
          </div>
        </div>

        <div class="sim-comment" id="simComment">
          ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ã¦ã€<strong>æ˜¥åˆ†ãƒ»å¤è‡³ãƒ»ç§‹åˆ†ãƒ»å†¬è‡³</strong>ã®ã¨ãã®åœ°çƒã®ä½ç½®ã¨ã€<strong>æ˜¼ã®é•·ã•</strong>ãŒã©ã†å¤‰ã‚ã‚‹ã‹è¦‹ã¦ã¿ã‚ˆã†ã€‚<br>
          å¤ªé™½ã®å…‰ãŒå½“ãŸã£ã¦ã„ã‚‹<strong>æ˜ã‚‹ã„éƒ¨åˆ†</strong>ãŒæ˜¼ã€<strong>æš—ã„éƒ¨åˆ†</strong>ãŒå¤œã§ã™ã€‚<br>
          æ—¥æœ¬ï¼ˆèµ¤ã„ãƒãƒ¼ã‚«ãƒ¼ï¼‰ã§ã¯ã€å¤è‡³ã”ã‚ã«æ˜¼ãŒã„ã¡ã°ã‚“<strong>é•·ã</strong>ã€å†¬è‡³ã”ã‚ã«æ˜¼ãŒã„ã¡ã°ã‚“<strong>çŸ­ã</strong>ãªã‚Šã¾ã™ã€‚
        </div>
      </div>
    </div>

    <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="info-panel" id="info-panel">
      <h3>ğŸ“Š åœ°çƒã®å…¬è»¢ã¨å­£ç¯€ãƒ»æ˜¼ã®é•·ã•</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>åœ°çƒã®å…¬è»¢</h4>
          <p>åœ°çƒã¯å¤ªé™½ã®ã¾ã‚ã‚Šã‚’<strong>1å¹´ã‹ã‘ã¦1å‘¨</strong>ã—ã¦ã„ã¾ã™ã€‚ã“ã®å‹•ãã‚’<strong>å…¬è»¢</strong>ã¨ã„ã„ã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>åœ°è»¸ã®å‚¾ã</h4>
          <p>åœ°çƒã®è‡ªè»¢ã™ã‚‹è»¸ï¼ˆåœ°è»¸ï¼‰ã¯ã€å°‘ã—<strong>ã‹ãŸã‚€ã„ã¦</strong>ã„ã¾ã™ã€‚ã“ã®ã‹ãŸã‚€ãã®ã›ã„ã§ã€å­£ç¯€ã”ã¨ã«<strong>æ—¥ç…§æ™‚é–“</strong>ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>æ˜¼ã¨å¤œ</h4>
          <p>å¤ªé™½ã®å…‰ãŒå½“ãŸã£ã¦ã„ã‚‹<strong>æ˜ã‚‹ã„éƒ¨åˆ†</strong>ãŒæ˜¼ã€å…‰ãŒå½“ãŸã£ã¦ã„ãªã„<strong>æš—ã„éƒ¨åˆ†</strong>ãŒå¤œã§ã™ã€‚åœ°çƒã®è‡ªè»¢ã«ã‚ˆã£ã¦ã€æ˜¼ã¨å¤œãŒäº¤äº’ã«ã‚„ã£ã¦ãã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>æ˜¼ã®é•·ã•</h4>
          <p>æ—¥æœ¬ã®ã‚ˆã†ãªä¸­ç·¯åº¦ã®åœ°åŸŸã§ã¯ã€<strong>å¤è‡³ã”ã‚</strong>ã«æ˜¼ãŒã„ã¡ã°ã‚“é•·ããªã‚Šã€<strong>å†¬è‡³ã”ã‚</strong>ã«æ˜¼ãŒã„ã¡ã°ã‚“çŸ­ããªã‚Šã¾ã™ã€‚æ˜¥åˆ†ãƒ»ç§‹åˆ†ã”ã‚ã¯æ˜¼ã¨å¤œãŒã»ã¼<strong>åŒã˜é•·ã•</strong>ã§ã™ã€‚</p>
        </div>
      </div>
      <button class="start-learning-btn" onclick="startLearning()">å­¦ç¿’ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <!-- â–¼ å•é¡Œã‚¨ãƒªã‚¢ -->
    <div class="question-container" id="question-container" style="display:none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="explanation" id="explanation"></div>
      <div class="navigation">
        <button class="nav-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>å‰ã®å•é¡Œ</button>
        <button class="nav-btn next-btn" id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       â–¼ åœ°çƒå…¬è»¢ï¼‹æ—¥ç…§æ™‚é–“ã‚·ãƒŸãƒ¥
    ================================= */
    const yearSlider = document.getElementById('yearSlider');
    const seasonDisplay = document.getElementById('seasonDisplay');
    const orbitField = document.getElementById('orbitField');
    const earthEl = document.getElementById('earth');
    const earthAxisEl = document.getElementById('earthAxis');
    const earthDayEl = document.getElementById('earthDay');
    const earthNightEl = document.getElementById('earthNight');
    const japanMarkerEl = document.getElementById('japanMarker');
    const japanLabelEl = document.getElementById('japanLabel');
    const dayPartEl = document.getElementById('dayPart');
    const nightPartEl = document.getElementById('nightPart');
    const dayInfoEl = document.getElementById('dayInfo');
    const nightInfoEl = document.getElementById('nightInfo');
    const simCommentEl = document.getElementById('simComment');

    function getSeasonText(angleDeg) {
      // 0Â°:æ˜¥åˆ†, 90Â°:å¤è‡³, 180Â°:ç§‹åˆ†, 270Â°:å†¬è‡³
      const a = ((angleDeg % 360) + 360) % 360;
      if (a >= 315 || a < 45) return 'æ˜¥åˆ†ã”ã‚';
      if (a >= 45 && a < 135) return 'å¤è‡³ã”ã‚';
      if (a >= 135 && a < 225) return 'ç§‹åˆ†ã”ã‚';
      return 'å†¬è‡³ã”ã‚';
    }

    function getSeasonComment(angleDeg, dayHours) {
      const a = ((angleDeg % 360) + 360) % 360;
      const day = Math.round(dayHours * 10) / 10;
      const night = Math.round((24 - dayHours) * 10) / 10;

      if (a >= 315 || a < 45) {
        return `å¤ªé™½ã®å½“ãŸã‚Šæ–¹ãŒã¡ã‚‡ã†ã©ä¸­ãã‚‰ã„ã§ã€<strong>æ˜¥åˆ†</strong>ã”ã‚ã§ã™ã€‚<br>
        æ—¥æœ¬ã§ã¯ã€æ˜¼ã‚‚å¤œã‚‚ã ã„ãŸã„<strong>åŒã˜é•·ã•</strong>ï¼ˆæ˜¼ï¼šç´„<strong>${day}æ™‚é–“</strong>ã€å¤œï¼šç´„<strong>${night}æ™‚é–“</strong>ï¼‰ã«ãªã‚Šã¾ã™ã€‚`;
      } else if (a >= 45 && a < 135) {
        return `å¤ªé™½ã®å…‰ãŒæ—¥æœ¬ã«<strong>ã‚ˆãå½“ãŸã‚‹</strong>ä½ç½®ã§ã€<strong>å¤è‡³</strong>ã”ã‚ã§ã™ã€‚<br>
        æ˜¼ãŒã„ã¡ã°ã‚“<strong>é•·ã</strong>ã€å¤œãŒã„ã¡ã°ã‚“<strong>çŸ­ã</strong>ãªã‚Šã¾ã™ï¼ˆæ˜¼ï¼šç´„<strong>${day}æ™‚é–“</strong>ã€å¤œï¼šç´„<strong>${night}æ™‚é–“</strong>ï¼‰ã€‚`;
      } else if (a >= 135 && a < 225) {
        return `ä»Šåº¦ã¯<strong>ç§‹åˆ†</strong>ã”ã‚ã§ã™ã€‚<br>
        æ˜¥åˆ†ã®ã¨ãã¨åŒã˜ã‚ˆã†ã«ã€æ˜¼ã¨å¤œãŒã ã„ãŸã„<strong>åŒã˜é•·ã•</strong>ï¼ˆæ˜¼ï¼šç´„<strong>${day}æ™‚é–“</strong>ã€å¤œï¼šç´„<strong>${night}æ™‚é–“</strong>ï¼‰ã«ãªã‚Šã¾ã™ã€‚`;
      } else {
        return `å¤ªé™½ã®å…‰ãŒæ—¥æœ¬ã«ã‚ãŸã‚Šã«ãã„ä½ç½®ã§ã€<strong>å†¬è‡³</strong>ã”ã‚ã§ã™ã€‚<br>
        æ˜¼ãŒã„ã¡ã°ã‚“<strong>çŸ­ã</strong>ã€å¤œãŒã„ã¡ã°ã‚“<strong>é•·ã</strong>ãªã‚Šã¾ã™ï¼ˆæ˜¼ï¼šç´„<strong>${day}æ™‚é–“</strong>ã€å¤œï¼šç´„<strong>${night}æ™‚é–“</strong>ï¼‰ã€‚`;
      }
    }

    function updateOrbitAndDaylength() {
      const angleDeg = parseFloat(yearSlider.value); // 0ã€œ360
      const angleRad = angleDeg * Math.PI / 180;

      // ã‚·ãƒ¼ã‚ºãƒ³è¡¨ç¤º
      const seasonText = getSeasonText(angleDeg);
      seasonDisplay.textContent = seasonText;

      // å…¬è»¢è»Œé“ä¸Šã®ä½ç½®
      const fieldRect = orbitField.getBoundingClientRect();
      const centerX = fieldRect.width / 2;
      const centerY = fieldRect.height / 2;
      const orbitRx = fieldRect.width * 0.38;
      const orbitRy = fieldRect.height * 0.28;

      const ex = centerX + orbitRx * Math.cos(angleRad);
      const ey = centerY + orbitRy * Math.sin(angleRad);
      const earthSize = 50;

      earthEl.style.left = (ex - earthSize/2) + 'px';
      earthEl.style.top  = (ey - earthSize/2) + 'px';

      // å¤ªé™½ã‹ã‚‰åœ°çƒã¸ã®æ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆå¤ªé™½ã¯ä¸­å¤®ï¼‰
      const sunX = centerX;
      const sunY = centerY;
      const dx = ex - sunX;
      const dy = ey - sunY;
      const sunAngle = Math.atan2(dy, dx); // å¤ªé™½ã‹ã‚‰è¦‹ãŸåœ°çƒã®æ–¹å‘ï¼ˆãƒ©ã‚¸ã‚¢ãƒ³ï¼‰

      // åœ°è»¸ï¼ˆå¸¸ã«åŒã˜å‘ãã«å°‘ã—å‚¾ã‘ã‚‹ï¼‰23.4åº¦
      // åœ°è»¸ã¯åœ°çƒã®ä¸­å¿ƒã‚’é€šã‚‹
      const axisTilt = 23.4;
      earthAxisEl.style.left = '50%';
      earthAxisEl.style.top = '50%';
      earthAxisEl.style.transform = `translate(-50%, -50%) rotate(${axisTilt}deg)`;
      earthAxisEl.style.width = '2px';
      earthAxisEl.style.height = `${earthSize}px`;

      // æ—¥æœ¬ã®ä½ç½®ï¼ˆåœ°çƒã®è¡¨é¢ã€æ±çµŒ135åº¦ã€åŒ—ç·¯35åº¦ã‚ãŸã‚Šï¼‰
      // ç°¡æ˜“ç‰ˆï¼šåœ°çƒã‚’æ­£é¢ã‹ã‚‰è¦‹ãŸã¨ãã€æ—¥æœ¬ã¯å³å´ï¼ˆæ±å´ï¼‰ã®ã‚„ã‚„ä¸Šï¼ˆåŒ—å´ï¼‰ã«ä½ç½®
      // åœ°çƒã®ä¸­å¿ƒã‹ã‚‰è¦‹ã¦ã€å³å´30åº¦ã€ä¸Šå´20åº¦ã®ä½ç½®
      const japanAngle = 30 * Math.PI / 180; // å³å´30åº¦
      const japanRadius = earthSize / 2 - 3; // åœ°çƒã®è¡¨é¢ã‹ã‚‰å°‘ã—å†…å´
      const japanX = Math.cos(japanAngle) * japanRadius;
      const japanY = -Math.sin(japanAngle) * japanRadius * 0.6; // ã‚„ã‚„ä¸Šï¼ˆåŒ—å´ï¼‰
      
      japanMarkerEl.style.left = `calc(50% + ${japanX}px)`;
      japanMarkerEl.style.top = `calc(50% + ${japanY}px)`;
      japanLabelEl.style.left = `calc(50% + ${japanX + 6}px)`;
      japanLabelEl.style.top = `calc(50% + ${japanY - 8}px)`;

      // å¤ªé™½å…‰ãŒå½“ãŸã£ã¦ã„ã‚‹éƒ¨åˆ†ï¼ˆæ˜¼ã¨å¤œã®å¢ƒç•Œç·šï¼‰
      // å¤ªé™½ã‹ã‚‰è¦‹ã¦ã€åœ°çƒã®ä¸­å¿ƒã‚’é€šã‚‹ç·šãŒæ˜¼ã¨å¤œã®å¢ƒç•Œ
      // å¤ªé™½ã®æ–¹å‘ã«å‚ç›´ãªç·šãŒå¢ƒç•Œç·š
      const terminatorAngleDeg = (sunAngle * 180 / Math.PI + 90) % 360; // å¢ƒç•Œç·šã®è§’åº¦ï¼ˆåº¦ï¼‰
      
      // çƒä½“ã®è¡¨é¢ã«æ²¿ã£ãŸã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ˜¼ã¨å¤œã‚’åˆ†ã‘ã‚‹
      // çƒä½“ã®ãŸã‚ã€radial-gradientã¨linear-gradientã‚’çµ„ã¿åˆã‚ã›ã‚‹
      const sunXRelative = (ex - centerX) / orbitRx;
      const sunYRelative = (ey - centerY) / orbitRy;
      const lightDirection = Math.atan2(sunYRelative, sunXRelative) * 180 / Math.PI;
      
      earthDayEl.style.background = `
        radial-gradient(ellipse 80% 100% at ${50 + sunXRelative * 20}% ${50 + sunYRelative * 20}%, 
          rgba(255,235,59,0.7) 0%, 
          rgba(255,235,59,0.5) 25%, 
          rgba(255,235,59,0.3) 40%, 
          rgba(255,235,59,0.1) 47%, 
          transparent 50%),
        linear-gradient(${terminatorAngleDeg}deg, 
          rgba(255,235,59,0.4) 0%, 
          rgba(255,235,59,0.2) 45%, 
          transparent 50%)`;
      
      earthNightEl.style.background = `
        radial-gradient(ellipse 80% 100% at ${50 - sunXRelative * 20}% ${50 - sunYRelative * 20}%, 
          transparent 0%, 
          rgba(0,0,0,0.1) 50%, 
          rgba(0,0,0,0.3) 60%, 
          rgba(0,0,0,0.5) 100%),
        linear-gradient(${terminatorAngleDeg}deg, 
          transparent 0%, 
          rgba(0,0,0,0.1) 50%, 
          rgba(0,0,0,0.3) 60%, 
          rgba(0,0,0,0.5) 100%)`;

      // æ—¥æœ¬ã®æ˜¼ã®é•·ã•ï¼ˆç°¡æ˜“ãƒ¢ãƒ‡ãƒ«ï¼‰
      // æ˜¥åˆ†(0Â°)ã¨ç§‹åˆ†(180Â°)ã§12hã€å¤è‡³(90Â°)ã§ç´„16hã€å†¬è‡³(270Â°)ã§ç´„8h ã«ãªã‚‹ã‚ˆã†ã«
      const dayHoursRaw = 12 + 4 * Math.sin(angleRad);
      const dayHours = Math.max(8, Math.min(16, dayHoursRaw));
      const nightHours = 24 - dayHours;

      const dayPercent = (dayHours / 24) * 100;
      const nightPercent = 100 - dayPercent;

      dayPartEl.style.width = dayPercent + '%';
      nightPartEl.style.width = nightPercent + '%';

      dayInfoEl.textContent = 'æ˜¼ï¼šç´„' + dayHours.toFixed(1) + 'æ™‚é–“';
      nightInfoEl.textContent = 'å¤œï¼šç´„' + nightHours.toFixed(1) + 'æ™‚é–“';

      simCommentEl.innerHTML = getSeasonComment(angleDeg, dayHours);
    }

    yearSlider.addEventListener('input', updateOrbitAndDaylength);
    window.addEventListener('resize', updateOrbitAndDaylength);
    // åˆæœŸè¡¨ç¤º
    updateOrbitAndDaylength();

    /* ================================
       â–¼ å•é¡Œãƒ‡ãƒ¼ã‚¿
    ================================= */
    const lessonData = {
      id: 'sci.kouten.nissho_wakaru',
      questions: [
        {
          id: 1,
          question: "æ—¥æœ¬ï¼ˆä¸­ç·¯åº¦ï¼‰ã§ã€æ˜¼ã®é•·ã•ãŒã„ã¡ã°ã‚“é•·ããªã‚‹ã®ã¯ã„ã¤ã”ã‚ã§ã™ã‹ï¼Ÿ",
          choices: [
            "æ˜¥åˆ†ã”ã‚",
            "å¤è‡³ã”ã‚",
            "ç§‹åˆ†ã”ã‚",
            "å†¬è‡³ã”ã‚"
          ],
          correct: 1,
          explanation: "æ—¥æœ¬ã®ã‚ˆã†ãªä¸­ç·¯åº¦ã®åœ°åŸŸã§ã¯ã€å¤ªé™½ã®å…‰ãŒã„ã¡ã°ã‚“ã‚ˆãå½“ãŸã‚‹<strong>å¤è‡³ã”ã‚</strong>ã«ã€æ˜¼ã®é•·ã•ãŒã„ã¡ã°ã‚“é•·ããªã‚Šã¾ã™ã€‚"
        },
        {
          id: 2,
          question: "æ˜¥åˆ†ã”ã‚ã¨ç§‹åˆ†ã”ã‚ã®ã€Œæ˜¼ã¨å¤œã®é•·ã•ã€ã®é–¢ä¿‚ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
          choices: [
            "æ˜¼ã®ã»ã†ãŒãšã£ã¨é•·ã„",
            "å¤œã®ã»ã†ãŒãšã£ã¨é•·ã„",
            "æ˜¼ã¨å¤œãŒã ã„ãŸã„åŒã˜é•·ã•",
            "ä¸€å¹´ä¸­ã€æ˜¼ã®ã»ã†ãŒé•·ã„"
          ],
          correct: 2,
          explanation: "æ˜¥åˆ†ã”ã‚ã¨ç§‹åˆ†ã”ã‚ã¯ã€å¤ªé™½ã®å½“ãŸã‚Šæ–¹ãŒã¡ã‚‡ã†ã©ä¸­ãã‚‰ã„ã«ãªã‚Šã€æ˜¼ã¨å¤œã®é•·ã•ãŒ<strong>ã»ã¼åŒã˜</strong>ã«ãªã‚Šã¾ã™ã€‚"
        },
        {
          id: 3,
          question: "æ¬¡ã®ã†ã¡ã€æ—¥æœ¬ã§ã®<strong>å†¬è‡³ã”ã‚</strong>ã®æ§˜å­ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
          choices: [
            "æ˜¼ãŒä¸€ç•ªé•·ãã€å¤œãŒä¸€ç•ªçŸ­ã„",
            "æ˜¼ãŒä¸€ç•ªçŸ­ãã€å¤œãŒä¸€ç•ªé•·ã„",
            "æ˜¼ã‚‚å¤œã‚‚ã¾ã£ãŸãåŒã˜é•·ã•",
            "æ˜¼ã‚‚å¤œã‚‚ä¸€å¹´ä¸­åŒã˜é•·ã•"
          ],
          correct: 1,
          explanation: "å†¬è‡³ã”ã‚ã¯ã€å¤ªé™½ã®å…‰ãŒæ—¥æœ¬ã«å½“ãŸã‚Šã«ãããªã‚Šã€<strong>æ˜¼ãŒã„ã¡ã°ã‚“çŸ­ã</strong>ã€é€†ã«<strong>å¤œãŒã„ã¡ã°ã‚“é•·ã</strong>ãªã‚Šã¾ã™ã€‚"
        }
      ]
    };

    /* ================================
       â–¼ LearningTracker & å•é¡Œè¡¨ç¤º
    ================================= */
    class LearningTracker {
      constructor() {
        this.mode = 'wakaru';
        this.historyKey = 'learningHistory_kouten_nissho_wakaru';
        this.currentSession = {
          startTime: Date.now(),
          questions: [],
          score: 0,
          totalQuestions: 0,
          mode: 'wakaru'
        };
      }
      recordAnswer(questionId, selectedAnswer, correctAnswer, timeSpent) {
        this.currentSession.questions.push({
          questionId,
          selectedAnswer,
          correctAnswer,
          isCorrect: selectedAnswer === correctAnswer,
          timeSpent,
          timestamp: Date.now()
        });
        if (selectedAnswer === correctAnswer) this.currentSession.score++;
        this.currentSession.totalQuestions++;
      }
      loadHistory() {
        try {
          const data = localStorage.getItem(this.historyKey);
          if (data) return JSON.parse(data);
        } catch(e){ console.error(e); }
        return {
          sessions: [],
          stats: {
            totalSessions:0,
            totalQuestions:0,
            correctAnswers:0,
            averageScore:0,
            bestScore:0
          }
        };
      }
      calculateStats(sessions) {
        const stats = {
          totalSessions: sessions.length,
          totalQuestions: 0,
          correctAnswers: 0,
          averageScore: 0,
          bestScore: 0
        };
        sessions.forEach(s=>{
          stats.totalQuestions += s.totalQuestions;
          stats.correctAnswers += s.score;
          stats.bestScore = Math.max(stats.bestScore, s.score);
        });
        if (stats.totalSessions>0 && stats.totalQuestions>0){
          stats.averageScore = (stats.correctAnswers / stats.totalQuestions *100).toFixed(1);
        }
        return stats;
      }
      saveSession() {
        try {
          const existing = this.loadHistory();
          const totalTime = Date.now() - this.currentSession.startTime;
          this.currentSession.totalTime = totalTime;
          const sessionToSave = {
            ...this.currentSession,
            endTime: Date.now(),
            duration: totalTime,
            totalTime
          };
          existing.sessions.push(sessionToSave);
          existing.stats = this.calculateStats(existing.sessions);
          localStorage.setItem(this.historyKey, JSON.stringify(existing));
          console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†', sessionToSave);
          return true;
        } catch(e){
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼', e);
          return false;
        }
      }
    }

    const learningTracker = new LearningTracker();
    let currentQuestion = 0;
    let score = 0;
    let questionStartTime = Date.now();

    function generateShuffledIndices(length){
      const idx = Array.from({length},(_,i)=>i);
      for(let i=idx.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
      return idx;
    }

    function showQuestion(index){
      const q = lessonData.questions[index];
      questionStartTime = Date.now();
      const expEl = document.getElementById('explanation');
      expEl.classList.remove('show');

      document.getElementById('question-text').textContent = q.question;
      const choicesContainer = document.getElementById('choices');
      choicesContainer.innerHTML = '';

      const order = generateShuffledIndices(q.choices.length);
      order.forEach(originalIndex=>{
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = q.choices[originalIndex];
        div.dataset.originalIndex = String(originalIndex);
        div.onclick = () => selectAnswer(originalIndex);
        choicesContainer.appendChild(div);
      });

      const progress = ((index+1)/lessonData.questions.length)*100;
      document.getElementById('progress-fill').style.width = progress + '%';

      document.getElementById('prev-btn').disabled = index===0;
      const nextBtn = document.getElementById('next-btn');
      if (index === lessonData.questions.length-1){
        nextBtn.disabled = false;
        nextBtn.textContent = 'å­¦ç¿’å®Œäº†';
      } else {
        nextBtn.disabled = false;
        nextBtn.textContent = 'æ¬¡ã®å•é¡Œ';
      }
    }

    function sendQuestionAnswerToParent(questionData, userAnswer, isCorrect){
      const messageData = {
        type:'question:answered',
        lessonId: lessonData.id,
        questionData:{
          qnum: questionData.id || currentQuestion,
          question: questionData.question,
          choices: questionData.choices,
          answer: questionData.correct,
          explanation: questionData.explanation
        },
        userAnswer,
        correctAnswer: questionData.correct,
        isCorrect,
        timestamp: Date.now()
      };
      console.log('ğŸ“ å€‹åˆ¥å•é¡Œå›ç­”ã‚’é€ä¿¡:', messageData);
      try{
        if (window.parent !== window) window.parent.postMessage(messageData,'*');
        if (window.top !== window) window.top.postMessage(messageData,'*');
        const existing = JSON.parse(localStorage.getItem('questionAnswers') || '[]');
        existing.push(messageData);
        localStorage.setItem('questionAnswers', JSON.stringify(existing));
      }catch(e){
        console.log('âŒ å€‹åˆ¥å•é¡Œå›ç­”é€ä¿¡å¤±æ•—:', e);
      }
    }

    function selectAnswer(choiceIndex){
      const q = lessonData.questions[currentQuestion];
      const choices = document.querySelectorAll('.choice');
      const timeSpent = Date.now() - questionStartTime;

      choices.forEach(c=>{ c.style.pointerEvents='none'; });

      choices.forEach(c=>{
        c.classList.remove('selected','correct','incorrect');
        const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
        if (originalIndex === choiceIndex){
          c.classList.add('selected');
        }
      });

      setTimeout(()=>{
        const isCorrect = choiceIndex === q.correct;
        choices.forEach(c=>{
          const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
          if (originalIndex === q.correct){
            c.classList.add('correct');
          } else if (originalIndex === choiceIndex && !isCorrect){
            c.classList.add('incorrect');
          }
        });

        const expEl = document.getElementById('explanation');
        expEl.innerHTML = '<h4>è§£èª¬</h4><p>' + q.explanation + '</p>';
        expEl.classList.add('show');

        if (isCorrect) score++;

        learningTracker.recordAnswer(
          q.id || currentQuestion,
          choiceIndex,
          q.correct,
          Math.round(timeSpent/1000)
        );
        sendQuestionAnswerToParent(q, choiceIndex, isCorrect);
      }, 500);
    }

    function previousQuestion(){
      if (currentQuestion>0){
        currentQuestion--;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function showCurrentSessionResult(){
      const session = learningTracker.currentSession;
      const scorePercent = session.totalQuestions>0
        ? Math.round((session.score/session.totalQuestions)*100)
        : 0;
      let msg = '';
      if (scorePercent >= 90) msg = 'ğŸ‰ ã¨ã¦ã‚‚ã‚ˆãç†è§£ã§ãã¦ã„ã¾ã™ï¼';
      else if (scorePercent >= 70) msg = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
      else if (scorePercent >= 50) msg = 'ğŸ“š ã ã„ã˜ãªã¨ã“ã‚ã‚’ã‚‚ã†ä¸€åº¦è¦‹ç›´ã—ã¦ã¿ã‚ˆã†ã€‚';
      else msg = 'ğŸ’ª ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ãªãŒã‚‰ã€ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚';

      const totalTime = Date.now() - session.startTime;
      const m = Math.floor(totalTime/60000);
      const s = Math.floor((totalTime%60000)/1000);
      const timeDisp = m>0 ? m+'åˆ†'+s+'ç§’' : s+'ç§’';

      return `
        <div style="background: linear-gradient(135deg,#66bb6a 0%,#26a69a 100%); color:white; padding:2rem; border-radius:16px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.3); margin-top:20px;">
          <div style="font-size:1.8rem; font-weight:bold; margin-bottom:1rem;">å­¦ç¿’å®Œäº†ï¼</div>
          <div style="font-size:1.1rem; margin-bottom:1.5rem;">${msg}</div>
          <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
            <div style="font-size:2.5rem; font-weight:bold; margin-bottom:0.5rem;">${session.score}/${session.totalQuestions}å•æ­£è§£</div>
            <div style="font-size:1.5rem; font-weight:600;">${scorePercent}%</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
            <div>å­¦ç¿’æ™‚é–“: <strong>${timeDisp}</strong></div>
            <div>å®Œäº†æ™‚åˆ»: <strong>${new Date().toLocaleString('ja-JP',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong></div>
          </div>
        </div>
      `;
    }

    function completeLesson(){
      learningTracker.saveSession();
      const messageData = {
        type:'lesson:complete',
        lessonId: lessonData.id,
        detail:{
          correct: learningTracker.currentSession.score,
          total: learningTracker.currentSession.totalQuestions,
          timeSec: Math.round((Date.now()-learningTracker.currentSession.startTime)/1000)
        }
      };
      console.log('ğŸš€ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', messageData);
      try{ if (window.parent !== window) window.parent.postMessage(messageData,'*'); }catch(e){}
      try{ if (window.top !== window) window.top.postMessage(messageData,'*'); }catch(e){}

      try{
        const storageMessage = { type:'lesson:complete', data:messageData, timestamp:Date.now() };
        localStorage.setItem('lessonCompleteMessage', JSON.stringify(storageMessage));
        if (window.parent && window.parent.saveLessonProgress){
          window.parent.saveLessonProgress(
            messageData.lessonId,
            messageData.detail.correct,
            messageData.detail.total,
            messageData.detail.timeSec
          );
        }
      }catch(e){ console.log('localStorage/saveLessonProgress ã‚¨ãƒ©ãƒ¼', e); }

      document.getElementById('question-container').style.display='none';
      const resultContainer = document.createElement('div');
      resultContainer.className='question-container';
      resultContainer.style.display='block';
      resultContainer.innerHTML = showCurrentSessionResult();

      const homeButton = document.createElement('button');
      homeButton.textContent = 'ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹';
      homeButton.className = 'start-learning-btn';
      homeButton.style.marginTop = '1.5rem';
      homeButton.onclick = ()=>{
        if (window.parent !== window || window.top !== window){
          try{
            window.parent.postMessage({type:'lesson:goBack'}, '*');
            window.top.postMessage({type:'lesson:goBack'}, '*');
            return;
          }catch(e){}
        }
        goHome();
      };
      resultContainer.appendChild(homeButton);
      document.querySelector('.main-container').appendChild(resultContainer);
    }

    function nextQuestion(){
      if (currentQuestion === lessonData.questions.length-1){
        completeLesson();
        return;
      }
      if (currentQuestion < lessonData.questions.length-1){
        currentQuestion++;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function startLearning(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('question-container').style.display = 'block';
      if (lessonData.questions.length > 0){
        showQuestion(0);
      } else {
        alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
    }

    function goHome(){
      window.location.href = '/';
    }
  </script>
</body>
</html>
