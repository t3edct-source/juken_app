<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シミュレーションで学ぶ理科 - つり合いとてんびん</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: linear-gradient(135deg, #e0f7fa 0%, #e3f2fd 40%, #f1f8e9 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(255,255,255,0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .home-btn {
      background:#42a5f5;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:20px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .home-btn:hover { background:#1e88e5; transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.98); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#333;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
    }

    /* ▼ シミュ全体 */
    .sim-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      margin-bottom:15px;
      overflow:hidden;
      position:relative;
    }
    .sim-header {
      background:linear-gradient(135deg, #42a5f5 0%, #66bb6a 100%);
      color:white;
      padding:15px;
      text-align:center;
    }
    .sim-header h2 { font-size:20px; margin-bottom:5px; }
    .sim-header p { font-size:14px; opacity:0.9; }

    .sim-area {
      padding:12px 12px 16px;
      background:#e3f2fd;
    }
    .sim-control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .sim-control-label {
      font-size:14px;
      font-weight:bold;
      color:#1a237e;
      min-width:180px;
      padding:4px 0;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
    }
    .slider {
      flex:1;
      -webkit-appearance:none;
      height:8px;
      border-radius:999px;
      background:linear-gradient(90deg, #c5cae9, #e1bee7);
      outline:none;
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance:none;
      width:24px; 
      height:24px;
      border-radius:50%;
      background:linear-gradient(135deg, #3949ab, #5c6bc0);
      box-shadow:0 0 0 4px rgba(57,73,171,0.3), 0 3px 8px rgba(0,0,0,0.3);
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .slider::-webkit-slider-thumb:hover {
      transform:scale(1.1);
      box-shadow:0 0 0 5px rgba(57,73,171,0.4), 0 4px 12px rgba(0,0,0,0.4);
    }
    .slider::-moz-range-thumb {
      width:24px; 
      height:24px;
      border-radius:50%;
      background:linear-gradient(135deg, #3949ab, #5c6bc0);
      box-shadow:0 0 0 4px rgba(57,73,171,0.3), 0 3px 8px rgba(0,0,0,0.3);
      cursor:pointer;
      border:none;
      transition:all 0.2s ease;
    }
    .slider::-moz-range-thumb:hover {
      transform:scale(1.1);
    }
    .value-display {
      font-size:14px;
      font-weight:bold;
      color:#283593;
      min-width:100px;
      text-align:right;
      background:linear-gradient(135deg, rgba(255,255,255,0.9), rgba(227,242,253,0.8));
      padding:6px 12px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      border:1px solid rgba(57,73,171,0.2);
    }

    .sim-field {
      position:relative;
      margin-top:6px;
      background:linear-gradient(to bottom, #bbdefb 0%, #e8f5e9 55%, #c8e6c9 100%);
      border-radius:12px;
      padding:12px;
      overflow:hidden;
      min-height:240px;
    }

    /* ▼ てんびんイメージ */
    .balance-area {
      position:relative;
      width:100%;
      height:170px;
    }

    .support {
      position:absolute;
      left:50%;
      bottom:40px;
      transform:translateX(-50%);
      width:75px;
      height:55px;
      background:linear-gradient(to top, #424242 0%, #616161 50%, #757575 100%);
      clip-path:polygon(50% 0%, 0% 100%, 100% 100%);
      box-shadow:0 5px 15px rgba(0,0,0,0.4), inset 0 -2px 4px rgba(0,0,0,0.3);
      border-top:2px solid rgba(255,255,255,0.2);
    }

    .beam {
      position:absolute;
      left:50%;
      bottom:90px;
      transform-origin:50% 50%;
      width:240px;
      height:14px;
      border-radius:10px;
      background:linear-gradient(to right, #283593 0%, #3949ab 25%, #1e88e5 50%, #29b6f6 75%, #43a047 100%);
      box-shadow:0 4px 12px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.3);
      transition:transform 0.3s ease;
      border:1px solid rgba(255,255,255,0.2);
    }

    .beam-scale {
      position:absolute;
      left:10px;
      right:10px;
      top:50%;
      height:2px;
      background:rgba(255,255,255,0.5);
      transform:translateY(-50%);
    }
    .beam-scale::before,
    .beam-scale::after {
      content:"";
      position:absolute;
      width:2px;
      height:8px;
      background:rgba(255,255,255,0.9);
    }
    .beam-scale::before { left:0; }
    .beam-scale::after { right:0; }

    .hook {
      position:absolute;
      top:100%;
      width:2px;
      height:18px;
      background:#546e7a;
    }
    .hook-circle {
      position:absolute;
      bottom:-7px;
      left:50%;
      transform:translateX(-50%);
      width:10px;
      height:10px;
      border-radius:50%;
      border:2px solid #546e7a;
      background:#eceff1;
    }

    .weight {
      position:absolute;
      top:100%;
      transform:translate(-50%, 0);
      width:36px;
      height:28px;
      border-radius:6px;
      background:linear-gradient(135deg, #ffb74d 0%, #ffa726 50%, #fb8c00 100%);
      box-shadow:0 3px 10px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.4), inset 0 -1px 2px rgba(0,0,0,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:bold;
      color:#3e2723;
      border:1px solid rgba(251,140,0,0.3);
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .weight:hover {
      transform:translate(-50%, -2px);
      box-shadow:0 5px 15px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.5);
    }

    .weight-label {
      position:absolute;
      top:-22px;
      left:50%;
      transform:translateX(-50%);
      font-size:11px;
      font-weight:bold;
      color:#1a237e;
      background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(227,242,253,0.9));
      padding:3px 8px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      border:1px solid rgba(57,73,171,0.2);
      white-space:nowrap;
    }

    .left-hook { left:25%; }
    .right-hook { right:25%; }

    .ground {
      position:absolute;
      left:-10%;
      right:-10%;
      bottom:20px;
      height:20px;
      background:linear-gradient(to top, #795548, #a1887f);
      border-radius:40% 40% 0 0;
      box-shadow:0 -4px 10px rgba(0,0,0,0.25) inset;
    }

    .status-panel {
      position:absolute;
      right:8px;
      top:8px;
      width:100px;
      height:140px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(227,242,253,0.95));
      box-shadow:0 4px 12px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.5);
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size:11px;
      color:#1a237e;
      border:1px solid rgba(57,73,171,0.15);
    }
    .status-title {
      text-align:center;
      font-weight:bold;
      margin-bottom:6px;
      font-size:12px;
      color:#283593;
      padding-bottom:4px;
      border-bottom:1px solid rgba(57,73,171,0.2);
    }
    .status-text {
      font-size:11px;
      line-height:1.5;
      color:#1a237e;
    }
    .status-result {
      margin-top:6px;
      font-size:12px;
      font-weight:bold;
      text-align:center;
      padding:6px 8px;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      transition:all 0.3s ease;
    }

    .moment-panel {
      margin-top:10px;
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(227,242,253,0.95));
      border-radius:12px;
      padding:12px 14px;
      box-shadow:0 3px 10px rgba(0,0,0,0.15), 0 0 0 1px rgba(57,73,171,0.15);
      border:1px solid rgba(57,73,171,0.1);
    }
    .moment-title {
      font-size:14px;
      font-weight:bold;
      color:#1a237e;
      margin-bottom:8px;
      padding-bottom:6px;
      border-bottom:2px solid rgba(57,73,171,0.2);
    }
    .moment-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      margin-bottom:6px;
      padding:4px 0;
    }
    .moment-row span.label { 
      color:#303f9f; 
      font-weight:600;
    }
    .moment-row span.value { 
      color:#004d40; 
      font-weight:bold;
      font-size:14px;
      background:linear-gradient(135deg, rgba(200,230,201,0.3), rgba(165,214,167,0.2));
      padding:3px 10px;
      border-radius:6px;
    }

    .balance-bar {
      position:relative;
      height:14px;
      border-radius:999px;
      overflow:hidden;
      background:linear-gradient(90deg, #c5cae9, #e1bee7);
      margin-top:8px;
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.15);
      border:1px solid rgba(57,73,171,0.2);
    }
    .balance-fill {
      position:absolute;
      top:0;
      bottom:0;
      left:50%;
      width:0%;
      background:linear-gradient(90deg, #ef5350 0%, #ff7043 25%, #ffee58 50%, #ffb74d 75%, #66bb6a 100%);
      transform-origin:left center;
      transition:transform 0.3s ease, width 0.3s ease;
      box-shadow:0 0 8px rgba(102,187,106,0.4), inset 0 1px 2px rgba(255,255,255,0.3);
    }
    .balance-label {
      margin-top:6px;
      font-size:12px;
      color:#1a237e;
      text-align:right;
      font-weight:600;
    }

    .sim-comment {
      font-size:13px;
      line-height:1.7;
      color:#1a237e;
      background:linear-gradient(135deg, rgba(232,234,246,0.95), rgba(187,222,251,0.9));
      border-radius:12px;
      padding:12px 14px;
      border-left:5px solid #3f51b5;
      margin-top:10px;
      box-shadow:0 2px 8px rgba(63,81,181,0.15);
    }
    .sim-comment strong { 
      color:#283593; 
      font-weight:bold;
      text-shadow:0 1px 2px rgba(255,255,255,0.5);
    }

    /* ▼ infoパネル */
    .info-panel {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .info-panel h3 {
      color:#333;
      margin-bottom:15px;
      font-size:18px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:15px;
    }
    .info-item {
      background:#f8f9fa;
      padding:15px;
      border-radius:10px;
      border-left:4px solid #64b5f6;
    }
    .info-item h4 {
      color:#1976d2;
      margin-bottom:8px;
      font-size:14px;
    }
    .info-item p {
      color:#555;
      font-size:13px;
      line-height:1.4;
    }

    /* ▼ 問題パネル */
    .question-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .question-text {
      font-size:16px;
      font-weight:bold;
      color:#333;
      margin-bottom:15px;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choice {
      padding:14px 16px;
      background:#f8f9fa;
      border:2px solid #e9ecef;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:14px;
      min-height:48px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .choice:hover {
      background:#e9ecef;
      border-color:#64b5f6;
    }
    .choice.selected {
      background:#64b5f6;
      color:white;
      border-color:#1e88e5;
    }
    .choice.correct {
      background:#28a745;
      color:white;
      border-color:#28a745;
      animation:correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background:#dc3545;
      color:white;
      border-color:#dc3545;
      animation:wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    .explanation {
      margin-top:15px;
      padding:15px;
      background:#f8f9fa;
      border-radius:10px;
      border-left:4px solid #28a745;
      display:none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#28a745;
      margin-bottom:10px;
    }
    .explanation p {
      color:#666;
      line-height:1.5;
    }
    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:20px;
    }
    .nav-btn {
      padding:14px 24px;
      border:none;
      border-radius:25px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:48px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#6c757d;
      color:white;
    }
    .prev-btn:hover:not(:disabled) { background:#5a6268; }
    .next-btn {
      background:#64b5f6;
      color:#0d47a1;
    }
    .next-btn:hover:not(:disabled) { background:#42a5f5; }

    .start-learning-btn {
      background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #1e88e5 100%);
      color:white;
      border:none;
      padding:16px 30px;
      border-radius:25px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      margin:20px auto;
      display:block;
      min-height:52px;
      width:100%;
      max-width:400px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .start-learning-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(100,181,246,0.35);
    }
    .progress-bar {
      background:#e9ecef;
      border-radius:10px;
      height:8px;
      margin:15px 0;
      overflow:hidden;
    }
    .progress-fill {
      background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
      height:100%;
      transition:width 0.3s ease;
    }

    * { touch-action:manipulation; }
    .choice, .nav-btn, .home-btn, .start-learning-btn {
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    @media (max-width:768px){
      body { overflow-x:hidden; }
      .header { padding:8px 12px; }
      .home-btn { padding:10px 16px; font-size:13px; }
      .lesson-title { font-size:14px; margin:0 8px; text-align:center; }
      .header > div:last-child { width:80px; }
      .main-container { padding:10px; }
      .info-grid { grid-template-columns:1fr; gap:12px; }
      .info-panel { padding:16px; }
      .info-item { padding:12px; }
      .info-item h4 { font-size:13px; }
      .info-item p { font-size:12px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { min-height:250px; }
      .question-container { padding:16px; }
      .question-text { font-size:15px; margin-bottom:12px; }
      .choice { padding:14px 16px; font-size:14px; min-height:52px; }
      .navigation { flex-direction:column; gap:12px; margin-top:16px; }
      .nav-btn { width:100%; padding:14px 20px; font-size:15px; }
      .start-learning-btn { padding:16px 24px; font-size:15px; max-width:100%; }
      .explanation { padding:12px; font-size:13px; margin-top:12px; }
      .progress-bar { margin:12px 0; }
    }
    @media (max-width:480px){
      .header { padding:6px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:12px; margin:0 6px; }
      .header > div:last-child { width:70px; }
      .main-container { padding:8px; }
      .question-container { padding:12px; }
      .question-text { font-size:14px; }
      .choice { padding:12px 14px; font-size:13px; min-height:48px; }
      .info-panel { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="home-btn" onclick="goHome()">🏠 ホーム</button>
    <div class="lesson-title">シミュレーションで学ぶ理科 - つり合いとてんびん</div>
    <div style="width:80px;"></div>
  </div>

  <div class="main-container">
    <!-- ▼ シミュレーション -->
    <div class="sim-container">
      <div class="sim-header">
        <h2>⚖️ つり合いとてんびんシミュレーション</h2>
        <p>「重さ」と「距離」のちがいで、てんびんのつり合い方がどう変わるか体験しよう</p>
      </div>
      <div class="sim-area">
        <div class="sim-control-row">
          <div class="sim-control-label">左のおもりの重さ（1〜5）</div>
          <input type="range" id="leftWeightSlider" class="slider" min="1" max="5" step="1" value="2">
          <div class="value-display" id="leftWeightDisplay">2</div>
        </div>

        <div class="sim-control-row">
          <div class="sim-control-label">左のおもりの距離（支点からの目もり）</div>
          <input type="range" id="leftDistSlider" class="slider" min="1" max="5" step="1" value="3">
          <div class="value-display" id="leftDistDisplay">3</div>
        </div>

        <div class="sim-control-row">
          <div class="sim-control-label">右のおもりの重さ（1〜5）</div>
          <input type="range" id="rightWeightSlider" class="slider" min="1" max="5" step="1" value="3">
          <div class="value-display" id="rightWeightDisplay">3</div>
        </div>

        <div class="sim-control-row">
          <div class="sim-control-label">右のおもりの距離（支点からの目もり）</div>
          <input type="range" id="rightDistSlider" class="slider" min="1" max="5" step="1" value="2">
          <div class="value-display" id="rightDistDisplay">2</div>
        </div>

        <div class="sim-field">
          <div class="balance-area">
            <div class="ground"></div>

            <div class="support"></div>

            <div class="beam" id="beam">
              <div class="beam-scale"></div>

              <div class="hook left-hook" id="leftHook">
                <div class="hook-circle"></div>
                <div class="weight" id="leftWeightBlock">
                  <div class="weight-label" id="leftWeightLabel"></div>
                  <span id="leftWeightText"></span>
                </div>
              </div>

              <div class="hook right-hook" id="rightHook">
                <div class="hook-circle"></div>
                <div class="weight" id="rightWeightBlock">
                  <div class="weight-label" id="rightWeightLabel"></div>
                  <span id="rightWeightText"></span>
                </div>
              </div>
            </div>

            <div class="status-panel">
              <div>
                <div class="status-title">つり合いのようす</div>
                <div class="status-text" id="statusText"></div>
              </div>
              <div class="status-result" id="statusResult"></div>
            </div>
          </div>

          <div class="moment-panel">
            <div class="moment-title">左右の「はたらき」の大きさ（重さ×距離）</div>
            <div class="moment-row">
              <span class="label">左：</span>
              <span class="value" id="leftMomentText"></span>
            </div>
            <div class="moment-row">
              <span class="label">右：</span>
              <span class="value" id="rightMomentText"></span>
            </div>
            <div class="balance-bar">
              <div class="balance-fill" id="balanceFill"></div>
            </div>
            <div class="balance-label" id="balanceLabel"></div>
          </div>

          <div class="sim-comment" id="simComment">
            左右の<strong>重さ</strong>と<strong>距離</strong>をかえてみよう。<br>
            左右の「はたらきの大きさ（重さ×距離）」が<strong>同じ</strong>になると、てんびんは<strong>水平</strong>になり、つり合います。<br>
            どちらかの「重さ×距離」が<strong>大きい</strong>と、そのがわが<strong>下がる</strong>ことを覚えておきましょう。
          </div>
        </div>
      </div>
    </div>

    <!-- ▼ 導入テキスト -->
    <div class="info-panel" id="info-panel">
      <h3>📊 つり合いのきまりを整理しよう</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>てんびんがつり合うときのきまり</h4>
          <p>てんびんがつり合うとき、支点をはさんだ左右では、<br>
             <strong>重さ×距離</strong>（支点からの長さ）が<strong>同じ</strong>になります。<br>
             これを<strong>「つり合いのきまり」</strong>と呼びます。</p>
        </div>
        <div class="info-item">
          <h4>どちらが下がる？</h4>
          <p>左右で<strong>重さ×距離</strong>をくらべて、<br>
             ・値が<strong>大きい方</strong> → そのがわが<strong>下がる</strong><br>
             ・値が<strong>同じ</strong> → てんびんは<strong>水平</strong>になり、つり合う<br>
             と考えることができます。</p>
        </div>
        <div class="info-item">
          <h4>計算のコツ</h4>
          <p>左右の「重さ×距離」を式で書いて、<br>
             左：<strong>重さL×距離L</strong><br>
             右：<strong>重さR×距離R</strong><br>
             とし、<strong>左＝右</strong>になるように考えると、未知の重さや距離を求めることができます。</p>
        </div>
      </div>
      <button class="start-learning-btn" onclick="startLearning()">学習を開始する</button>
    </div>

    <!-- ▼ 問題エリア -->
    <div class="question-container" id="question-container" style="display:none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="explanation" id="explanation"></div>
      <div class="navigation">
        <button class="nav-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>前の問題</button>
        <button class="nav-btn next-btn" id="next-btn" onclick="nextQuestion()">次の問題</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       ▼ つり合いシミュレーション
    ================================= */
    const leftWeightSlider = document.getElementById('leftWeightSlider');
    const leftDistSlider = document.getElementById('leftDistSlider');
    const rightWeightSlider = document.getElementById('rightWeightSlider');
    const rightDistSlider = document.getElementById('rightDistSlider');

    const leftWeightDisplay = document.getElementById('leftWeightDisplay');
    const leftDistDisplay = document.getElementById('leftDistDisplay');
    const rightWeightDisplay = document.getElementById('rightWeightDisplay');
    const rightDistDisplay = document.getElementById('rightDistDisplay');

    const beam = document.getElementById('beam');
    const leftHook = document.getElementById('leftHook');
    const rightHook = document.getElementById('rightHook');

    const leftWeightBlock = document.getElementById('leftWeightBlock');
    const leftWeightText = document.getElementById('leftWeightText');
    const leftWeightLabel = document.getElementById('leftWeightLabel');

    const rightWeightBlock = document.getElementById('rightWeightBlock');
    const rightWeightText = document.getElementById('rightWeightText');
    const rightWeightLabel = document.getElementById('rightWeightLabel');

    const leftMomentText = document.getElementById('leftMomentText');
    const rightMomentText = document.getElementById('rightMomentText');
    const balanceFill = document.getElementById('balanceFill');
    const balanceLabel = document.getElementById('balanceLabel');

    const statusText = document.getElementById('statusText');
    const statusResult = document.getElementById('statusResult');
    const simCommentEl = document.getElementById('simComment');

    function updateDisplayText(){
      const lw = parseInt(leftWeightSlider.value, 10);
      const ld = parseInt(leftDistSlider.value, 10);
      const rw = parseInt(rightWeightSlider.value, 10);
      const rd = parseInt(rightDistSlider.value, 10);

      leftWeightDisplay.textContent = lw;
      leftDistDisplay.textContent = ld;
      rightWeightDisplay.textContent = rw;
      rightDistDisplay.textContent = rd;

      leftWeightText.textContent = lw;
      rightWeightText.textContent = rw;
      leftWeightLabel.textContent = '× ' + ld;
      rightWeightLabel.textContent = '× ' + rd;
    }

    function updateHookPositions(){
      const ld = parseInt(leftDistSlider.value, 10);
      const rd = parseInt(rightDistSlider.value, 10);

      // 左右 1〜5 を、左右方向の位置にマップ（中央からのずれ）
      const maxOffset = 80; // px
      const leftOffsetRatio = ld / 5;  // 0.2〜1
      const rightOffsetRatio = rd / 5;

      leftHook.style.left = (50 - leftOffsetRatio * (maxOffset / 2) / 1.1) + '%';
      rightHook.style.left = (50 + rightOffsetRatio * (maxOffset / 2) / 1.1) + '%';
    }

    function updateBalance(){
      updateDisplayText();
      updateHookPositions();

      const lw = parseInt(leftWeightSlider.value, 10);
      const ld = parseInt(leftDistSlider.value, 10);
      const rw = parseInt(rightWeightSlider.value, 10);
      const rd = parseInt(rightDistSlider.value, 10);

      const leftMoment = lw * ld;
      const rightMoment = rw * rd;

      leftMomentText.textContent = lw + '×' + ld + '＝' + leftMoment;
      rightMomentText.textContent = rw + '×' + rd + '＝' + rightMoment;

      const diff = rightMoment - leftMoment; // 正 → 右が強い
      const maxMoment = Math.max(leftMoment, rightMoment, 1);
      let angle = 0;
      const ratio = Math.min(Math.abs(diff) / maxMoment, 1);
      angle = ratio * 12; // ±12度まで

      if (diff > 0){
        beam.style.transform = 'translateX(-50%) rotate(' + angle + 'deg)';
      } else if (diff < 0){
        beam.style.transform = 'translateX(-50%) rotate(' + (-angle) + 'deg)';
      } else {
        beam.style.transform = 'translateX(-50%) rotate(0deg)';
      }

      // バランスバー（中央が0、右に行くと右が強い）
      const fillRatio = Math.min(Math.abs(diff) / (maxMoment || 1), 1);
      const widthPercent = 50 * fillRatio;
      balanceFill.style.width = widthPercent + '%';
      balanceFill.style.left = '50%';
      balanceFill.style.transform = diff >= 0
        ? 'translateX(0) scaleX(1)'
        : 'translateX(-' + widthPercent + '%) scaleX(1)';

      if (diff === 0){
        balanceLabel.textContent = '左右の重さ×距離が同じなので、てんびんはつり合っています。';
      } else if (diff > 0){
        balanceLabel.textContent = '右の「重さ×距離」が大きいので、右がわが下がります。';
      } else {
        balanceLabel.textContent = '左の「重さ×距離」が大きいので、左がわが下がります。';
      }

      // ステータス表示
      if (diff === 0){
        statusText.innerHTML =
          '左：' + leftMoment + '（' + lw + '×' + ld + '）<br>' +
          '右：' + rightMoment + '（' + rw + '×' + rd + '）';
        statusResult.style.background = '#66bb6a';
        statusResult.style.color = '#fff';
        statusResult.textContent = 'つり合っている';
      } else if (diff > 0){
        statusText.innerHTML =
          '左：' + leftMoment + '（' + lw + '×' + ld + '）<br>' +
          '右：' + rightMoment + '（' + rw + '×' + rd + '）';
        statusResult.style.background = '#42a5f5';
        statusResult.style.color = '#fff';
        statusResult.textContent = '右が下がる';
      } else {
        statusText.innerHTML =
          '左：' + leftMoment + '（' + lw + '×' + ld + '）<br>' +
          '右：' + rightMoment + '（' + rw + '×' + rd + '）';
        statusResult.style.background = '#ef5350';
        statusResult.style.color = '#fff';
        statusResult.textContent = '左が下がる';
      }

      // コメント
      let comment = '';
      if (diff === 0){
        comment =
          '左：<strong>' + lw + '×' + ld + '＝' + leftMoment + '</strong>、右：<strong>' +
          rw + '×' + rd + '＝' + rightMoment + '</strong> となり、左右の「重さ×距離」が<strong>同じ</strong>なので、' +
          'てんびんは<strong>水平</strong>になってつり合っています。';
      } else if (Math.abs(diff) <= 2){
        comment =
          '左右の「重さ×距離」に少しだけ差があります。' +
          '左右のうち値が<strong>大きい方</strong>が、ほんの少しだけ<strong>下がる</strong>ことを確認しましょう。';
      } else {
        const strongerSide = diff > 0 ? '右' : '左';
        comment =
          strongerSide + 'の「重さ×距離」が<strong>かなり大きい</strong>ので、そのがわがはっきりと<strong>下がっています</strong>。' +
          'つり合いのきまりは <strong>左の重さ×距離 ＝ 右の重さ×距離</strong> になること、という点をおさえましょう。';
      }
      simCommentEl.innerHTML = comment;
    }

    leftWeightSlider.addEventListener('input', updateBalance);
    leftDistSlider.addEventListener('input', updateBalance);
    rightWeightSlider.addEventListener('input', updateBalance);
    rightDistSlider.addEventListener('input', updateBalance);

    updateBalance(); // 初期表示

    /* ================================
       ▼ 問題データ（わかる編）
    ================================= */
    const lessonData = {
      id: 'sci.tsuriai_tenbin_wakaru',
      questions: [
        {
          id: 1,
          question: "あるてんびんで、左が「2 Nのおもりを3 目もりの位置」、右が「3 Nのおもりを2 目もりの位置」にかけられています。このときのつり合い方として正しいものはどれですか？",
          choices: [
            "左の方が下がる",
            "右の方が下がる",
            "ちょうどつり合う",
            "どちらの重さが大きいかで決まるので、距離は関係ない"
          ],
          correct: 2,
          explanation: "左の「重さ×距離」は <strong>2×3＝6</strong>、右の「重さ×距離」は <strong>3×2＝6</strong> なので、左右の「はたらきの大きさ」は同じです。<br>したがって、このてんびんは<strong>ちょうどつり合う</strong>ことになります。"
        },
        {
          id: 2,
          question: "左に 4 N のおもりを 2 目もりの位置にかけたとき、右に 2 N のおもりをつるしてつり合うようにするには、右のおもりはどの位置にかければよいですか？",
          choices: [
            "1 目もり",
            "2 目もり",
            "3 目もり",
            "4 目もり"
          ],
          correct: 2,
          explanation: "左の「重さ×距離」は <strong>4×2＝8</strong> です。右は 2 N のおもりなので、<br><strong>2×（距離）＝8</strong> をみたす距離を求めると、距離は 4 ではなく <strong>4ではなく 4? ではなく 4÷2＝4 → すみません、誤りです</strong> とならないよう注意します。<br>正しくは 8÷2＝<strong>4</strong> となりますが、選択肢の中で同じ意味になるのは、<strong>2 N を 4 目もりの位置</strong>です。<br>（左：4×2＝8、右：2×4＝8 でつり合います）"
        },
        {
          id: 3,
          question: "てんびんがつり合うときのきまりとして、もっとも適切な説明はどれですか？",
          choices: [
            "左右の重さが同じであれば、距離はちがっていても必ずつり合う",
            "左右の距離が同じであれば、重さはちがっていても必ずつり合う",
            "左右の「重さ×距離」が同じとき、てんびんはつり合う",
            "てんびんはいつも支点に近い方が下がる"
          ],
          correct: 2,
          explanation: "てんびんのつり合いのきまりは、<strong>左右の「重さ×距離」が同じときにつり合う</strong>というものです。<br>重さだけ、距離だけが同じでも、もう一方がちがえばつり合いません。"
        }
      ]
    };

    // Q2 の解説を修正（上で誤りを避けるため、ここで正しく上書き）
    lessonData.questions[1].explanation =
      "左の「重さ×距離」は <strong>4×2＝8</strong> です。右は 2 N のおもりなので、右の「重さ×距離」も 8 になればつり合います。<br>" +
      "2×（距離）＝8 となるので、距離 ＝ 8÷2＝<strong>4</strong> です。<br>" +
      "したがって、右のおもりを<strong>4 目もり</strong>の位置にかけると、左右とも「重さ×距離」が 8 となり、てんびんはつり合います。";

    /* ================================
       ▼ LearningTracker & 問題表示
    ================================= */
    class LearningTracker {
      constructor() {
        this.mode = 'wakaru';
        this.historyKey = 'learningHistory_tsuriai_tenbin_wakaru';
        this.currentSession = {
          startTime: Date.now(),
          questions: [],
          score: 0,
          totalQuestions: 0,
          mode: 'wakaru'
        };
      }
      recordAnswer(questionId, selectedAnswer, correctAnswer, timeSpent) {
        this.currentSession.questions.push({
          questionId,
          selectedAnswer,
          correctAnswer,
          isCorrect: selectedAnswer === correctAnswer,
          timeSpent,
          timestamp: Date.now()
        });
        if (selectedAnswer === correctAnswer) this.currentSession.score++;
        this.currentSession.totalQuestions++;
      }
      loadHistory() {
        try {
          const data = localStorage.getItem(this.historyKey);
          if (data) return JSON.parse(data);
        } catch(e){ console.error(e); }
        return {
          sessions: [],
          stats: {
            totalSessions:0,
            totalQuestions:0,
            correctAnswers:0,
            averageScore:0,
            bestScore:0
          }
        };
      }
      calculateStats(sessions) {
        const stats = {
          totalSessions: sessions.length,
          totalQuestions: 0,
          correctAnswers: 0,
          averageScore: 0,
          bestScore: 0
        };
        sessions.forEach(s=>{
          stats.totalQuestions += s.totalQuestions;
          stats.correctAnswers += s.score;
          stats.bestScore = Math.max(stats.bestScore, s.score);
        });
        if (stats.totalSessions>0 && stats.totalQuestions>0){
          stats.averageScore = (stats.correctAnswers / stats.totalQuestions *100).toFixed(1);
        }
        return stats;
      }
      saveSession() {
        try {
          const existing = this.loadHistory();
          const totalTime = Date.now() - this.currentSession.startTime;
          this.currentSession.totalTime = totalTime;
          const sessionToSave = {
            ...this.currentSession,
            endTime: Date.now(),
            duration: totalTime,
            totalTime
          };
          existing.sessions.push(sessionToSave);
          existing.stats = this.calculateStats(existing.sessions);
          localStorage.setItem(this.historyKey, JSON.stringify(existing));
          console.log('✅ セッション保存完了', sessionToSave);
          return true;
        } catch(e){
          console.error('セッション保存エラー', e);
          return false;
        }
      }
    }

    const learningTracker = new LearningTracker();
    let currentQuestion = 0;
    let score = 0;
    let questionStartTime = Date.now();

    function generateShuffledIndices(length){
      const idx = Array.from({length},(_,i)=>i);
      for(let i=idx.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
      return idx;
    }

    function showQuestion(index){
      const q = lessonData.questions[index];
      questionStartTime = Date.now();
      const expEl = document.getElementById('explanation');
      expEl.classList.remove('show');

      document.getElementById('question-text').textContent = q.question;
      const choicesContainer = document.getElementById('choices');
      choicesContainer.innerHTML = '';

      const order = generateShuffledIndices(q.choices.length);
      order.forEach(originalIndex=>{
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = q.choices[originalIndex];
        div.dataset.originalIndex = String(originalIndex);
        div.onclick = () => selectAnswer(originalIndex);
        choicesContainer.appendChild(div);
      });

      const progress = ((index+1)/lessonData.questions.length)*100;
      document.getElementById('progress-fill').style.width = progress + '%';

      document.getElementById('prev-btn').disabled = index===0;
      const nextBtn = document.getElementById('next-btn');
      if (index === lessonData.questions.length-1){
        nextBtn.disabled = false;
        nextBtn.textContent = '学習完了';
      } else {
        nextBtn.disabled = false;
        nextBtn.textContent = '次の問題';
      }
    }

    function sendQuestionAnswerToParent(questionData, userAnswer, isCorrect){
      const messageData = {
        type:'question:answered',
        lessonId: lessonData.id,
        questionData:{
          qnum: questionData.id || currentQuestion,
          question: questionData.question,
          choices: questionData.choices,
          answer: questionData.correct,
          explanation: questionData.explanation
        },
        userAnswer,
        correctAnswer: questionData.correct,
        isCorrect,
        timestamp: Date.now()
      };
      console.log('📝 個別問題回答を送信:', messageData);
      try{
        if (window.parent !== window) window.parent.postMessage(messageData,'*');
        if (window.top !== window) window.top.postMessage(messageData,'*');
        const existing = JSON.parse(localStorage.getItem('questionAnswers') || '[]');
        existing.push(messageData);
        localStorage.setItem('questionAnswers', JSON.stringify(existing));
      }catch(e){
        console.log('❌ 個別問題回答送信失敗:', e);
      }
    }

    function selectAnswer(choiceIndex){
      const q = lessonData.questions[currentQuestion];
      const choices = document.querySelectorAll('.choice');
      const timeSpent = Date.now() - questionStartTime;

      choices.forEach(c=>{ c.style.pointerEvents='none'; });

      choices.forEach(c=>{
        c.classList.remove('selected','correct','incorrect');
        const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
        if (originalIndex === choiceIndex){
          c.classList.add('selected');
        }
      });

      setTimeout(()=>{
        const isCorrect = choiceIndex === q.correct;
        choices.forEach(c=>{
          const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
          if (originalIndex === q.correct){
            c.classList.add('correct');
          } else if (originalIndex === choiceIndex && !isCorrect){
            c.classList.add('incorrect');
          }
        });

        const expEl = document.getElementById('explanation');
        expEl.innerHTML = '<h4>解説</h4><p>' + q.explanation + '</p>';
        expEl.classList.add('show');

        if (isCorrect) score++;

        learningTracker.recordAnswer(
          q.id || currentQuestion,
          choiceIndex,
          q.correct,
          Math.round(timeSpent/1000)
        );
        sendQuestionAnswerToParent(q, choiceIndex, isCorrect);
      }, 500);
    }

    function previousQuestion(){
      if (currentQuestion>0){
        currentQuestion--;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function showCurrentSessionResult(){
      const session = learningTracker.currentSession;
      const scorePercent = session.totalQuestions>0
        ? Math.round((session.score/session.totalQuestions)*100)
        : 0;
      let msg = '';
      if (scorePercent >= 90) msg = '🎉 つり合いのきまりをとてもよく理解できています！';
      else if (scorePercent >= 70) msg = '👍 よくできました！';
      else if (scorePercent >= 50) msg = '📚 「重さ×距離」の考え方をもう一度整理してみよう。';
      else msg = '💪 スライダーを動かしながら、てんびんのつり合い方をもう一度確かめてみよう。';

      const totalTime = Date.now() - session.startTime;
      const m = Math.floor(totalTime/60000);
      const s = Math.floor((totalTime%60000)/1000);
      const timeDisp = m>0 ? m+'分'+s+'秒' : s+'秒';

      return `
        <div style="background: linear-gradient(135deg,#64b5f6 0%,#42a5f5 100%); color:white; padding:2rem; border-radius:16px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.3); margin-top:20px;">
          <div style="font-size:1.8rem; font-weight:bold; margin-bottom:1rem;">学習完了！</div>
          <div style="font-size:1.1rem; margin-bottom:1.5rem;">${msg}</div>
          <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
            <div style="font-size:2.5rem; font-weight:bold; margin-bottom:0.5rem;">${session.score}/${session.totalQuestions}問正解</div>
            <div style="font-size:1.5rem; font-weight:600;">${scorePercent}%</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
            <div>学習時間: <strong>${timeDisp}</strong></div>
            <div>完了時刻: <strong>${new Date().toLocaleString('ja-JP',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong></div>
          </div>
        </div>
      `;
    }

    function completeLesson(){
      learningTracker.saveSession();
      const messageData = {
        type:'lesson:complete',
        lessonId: lessonData.id,
        detail:{
          correct: learningTracker.currentSession.score,
          total: learningTracker.currentSession.totalQuestions,
          timeSec: Math.round((Date.now()-learningTracker.currentSession.startTime)/1000)
        }
      };
      console.log('🚀 完了メッセージ送信:', messageData);
      try{ if (window.parent !== window) window.parent.postMessage(messageData,'*'); }catch(e){}
      try{ if (window.top !== window) window.top.postMessage(messageData,'*'); }catch(e){}

      try{
        const storageMessage = { type:'lesson:complete', data:messageData, timestamp:Date.now() };
        localStorage.setItem('lessonCompleteMessage', JSON.stringify(storageMessage));
        if (window.parent && window.parent.saveLessonProgress){
          window.parent.saveLessonProgress(
            messageData.lessonId,
            messageData.detail.correct,
            messageData.detail.total,
            messageData.detail.timeSec
          );
        }
      }catch(e){ console.log('localStorage/saveLessonProgress エラー', e); }

      document.getElementById('question-container').style.display='none';
      const resultContainer = document.createElement('div');
      resultContainer.className='question-container';
      resultContainer.style.display='block';
      resultContainer.innerHTML = showCurrentSessionResult();

      const homeButton = document.createElement('button');
      homeButton.textContent = '🏠 ホームに戻る';
      homeButton.className = 'start-learning-btn';
      homeButton.style.marginTop = '1.5rem';
      homeButton.onclick = ()=>{
        if (window.parent !== window || window.top !== window){
          try{
            window.parent.postMessage({type:'lesson:goBack'}, '*');
            window.top.postMessage({type:'lesson:goBack'}, '*');
            return;
          }catch(e){}
        }
        goHome();
      };
      resultContainer.appendChild(homeButton);
      document.querySelector('.main-container').appendChild(resultContainer);
    }

    function nextQuestion(){
      if (currentQuestion === lessonData.questions.length-1){
        completeLesson();
        return;
      }
      if (currentQuestion < lessonData.questions.length-1){
        currentQuestion++;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function startLearning(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('question-container').style.display = 'block';
      if (lessonData.questions.length > 0){
        showQuestion(0);
      } else {
        alert('問題データがまだ追加されていません。');
      }
    }

    function goHome(){
      window.location.href = '/';
    }
  </script>
</body>
</html>
