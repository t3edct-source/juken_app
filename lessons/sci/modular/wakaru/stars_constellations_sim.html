<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - æ˜Ÿã¨æ˜Ÿåº§</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: radial-gradient(circle at top, #0d1b2a 0%, #000814 45%, #02010a 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color:#f1f5f9;
    }
    .header {
      background: rgba(3, 4, 94, 0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
    }
    .home-btn {
      background:linear-gradient(135deg,#00b4d8,#48cae4);
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:20px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 2px 8px rgba(0,0,0,0.4);
    }
    .home-btn:hover { background:#00a0c6; transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.97); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#e0f7fa;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
      text-align:center;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
      gap:12px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥å…¨ä½“ */
    .sim-container {
      background:rgba(4, 18, 38, 0.96);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.7);
      margin-bottom:10px;
      overflow:hidden;
      position:relative;
      border:1px solid rgba(148, 163, 184, 0.4);
    }
    .sim-header {
      background:radial-gradient(circle at top, #1b263b 0%, #0b1320 60%, #000814 100%);
      color:#e0f7fa;
      padding:14px 15px;
      text-align:center;
      border-bottom:1px solid rgba(148,163,184,0.4);
    }
    .sim-header h2 { font-size:20px; margin-bottom:5px; }
    .sim-header p { font-size:13px; opacity:0.9; }

    .sim-area {
      padding:12px 12px 16px;
    }

    .control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .control-label {
      font-size:13px;
      font-weight:bold;
      color:#a5f3fc;
      min-width:120px;
    }
    .season-tabs {
      display:flex;
      gap:8px;
      flex:1;
    }
    .season-btn {
      flex:1;
      border:none;
      border-radius:20px;
      padding:10px 8px;
      font-size:13px;
      cursor:pointer;
      background:rgba(25,118,210,0.25);
      color:#bbdefb;
      font-weight:bold;
      min-height:40px;
      transition:all .25s ease;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 2px 6px rgba(0,0,0,0.6);
      display:flex;
      justify-content:center;
      align-items:center;
      gap:4px;
    }
    .season-btn span.emoji{font-size:16px;}
    .season-btn.active {
      background:linear-gradient(135deg,#42a5f5,#ab47bc);
      color:#fff;
      box-shadow:0 4px 14px rgba(0,0,0,0.85);
      transform:translateY(-1px);
    }
    .season-desc {
      min-width:120px;
      font-size:11px;
      text-align:right;
      color:#c5cae9;
    }

    .sim-field {
      margin-top:6px;
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:10px;
    }

    /* â–¼ å…¬è»¢å›³å´ */
    .orbit-panel {
      position:relative;
      border-radius:14px;
      background:radial-gradient(circle at center,#1a237e 0%,#000015 55%,#000 100%);
      min-height:230px;
      overflow:hidden;
      box-shadow:inset 0 0 30px rgba(0,0,0,0.9);
      border:1px solid rgba(144,202,249,0.3);
    }
    .starfield {
      position:absolute;
      inset:0;
      background-image:
        radial-gradient(2px 2px at 10% 20%,rgba(255,255,255,0.9),transparent),
        radial-gradient(1.5px 1.5px at 30% 80%,rgba(187,222,251,0.9),transparent),
        radial-gradient(1.5px 1.5px at 70% 30%,rgba(255,255,255,0.8),transparent),
        radial-gradient(2px 2px at 90% 60%,rgba(179,229,252,0.95),transparent),
        radial-gradient(1px 1px at 20% 60%,rgba(255,255,255,0.7),transparent);
      opacity:.6;
      animation:twinkle 6s ease-in-out infinite alternate;
    }
    @keyframes twinkle {
      0% {opacity:.4;transform:scale(1);}
      50% {opacity:.9;transform:scale(1.02);}
      100% {opacity:.5;transform:scale(1.01);}
    }

    .sun {
      position:absolute;
      left:50%;
      top:50%;
      width:56px;
      height:56px;
      margin:-28px 0 0 -28px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#fff59d,#ffca28,#f57f17);
      box-shadow:0 0 40px rgba(255,235,59,0.8),0 0 80px rgba(255,193,7,0.6);
      animation:pulseSun 4s ease-in-out infinite;
    }
    @keyframes pulseSun {
      0%,100% {transform:scale(1);}
      50% {transform:scale(1.05);}
    }

    .orbit {
      position:absolute;
      left:50%;
      top:50%;
      width:200px;
      height:140px;
      margin:-70px 0 0 -100px;
      border-radius:50%;
      border:1px dashed rgba(144,202,249,0.6);
      transform:rotate(-20deg);
      box-shadow:0 0 20px rgba(144,202,249,0.4);
    }

    .earth-orbit-pos {
      position:absolute;
      width:100%;
      height:100%;
      transform-origin:50% 50%;
      transition:transform .8s ease-in-out;
    }
    .earth {
      position:absolute;
      width:26px;
      height:26px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#e3f2fd,#42a5f5,#1a237e);
      box-shadow:0 0 15px rgba(129,212,250,0.9);
      top:50%;
      left:100%;
      margin:-13px 0 0 -13px;
    }
    .earth::after {
      content:"ğŸŒ";
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:18px;
      text-shadow:0 0 6px rgba(0,0,0,0.7);
    }

    .night-arrow {
      position:absolute;
      left:50%;
      top:50%;
      width:100px;
      height:2px;
      background:linear-gradient(90deg,transparent,#bbdefb);
      transform-origin:0 50%;
      transform:rotate(0deg);
      transition:transform .8s ease-in-out;
      opacity:.9;
    }
    .night-arrow::after {
      content:"å¤œã®ç©ºã®å‘ã";
      position:absolute;
      right:-6px;
      top:-18px;
      font-size:11px;
      color:#e3f2fd;
      text-shadow:0 0 4px #000;
    }

    /* â–¼ å¤œç©ºãƒ»æ˜Ÿåº§ãƒ‘ãƒãƒ« */
    .sky-panel {
      position:relative;
      border-radius:14px;
      background:radial-gradient(circle at top,#1a237e 0%,#000015 65%,#000 100%);
      min-height:230px;
      overflow:hidden;
      box-shadow:inset 0 0 30px rgba(0,0,0,0.9);
      border:1px solid rgba(179,136,255,0.5);
    }
    .sky-stars {
      position:absolute;
      inset:0;
      background-image:
        radial-gradient(1.5px 1.5px at 15% 10%,rgba(255,255,255,0.9),transparent),
        radial-gradient(2px 2px at 60% 25%,rgba(206,147,216,0.95),transparent),
        radial-gradient(1.5px 1.5px at 85% 70%,rgba(129,212,250,0.9),transparent),
        radial-gradient(1.2px 1.2px at 35% 80%,rgba(255,255,255,0.8),transparent),
        radial-gradient(1.2px 1.2px at 70% 50%,rgba(255,241,118,0.9),transparent);
      opacity:.7;
      animation:twinkle 5.5s ease-in-out infinite alternate;
    }
    .sky-horizon {
      position:absolute;
      left:-10%;
      right:-10%;
      bottom:-5%;
      height:40%;
      background:linear-gradient(to top,#263238 0%,transparent 80%);
    }

    .constellation-name {
      position:absolute;
      bottom:14px;
      left:14px;
      padding:7px 11px;
      border-radius:18px;
      background:rgba(0,0,0,0.7);
      border:1px solid rgba(187,222,251,0.6);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:5px;
    }
    .constellation-name span.emoji {
      font-size:18px;
      filter:drop-shadow(0 0 4px rgba(255,255,255,0.8));
      animation:float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%,100% {transform:translateY(0);}
      50% {transform:translateY(-3px);}
    }

    .constellation-lines {
      position:absolute;
      inset:18% 10% 32% 10%;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .constellation-svg {
      width:100%;
      height:100%;
      filter:drop-shadow(0 0 6px rgba(255,255,255,0.7));
    }
    .constellation-svg line {
      stroke:#fff;
      stroke-width:1.2;
      stroke-linecap:round;
      stroke-dasharray:4 3;
      animation:drawLine 4s linear infinite alternate;
    }
    .constellation-svg circle {
      fill:#fff;
      animation:twinkle 4s ease-in-out infinite alternate;
    }
    @keyframes drawLine {
      0% {stroke-dashoffset:20;}
      100% {stroke-dashoffset:0;}
    }

    /* åŒ—æ–—ä¸ƒæ˜Ÿï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ */
    .dipper {
      position:absolute;
      top:15%;
      left:10%;
      width:35%;
      height:25%;
    }
    .dipper-svg {
      width:100%;
      height:100%;
      filter:drop-shadow(0 0 4px rgba(255,255,255,0.6));
    }
    .dipper-svg line {
      stroke:#e3f2fd;
      stroke-width:1.5;
      stroke-linecap:round;
      opacity:0.8;
    }
    .dipper-svg circle {
      fill:#fff;
      opacity:0.9;
    }

    .season-caption {
      position:absolute;
      top:10px;
      right:12px;
      font-size:11px;
      padding:5px 9px;
      border-radius:14px;
      background:rgba(0,0,0,0.65);
      border:1px solid rgba(187,222,251,0.5);
    }

    .sim-comment {
      margin-top:10px;
      font-size:13px;
      line-height:1.7;
      color:#e3f2fd;
      background:linear-gradient(135deg,rgba(13,71,161,0.8),rgba(81,45,168,0.85));
      border-radius:12px;
      padding:10px 12px;
      border-left:5px solid #42a5f5;
      box-shadow:0 2px 10px rgba(0,0,0,0.8);
    }
    .sim-comment strong {color:#fff59d;}

    /* â–¼ infoãƒ‘ãƒãƒ« */
    .info-panel {
      background:rgba(13,13,40,0.96);
      border-radius:16px;
      box-shadow:0 10px 35px rgba(0,0,0,0.8);
      padding:18px;
    }
    .info-panel h3 {
      font-size:17px;
      margin-bottom:12px;
      color:#e3f2fd;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
    }
    .info-item {
      background:rgba(21,21,60,0.9);
      padding:12px;
      border-radius:10px;
      border-left:4px solid #42a5f5;
    }
    .info-item h4 {
      font-size:14px;
      color:#bbdefb;
      margin-bottom:6px;
    }
    .info-item p {
      font-size:13px;
      color:#e0e0e0;
      line-height:1.5;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background:rgba(13,13,40,0.96);
      border-radius:16px;
      box-shadow:0 10px 35px rgba(0,0,0,0.8);
      padding:18px;
      margin-bottom:6px;
    }
    .question-text {
      font-size:16px;
      font-weight:bold;
      margin-bottom:12px;
    }
    .progress-bar {
      background:#263238;
      border-radius:8px;
      height:8px;
      margin:10px 0 16px;
      overflow:hidden;
    }
    .progress-fill {
      background:linear-gradient(90deg,#42a5f5,#ab47bc);
      height:100%;
      width:0;
      transition:width .3s ease;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choice {
      padding:12px 14px;
      background:#1c2540;
      border:2px solid #37474f;
      border-radius:10px;
      cursor:pointer;
      transition:all .25s ease;
      font-size:14px;
      min-height:48px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .choice:hover {
      background:#283655;
      border-color:#64b5f6;
    }
    .choice.correct {
      background:#2e7d32;
      border-color:#81c784;
      animation:correctPulse .6s ease;
      color:#e8f5e9;
    }
    .choice.incorrect {
      background:#b71c1c;
      border-color:#ef9a9a;
      animation:wrongShake .6s ease;
      color:#ffebee;
    }
    @keyframes correctPulse {
      0%,100% {transform:scale(1);}
      50% {transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100% {transform:translateX(0);}
      25% {transform:translateX(-8px);}
      75% {transform:translateX(8px);}
    }
    .explanation {
      margin-top:14px;
      padding:12px;
      background:#1c2540;
      border-radius:10px;
      border-left:4px solid #42a5f5;
      display:none;
      font-size:13px;
      line-height:1.6;
    }
    .explanation.show {display:block;}
    .explanation h4 {
      color:#bbdefb;
      margin-bottom:6px;
      font-size:13px;
    }
    .navigation {
      margin-top:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .nav-btn {
      padding:12px 20px;
      border:none;
      border-radius:22px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all .25s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:.4;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#546e7a;
      color:#eceff1;
    }
    .prev-btn:hover:not(:disabled) {background:#455a64;}
    .next-btn {
      background:#42a5f5;
      color:#0d47a1;
    }
    .next-btn:hover:not(:disabled) {background:#1e88e5;color:#e3f2fd;}

    * {touch-action:manipulation;}
    .choice,.nav-btn,.home-btn,.season-btn {-webkit-tap-highlight-color:transparent;}

    @media(max-width:768px){
      .main-container {padding:10px;}
      .sim-field {
        grid-template-columns:1fr;
      }
      .orbit-panel,.sky-panel {min-height:210px;}
      .question-container,.info-panel {padding:15px;}
      .question-text {font-size:15px;}
      .choice {font-size:13px;padding:11px 12px;}
      .info-grid {grid-template-columns:1fr;}
      .lesson-title {font-size:14px;}
    }
  </style>
</head>
<body>
<header class="header">
  <button class="home-btn" onclick="goHome()">ãƒ›ãƒ¼ãƒ </button>
  <div class="lesson-title">æ˜Ÿã¨æ˜Ÿåº§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå­£ç¯€ã¨æ˜Ÿåº§ï¼‰</div>
  <div style="width:80px;"></div>
</header>

<main class="main-container">
  <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ -->
  <section class="sim-container">
    <div class="sim-header">
      <h2>åœ°çƒã®å…¬è»¢ã¨ å­£ç¯€ã®æ˜Ÿåº§ã®è¦‹ãˆæ–¹</h2>
      <p>æ˜¥ãƒ»å¤ãƒ»ç§‹ãƒ»å†¬ã§ã€Œå¤œã«è¦‹ãˆã‚‹æ˜Ÿåº§ã€ãŒå¤‰ã‚ã‚‹ã®ã¯ã€åœ°çƒãŒå¤ªé™½ã®ã¾ã‚ã‚Šã‚’å…¬è»¢ã—ã¦ã„ã‚‹ã‹ã‚‰ã ã‚ˆã€‚</p>
    </div>
    <div class="sim-area">
      <div class="control-row">
        <div class="control-label">å­£ç¯€ã‚’ãˆã‚‰ã¶</div>
        <div class="season-tabs">
          <button class="season-btn active" data-season="spring" id="btnSpring">
            <span class="emoji">ğŸŒ¸</span><span>æ˜¥ï¼ˆæ˜¥åˆ†ã®ã“ã‚ï¼‰</span>
          </button>
          <button class="season-btn" data-season="summer" id="btnSummer">
            <span class="emoji">ğŸŒ»</span><span>å¤ï¼ˆå¤è‡³ã®ã“ã‚ï¼‰</span>
          </button>
          <button class="season-btn" data-season="autumn" id="btnAutumn">
            <span class="emoji">ğŸ</span><span>ç§‹ï¼ˆç§‹åˆ†ã®ã“ã‚ï¼‰</span>
          </button>
          <button class="season-btn" data-season="winter" id="btnWinter">
            <span class="emoji">â„ï¸</span><span>å†¬ï¼ˆå†¬è‡³ã®ã“ã‚ï¼‰</span>
          </button>
        </div>
        <div class="season-desc" id="seasonDesc">æ˜¥ã®å¤œï¼šã—ã—åº§ãŒã‚ˆãè¦‹ãˆã‚‹</div>
      </div>

      <div class="sim-field">
        <!-- å…¬è»¢å›³ -->
        <div class="orbit-panel">
          <div class="starfield"></div>
          <div class="sun"></div>
          <div class="orbit"></div>
          <div class="earth-orbit-pos" id="earthOrbit">
            <div class="earth"></div>
          </div>
          <div class="night-arrow" id="nightArrow"></div>
        </div>

        <!-- å¤œç©º & æ˜Ÿåº§ -->
        <div class="sky-panel">
          <div class="sky-stars"></div>
          <div class="sky-horizon"></div>

          <div class="season-caption" id="skySeasonCaption">æ˜¥ã®å¤œç©º</div>

          <!-- åŒ—æ–—ä¸ƒæ˜Ÿï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
          <div class="dipper">
            <svg class="dipper-svg" viewBox="0 0 100 70">
              <circle cx="15" cy="20" r="2"/>
              <circle cx="25" cy="15" r="2"/>
              <circle cx="35" cy="10" r="2"/>
              <circle cx="45" cy="12" r="2"/>
              <circle cx="50" cy="25" r="2"/>
              <circle cx="55" cy="40" r="2"/>
              <circle cx="60" cy="55" r="2"/>
              <line x1="15" y1="20" x2="25" y2="15"/>
              <line x1="25" y1="15" x2="35" y2="10"/>
              <line x1="35" y1="10" x2="45" y2="12"/>
              <line x1="45" y1="12" x2="50" y2="25"/>
              <line x1="50" y1="25" x2="55" y2="40"/>
              <line x1="55" y1="40" x2="60" y2="55"/>
            </svg>
          </div>

          <div class="constellation-lines" id="constellationLines">
            <!-- SVGã¯JSã§å·®ã—æ›¿ãˆ -->
            <svg class="constellation-svg" viewBox="0 0 100 60">
              <circle cx="10" cy="40" r="1.5"/>
              <circle cx="30" cy="25" r="1.5"/>
              <circle cx="50" cy="20" r="1.5"/>
              <circle cx="70" cy="30" r="1.5"/>
              <circle cx="85" cy="15" r="1.5"/>
              <line x1="10" y1="40" x2="30" y2="25"/>
              <line x1="30" y1="25" x2="50" y2="20"/>
              <line x1="50" y1="20" x2="70" y2="30"/>
              <line x1="70" y1="30" x2="85" y2="15"/>
            </svg>
          </div>

          <div class="constellation-name" id="constellationName">
            <span class="emoji" id="constellationEmoji">ğŸ¦</span>
            <span id="constellationText">æ˜¥ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ï¼šã—ã—åº§</span>
          </div>
        </div>
      </div>

      <div class="sim-comment" id="simComment">
        <strong>æ˜¥åˆ†ã®ã“ã‚</strong>ã€å¤œã«ã¯å¤ªé™½ã¨åå¯¾å´ã®ç©ºã«ã‚ã‚‹ã€Œã—ã—åº§ã€ãªã©ãŒã‚ˆãè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚åœ°çƒãŒå¤ªé™½ã®ã¾ã‚ã‚Šã‚’å‹•ãã“ã¨ã§ã€å¤œã«å‘ã„ã¦ã„ã‚‹æ–¹å‘ãŒå°‘ã—ãšã¤å¤‰ã‚ã‚Šã€å­£ç¯€ã”ã¨ã«è¦‹ãˆã‚‹æ˜Ÿåº§ãŒå¤‰åŒ–ã—ã¾ã™ã€‚
      </div>
    </div>
  </section>

  <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆ(info-panel) -->
  <section class="info-panel">
    <h3>å­£ç¯€ã”ã¨ã«å¤‰ã‚ã‚‹æ˜Ÿåº§</h3>
    <div class="info-grid">
      <div class="info-item">
        <h4>â‘  åœ°çƒã®å…¬è»¢ã¨å­£ç¯€ã®æ˜Ÿåº§</h4>
        <p>
          åœ°çƒã¯ä¸€å¹´ã‹ã‘ã¦å¤ªé™½ã®ã¾ã‚ã‚Šã‚’<strong>å…¬è»¢</strong>ã—ã¦ã„ã¾ã™ã€‚åœ°çƒã®ä½ç½®ãŒå¤‰ã‚ã‚‹ã¨ã€å¤œã«å¤ªé™½ã¨åå¯¾å´ã«è¦‹ãˆã‚‹å®‡å®™ã®æ–¹å‘ã‚‚å¤‰ã‚ã‚‹ãŸã‚ã€
          æ˜¥ã«ã¯ã—ã—åº§ã€å¤ã«ã¯ã•ãã‚Šåº§ã€ç§‹ã«ã¯ãƒšã‚¬ã‚¹ã‚¹åº§ã€å†¬ã«ã¯ã‚ªãƒªã‚ªãƒ³åº§ã®ã‚ˆã†ã«ã€å­£ç¯€ã”ã¨ã«ä¸»å½¹ã«ãªã‚‹æ˜Ÿåº§ãŒå…¥ã‚Œã‹ã‚ã‚Šã¾ã™ã€‚
        </p>
      </div>
      <div class="info-item">
        <h4>â‘¡ å­£ç¯€ã®ä»£è¡¨çš„ãªæ˜Ÿåº§</h4>
        <p>
          ãã‚Œãã‚Œã®å­£ç¯€ã«ã¯ã€å½¢ãŒåˆ†ã‹ã‚Šã‚„ã™ã„<strong>ä»£è¡¨çš„ãªæ˜Ÿåº§</strong>ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€æ˜¥ã¯<strong>ã—ã—åº§</strong>ã€å¤ã¯èµ¤ã„ã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ãŒç›®ç«‹ã¤<strong>ã•ãã‚Šåº§</strong>ã€
          ç§‹ã¯å››è§’å½¢ã®<strong>ãƒšã‚¬ã‚¹ã‚¹åº§</strong>ã€å†¬ã¯ä¸‰ã¤æ˜ŸãŒãªã‚‰ã¶<strong>ã‚ªãƒªã‚ªãƒ³åº§</strong>ãªã©ã§ã™ã€‚
        </p>
      </div>
      <div class="info-item">
        <h4>â‘¢ åŒ—æ–—ä¸ƒæ˜Ÿã«ã¤ã„ã¦</h4>
        <p>
          <strong>åŒ—æ–—ä¸ƒæ˜Ÿ</strong>ã¯ã€å­£ç¯€ã«é–¢ä¿‚ãªãåŒ—ã®ç©ºã«è¦‹ãˆã‚‹æ˜Ÿåº§ã§ã™ã€‚ã²ã—ã‚ƒãã®å½¢ã‚’ã—ã¦ã„ã¦ã€ãã®å…ˆã‚’ãŸã©ã‚‹ã¨åŒ—æ¥µæ˜Ÿã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
          åŒ—æ–—ä¸ƒæ˜Ÿã¯ä¸€å¹´ä¸­è¦‹ãˆã‚‹ã®ã§ã€æ–¹è§’ã‚’çŸ¥ã‚‹æ‰‹ãŒã‹ã‚Šã¨ã—ã¦æ˜”ã‹ã‚‰åˆ©ç”¨ã•ã‚Œã¦ãã¾ã—ãŸã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- â–¼ ã‚ã‹ã‚‹ç·¨ 3å• -->
  <section class="question-container">
    <div class="question-text" id="questionText"></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="choices" id="choicesContainer"></div>
    <div class="explanation" id="explanationBox">
      <h4>è§£èª¬</h4>
      <p id="explanationText"></p>
    </div>
    <div class="navigation">
      <button class="nav-btn prev-btn" id="prevBtn">å‰ã®å•é¡Œã¸</button>
      <button class="nav-btn next-btn" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>
    </div>
    <div id="historyDisplay"></div>
  </section>
</main>

<script>
  /************ LearningTracker ************/
  class LearningTracker{
    constructor(lessonId){
      this.lessonId = lessonId;
      this.storageKey = "stepnavi_science_" + lessonId;
      this.currentSession = null;
      this.history = this.loadHistory();
    }
    loadHistory(){
      try{
        const raw = localStorage.getItem(this.storageKey);
        return raw ? JSON.parse(raw) : {sessions:[]};
      }catch(e){
        console.warn("Failed to load history:",e);
        return {sessions:[]};
      }
    }
    startSession(){
      this.currentSession = {
        startedAt:Date.now(),
        answered:0,
        correct:0,
        records:[]
      };
    }
    recordAnswer(questionIndex,isCorrect){
      if(!this.currentSession) this.startSession();
      const now = Date.now();
      this.currentSession.answered++;
      if(isCorrect) this.currentSession.correct++;
      this.currentSession.records.push({
        questionIndex,
        isCorrect,
        answeredAt:now
      });
      this.postToParent("question:answered",{
        lessonId:this.lessonId,
        questionIndex,
        isCorrect,
        timestamp:now
      });
    }
    completeLesson(totalQuestions){
      if(!this.currentSession) return;
      const now = Date.now();
      const durationMs = now - this.currentSession.startedAt;
      const summary = {
        ...this.currentSession,
        finishedAt:now,
        durationMs,
        totalQuestions
      };
      this.history.sessions.push(summary);
      try{
        localStorage.setItem(this.storageKey,JSON.stringify(this.history));
      }catch(e){
        console.warn("Failed to save history:",e);
      }
      this.postToParent("lesson:complete",{
        lessonId:this.lessonId,
        totalQuestions,
        answered:this.currentSession.answered,
        correct:this.currentSession.correct,
        durationMs
      });
      this.currentSession = null;
    }
    postToParent(type,payload){
      try{
        if(window.parent && window.parent !== window){
          window.parent.postMessage({type,payload},"*");
        }
      }catch(e){
        console.warn("postMessage failed:",e);
      }
    }
  }

  const LESSON_ID = "sci.earth.stars_constellations_sim";
  const tracker = new LearningTracker(LESSON_ID);

  /************ å­£ç¯€ã‚·ãƒŸãƒ¥åˆ¶å¾¡ ************/
  const earthOrbit = document.getElementById("earthOrbit");
  const nightArrow = document.getElementById("nightArrow");
  const seasonDesc = document.getElementById("seasonDesc");
  const skySeasonCaption = document.getElementById("skySeasonCaption");
  const constellationName = document.getElementById("constellationName");
  const constellationEmoji = document.getElementById("constellationEmoji");
  const constellationText = document.getElementById("constellationText");
  const constellationLines = document.getElementById("constellationLines");
  const simComment = document.getElementById("simComment");

  const seasonButtons = [
    document.getElementById("btnSpring"),
    document.getElementById("btnSummer"),
    document.getElementById("btnAutumn"),
    document.getElementById("btnWinter")
  ];

  let currentSeason = "spring";

  const seasonData = {
    spring:{
      orbitDeg:0,
      nightDeg:180,
      desc:"æ˜¥ã®å¤œï¼šã—ã—åº§ãªã©ãŒã‚ˆãè¦‹ãˆã‚‹",
      skyCaption:"æ˜¥ã®å¤œç©º",
      emoji:"ğŸ¦",
      label:"æ˜¥ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ï¼šã—ã—åº§",
      comment:"<strong>æ˜¥åˆ†ã®ã“ã‚</strong>ã€å¤œã«ã¯ã—ã—åº§ãªã©æ˜¥ã®æ˜Ÿåº§ãŒã‚ˆãè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚åœ°çƒãŒå…¬è»¢ã™ã‚‹ã“ã¨ã§ã€å¤œã«å‘ã„ã¦ã„ã‚‹æ–¹å‘ãŒå¤‰ã‚ã‚Šã€æ˜¥ã«ã¯æ˜¥ã®æ˜Ÿåº§ãŒä¸»å½¹ã«ãªã‚Šã¾ã™ã€‚",
      svg:`
        <svg class="constellation-svg" viewBox="0 0 100 60">
          <!-- ã—ã—åº§ï¼šãƒ©ã‚¤ã‚ªãƒ³ã®é ­éƒ¨ï¼ˆéŒå½¢ï¼‰ã€èƒ´ä½“ã€å°¾ -->
          <circle cx="15" cy="15" r="1.5"/>
          <circle cx="25" cy="20" r="1.5"/>
          <circle cx="35" cy="25" r="1.5"/>
          <circle cx="50" cy="30" r="2" fill="#fff59d"/>
          <circle cx="65" cy="35" r="1.5"/>
          <circle cx="75" cy="40" r="1.5"/>
          <circle cx="80" cy="50" r="1.5"/>
          <line x1="15" y1="15" x2="25" y2="20"/>
          <line x1="25" y1="20" x2="35" y2="25"/>
          <line x1="35" y1="25" x2="50" y2="30"/>
          <line x1="50" y1="30" x2="65" y2="35"/>
          <line x1="65" y1="35" x2="75" y2="40"/>
          <line x1="75" y1="40" x2="80" y2="50"/>
        </svg>`
    },
    summer:{
      orbitDeg:90,
      nightDeg:270,
      desc:"å¤ã®å¤œï¼šã•ãã‚Šåº§ãªã©ãŒã‚ˆãè¦‹ãˆã‚‹",
      skyCaption:"å¤ã®å¤œç©º",
      emoji:"ğŸ¦‚",
      label:"å¤ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ï¼šã•ãã‚Šåº§",
      comment:"<strong>å¤è‡³ã®ã“ã‚</strong>ã€å¤œã«ã¯ã•ãã‚Šåº§ãªã©å¤ã®æ˜Ÿåº§ãŒã‚ˆãè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚èµ¤ãå…‰ã‚‹ã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ã‚’ãµãã‚€ã•ãã‚Šåº§ã¯ã€å¤ã‚’ä»£è¡¨ã™ã‚‹æ˜Ÿåº§ã§ã™ã€‚",
      svg:`
        <svg class="constellation-svg" viewBox="0 0 100 60">
          <!-- ã•ãã‚Šåº§ï¼šé ­éƒ¨ã€èƒ´ä½“ã€æ›²ãŒã£ãŸå°¾ã€ã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ï¼ˆå¿ƒè‡“éƒ¨åˆ†ï¼‰ã‚’å¼·èª¿ -->
          <circle cx="20" cy="12" r="1.5"/>
          <circle cx="30" cy="18" r="1.5"/>
          <circle cx="40" cy="25" r="2.5" fill="#ff6b6b"/>
          <circle cx="50" cy="32" r="1.5"/>
          <circle cx="60" cy="40" r="1.5"/>
          <circle cx="68" cy="48" r="1.5"/>
          <circle cx="75" cy="52" r="1.5"/>
          <line x1="20" y1="12" x2="30" y2="18"/>
          <line x1="30" y1="18" x2="40" y2="25"/>
          <line x1="40" y1="25" x2="50" y2="32"/>
          <line x1="50" y1="32" x2="60" y2="40"/>
          <line x1="60" y1="40" x2="68" y2="48"/>
          <line x1="68" y1="48" x2="75" y2="52"/>
        </svg>`
    },
    autumn:{
      orbitDeg:180,
      nightDeg:0,
      desc:"ç§‹ã®å¤œï¼šãƒšã‚¬ã‚¹ã‚¹åº§ãªã©ãŒã‚ˆãè¦‹ãˆã‚‹",
      skyCaption:"ç§‹ã®å¤œç©º",
      emoji:"ğŸ´",
      label:"ç§‹ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ï¼šãƒšã‚¬ã‚¹ã‚¹åº§",
      comment:"<strong>ç§‹åˆ†ã®ã“ã‚</strong>ã€å¤œã«ã¯ãƒšã‚¬ã‚¹ã‚¹åº§ãªã©ç§‹ã®æ˜Ÿåº§ãŒé«˜ãã®ã¼ã£ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å››è§’å½¢ã®ã€Œç§‹ã®å››è¾ºå½¢ã€ãŒç›®å°ã§ã™ã€‚",
      svg:`
        <svg class="constellation-svg" viewBox="0 0 100 60">
          <circle cx="20" cy="20" r="1.5"/>
          <circle cx="60" cy="20" r="1.5"/>
          <circle cx="60" cy="45" r="1.5"/>
          <circle cx="20" cy="45" r="1.5"/>
          <line x1="20" y1="20" x2="60" y2="20"/>
          <line x1="60" y1="20" x2="60" y2="45"/>
          <line x1="60" y1="45" x2="20" y2="45"/>
          <line x1="20" y1="45" x2="20" y2="20"/>
        </svg>`
    },
    winter:{
      orbitDeg:270,
      nightDeg:90,
      desc:"å†¬ã®å¤œï¼šã‚ªãƒªã‚ªãƒ³åº§ãªã©ãŒã‚ˆãè¦‹ãˆã‚‹",
      skyCaption:"å†¬ã®å¤œç©º",
      emoji:"ğŸ¹",
      label:"å†¬ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ï¼šã‚ªãƒªã‚ªãƒ³åº§",
      comment:"<strong>å†¬è‡³ã®ã“ã‚</strong>ã€å¤œã«ã¯ã‚ªãƒªã‚ªãƒ³åº§ãªã©å†¬ã®æ˜Ÿåº§ãŒã‚ˆãè¦‹ãˆã¾ã™ã€‚ä¸‰ã¤æ˜ŸãŒä¸€ç›´ç·šã«ãªã‚‰ã¶ã‚ªãƒªã‚ªãƒ³åº§ã¯ã€å†¬ã®å¤œç©ºã§ã‚‚ã£ã¨ã‚‚ç›®ç«‹ã¤æ˜Ÿåº§ã®ä¸€ã¤ã§ã™ã€‚",
      svg:`
        <svg class="constellation-svg" viewBox="0 0 100 60">
          <!-- ã‚ªãƒªã‚ªãƒ³åº§ï¼šä¸‰ã¤æ˜Ÿï¼ˆãƒ™ãƒ«ãƒˆï¼‰ãŒä¸­å¤®ã€ä¸Šä¸‹ã«æ˜ã‚‹ã„æ˜Ÿ -->
          <circle cx="50" cy="12" r="2" fill="#ff9800"/>
          <circle cx="35" cy="28" r="1.5"/>
          <circle cx="50" cy="28" r="2" fill="#fff59d"/>
          <circle cx="65" cy="28" r="1.5"/>
          <circle cx="50" cy="48" r="2" fill="#64b5f6"/>
          <line x1="50" y1="12" x2="35" y2="28"/>
          <line x1="50" y1="12" x2="65" y2="28"/>
          <line x1="35" y1="28" x2="50" y2="28"/>
          <line x1="50" y1="28" x2="65" y2="28"/>
          <line x1="35" y1="28" x2="50" y2="48"/>
          <line x1="65" y1="28" x2="50" y2="48"/>
        </svg>`
    }
  };

  function setSeason(season){
    currentSeason = season;
    seasonButtons.forEach(btn=>{
      btn.classList.toggle("active",btn.dataset.season===season);
    });

    const data = seasonData[season];
    earthOrbit.style.transform = "rotate(" + data.orbitDeg + "deg)";
    nightArrow.style.transform = "rotate(" + data.nightDeg + "deg)";

    seasonDesc.textContent = data.desc;
    skySeasonCaption.textContent = data.skyCaption;
    constellationEmoji.textContent = data.emoji;
    constellationText.textContent = data.label;
    simComment.innerHTML = data.comment;

    constellationLines.innerHTML = data.svg;
  }

  seasonButtons.forEach(btn=>{
    btn.addEventListener("click",()=>setSeason(btn.dataset.season));
  });

  setSeason("spring");

  /************ ã‚ã‹ã‚‹ç·¨ï¼š3å• ************/
  const questions = [
    {
      id:"q1",
      text:"å­£ç¯€ã«ã‚ˆã£ã¦å¤œã«è¦‹ãˆã‚‹æ˜Ÿåº§ãŒå¤‰ã‚ã‚‹ä¸»ãªãŠã‚‚ãªç†ç”±ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
      choices:[
        "åœ°çƒãŒå¤ªé™½ã®ã¾ã‚ã‚Šã‚’å…¬è»¢ã—ã¦ã„ã‚‹ã‹ã‚‰",
        "åœ°çƒãŒ1æ—¥ã«1å›è‡ªè»¢ã—ã¦ã„ã‚‹ã‹ã‚‰",
        "æ˜ŸãŒè‡ªåˆ†ã§å‹•ãå›ã£ã¦ã„ã‚‹ã‹ã‚‰",
        "æœˆã®æº€ã¡æ¬ ã‘ãŒå¤‰ã‚ã‚‹ã‹ã‚‰"
      ],
      correct:0,
      explanation:"å­£ç¯€ã”ã¨ã«è¦‹ãˆã‚‹æ˜Ÿåº§ãŒå¤‰ã‚ã‚‹ã®ã¯ã€åœ°çƒãŒä¸€å¹´ã‹ã‘ã¦å¤ªé™½ã®ã¾ã‚ã‚Šã‚’<strong>å…¬è»¢</strong>ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚åœ°çƒã®ä½ç½®ãŒå¤‰ã‚ã‚‹ã¨ã€å¤œã«å¤ªé™½ã¨åå¯¾å´ã«è¦‹ãˆã‚‹æ–¹å‘ã‚‚å¤‰ã‚ã‚Šã€ãã®æ–¹å‘ã«ã‚ã‚‹æ˜Ÿåº§ãŒå­£ç¯€ã®æ˜Ÿåº§ã¨ã—ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚"
    },
    {
      id:"q2",
      text:"å¤ã®å¤œç©ºã‚’ä»£è¡¨ã™ã‚‹æ˜Ÿåº§ã¨ã—ã¦ã€ã‚‚ã£ã¨ã‚‚é©ã—ã¦ã„ã‚‹ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
      choices:[
        "ã•ãã‚Šåº§",
        "ã‚ªãƒªã‚ªãƒ³åº§",
        "ã—ã—åº§",
        "ãƒšã‚¬ã‚¹ã‚¹åº§"
      ],
      correct:0,
      explanation:"å¤ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ã¯<strong>ã•ãã‚Šåº§</strong>ã§ã™ã€‚èµ¤ãæ˜ã‚‹ãå…‰ã‚‹ã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ã‚’ä¸­å¿ƒã«ã€æ›²ãŒã£ãŸå°¾ã®ã‚ˆã†ãªå½¢ãŒç‰¹å¾´ã§ã€å¤ã®å¤œç©ºã§ã¨ã¦ã‚‚ç›®ç«‹ã¤æ˜Ÿåº§ã§ã™ã€‚"
    },
    {
      id:"q3",
      text:"å†¬ã®å¤œç©ºã§ä¸‰ã¤æ˜ŸãŒãªã‚‰ã¶å½¢ãŒç›®ç«‹ã¤ã€ä»£è¡¨çš„ãªæ˜Ÿåº§ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
      choices:[
        "ã‚ªãƒªã‚ªãƒ³åº§",
        "ã•ãã‚Šåº§",
        "ã—ã—åº§",
        "ãŠãŠãã¾åº§"
      ],
      correct:0,
      explanation:"å†¬ã®ä»£è¡¨çš„ãªæ˜Ÿåº§ã¯<strong>ã‚ªãƒªã‚ªãƒ³åº§</strong>ã§ã™ã€‚çœŸã‚“ä¸­ã«ä¸‰ã¤æ˜ŸãŒä¸€ç›´ç·šã«ãªã‚‰ã¶ã€Œä¸‰ã¤æ˜Ÿã€ãŒã‚ã‚Šã€ãã®ä¸Šä¸‹ã«ã‚‚æ˜ã‚‹ã„æ˜ŸãŒãªã‚‰ã¶ã®ã§ã€ã¨ã¦ã‚‚è¦‹ã¤ã‘ã‚„ã™ã„æ˜Ÿåº§ã§ã™ã€‚"
    }
  ];

  let currentQuestionIndex = 0;
  let answeredFlags = new Array(questions.length).fill(false);

  const questionTextEl = document.getElementById("questionText");
  const choicesContainer = document.getElementById("choicesContainer");
  const explanationBox = document.getElementById("explanationBox");
  const explanationText = document.getElementById("explanationText");
  const progressFill = document.getElementById("progressFill");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  function renderQuestion(index){
    const q = questions[index];
    questionTextEl.textContent = "Q" + (index+1) + ". " + q.text;
    choicesContainer.innerHTML = "";
    explanationBox.classList.remove("show");
    explanationText.innerHTML = "";

    q.choices.forEach((choiceText,i)=>{
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = choiceText;
      btn.dataset.index = i;
      btn.addEventListener("click",()=>handleChoiceClick(index,i,btn));
      choicesContainer.appendChild(btn);
    });

    updateProgress();
    updateNavButtons();
  }

  function handleChoiceClick(qIndex,choiceIndex,btnEl){
    const q = questions[qIndex];
    if(answeredFlags[qIndex]) return;
    const allChoices = choicesContainer.querySelectorAll(".choice");
    allChoices.forEach(el=>el.disabled = true);

    const isCorrect = (choiceIndex === q.correct);
    answeredFlags[qIndex] = true;

    if(isCorrect){
      btnEl.classList.add("correct");
    }else{
      btnEl.classList.add("incorrect");
      const correctBtn = allChoices[q.correct];
      if(correctBtn) correctBtn.classList.add("correct");
    }

    explanationBox.classList.add("show");
    explanationText.innerHTML = q.explanation;

    tracker.recordAnswer(qIndex,isCorrect);
    
    updateProgress();
    updateNavButtons();
    
    if(answeredFlags.every(f=>f)){
      // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ãŸå ´åˆã€å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
      nextBtn.disabled = true;
      prevBtn.disabled = true;
      nextBtn.style.opacity = "0.5";
      prevBtn.style.opacity = "0.5";
      
      setTimeout(() => {
        if(answeredFlags.every(f=>f)){
          showCompletionScreen();
        }
      }, 2000);
    }
  }

  function updateProgress(){
    const answeredCount = answeredFlags.filter(f=>f).length;
    const ratio = answeredCount / questions.length;
    progressFill.style.width = (ratio*100) + "%";
  }

  function updateNavButtons(){
    // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”æ¸ˆã¿ã®å ´åˆã¯ã€å®Œäº†ç”»é¢è¡¨ç¤ºä¸­ãªã®ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    if(answeredFlags.every(f=>f)){
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }
    prevBtn.disabled = (currentQuestionIndex === 0);
    nextBtn.disabled = (currentQuestionIndex === questions.length-1);
  }

  prevBtn.addEventListener("click",()=>{
    if(currentQuestionIndex > 0){
      currentQuestionIndex--;
      renderQuestion(currentQuestionIndex);
    }
  });

  nextBtn.addEventListener("click",()=>{
    if(currentQuestionIndex < questions.length - 1){
      currentQuestionIndex++;
      renderQuestion(currentQuestionIndex);
    } else {
      // æœ€å¾Œã®å•é¡Œã§ã€Œæ¬¡ã®å•é¡Œã¸ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
      if(answeredFlags.every(f=>f)){
        showCompletionScreen();
      }
    }
  });

  tracker.startSession();
  renderQuestion(currentQuestionIndex);

  function showCompletionScreen() {
    // å­¦ç¿’å±¥æ­´ã‚’ä¿å­˜
    tracker.saveSession();
    
    // ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤
    clearCheckpoint();
    
    // UIã‚’å®Œäº†ç”»é¢ã«å¤‰æ›´
    questionTextEl.textContent = "å­¦ç¿’å®Œäº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
    choicesContainer.innerHTML = "";
    explanationBox.classList.remove("show");
    explanationText.innerHTML = "";
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
    nextBtn.style.display = "none";
    prevBtn.style.display = "none";
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
    progressFill.style.width = "100%";
    
    // ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœã‚’è¡¨ç¤º
    const historyDisplay = document.getElementById("historyDisplay");
    if (historyDisplay) {
      historyDisplay.innerHTML = showCurrentSessionResult();
      historyDisplay.style.display = "block";
      historyDisplay.style.visibility = "visible";
      historyDisplay.style.opacity = "1";
    }
    
    // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ªãƒ•ãƒ¬ãƒ¼ãƒ ã«é€ä¿¡
    const totalQuestions = questions.length;
    const messageData = {
      type: 'lesson:complete',
      lessonId: LESSON_ID,
      detail: {
        correct: tracker.currentSession ? tracker.currentSession.correct : 0,
        total: totalQuestions,
        timeSec: tracker.currentSession ? Math.floor((Date.now() - tracker.currentSession.startedAt) / 1000) : 0
      }
    };
    
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(messageData, "*");
      } else {
        window.parent.postMessage(messageData, "*");
      }
    } catch (e) {
      console.warn("postMessage failed:", e);
    }
    
    // completeLessonã‚‚å‘¼ã³å‡ºã—ã¦å±¥æ­´ã«è¨˜éŒ²
    tracker.completeLesson(totalQuestions);
  }

  function clearCheckpoint() {
    try {
      const checkpointKey = `checkpoint:${LESSON_ID}`;
      localStorage.removeItem(checkpointKey);
      return true;
    } catch (error) {
      console.error('âŒ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
  }

  function showCurrentSessionResult() {
    const session = tracker.currentSession;
    if (!session) return '';
    
    const totalQuestions = questions.length;
    const correct = session.correct || 0;
    const scorePercent = totalQuestions > 0 ? 
      Math.round((correct / totalQuestions) * 100) : 0;
    
    // æˆç¸¾ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    let resultMessage = '';
    if (scorePercent >= 90) {
      resultMessage = 'ğŸ‰ ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼';
    } else if (scorePercent >= 70) {
      resultMessage = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
    } else if (scorePercent >= 50) {
      resultMessage = 'ğŸ’ª ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
    } else {
      resultMessage = 'ğŸ“š å¾©ç¿’ã—ã¦å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼';
    }
    
    return `
      <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; margin-top: 12px;">
        <h3 style="margin-bottom: 12px; color: #333; font-size: 16px;">ä»Šå›ã®çµæœ</h3>
        <p style="margin: 8px 0; color: #555; font-size: 14px;">
          <strong>æ­£è§£æ•°:</strong> ${correct} / ${totalQuestions} å•
        </p>
        <p style="margin: 8px 0; color: #555; font-size: 14px;">
          <strong>æ­£ç­”ç‡:</strong> ${scorePercent}%
        </p>
        <p style="margin: 12px 0 0 0; color: #1976d2; font-size: 15px; font-weight: bold;">
          ${resultMessage}
        </p>
      </div>
    `;
  }

  /************ ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ ************/
  function goHome() {
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: "navigate:home", payload: { from: LESSON_ID }}, "*");
      } else {
        console.log("goHome called (standalone)");
      }
    } catch (e) {
      console.warn("goHome failed:", e);
    }
  }
  window.goHome = goHome;
</script>
</body>
</html>
