<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - åœ°éœ‡ã®ã—ãã¿</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #fbe9e7 40%, #fffde7 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(255,255,255,0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .home-btn {
      background:#42a5f5;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:20px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .home-btn:hover { background:#1e88e5; transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.98); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#333;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥å…¨ä½“ */
    .sim-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      margin-bottom:15px;
      overflow:hidden;
      position:relative;
    }
    .sim-header {
      background:linear-gradient(135deg, #ef5350 0%, #ffa726 100%);
      color:white;
      padding:15px;
      text-align:center;
    }
    .sim-header h2 { font-size:20px; margin-bottom:5px; }
    .sim-header p { font-size:14px; opacity:0.9; }

    .sim-area {
      padding:12px 12px 16px;
      background:#ffebee;
    }

    .control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin-bottom:10px;
    }
    .control-btn {
      padding:12px 24px;
      border:none;
      border-radius:25px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:48px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .control-btn:active {
      transform:scale(0.95);
    }
    .control-btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }
    .start-btn {
      background:linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
      color:white;
    }
    .start-btn:hover:not(:disabled) {
      background:linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(30,136,229,0.4);
    }
    .start-btn.active {
      background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      animation:pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow:0 4px 12px rgba(255,152,0,0.4); }
      50% { box-shadow:0 4px 20px rgba(255,152,0,0.7); }
    }
    .reset-btn {
      background:linear-gradient(135deg, #78909c 0%, #546e7a 100%);
      color:white;
    }
    .reset-btn:hover:not(:disabled) {
      background:linear-gradient(135deg, #546e7a 0%, #455a64 100%);
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(84,110,122,0.4);
    }
    .control-info {
      font-size:12px;
      color:#666;
      text-align:center;
      width:100%;
      margin-top:5px;
      font-style:italic;
    }

    /* â–¼ åœ°éœ‡ã‚·ãƒ¼ãƒ³ */
    .sim-field {
      position:relative;
      margin-top:0;
      margin-bottom:12px;
      background:radial-gradient(circle at 50% -10%, #ffebee, #ffcdd2 45%, #f8bbd0 70%, #f3e5f5 100%);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
      min-height:260px;
      box-shadow:0 4px 12px rgba(0,0,0,0.12), inset 0 1px 2px rgba(255,255,255,0.6);
      border:1px solid rgba(255,255,255,0.6);
    }

    .quake-scene {
      position:relative;
      width:100%;
      height:180px;
      border-radius:12px;
      overflow:hidden;
      background:linear-gradient(to bottom, #bbdefb 0%, #90caf9 35%, #e0e0e0 36%, #ffccbc 60%, #d7ccc8 100%);
      box-shadow:inset 0 3px 12px rgba(0,0,0,0.25), 0 4px 16px rgba(0,0,0,0.2);
    }

    /* ç©ºãƒ»é›² */
    .quake-sky {
      position:absolute;
      top:0; left:0; right:0;
      height:40%;
      background:linear-gradient(to bottom, #bbdefb, #90caf9);
    }
    .quake-cloud {
      position:absolute;
      top:15px;
      left:20px;
      width:70px;
      height:30px;
      background:radial-gradient(circle at 30% 30%, #ffffff, #e3f2fd);
      border-radius:999px;
      box-shadow:25px 5px 0 0 rgba(255,255,255,0.9), 55px 8px 0 0 rgba(227,242,253,0.9);
      opacity:0.9;
      animation:cloudMove 18s linear infinite;
    }
    .quake-cloud:nth-child(2) {
      top:28px;
      left:auto;
      right:25px;
      transform:scale(0.8);
      animation-delay:-6s;
    }
    @keyframes cloudMove {
      0% { transform:translateX(0); }
      100% { transform:translateX(80px); }
    }

    /* åœ°è¡¨ */
    .quake-ground {
      position:absolute;
      top:40%;
      left:0; right:0;
      height:14%;
      background:linear-gradient(to top, #6d4c41 0%, #8d6e63 35%, #a1887f 80%, #d7ccc8 100%);
      box-shadow:0 -2px 6px rgba(0,0,0,0.35);
      transform-origin:center;
    }

    /* åœ°ä¸‹ã®å±¤ï¼ˆèƒŒæ™¯ï¼‰ */
    .quake-underground {
      position:absolute;
      top:54%;
      left:0; right:0;
      bottom:0;
      background:repeating-linear-gradient(
        -12deg,
        #5d4037 0,
        #5d4037 10px,
        #4e342e 10px,
        #4e342e 20px
      );
      filter:brightness(0.95);
      z-index:0;
    }

    /* ãƒ—ãƒ¬ãƒ¼ãƒˆ */
    .plate {
      position:absolute;
      top:54%;
      bottom:0;
      background:repeating-linear-gradient(
        -12deg,
        #5d4037 0,
        #5d4037 10px,
        #4e342e 10px,
        #4e342e 20px
      );
      filter:brightness(0.95);
      transition:transform 0.5s ease;
      z-index:1;
    }
    .plate-left {
      left:0;
      right:50%;
      border-right:3px solid rgba(255,255,255,0.3);
      transform-origin:right center;
    }
    .plate-right {
      left:50%;
      right:0;
      border-left:3px solid rgba(255,255,255,0.3);
      transform-origin:left center;
    }
    .plate.compressing {
      animation:plateCompress 1.5s ease-in-out infinite;
    }
    @keyframes plateCompress {
      0%,100% { transform:scaleX(1); }
      50% { transform:scaleX(0.995); }
    }
    .plate-left.compressing {
      animation:plateLeftCompress 1.5s ease-in-out infinite;
    }
    .plate-right.compressing {
      animation:plateRightCompress 1.5s ease-in-out infinite;
    }
    @keyframes plateLeftCompress {
      0%,100% { transform:translateX(0) scaleX(1); }
      50% { transform:translateX(3px) scaleX(0.99); }
    }
    @keyframes plateRightCompress {
      0%,100% { transform:translateX(0) scaleX(1); }
      50% { transform:translateX(-3px) scaleX(0.99); }
    }
    
    /* ãƒ—ãƒ¬ãƒ¼ãƒˆãŒãšã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåœ°éœ‡ç™ºç”Ÿæ™‚ï¼‰ */
    .plate.slipping {
      animation:none;
    }
    .plate-left.slipping {
      animation:plateSlipLeft 0.8s ease-out forwards;
    }
    .plate-right.slipping {
      animation:plateSlipRight 0.8s ease-out forwards;
    }
    @keyframes plateSlipLeft {
      0% { transform:translateX(0) translateY(0); }
      50% { transform:translateX(8px) translateY(-4px); }
      100% { transform:translateX(12px) translateY(-6px); }
    }
    @keyframes plateSlipRight {
      0% { transform:translateX(0) translateY(0); }
      50% { transform:translateX(-8px) translateY(4px); }
      100% { transform:translateX(-12px) translateY(6px); }
    }
    .plate-label {
      position:absolute;
      top:10px;
      font-size:11px;
      font-weight:bold;
      color:rgba(255,255,255,0.9);
      text-shadow:0 1px 3px rgba(0,0,0,0.5);
      pointer-events:none;
      z-index:2;
    }
    .plate-left .plate-label {
      right:10px;
    }
    .plate-right .plate-label {
      left:10px;
    }
    
    /* ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‹•ãã‚’ç¤ºã™çŸ¢å° */
    .plate-arrow {
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      font-size:24px;
      color:rgba(255,255,255,0.9);
      text-shadow:0 2px 6px rgba(0,0,0,0.6);
      pointer-events:none;
      z-index:2;
      animation:arrowPulse 1.5s ease-in-out infinite;
    }
    @keyframes arrowPulse {
      0%,100% { opacity:0.7; transform:translateY(-50%) scale(1); }
      50% { opacity:1; transform:translateY(-50%) scale(1.1); }
    }
    .plate-left .plate-arrow {
      right:20px;
    }
    .plate-right .plate-arrow {
      left:20px;
    }
    .plate.compressing .plate-arrow {
      animation:arrowPulse 1s ease-in-out infinite;
      color:rgba(255,183,77,1);
      text-shadow:0 2px 8px rgba(255,152,0,0.8);
    }

    /* æ–­å±¤é¢ */
    .fault-plane {
      position:absolute;
      top:54%;
      left:50%;
      width:8px;
      height:60%;
      background:linear-gradient(to bottom, 
        rgba(255,255,255,0.95) 0%,
        rgba(255,224,178,0.95) 30%,
        rgba(255,183,77,0.9) 60%,
        rgba(255,152,0,0.9) 100%
      );
      box-shadow:0 0 15px rgba(255,255,255,0.8), 
                 0 0 25px rgba(255,152,0,0.5),
                 inset 0 0 10px rgba(255,255,255,0.6);
      transform-origin:top center;
      transform:translateX(-50%) skewX(-18deg);
      z-index:2;
      transition:all 0.3s ease;
    }
    .fault-plane.stressed {
      box-shadow:0 0 20px rgba(255,87,34,0.8), 
                 0 0 35px rgba(255,152,0,0.7),
                 inset 0 0 15px rgba(255,255,255,0.8);
      background:linear-gradient(to bottom, 
        rgba(255,255,255,1) 0%,
        rgba(255,224,178,1) 20%,
        rgba(255,183,77,1) 50%,
        rgba(255,87,34,0.95) 80%,
        rgba(244,67,54,0.9) 100%
      );
    }
    .fault-label {
      position:absolute;
      top:20%;
      left:50%;
      transform:translateX(-50%) translateY(-50%);
      font-size:11px;
      font-weight:bold;
      color:rgba(255,255,255,0.95);
      text-shadow:0 1px 3px rgba(0,0,0,0.7);
      pointer-events:none;
      z-index:3;
      white-space:nowrap;
    }

    /* éœ‡æº */
    .epicenter {
      position:absolute;
      top:64%;
      left:50%;
      width:24px;
      height:24px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #ffebee, #e53935, #c62828);
      box-shadow:0 0 0 0 rgba(244,67,54,0.7),
                 0 0 0 0 rgba(244,67,54,0.5);
      transform:translate(-50%, -50%);
      z-index:4;
      animation:epicenterPulse 2.3s ease-out infinite;
    }
    .epicenter.active {
      animation:epicenterPulseActive 1s ease-out infinite;
    }
    @keyframes epicenterPulse {
      0%   { box-shadow:0 0 0 0 rgba(244,67,54,0.7), 0 0 0 0 rgba(244,67,54,0.5); opacity:1; }
      60%  { box-shadow:0 0 0 16px rgba(244,67,54,0.0), 0 0 0 24px rgba(244,67,54,0.0); opacity:1; }
      100% { box-shadow:0 0 0 0 0 rgba(244,67,54,0.0), 0 0 0 0 rgba(244,67,54,0.0); opacity:1; }
    }
    @keyframes epicenterPulseActive {
      0%   { box-shadow:0 0 0 0 rgba(244,67,54,0.9), 0 0 0 0 rgba(255,87,34,0.7); opacity:1; }
      50%  { box-shadow:0 0 0 20px rgba(244,67,54,0.0), 0 0 0 30px rgba(255,87,34,0.0); opacity:1; }
      100% { box-shadow:0 0 0 0 0 rgba(244,67,54,0.0), 0 0 0 0 rgba(255,87,34,0.0); opacity:1; }
    }
    .epicenter-label {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -80%);
      font-size:10px;
      font-weight:bold;
      color:rgba(255,255,255,0.95);
      text-shadow:0 1px 3px rgba(0,0,0,0.8);
      pointer-events:none;
      z-index:5;
      white-space:nowrap;
    }


    /* æ³¢ï¼ˆåœ°éœ‡æ³¢ï¼‰ */
    .seismic-wave {
      position:absolute;
      top:50%;
      left:50%;
      width:60px;
      height:60px;
      border-radius:50%;
      border:4px solid rgba(255,255,255,0.95);
      opacity:0;
      pointer-events:none;
      transform:translate(-50%, -50%) scale(0.3);
      z-index:3;
    }
    .seismic-wave.wave-1 {
      border-color:rgba(255,255,255,0.95);
      box-shadow:0 0 10px rgba(255,255,255,0.8);
    }
    .seismic-wave.wave-2 {
      border-color:rgba(255,224,178,0.9);
      box-shadow:0 0 15px rgba(255,224,178,0.7);
    }
    .seismic-wave.wave-3 {
      border-color:rgba(255,183,77,0.85);
      box-shadow:0 0 20px rgba(255,183,77,0.6);
    }

    /* åŠ›ã®è“„ç©ã®è¦–è¦šåŒ–ï¼ˆã‚†ãŒã¿ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰ */
    .stress-effect {
      position:absolute;
      top:54%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:radial-gradient(circle, rgba(255,152,0,0.3), rgba(255,87,34,0.2), transparent);
      transform:translate(-50%, -50%);
      pointer-events:none;
      z-index:1;
      transition:width 0.5s ease, height 0.5s ease;
    }
    .stress-effect.active {
      width:200px;
      height:200px;
    }
    .stress-effect.strong {
      width:300px;
      height:300px;
      background:radial-gradient(circle, rgba(255,87,34,0.4), rgba(244,67,54,0.3), transparent);
    }

    /* æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚·ãƒ¼ãƒ³å…¨ä½“ã«ã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼‰ */
    .quake-scene.shake-weak .quake-ground {
      animation:shakeWeak 0.5s linear infinite;
    }
    .quake-scene.shake-strong .quake-ground {
      animation:shakeStrong 0.35s linear infinite;
    }
    @keyframes shakeWeak {
      0%,100% { transform:translateX(0) rotate(0deg); }
      25% { transform:translateX(-3px) rotate(-1deg); }
      50% { transform:translateX(3px) rotate(1deg); }
      75% { transform:translateX(-2px) rotate(-0.5deg); }
    }
    @keyframes shakeStrong {
      0%,100% { transform:translateX(0) rotate(0deg); }
      20% { transform:translateX(-6px) rotate(-2deg); }
      40% { transform:translateX(6px) rotate(2deg); }
      60% { transform:translateX(-5px) rotate(-2deg); }
      80% { transform:translateX(5px) rotate(2deg); }
    }

    /* infoãƒ‘ãƒãƒ«ãƒ»ç’°å¢ƒè¡¨ç¤º */
    .env-panel {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .env-card {
      flex:1 1 140px;
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.6);
      transition:transform 0.3s ease, box-shadow 0.3s ease;
    }
    .env-card:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.8);
    }
    .env-title {
      font-size:13px;
      font-weight:bold;
      margin-bottom:4px;
      color:#b71c1c;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .env-title span.emoji {
      font-size:18px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      animation:float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%,100% { transform:translateY(0); }
      50% { transform:translateY(-3px); }
    }
    .env-value {
      font-size:14px;
      font-weight:bold;
      margin-bottom:4px;
      color:#bf360c;
    }
    .env-bar-bg {
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:#ffccbc;
      overflow:hidden;
    }
    .env-bar-fill {
      position:absolute;
      top:0; left:0;
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, #ffcc80 0%, #ff9800 40%, #e64a19 80%, #b71c1c 100%);
      transition:width 0.4s ease;
      box-shadow:0 0 8px rgba(255,152,0,0.5), inset 0 1px 2px rgba(255,255,255,0.4);
    }
    .env-sub {
      font-size:11px;
      color:#555;
      margin-top:3px;
    }

    .sim-comment {
      margin-top:10px;
      font-size:13px;
      line-height:1.7;
      color:#4a148c;
      background:linear-gradient(135deg, rgba(243,229,245,0.95), rgba(225,190,231,0.9));
      border-radius:12px;
      padding:10px 12px;
      border-left:5px solid #ab47bc;
      box-shadow:0 2px 8px rgba(171,71,188,0.25);
    }
    .sim-comment strong {
      color:#4a148c;
      text-shadow:0 1px 2px rgba(255,255,255,0.7);
    }

    /* â–¼ infoãƒ‘ãƒãƒ« */
    .info-panel {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .info-panel h3 {
      color:#333;
      margin-bottom:15px;
      font-size:18px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:15px;
    }
    .info-item {
      background:#f8f9fa;
      padding:15px;
      border-radius:10px;
      border-left:4px solid #ef5350;
    }
    .info-item h4 {
      color:#d32f2f;
      margin-bottom:8px;
      font-size:14px;
    }
    .info-item p {
      color:#555;
      font-size:13px;
      line-height:1.4;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .question-text {
      font-size:16px;
      font-weight:bold;
      color:#333;
      margin-bottom:15px;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choice {
      padding:14px 16px;
      background:#f8f9fa;
      border:2px solid #e9ecef;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:14px;
      min-height:48px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .choice:hover {
      background:#e9ecef;
      border-color:#64b5f6;
    }
    .choice.selected {
      background:#64b5f6;
      color:white;
      border-color:#1e88e5;
    }
    .choice.correct {
      background:#28a745;
      color:white;
      border-color:#28a745;
      animation:correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background:#dc3545;
      color:white;
      border-color:#dc3545;
      animation:wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }

    .explanation {
      margin-top:15px;
      padding:15px;
      background:#f8f9fa;
      border-radius:10px;
      border-left:4px solid #28a745;
      display:none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#28a745;
      margin-bottom:10px;
    }
    .explanation p {
      color:#666;
      line-height:1.5;
    }

    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:20px;
    }
    .nav-btn {
      padding:14px 24px;
      border:none;
      border-radius:25px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:48px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#6c757d;
      color:white;
    }
    .prev-btn:hover:not(:disabled) { background:#5a6268; }
    .next-btn {
      background:#64b5f6;
      color:#0d47a1;
    }
    .next-btn:hover:not(:disabled) { background:#42a5f5; }

    .progress-bar {
      background:#e9ecef;
      border-radius:10px;
      height:8px;
      margin:15px 0;
      overflow:hidden;
    }
    .progress-fill {
      background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
      height:100%;
      width:0%;
      transition:width 0.3s ease;
    }

    * { touch-action:manipulation; }
    .choice, .nav-btn, .home-btn {
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    @media (max-width:768px){
      body { overflow-x:hidden; }
      .header { padding:8px 12px; }
      .home-btn { padding:10px 16px; font-size:13px; }
      .lesson-title { font-size:14px; margin:0 8px; text-align:center; }
      .main-container { padding:10px; }
      .info-grid { grid-template-columns:1fr; gap:12px; }
      .info-panel { padding:16px; }
      .info-item { padding:12px; }
      .info-item h4 { font-size:13px; }
      .info-item p { font-size:12px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { min-height:240px; }
      .quake-scene { height:160px; }
      .control-btn { padding:10px 20px; font-size:13px; }
      .control-info { font-size:11px; }
      .plate-label, .fault-label, .epicenter-label {
        font-size:10px;
      }
      .question-container { padding:16px; }
      .question-text { font-size:15px; margin-bottom:12px; }
      .choice { padding:12px 14px; font-size:13px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <button class="home-btn" onclick="goHome()">ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - åœ°éœ‡ã®ã—ãã¿</div>
    <div style="width:80px;"></div>
  </header>

  <main class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <section class="sim-container">
      <div class="sim-header">
        <h2>ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãŸã¾ã‚‹åŠ›ã¨ ã‚†ã‚Œã®ã‚ˆã†ã™</h2>
        <p>ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãŸã¾ã£ãŸåŠ›ãŒæ€¥ã«ãšã‚Œã‚‹ã¨ã€åœ°éœ‡ãŒèµ·ã“ã‚‹ã‚ˆã€‚</p>
        <p style="font-size:12px; opacity:0.85; margin-top:5px;">
          â€»å®Ÿéš›ã®åœ°éœ‡ã¯ä½•åå¹´ã€œæ•°åƒå¹´ã‹ã‘ã¦åŠ›ãŒãŸã¾ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯çŸ­ç¸®ã—ã¦è¦‹ã¦ã„ã¾ã™
        </p>
      </div>

      <div class="sim-area">
        <div class="sim-field">
          <div class="quake-scene" id="quakeScene">
            <div class="quake-sky">
              <div class="quake-cloud"></div>
              <div class="quake-cloud"></div>
            </div>
            <div class="quake-ground" id="quakeGround"></div>
            <div class="quake-underground"></div>
            
            <!-- ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
            <div class="plate plate-left">
              <div class="plate-label">ãƒ—ãƒ¬ãƒ¼ãƒˆA</div>
              <div class="plate-arrow">â†’</div>
            </div>
            <div class="plate plate-right">
              <div class="plate-label">ãƒ—ãƒ¬ãƒ¼ãƒˆB</div>
              <div class="plate-arrow">â†</div>
            </div>
            
            <!-- åŠ›ã®è“„ç©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
            <div class="stress-effect" id="stressEffect"></div>
            
            <!-- æ–­å±¤é¢ -->
            <div class="fault-plane" id="faultPlane">
              <div class="fault-label">æ–­å±¤é¢</div>
            </div>
            
            <!-- éœ‡æº -->
            <div class="epicenter" id="epicenter">
              <div class="epicenter-label">éœ‡æº</div>
            </div>

            <!-- åœ°éœ‡æ³¢ -->
            <div class="seismic-wave wave-1" id="wave1"></div>
            <div class="seismic-wave wave-2" id="wave2"></div>
            <div class="seismic-wave wave-3" id="wave3"></div>
          </div>

          <div class="env-panel">
            <div class="env-card">
              <div class="env-title"><span class="emoji">ğŸ’¥</span>ã‚†ã‚Œã®å¼·ã•ï¼ˆåœ°è¡¨ï¼‰</div>
              <div class="env-value" id="strengthText">ã»ã¨ã‚“ã©æ„Ÿã˜ãªã„</div>
              <div class="env-bar-bg">
                <div class="env-bar-fill" id="strengthBar"></div>
              </div>
              <div class="env-sub">éœ‡æºã‹ã‚‰ã¯ãªã‚ŒãŸåœ°è¡¨ã§ã€äººãŒæ„Ÿã˜ã‚‹ã‚†ã‚Œã®å¤§ãã•</div>
            </div>
            <div class="env-card">
              <div class="env-title"><span class="emoji">ğŸ“‰</span>ãŸã¾ã£ã¦ã„ãŸåŠ›</div>
              <div class="env-value" id="stressText">å°ã•ã„ï¼ˆã¾ã ãŸã¾ã‚Šã¯ã˜ã‚ï¼‰</div>
              <div class="env-bar-bg">
                <div class="env-bar-fill" id="stressBar"></div>
              </div>
              <div class="env-sub">ãƒ—ãƒ¬ãƒ¼ãƒˆã©ã†ã—ãŒæŠ¼ã—åˆã£ã¦ãŸã¾ã£ã¦ã„ãŸåŠ›ã®å¤§ãã•</div>
            </div>
          </div>

          <div class="sim-comment" id="simComment">
            <strong>åŠ›ãŒå°ã•ã„ã¨ã</strong>ã¯ã€ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¢ƒç›®ã«ã¾ã å°‘ã—ã—ã‹åŠ›ãŒãŸã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚
            åœ°è¡¨ã§ã¯ã€ã‚†ã‚Œã‚’ã»ã¨ã‚“ã©æ„Ÿã˜ã¾ã›ã‚“ã€‚
          </div>
        </div>

        <!-- æ“ä½œUIã‚’ä¸‹ã«é…ç½® -->
        <div class="control-row">
          <button class="control-btn start-btn" id="startBtn">
            <span id="startBtnText">ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŠ¼ã—åˆã†</span>
          </button>
          <button class="control-btn reset-btn" id="resetBtn" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
          <div class="control-info" id="controlInfo">
            â€»ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæŠ¼ã—åˆã„å§‹ã‚ã¾ã™ï¼ˆå®Ÿéš›ã¯ä½•åå¹´ã‚‚ã‹ã‹ã‚‹éç¨‹ã‚’çŸ­ç¸®ã—ã¦è¦‹ã¦ã„ã¾ã™ï¼‰
          </div>
        </div>
      </div>
    </section>

    <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆ -->
    <section class="info-panel">
      <h3>åœ°éœ‡ã¯ã©ã®ã‚ˆã†ã«èµ·ã“ã‚‹ï¼Ÿ</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>â‘  ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŠ›ãŒãŸã¾ã‚‹</h4>
          <p>
            åœ°çƒã®è¡¨é¢ã¯ã€Œãƒ—ãƒ¬ãƒ¼ãƒˆã€ã¨ã‚ˆã°ã‚Œã‚‹å¤§ããªå²©ã®æ¿ã§ã§ãã¦ã„ã¦ã€ã„ã¤ã‚‚å°‘ã—ãšã¤å‹•ã„ã¦ã„ã¾ã™ã€‚
            ãƒ—ãƒ¬ãƒ¼ãƒˆã©ã†ã—ãŒæŠ¼ã—åˆã†ã¨ã€å¢ƒç›®ã®å²©ãŒ<strong>ã‚†ãŒã‚“ã§åŠ›ã‚’ãŸã‚ã¦</strong>ã„ãã¾ã™ã€‚
          </p>
        </div>
        <div class="info-item">
          <h4>â‘¡ ãŒã¾ã‚“ã®é™ç•Œã§ ãšã‚Œå‹•ã</h4>
          <p>
            ãŸã¾ã£ãŸåŠ›ãŒå¤§ãããªã‚‹ã¨ã€å²©ãŒãŒã¾ã‚“ã§ããªããªã‚Šã€
            <strong>ã€Œãƒ‘ã‚­ãƒƒï¼ã€ã¨ãšã‚Œã¦</strong>ã€ãã®ã¾ã‚ã‚Šã«å¼·ã„æŒ¯å‹•ãŒåºƒãŒã‚Šã¾ã™ã€‚
            ã“ã®ã¨ãã®ã€Œå²©ã®ãšã‚ŒãŸã¨ã“ã‚ã€ãŒéœ‡æºã§ã™ã€‚
          </p>
        </div>
        <div class="info-item">
          <h4>â‘¢ ã‚†ã‚ŒãŒæ³¢ã¨ãªã£ã¦åºƒãŒã‚‹</h4>
          <p>
            å²©ã®ãšã‚Œã§ç”Ÿã¾ã‚ŒãŸæŒ¯å‹•ã¯ã€<strong>åœ°éœ‡æ³¢ï¼ˆã˜ã—ã‚“ã¯ï¼‰</strong>ã¨ã—ã¦å››æ–¹å…«æ–¹ã«åºƒãŒã‚Šã¾ã™ã€‚
            åœ°éœ‡æ³¢ãŒåœ°è¡¨ã«å±Šãã¨ã€å»ºç‰©ã‚„åœ°é¢ãŒã‚†ã‚Œã¾ã™ã€‚
            ãŸã¾ã£ã¦ã„ãŸåŠ›ãŒå¤§ãã„ã»ã©ã€ã‚†ã‚Œã‚‚å¼·ããªã‚Šã¾ã™ã€‚
          </p>
        </div>
      </div>
    </section>

    <!-- â–¼ ã‚ã‹ã‚‹ç·¨ 3å• -->
    <section class="question-container">
      <div class="question-text" id="questionText"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="choices" id="choicesContainer"></div>
      <div class="explanation" id="explanationBox">
        <h4>è§£èª¬</h4>
        <p id="explanationText"></p>
      </div>

      <div class="navigation">
        <button class="nav-btn prev-btn" id="prevBtn">å‰ã®å•é¡Œã¸</button>
        <button class="nav-btn next-btn" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>
      </div>
      <div id="historyDisplay"></div>
    </section>
  </main>

  <script>
    /************ LearningTracker ************/
    class LearningTracker {
      constructor(lessonId) {
        this.lessonId = lessonId;
        this.storageKey = "stepnavi_science_" + lessonId;
        this.currentSession = null;
        this.history = this.loadHistory();
      }

      loadHistory() {
        try {
          const raw = localStorage.getItem(this.storageKey);
          return raw ? JSON.parse(raw) : { sessions: [] };
        } catch (e) {
          console.warn("Failed to load history:", e);
          return { sessions: [] };
        }
      }

      startSession() {
        this.currentSession = {
          startedAt: Date.now(),
          answered: 0,
          correct: 0,
          records: []
        };
      }

      recordAnswer(questionIndex, isCorrect) {
        if (!this.currentSession) this.startSession();
        const now = Date.now();
        this.currentSession.answered += 1;
        if (isCorrect) this.currentSession.correct += 1;
        this.currentSession.records.push({
          questionIndex,
          isCorrect,
          answeredAt: now
        });

        // è¦ªã‚¢ãƒ—ãƒªã¸é€ä¿¡
        this.postToParent("question:answered", {
          lessonId: this.lessonId,
          questionIndex,
          isCorrect,
          timestamp: now
        });
      }

      completeLesson(totalQuestions) {
        if (!this.currentSession) return;
        const now = Date.now();
        const durationMs = now - this.currentSession.startedAt;
        const summary = {
          ...this.currentSession,
          finishedAt: now,
          durationMs,
          totalQuestions
        };
        this.history.sessions.push(summary);
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.history));
        } catch (e) {
          console.warn("Failed to save history:", e);
        }

        this.postToParent("lesson:complete", {
          lessonId: this.lessonId,
          totalQuestions,
          answered: this.currentSession.answered,
          correct: this.currentSession.correct,
          durationMs
        });

        this.currentSession = null;
      }

      postToParent(type, payload) {
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type, payload }, "*");
          }
        } catch (e) {
          console.warn("postMessage failed:", e);
        }
      }
    }

    const LESSON_ID = "sci.earth.earthquake_structure_sim";
    const tracker = new LearningTracker(LESSON_ID);

    /************ åœ°éœ‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ ************/
    const startBtn = document.getElementById("startBtn");
    const startBtnText = document.getElementById("startBtnText");
    const resetBtn = document.getElementById("resetBtn");
    const controlInfo = document.getElementById("controlInfo");
    const strengthText = document.getElementById("strengthText");
    const strengthBar = document.getElementById("strengthBar");
    const stressText = document.getElementById("stressText");
    const stressBar = document.getElementById("stressBar");
    const simComment = document.getElementById("simComment");

    const quakeScene = document.getElementById("quakeScene");
    const faultPlane = document.getElementById("faultPlane");
    const epicenter = document.getElementById("epicenter");
    const stressEffect = document.getElementById("stressEffect");
    const plateLeft = document.querySelector(".plate-left");
    const plateRight = document.querySelector(".plate-right");
    const wave1 = document.getElementById("wave1");
    const wave2 = document.getElementById("wave2");
    const wave3 = document.getElementById("wave3");

    let isRunning = false;
    let stressLevel = 0; // 0-100
    let animationFrame = null;
    let lastUpdate = Date.now();

    function resetWaves() {
      [wave1, wave2, wave3].forEach((wave) => {
        wave.style.opacity = "0";
        wave.style.transform = "translate(-50%, -50%) scale(0.3)";
        wave.style.transition = "none";
      });
    }

    function triggerWaves(intensity) {
      resetWaves();
      const waveCount = intensity >= 80 ? 3 : intensity >= 40 ? 2 : 1;
      const waves = [wave1, wave2, wave3].slice(0, waveCount);

      waves.forEach((wave, idx) => {
        setTimeout(() => {
          wave.style.opacity = "1";
          wave.style.transition = "transform 2s ease-out, opacity 2s ease-out";
          wave.style.transform = "translate(-50%, -50%) scale(4)";
          wave.style.opacity = "0";
        }, idx * 150);
      });
    }

    let earthquakeOccurred = false;
    let earthquakeStartTime = null;
    const EARTHQUAKE_DURATION = 5000; // åœ°éœ‡ã®ç¶™ç¶šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰

    function updateQuakeSim() {
      // ã‚·ãƒ¼ãƒ³ã®æºã‚Œã‚¯ãƒ©ã‚¹ï¼ˆåœ°éœ‡ç™ºç”Ÿæ™‚ã®ã¿ï¼‰
      if (!earthquakeOccurred) {
        quakeScene.classList.remove("shake-weak", "shake-strong");
      }

      faultPlane.classList.remove("stressed");
      epicenter.classList.remove("active");
      stressEffect.classList.remove("active", "strong");
      plateLeft.classList.remove("compressing", "slipping");
      plateRight.classList.remove("compressing", "slipping");

      if (stressLevel < 20) {
        strengthText.textContent = "ã»ã¨ã‚“ã©æ„Ÿã˜ãªã„";
        stressText.textContent = "å°ã•ã„ï¼ˆã¾ã ãŸã¾ã‚Šã¯ã˜ã‚ï¼‰";
        strengthBar.style.width = "5%";
        stressBar.style.width = stressLevel + "%";
        simComment.innerHTML = "<strong>åŠ›ãŒå°ã•ã„ã¨ã</strong>ã¯ã€ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¢ƒç›®ã«ã¾ã å°‘ã—ã—ã‹åŠ›ãŒãŸã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚åœ°è¡¨ã§ã¯ã€ã‚†ã‚Œã‚’ã»ã¨ã‚“ã©æ„Ÿã˜ã¾ã›ã‚“ã€‚";
        controlInfo.textContent = "â€»ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæŠ¼ã—åˆã„å§‹ã‚ã¾ã™ï¼ˆå®Ÿéš›ã¯ä½•åå¹´ã‚‚ã‹ã‹ã‚‹éç¨‹ã‚’çŸ­ç¸®ã—ã¦è¦‹ã¦ã„ã¾ã™ï¼‰";
      } else if (stressLevel < 70) {
        // åŠ›ãŒãŸã¾ã£ã¦ã„ã‚‹æ®µéšï¼šã¾ã æºã‚Œã¯ç™ºç”Ÿã—ãªã„
        strengthText.textContent = "ã»ã¨ã‚“ã©æ„Ÿã˜ãªã„";
        stressText.textContent = "ä¸­ãã‚‰ã„ï¼ˆã‚†ãŒã¿ãŒãŸã¾ã£ã¦ã„ã‚‹ï¼‰";
        strengthBar.style.width = "10%"; // ã¾ã æºã‚Œã¯ãªã„ã®ã§ä½ã‚ã«
        stressBar.style.width = stressLevel + "%";
        faultPlane.classList.add("stressed");
        stressEffect.classList.add("active");
        plateLeft.classList.add("compressing");
        plateRight.classList.add("compressing");
        simComment.innerHTML = "<strong>åŠ›ãŒä¸­ãã‚‰ã„</strong>ã«ãªã‚‹ã¨ã€å²©ã®ã‚†ãŒã¿ãŒå¤§ãããªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€ã¾ã åœ°éœ‡ã¯èµ·ã“ã£ã¦ã„ãªã„ã®ã§ã€åœ°è¡¨ã§ã¯æºã‚Œã‚’æ„Ÿã˜ã¾ã›ã‚“ã€‚";
        controlInfo.textContent = "â€»ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å¸¸ã«å‹•ã„ã¦ã„ã‚‹ãŸã‚ã€ãƒœã‚¿ãƒ³ã‚’é›¢ã—ã¦ã‚‚åŠ›ã¯ãŸã¾ã‚Šç¶šã‘ã¾ã™";
      } else if (stressLevel < 100) {
        // åŠ›ãŒå¤§ãããªã£ã¦ããŸæ®µéšï¼šã¾ã æºã‚Œã¯ç™ºç”Ÿã—ãªã„
        strengthText.textContent = "ã»ã¨ã‚“ã©æ„Ÿã˜ãªã„";
        stressText.textContent = "å¤§ãã„ï¼ˆãŒã¾ã‚“ã®é™ç•Œã«è¿‘ã¥ã„ã¦ã„ã‚‹ï¼ï¼‰";
        strengthBar.style.width = "15%"; // ã¾ã æºã‚Œã¯ãªã„ã®ã§ä½ã‚ã«
        stressBar.style.width = stressLevel + "%";
        faultPlane.classList.add("stressed");
        epicenter.classList.add("active");
        stressEffect.classList.add("active", "strong");
        plateLeft.classList.add("compressing");
        plateRight.classList.add("compressing");
        simComment.innerHTML = "<strong>åŠ›ãŒå¤§ãããªã£ã¦ãã¾ã—ãŸ</strong>ã€‚ãŒã¾ã‚“ã®é™ç•Œã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ã¾ã æ–­å±¤ã¯ãšã‚Œã¦ã„ãªã„ã®ã§ã€åœ°è¡¨ã§ã¯æºã‚Œã‚’æ„Ÿã˜ã¾ã›ã‚“ã€‚";
        controlInfo.textContent = "âš ï¸ ãŒã¾ã‚“ã®é™ç•Œã«è¿‘ã¥ã„ã¦ã„ã¾ã™ï¼";
      } else {
        // åœ°éœ‡ç™ºç”Ÿï¼
        if (!earthquakeOccurred) {
          earthquakeOccurred = true;
          earthquakeStartTime = Date.now();
        }

        const elapsed = Date.now() - earthquakeStartTime;
        const isDuringQuake = elapsed < EARTHQUAKE_DURATION;

        if (isDuringQuake) {
          // åœ°éœ‡ç™ºç”Ÿä¸­ï¼šå¼·ã„æºã‚Œ
          strengthText.textContent = "å¼·ã„ã‚†ã‚Œã‚’æ„Ÿã˜ã‚‹";
          stressText.textContent = "ãŒã¾ã‚“ã®é™ç•Œï¼åœ°éœ‡ç™ºç”Ÿï¼";
          strengthBar.style.width = "100%";
          stressBar.style.width = "100%";
          quakeScene.classList.add("shake-strong");
          faultPlane.classList.add("stressed");
          epicenter.classList.add("active");
          stressEffect.classList.add("active", "strong");
          
          // ãƒ—ãƒ¬ãƒ¼ãƒˆãŒãšã‚Œã‚‹ï¼ˆæœ€åˆã®0.8ç§’ã®ã¿ï¼‰
          if (elapsed < 800) {
            plateLeft.classList.remove("compressing");
            plateRight.classList.remove("compressing");
            plateLeft.classList.add("slipping");
            plateRight.classList.add("slipping");
            simComment.innerHTML = "<strong>ãŸã¾ã£ãŸåŠ›ãŒãŒã¾ã‚“ã®é™ç•Œã‚’ã“ãˆã¾ã—ãŸï¼</strong> ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ–­å±¤é¢ã«æ²¿ã£ã¦<strong>æ€¥ã«ãšã‚Œã¾ã—ãŸ</strong>ï¼ã“ã®ç¬é–“ã«å¤§ããªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒç™ºç”Ÿã—ã€å¼·ã„ã‚†ã‚ŒãŒåºƒãŒã‚Šã¾ã™ã€‚";
          } else {
            // ãšã‚ŒãŸå¾Œã¯å…ƒã®ä½ç½®ã«æˆ»ã‚‹ï¼ˆãŸã ã—å°‘ã—ãšã‚ŒãŸçŠ¶æ…‹ã‚’ç¶­æŒï¼‰
            plateLeft.classList.remove("slipping");
            plateRight.classList.remove("slipping");
            plateLeft.style.transform = "translateX(12px) translateY(-6px)";
            plateRight.style.transform = "translateX(-12px) translateY(6px)";
            simComment.innerHTML = "<strong>ãƒ—ãƒ¬ãƒ¼ãƒˆãŒãšã‚Œã¾ã—ãŸï¼</strong> ã“ã®æ€¥æ¿€ãªãšã‚Œã«ã‚ˆã£ã¦ç™ºç”Ÿã—ãŸåœ°éœ‡æ³¢ãŒåºƒãŒã‚Šã€åœ°è¡¨ã§å¼·ã„ã‚†ã‚Œã‚’æ„Ÿã˜ã¾ã™ã€‚";
          }
          
          controlInfo.textContent = "ğŸ’¥ åœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼";
          
          // åœ°éœ‡æ³¢ã‚’ç™ºç”Ÿï¼ˆæœ€åˆã®1ç§’ã®ã¿ï¼‰
          if (elapsed < 1000) {
            triggerWaves(100);
          }
        } else {
          // åœ°éœ‡çµ‚äº†å¾Œï¼šæºã‚Œã¯åã¾ã‚‹
          strengthText.textContent = "æºã‚ŒãŒåã¾ã‚Šã¾ã—ãŸ";
          stressText.textContent = "åœ°éœ‡ç™ºç”Ÿæ¸ˆã¿";
          strengthBar.style.width = "20%"; // ä½™éœ‡ãƒ¬ãƒ™ãƒ«
          stressBar.style.width = "100%";
          quakeScene.classList.remove("shake-strong");
          quakeScene.classList.add("shake-weak"); // å¼±ã„ä½™éœ‡
          simComment.innerHTML = "<strong>åœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong>ã€‚ä¸»ãªæºã‚Œã¯åã¾ã‚Šã¾ã—ãŸãŒã€å°ã•ãªä½™éœ‡ãŒç¶šãã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚";
          controlInfo.textContent = "ğŸ’¥ åœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§æœ€åˆã«æˆ»ã‚Œã¾ã™";
        }
      }
    }

    function startSimulation() {
      if (isRunning) return;
      
      isRunning = true;
      startBtn.classList.add("active");
      startBtnText.textContent = "ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæŠ¼ã—åˆã£ã¦ã„ã¾ã™...";
      startBtn.disabled = true;
      resetBtn.disabled = false;
      lastUpdate = Date.now();

      function animate() {
        if (!isRunning) return;

        const now = Date.now();
        const deltaTime = (now - lastUpdate) / 1000; // ç§’
        lastUpdate = now;

        // åŠ›ãŒãŸã¾ã‚‹é€Ÿåº¦ï¼ˆæ¯ç§’ç´„2%ï¼‰
        stressLevel = Math.min(100, stressLevel + deltaTime * 2);

        updateQuakeSim();

        // åœ°éœ‡ç™ºç”Ÿå¾Œã‚‚ä¸€å®šæ™‚é–“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶™ç¶š
        if (stressLevel < 100 || (earthquakeOccurred && (Date.now() - earthquakeStartTime) < EARTHQUAKE_DURATION)) {
          animationFrame = requestAnimationFrame(animate);
        } else if (earthquakeOccurred && (Date.now() - earthquakeStartTime) >= EARTHQUAKE_DURATION) {
          // åœ°éœ‡çµ‚äº†å¾Œã€è‡ªå‹•åœæ­¢
          stopSimulation();
        }
      }

      animate();
    }

    function stopSimulation() {
      isRunning = false;
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
        animationFrame = null;
      }
      startBtn.classList.remove("active");
      startBtnText.textContent = "ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŠ¼ã—åˆã†";
      startBtn.disabled = false;
    }

    function resetSimulation() {
      stopSimulation();
      stressLevel = 0;
      earthquakeOccurred = false;
      earthquakeStartTime = null;
      resetWaves();
      // ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
      plateLeft.style.transform = "";
      plateRight.style.transform = "";
      updateQuakeSim();
      resetBtn.disabled = true;
      controlInfo.textContent = "â€»ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæŠ¼ã—åˆã„å§‹ã‚ã¾ã™ï¼ˆå®Ÿéš›ã¯ä½•åå¹´ã‚‚ã‹ã‹ã‚‹éç¨‹ã‚’çŸ­ç¸®ã—ã¦è¦‹ã¦ã„ã¾ã™ï¼‰";
    }

    startBtn.addEventListener("click", startSimulation);
    resetBtn.addEventListener("click", resetSimulation);

    // åˆæœŸçŠ¶æ…‹
    updateQuakeSim();

    /************ ã‚ã‹ã‚‹ç·¨ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿ ************/
    const questions = [
      {
        id: "q1",
        text: "åœ°éœ‡ãŒèµ·ã“ã‚‹ã¨ãã€ã„ã¡ã°ã‚“ç›´æ¥ã®åŸå› ã«ãªã£ã¦ã„ã‚‹ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
        choices: [
          "åœ°è¡¨ã®å»ºç‰©ãŒé‡ããªã‚Šã™ãã‚‹ã“ã¨",
          "å²©ã«ãŸã¾ã£ãŸåŠ›ãŒé™ç•Œã«ãªã£ã¦æ€¥ã«ãšã‚Œã‚‹ã“ã¨",
          "é›²ãŒã‚ã¤ã¾ã£ã¦é›¨ãŒãµã‚‹ã“ã¨",
          "åœ°çƒãŒå¤ªé™½ã®ã¾ã‚ã‚Šã‚’å›ã‚‹ã“ã¨"
        ],
        correct: 1,
        explanation:
          "åœ°éœ‡ã¯ã€ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¢ƒç›®ãªã©ã§<strong>å²©ã«ãŸã¾ã£ãŸåŠ›ãŒé™ç•Œã«ãªã‚Šã€æ€¥ã«ãšã‚Œå‹•ã</strong>ã“ã¨ã§èµ·ã“ã‚Šã¾ã™ã€‚å»ºç‰©ã®é‡ã•ã‚„é›¨ã€åœ°çƒã®å…¬è»¢ã¯ç›´æ¥ã®åŸå› ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
      },
      {
        id: "q2",
        text: "åœ°éœ‡æ³¢ï¼ˆã˜ã—ã‚“ã¯ï¼‰ã«ã¤ã„ã¦æ­£ã—ã„èª¬æ˜ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
        choices: [
          "åœ°éœ‡æ³¢ã¯ã€éœ‡æºã‹ã‚‰åºƒãŒã‚‹ã‚†ã‚Œã®æ³¢ã§ã€åœ°è¡¨ã«ä¼ã‚ã‚‹ã¨å»ºç‰©ãŒã‚†ã‚Œã‚‹ã€‚",
          "åœ°éœ‡æ³¢ã¯ã€åœ°è¡¨ã‚’æµã‚Œã‚‹å·ã®æ³¢ã®ã“ã¨ã ã€‚",
          "åœ°éœ‡æ³¢ã¯ã€åœ°éœ‡ã®å‰ã ã‘ã«ãµãç‰¹åˆ¥ãªé¢¨ã®ã“ã¨ã ã€‚",
          "åœ°éœ‡æ³¢ã¯ã€å¤ªé™½ã®å…‰ãŒã‚†ã‚‰ã„ã§è¦‹ãˆã‚‹ç¾è±¡ã®ã“ã¨ã ã€‚"
        ],
        correct: 0,
        explanation:
          "åœ°éœ‡æ³¢ã¯ã€å²©ã®ãšã‚Œã«ã‚ˆã£ã¦ç”Ÿã¾ã‚ŒãŸ<strong>ã‚†ã‚Œã®æ³¢</strong>ãŒå››æ–¹ã«åºƒãŒã‚‹ã‚‚ã®ã§ã™ã€‚åœ°è¡¨ã«å±Šãã¨ã€å»ºç‰©ã‚„åœ°é¢ãŒã‚†ã‚Œã¾ã™ã€‚"
      },
      {
        id: "q3",
        text: "æ¬¡ã®ã†ã¡ã€ã‚†ã‚ŒãŒå¼·ããªã‚Šã‚„ã™ã„åœ°éœ‡ã®æ¡ä»¶ã¨ã—ã¦ã‚ã¦ã¯ã¾ã‚‹ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
        choices: [
          "ãŸã¾ã£ã¦ã„ãŸåŠ›ãŒå°ã•ãã€ãšã‚Œã‚‚å°ã•ã„åœ°éœ‡",
          "ãŸã¾ã£ã¦ã„ãŸåŠ›ãŒå¤§ããã€å²©ãŒå¤§ãããšã‚ŒãŸåœ°éœ‡",
          "ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã¾ã£ãŸãå‹•ã„ã¦ã„ãªã„åœ°éœ‡",
          "åœ°éœ‡æ³¢ãŒåœ°è¡¨ã¾ã§å±Šã‹ãªã„åœ°éœ‡"
        ],
        correct: 1,
        explanation:
          "ä¸€èˆ¬ã«ã€<strong>ãŸã¾ã£ã¦ã„ãŸåŠ›ãŒå¤§ããã€å²©ãŒå¤§ãããšã‚ŒãŸåœ°éœ‡</strong>ã»ã©ã€å‘¨ã‚Šã«ä¼ã‚ã‚‹ã‚†ã‚Œã‚‚å¼·ããªã‚Šã¾ã™ã€‚ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå‹•ã‹ãªã„ã¨åœ°éœ‡ã¯èµ·ã“ã‚Šã¾ã›ã‚“ã€‚"
      }
    ];

    let currentQuestionIndex = 0;
    let answeredFlags = new Array(questions.length).fill(false);

    const questionTextEl = document.getElementById("questionText");
    const choicesContainer = document.getElementById("choicesContainer");
    const explanationBox = document.getElementById("explanationBox");
    const explanationText = document.getElementById("explanationText");
    const progressFill = document.getElementById("progressFill");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    function renderQuestion(index) {
      const q = questions[index];
      questionTextEl.textContent = "Q" + (index + 1) + ". " + q.text;
      choicesContainer.innerHTML = "";
      explanationBox.classList.remove("show");
      explanationText.innerHTML = "";

      q.choices.forEach((choiceText, i) => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = choiceText;
        btn.dataset.index = i;
        btn.addEventListener("click", () => handleChoiceClick(index, i, btn));
        choicesContainer.appendChild(btn);
      });

      updateProgress();
      updateNavButtons();
    }

    function handleChoiceClick(qIndex, choiceIndex, btnEl) {
      const q = questions[qIndex];

      // ã™ã§ã«è§£ç­”æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
      if (answeredFlags[qIndex]) return;

      const allChoices = choicesContainer.querySelectorAll(".choice");
      allChoices.forEach(el => el.disabled = true);

      const isCorrect = (choiceIndex === q.correct);
      answeredFlags[qIndex] = true;

      if (isCorrect) {
        btnEl.classList.add("correct");
      } else {
        btnEl.classList.add("incorrect");
        const correctBtn = allChoices[q.correct];
        if (correctBtn) correctBtn.classList.add("correct");
      }

      explanationBox.classList.add("show");
      explanationText.innerHTML = q.explanation;

      tracker.recordAnswer(qIndex, isCorrect);

      updateProgress();
      updateNavButtons();

      if (answeredFlags.every(f => f)) {
        // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ãŸå ´åˆã€å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        nextBtn.disabled = true;
        prevBtn.disabled = true;
        nextBtn.style.opacity = "0.5";
        prevBtn.style.opacity = "0.5";
        
        setTimeout(() => {
          if (answeredFlags.every(f => f)) {
            showCompletionScreen();
          }
        }, 2000);
      }
    }

    function updateProgress() {
      const answeredCount = answeredFlags.filter(f => f).length;
      const ratio = answeredCount / questions.length;
      progressFill.style.width = (ratio * 100) + "%";
    }

    function updateNavButtons() {
      // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”æ¸ˆã¿ã®å ´åˆã¯ã€å®Œäº†ç”»é¢è¡¨ç¤ºä¸­ãªã®ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (answeredFlags.every(f => f)) {
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      prevBtn.disabled = (currentQuestionIndex === 0);
      nextBtn.disabled = (currentQuestionIndex === questions.length - 1);
    }

    prevBtn.addEventListener("click", () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion(currentQuestionIndex);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion(currentQuestionIndex);
      } else {
        // æœ€å¾Œã®å•é¡Œã§ã€Œæ¬¡ã®å•é¡Œã¸ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
        if (answeredFlags.every(f => f)) {
          showCompletionScreen();
        }
      }
    });

    // æœ€åˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼†åˆæœŸæç”»
    tracker.startSession();
    renderQuestion(currentQuestionIndex);

    function showCompletionScreen() {
      // å­¦ç¿’å±¥æ­´ã‚’ä¿å­˜
      tracker.saveSession();
      
      // ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤
      clearCheckpoint();
      
      // UIã‚’å®Œäº†ç”»é¢ã«å¤‰æ›´
      questionTextEl.textContent = "å­¦ç¿’å®Œäº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
      choicesContainer.innerHTML = "";
      explanationBox.classList.remove("show");
      explanationText.innerHTML = "";
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      nextBtn.style.display = "none";
      prevBtn.style.display = "none";
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
      progressFill.style.width = "100%";
      
      // ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœã‚’è¡¨ç¤º
      const historyDisplay = document.getElementById("historyDisplay");
      if (historyDisplay) {
        historyDisplay.innerHTML = showCurrentSessionResult();
        historyDisplay.style.display = "block";
        historyDisplay.style.visibility = "visible";
        historyDisplay.style.opacity = "1";
      }
      
      // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ªãƒ•ãƒ¬ãƒ¼ãƒ ã«é€ä¿¡
      const totalQuestions = questions.length;
      const messageData = {
        type: 'lesson:complete',
        lessonId: LESSON_ID,
        detail: {
          correct: tracker.currentSession ? tracker.currentSession.correct : 0,
          total: totalQuestions,
          timeSec: tracker.currentSession ? Math.floor((Date.now() - tracker.currentSession.startedAt) / 1000) : 0
        }
      };
      
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(messageData, "*");
        } else {
          window.parent.postMessage(messageData, "*");
        }
      } catch (e) {
        console.warn("postMessage failed:", e);
      }
      
      // completeLessonã‚‚å‘¼ã³å‡ºã—ã¦å±¥æ­´ã«è¨˜éŒ²
      tracker.completeLesson(totalQuestions);
    }

    function clearCheckpoint() {
      try {
        const checkpointKey = `checkpoint:${LESSON_ID}`;
        localStorage.removeItem(checkpointKey);
        return true;
      } catch (error) {
        console.error('âŒ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        return false;
      }
    }

    function showCurrentSessionResult() {
      const session = tracker.currentSession;
      if (!session) return '';
      
      const totalQuestions = questions.length;
      const correct = session.correct || 0;
      const scorePercent = totalQuestions > 0 ? 
        Math.round((correct / totalQuestions) * 100) : 0;
      
      // æˆç¸¾ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let resultMessage = '';
      if (scorePercent >= 90) {
        resultMessage = 'ğŸ‰ ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼';
      } else if (scorePercent >= 70) {
        resultMessage = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
      } else if (scorePercent >= 50) {
        resultMessage = 'ğŸ’ª ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
      } else {
        resultMessage = 'ğŸ“š å¾©ç¿’ã—ã¦å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼';
      }
      
      return `
        <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; margin-top: 12px;">
          <h3 style="margin-bottom: 12px; color: #333; font-size: 16px;">ä»Šå›ã®çµæœ</h3>
          <p style="margin: 8px 0; color: #555; font-size: 14px;">
            <strong>æ­£è§£æ•°:</strong> ${correct} / ${totalQuestions} å•
          </p>
          <p style="margin: 8px 0; color: #555; font-size: 14px;">
            <strong>æ­£ç­”ç‡:</strong> ${scorePercent}%
          </p>
          <p style="margin: 12px 0 0 0; color: #1976d2; font-size: 15px; font-weight: bold;">
            ${resultMessage}
          </p>
        </div>
      `;
    }

    /************ ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ ************/
    function goHome() {
      try {
        if (window.parent && window.parent !== window) {
          // app.jsã§å‡¦ç†ã•ã‚Œã¦ã„ã‚‹lesson:goBackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
          window.parent.postMessage({ type: "lesson:goBack" }, "*");
          console.log("ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
        } else {
          // å˜ä½“å®Ÿè¡Œæ™‚ã¯ç›´æ¥ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
          console.log("goHome called (standalone)");
          window.location.href = "/index.html";
        }
      } catch (e) {
        console.warn("goHome failed:", e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        try {
          window.location.href = "/index.html";
        } catch (e2) {
          console.error("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:", e2);
        }
      }
    }
    window.goHome = goHome;
  </script>
</body>
</html>
