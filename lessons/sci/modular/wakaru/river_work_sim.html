<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シミュレーションで学ぶ理科 - 川のはたらき</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 40%, #fffde7 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(255,255,255,0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .home-btn {
      background:#42a5f5;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:20px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .home-btn:hover { background:#1e88e5; transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.98); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#333;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
    }

    /* ▼ シミュ全体 */
    .sim-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      margin-bottom:15px;
      overflow:hidden;
      position:relative;
    }
    .sim-header {
      background:linear-gradient(135deg, #42a5f5 0%, #66bb6a 100%);
      color:white;
      padding:18px;
      text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .sim-header h2 { 
      font-size:22px; 
      margin-bottom:6px; 
      text-shadow:0 2px 4px rgba(0,0,0,0.2);
      font-weight:bold;
    }
    .sim-header p { 
      font-size:14px; 
      opacity:0.95; 
      text-shadow:0 1px 2px rgba(0,0,0,0.15);
    }

    .sim-area {
      padding:12px 12px 16px;
      background:#e3f2fd;
    }

    .river-tabs {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:12px;
    }
    .river-tab {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:10px 16px;
      border-radius:999px;
      border:2px solid #90caf9;
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(227,242,253,0.95));
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      color:#1565c0;
      transition:all 0.3s ease;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .river-tab:hover {
      transform:translateY(-2px);
      box-shadow:0 4px 10px rgba(33,150,243,0.3);
      border-color:#64b5f6;
    }
    .river-tab span.emoji { 
      font-size:20px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      transition:transform 0.3s ease;
    }
    .river-tab:hover span.emoji {
      transform:scale(1.15) rotate(5deg);
    }
    .river-tab.active {
      background:linear-gradient(135deg,#64b5f6 0%,#42a5f5 50%,#1e88e5 100%);
      color:white;
      border-color:#1976d2;
      box-shadow:0 4px 12px rgba(33,150,243,0.5), 0 0 0 2px rgba(33,150,243,0.2);
      transform:translateY(-1px);
    }
    .river-tab.active span.emoji {
      transform:scale(1.1);
      filter:drop-shadow(0 2px 6px rgba(0,0,0,0.3));
    }

    .sim-field {
      position:relative;
      margin-top:8px;
      background:linear-gradient(135deg, rgba(187,222,251,0.95) 0%, rgba(232,245,233,0.95) 55%, rgba(200,230,201,0.95) 100%);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
      min-height:280px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1), inset 0 1px 2px rgba(255,255,255,0.5);
      border:1px solid rgba(255,255,255,0.3);
    }

    /* ▼ 川の流れアニメーション */
    .river-animation {
      position:relative;
      width:100%;
      height:160px;
      margin-bottom:14px;
      border-radius:12px;
      overflow:hidden;
      background:linear-gradient(to bottom, #87ceeb 0%, #4fc3f7 50%, #29b6f6 100%);
      box-shadow:inset 0 3px 12px rgba(0,0,0,0.25), 0 4px 16px rgba(0,0,0,0.2), 0 0 0 2px rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
    }
    .river-animation.upper {
      background:linear-gradient(to bottom, #64b5f6 0%, #42a5f5 50%, #1e88e5 100%);
    }
    .river-animation.middle {
      background:linear-gradient(to bottom, #81d4fa 0%, #4fc3f7 50%, #29b6f6 100%);
    }
    .river-animation.lower {
      background:linear-gradient(to bottom, #b3e5fc 0%, #81d4fa 50%, #4fc3f7 100%);
    }

    /* 川岸の形状 */
    .river-banks {
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      height:75px;
      z-index:2;
      box-shadow:0 -3px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.1);
    }
    .river-banks.upper {
      clip-path:polygon(0% 100%, 15% 35%, 35% 28%, 50% 25%, 65% 28%, 85% 35%, 100% 100%);
      background:linear-gradient(to bottom, #5d4037 0%, #6d4c41 30%, #8d6e63 60%, #a1887f 100%);
    }
    .river-banks.middle {
      clip-path:polygon(0% 100%, 8% 45%, 25% 40%, 50% 35%, 75% 40%, 92% 45%, 100% 100%);
      background:linear-gradient(to bottom, #8d6e63 0%, #a1887f 30%, #bcaaa4 60%, #d7ccc8 100%);
    }
    .river-banks.lower {
      clip-path:polygon(0% 100%, 3% 55%, 12% 50%, 20% 48%, 80% 48%, 88% 50%, 97% 55%, 100% 100%);
      background:linear-gradient(to bottom, #a1887f 0%, #bcaaa4 30%, #d7ccc8 60%, #efebe9 100%);
    }

    /* 流れる水の波 */
    .water-wave {
      position:absolute;
      bottom:0;
      left:0;
      width:100%;
      height:100%;
      background:repeating-linear-gradient(
        90deg,
        transparent,
        transparent 20px,
        rgba(255,255,255,0.1) 20px,
        rgba(255,255,255,0.1) 40px
      );
      animation:flowWave linear infinite;
      z-index:1;
    }
    .water-wave.upper {
      animation-duration:1.5s;
    }
    .water-wave.middle {
      animation-duration:2.5s;
    }
    .water-wave.lower {
      animation-duration:4s;
    }
    @keyframes flowWave {
      0% { transform:translateX(0); }
      100% { transform:translateX(40px); }
    }

    /* 流れるパーティクル（泡や波） */
    .water-particle {
      position:absolute;
      border-radius:50%;
      background:rgba(255,255,255,0.6);
      animation:flowParticle linear infinite;
      z-index:1;
    }
    .water-particle.upper {
      width:8px;
      height:8px;
      animation-duration:2s;
    }
    .water-particle.middle {
      width:6px;
      height:6px;
      animation-duration:3s;
    }
    .water-particle.lower {
      width:4px;
      height:4px;
      animation-duration:5s;
    }
    @keyframes flowParticle {
      0% {
        left:-10px;
        opacity:0;
        transform:translateY(0) scale(0.5);
      }
      10% {
        opacity:1;
      }
      90% {
        opacity:1;
      }
      100% {
        left:calc(100% + 10px);
        opacity:0;
        transform:translateY(-20px) scale(1);
      }
    }

    /* 流れる石や土砂 */
    .sediment-particle {
      position:absolute;
      border-radius:4px;
      background:linear-gradient(135deg, #8d6e63, #6d4c41);
      animation:flowSediment linear infinite;
      z-index:1;
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
    }
    .sediment-particle.upper {
      width:12px;
      height:12px;
      animation-duration:3s;
      background:linear-gradient(135deg, #6d4c41, #5d4037);
    }
    .sediment-particle.middle {
      width:8px;
      height:8px;
      animation-duration:4s;
      background:linear-gradient(135deg, #8d6e63, #6d4c41);
    }
    .sediment-particle.lower {
      width:4px;
      height:4px;
      animation-duration:6s;
      background:linear-gradient(135deg, #a1887f, #8d6e63);
    }
    @keyframes flowSediment {
      0% {
        left:-15px;
        opacity:0;
        transform:translateY(0) rotate(0deg);
      }
      10% {
        opacity:0.8;
      }
      90% {
        opacity:0.8;
      }
      100% {
        left:calc(100% + 15px);
        opacity:0;
        transform:translateY(10px) rotate(360deg);
      }
    }

    /* 侵食エフェクト（上流） */
    .erosion-effect {
      position:absolute;
      bottom:75px;
      left:25%;
      width:35px;
      height:25px;
      background:rgba(139,69,19,0.4);
      border-radius:50% 50% 0 0;
      animation:erosionPulse 1.5s ease-in-out infinite;
      z-index:1;
      box-shadow:0 -5px 10px rgba(139,69,19,0.3);
    }
    .erosion-effect::before {
      content:'';
      position:absolute;
      bottom:0;
      left:35%;
      width:25px;
      height:20px;
      background:rgba(139,69,19,0.3);
      border-radius:50% 50% 0 0;
      animation:erosionPulse 1.8s ease-in-out infinite;
      animation-delay:0.3s;
    }
    @keyframes erosionPulse {
      0%, 100% {
        transform:scale(1) translateY(0);
        opacity:0.4;
      }
      50% {
        transform:scale(1.15) translateY(-3px);
        opacity:0.7;
      }
    }

    /* 堆積エフェクト（下流） */
    .deposit-effect {
      position:absolute;
      bottom:75px;
      left:45%;
      width:50px;
      height:20px;
      background:rgba(139,69,19,0.5);
      border-radius:0 0 50% 50%;
      animation:depositGrow 2.5s ease-in-out infinite;
      z-index:1;
      box-shadow:0 5px 10px rgba(139,69,19,0.3);
    }
    .deposit-effect::before {
      content:'';
      position:absolute;
      bottom:0;
      left:55%;
      width:40px;
      height:18px;
      background:rgba(139,69,19,0.4);
      border-radius:0 0 50% 50%;
      animation:depositGrow 3s ease-in-out infinite;
      animation-delay:0.5s;
    }
    @keyframes depositGrow {
      0%, 100% {
        transform:scaleY(1) translateY(0);
        opacity:0.5;
      }
      50% {
        transform:scaleY(1.4) translateY(5px);
        opacity:0.8;
      }
    }

    /* ▼ 川のアニメーション内の情報ボタン */
    .river-info-buttons {
      position:absolute;
      bottom:10px;
      right:10px;
      display:flex;
      gap:8px;
      z-index:10;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .river-info-btn {
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
      border:2px solid rgba(255,255,255,0.8);
      border-radius:20px;
      font-size:12px;
      font-weight:600;
      color:#1565c0;
      cursor:pointer;
      transition:all 0.3s ease;
      box-shadow:0 4px 12px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.1);
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .river-info-btn:hover {
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 6px 16px rgba(0,0,0,0.35), 0 0 0 1px rgba(0,0,0,0.15);
      background:linear-gradient(135deg, rgba(255,255,255,1), rgba(240,248,255,0.95));
    }
    .river-info-btn:active {
      transform:translateY(0) scale(1);
    }
    .river-info-btn span.emoji {
      font-size:16px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    /* ▼ 詳細情報モーダル */
    .river-detail-modal {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
      backdrop-filter:blur(4px);
    }
    .river-detail-modal.show {
      display:flex;
    }
    .river-detail-content {
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,249,250,0.95));
      border-radius:16px;
      padding:20px;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.3);
      animation:modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
      from {
        transform:translateY(-20px);
        opacity:0;
      }
      to {
        transform:translateY(0);
        opacity:1;
      }
    }
    .river-detail-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:2px solid rgba(33,150,243,0.2);
    }
    .river-detail-header h3 {
      font-size:18px;
      font-weight:bold;
      color:#1a237e;
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
    }
    .river-detail-header h3 span.emoji {
      font-size:24px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }
    .river-detail-close {
      width:32px;
      height:32px;
      border-radius:50%;
      border:none;
      background:rgba(0,0,0,0.1);
      color:#333;
      font-size:20px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s ease;
    }
    .river-detail-close:hover {
      background:rgba(0,0,0,0.2);
      transform:rotate(90deg);
    }
    .river-detail-body {
      font-size:13px;
      color:#424242;
      line-height:1.7;
    }
    .river-detail-tags {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:12px 0 16px 0;
    }
    .river-detail-tags .shape-tag {
      font-size:11px;
      font-weight:500;
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color:#2e7d32;
      border:2px solid #a5d6a7;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }

    /* ▼ 上段：はたらきパネル */
    .work-panel {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:12px;
    }
    .work-card {
      flex:1 1 160px;
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(250,250,250,0.95));
      border-radius:12px;
      padding:12px 14px;
      box-shadow:0 3px 10px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      border:1px solid rgba(0,0,0,0.08);
      transition:all 0.3s ease;
    }
    .work-card:hover {
      transform:translateY(-2px);
      box-shadow:0 5px 14px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.1);
    }
    .work-title {
      font-size:14px;
      font-weight:bold;
      margin-bottom:8px;
      color:#1a237e;
      display:flex;
      align-items:center;
      gap:6px;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
    }
    .work-title span.emoji { 
      font-size:20px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }
    .work-value {
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      color:#004d40;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
    }
    .work-bar-bg {
      position:relative;
      width:100%;
      height:12px;
      border-radius:999px;
      background:linear-gradient(90deg, #e0e0e0, #cfd8dc);
      overflow:hidden;
      margin-bottom:6px;
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.15);
      border:1px solid rgba(0,0,0,0.1);
    }
    .work-bar-fill {
      position:absolute;
      top:0; left:0;
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, #64b5f6 0%, #81c784 50%, #ffb74d 100%);
      transition:width 0.4s ease;
      box-shadow:0 0 8px rgba(100,181,246,0.4), inset 0 1px 2px rgba(255,255,255,0.3);
    }
    .work-sub {
      font-size:11px;
      color:#555;
      line-height:1.4;
    }

    /* ▼ 下段：川の形と石・土 */
    .river-detail {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .shape-card, .sediment-card {
      flex:1 1 180px;
      background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,249,250,0.95));
      border-radius:12px;
      padding:12px 14px;
      box-shadow:0 3px 10px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      border:1px solid rgba(0,0,0,0.08);
      transition:all 0.3s ease;
    }
    .shape-card:hover, .sediment-card:hover {
      transform:translateY(-2px);
      box-shadow:0 5px 14px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.1);
    }
    .shape-title, .sediment-title {
      font-size:14px;
      font-weight:bold;
      color:#1b5e20;
      margin-bottom:8px;
      padding-bottom:6px;
      border-bottom:2px solid rgba(76,175,80,0.2);
      display:flex;
      align-items:center;
      gap:6px;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
    }
    .shape-title span.emoji, .sediment-title span.emoji { 
      font-size:22px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }
    .shape-body, .sediment-body {
      font-size:12px;
      color:#424242;
      line-height:1.6;
      padding-top:4px;
    }
    .shape-tag-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:6px;
    }
    .shape-tag {
      font-size:11px;
      font-weight:500;
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color:#2e7d32;
      border:2px solid #a5d6a7;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }

    .sim-comment {
      margin-top:12px;
      font-size:13px;
      line-height:1.7;
      color:#1a237e;
      background:linear-gradient(135deg, rgba(227,242,253,0.95), rgba(187,222,251,0.9));
      border-radius:12px;
      padding:12px 14px;
      border-left:5px solid #42a5f5;
      box-shadow:0 2px 8px rgba(66,165,245,0.15), 0 0 0 1px rgba(66,165,245,0.1);
    }
    .sim-comment strong { 
      color:#0d47a1; 
      font-weight:bold;
      text-shadow:0 1px 2px rgba(255,255,255,0.5);
    }

    /* ▼ infoパネル */
    .info-panel {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .info-panel h3 {
      color:#333;
      margin-bottom:15px;
      font-size:18px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:15px;
    }
    .info-item {
      background:#f8f9fa;
      padding:15px;
      border-radius:10px;
      border-left:4px solid #64b5f6;
    }
    .info-item h4 {
      color:#1976d2;
      margin-bottom:8px;
      font-size:14px;
    }
    .info-item p {
      color:#555;
      font-size:13px;
      line-height:1.4;
    }

    /* ▼ 問題パネル */
    .question-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .question-text {
      font-size:16px;
      font-weight:bold;
      color:#333;
      margin-bottom:15px;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choice {
      padding:14px 16px;
      background:#f8f9fa;
      border:2px solid #e9ecef;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:14px;
      min-height:48px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .choice:hover {
      background:#e9ecef;
      border-color:#64b5f6;
    }
    .choice.selected {
      background:#64b5f6;
      color:white;
      border-color:#1e88e5;
    }
    .choice.correct {
      background:#28a745;
      color:white;
      border-color:#28a745;
      animation:correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background:#dc3545;
      color:white;
      border-color:#dc3545;
      animation:wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    .explanation {
      margin-top:15px;
      padding:15px;
      background:#f8f9fa;
      border-radius:10px;
      border-left:4px solid #28a745;
      display:none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#28a745;
      margin-bottom:10px;
    }
    .explanation p {
      color:#666;
      line-height:1.5;
    }
    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:20px;
    }
    .nav-btn {
      padding:14px 24px;
      border:none;
      border-radius:25px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:48px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#6c757d;
      color:white;
    }
    .prev-btn:hover:not(:disabled) { background:#5a6268; }
    .next-btn {
      background:#64b5f6;
      color:#0d47a1;
    }
    .next-btn:hover:not(:disabled) { background:#42a5f5; }

    .start-learning-btn {
      background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #1e88e5 100%);
      color:white;
      border:none;
      padding:16px 30px;
      border-radius:25px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      margin:20px auto;
      display:block;
      min-height:52px;
      width:100%;
      max-width:400px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .start-learning-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(100,181,246,0.35);
    }
    .progress-bar {
      background:#e9ecef;
      border-radius:10px;
      height:8px;
      margin:15px 0;
      overflow:hidden;
    }
    .progress-fill {
      background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
      height:100%;
      transition:width 0.3s ease;
    }

    * { touch-action:manipulation; }
    .choice, .nav-btn, .home-btn, .start-learning-btn, .river-tab, .river-info-btn {
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    @media (max-width:768px){
      body { overflow-x:hidden; }
      .header { padding:8px 12px; }
      .home-btn { padding:10px 16px; font-size:13px; }
      .lesson-title { font-size:14px; margin:0 8px; text-align:center; }
      .header > div:last-child { width:80px; }
      .main-container { padding:10px; }

      .info-grid { grid-template-columns:1fr; gap:12px; }
      .info-panel { padding:16px; }
      .info-item { padding:12px; }
      .info-item h4 { font-size:13px; }
      .info-item p { font-size:12px; }

      .sim-area { padding:10px 10px 14px; }
      .sim-field { min-height:260px; }
      
      .river-animation { height:140px; }
      .river-info-buttons {
        bottom:8px;
        right:8px;
        gap:6px;
        flex-direction:row;
        flex-wrap:wrap;
      }
      .river-info-btn {
        padding:6px 12px;
        font-size:11px;
      }
      .river-info-btn span.emoji {
        font-size:14px;
      }

      .river-detail-modal {
        padding:10px;
      }
      .river-detail-content {
        padding:16px;
        max-height:85vh;
      }
      .river-detail-header h3 {
        font-size:16px;
      }
      .river-detail-header h3 span.emoji {
        font-size:20px;
      }
      .river-detail-body {
        font-size:12px;
      }

      .question-container { padding:16px; }
      .question-text { font-size:15px; margin-bottom:12px; }
      .choice { padding:14px 16px; font-size:14px; min-height:52px; }
      .navigation { flex-direction:column; gap:12px; margin-top:16px; }
      .nav-btn { width:100%; padding:14px 20px; font-size:15px; }
      .start-learning-btn { padding:16px 24px; font-size:15px; max-width:100%; }
      .explanation { padding:12px; font-size:13px; margin-top:12px; }
      .progress-bar { margin:12px 0; }
    }
    @media (max-width:480px){
      .header { padding:6px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:12px; margin:0 6px; }
      .header > div:last_child { width:70px; }
      .main-container { padding:8px; }
      .question-container { padding:12px; }
      .question-text { font-size:14px; }
      .choice { padding:12px 14px; font-size:13px; min-height:48px; }
      .info-panel { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="home-btn" onclick="goHome()">🏠 ホーム</button>
    <div class="lesson-title">シミュレーションで学ぶ理科 - 川のはたらき</div>
    <div style="width:80px;"></div>
  </div>

  <div class="main-container">
    <!-- ▼ シミュレーション -->
    <div class="sim-container">
      <div class="sim-header">
        <h2>🏞️ 川のはたらき</h2>
        <p>上流・中流・下流をえらんで、「けずる・運ぶ・積もらせる」川のはたらきをくらべてみよう</p>
      </div>
      <div class="sim-area">
        <div class="river-tabs">
          <button class="river-tab active" data-section="upper">
            <span class="emoji">⛰️</span><span>上流（山あい）</span>
          </button>
          <button class="river-tab" data-section="middle">
            <span class="emoji">🏞️</span><span>中流（谷〜平地）</span>
          </button>
          <button class="river-tab" data-section="lower">
            <span class="emoji">🌊</span><span>下流（平野・河口）</span>
          </button>
        </div>

        <div class="sim-field">
          <!-- 川の流れアニメーション -->
          <div class="river-animation" id="riverAnimation">
            <div class="water-wave" id="waterWave"></div>
            <div class="river-banks" id="riverBanks"></div>
            <div class="erosion-effect" id="erosionEffect" style="display:none;"></div>
            <div class="deposit-effect" id="depositEffect" style="display:none;"></div>
            <!-- 情報ボタン -->
            <div class="river-info-buttons">
              <button class="river-info-btn" onclick="showRiverDetail('shape')">
                <span class="emoji" id="shapeBtnEmoji">⛰️</span>
                <span>川の形</span>
              </button>
              <button class="river-info-btn" onclick="showRiverDetail('sediment')">
                <span class="emoji">🪨</span>
                <span>石・土</span>
              </button>
            </div>
          </div>

          <!-- 川のはたらきパネル -->
          <div class="work-panel">
            <div class="work-card">
              <div class="work-title">
                <span class="emoji">💧</span><span>川の流れの速さ</span>
              </div>
              <div class="work-value" id="speedValue"></div>
              <div class="work-bar-bg">
                <div class="work-bar-fill" id="speedBar"></div>
              </div>
              <div class="work-sub" id="speedSub"></div>
            </div>
            <div class="work-card">
              <div class="work-title">
                <span class="emoji">⛏️</span><span>けずるはたらき（侵食）</span>
              </div>
              <div class="work-value" id="erodeValue"></div>
              <div class="work-bar-bg">
                <div class="work-bar-fill" id="erodeBar"></div>
              </div>
              <div class="work-sub" id="erodeSub"></div>
            </div>
            <div class="work-card">
              <div class="work-title">
                <span class="emoji">🪨</span><span>運ぶ・積もらせるはたらき</span>
              </div>
              <div class="work-value" id="depositValue"></div>
              <div class="work-bar-bg">
                <div class="work-bar-fill" id="depositBar"></div>
              </div>
              <div class="work-sub" id="depositSub"></div>
            </div>
          </div>

          <!-- 詳細情報モーダル -->
          <div class="river-detail-modal" id="riverDetailModal">
            <div class="river-detail-content">
              <div class="river-detail-header">
                <h3>
                  <span class="emoji" id="modalEmoji">⛰️</span>
                  <span id="modalTitle">川の形</span>
                </h3>
                <button class="river-detail-close" onclick="closeRiverDetail()">×</button>
              </div>
              <div class="river-detail-body">
                <div class="river-detail-tags" id="modalTags"></div>
                <div id="modalBody"></div>
              </div>
            </div>
          </div>

          <div class="sim-comment" id="simComment">
            川の上流では流れが<strong>速く</strong>、川底や川岸を<strong>強くけずる（侵食）</strong>はたらきが大きくなります。<br>
            下流に行くほど流れは<strong>ゆるやか</strong>になり、運んできた土砂を<strong>積もらせる（堆積）</strong>はたらきが大きくなります。<br>
            中流はその中間で、けずる・運ぶ・積もらせるはたらきがほどよくはたらき、川の横に広く平らな場所ができやすくなります。
          </div>
        </div>
      </div>
    </div>

    <!-- ▼ 導入テキスト -->
    <div class="info-panel" id="info-panel">
      <h3>📊 川の「けずる・運ぶ・積もらせる」はたらき</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>上流：けずる力が大きい</h4>
          <p>山あいを流れる上流では、川の流れが<strong>とても速く</strong>、川底や川岸の岩や土を<strong>けずり取る（侵食する）</strong>力が大きくはたらきます。<br>
             このため、谷は下に向かって深くほられ、<strong>V字谷</strong>とよばれる形になりやすくなります。</p>
        </div>
        <div class="info-item">
          <h4>中流：けずる・運ぶ・積もらせるのバランス</h4>
          <p>中流では、流れの速さは上流よりおだやかになりますが、まだ<strong>けずる力と運ぶ力</strong>がはたらいています。<br>
             一方で、流れがおそくなったところには土砂がたまり、川の横に<strong>平らな土地（河岸段丘や氾濫原）</strong>がつくられていきます。</p>
        </div>
        <div class="info-item">
          <h4>下流：積もらせる力が大きい</h4>
          <p>下流では、川の流れが<strong>ゆるやか</strong>になり、上流や中流から運ばれてきた土砂が<strong>積もりやすく</strong>なります。<br>
             このため、川のまわりには広い<strong>平野</strong>や、海にそそぐところには<strong>三角州</strong>がつくられます。</p>
        </div>
      </div>
      <button class="start-learning-btn" onclick="startLearning()">学習を開始する</button>
    </div>

    <!-- ▼ 問題エリア -->
    <div class="question-container" id="question-container" style="display:none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="explanation" id="explanation"></div>
      <div class="navigation">
        <button class="nav-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>前の問題</button>
        <button class="nav-btn next-btn" id="next-btn" onclick="nextQuestion()">次の問題</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       ▼ 川のはたらきシミュ
    ================================= */
    const riverTabs = document.querySelectorAll('.river-tab');

    const speedValue = document.getElementById('speedValue');
    const speedBar = document.getElementById('speedBar');
    const speedSub = document.getElementById('speedSub');

    const erodeValue = document.getElementById('erodeValue');
    const erodeBar = document.getElementById('erodeBar');
    const erodeSub = document.getElementById('erodeSub');

    const depositValue = document.getElementById('depositValue');
    const depositBar = document.getElementById('depositBar');
    const depositSub = document.getElementById('depositSub');

    const simCommentEl = document.getElementById('simComment');
    const shapeBtnEmoji = document.getElementById('shapeBtnEmoji');
    
    const riverDetailModal = document.getElementById('riverDetailModal');
    const modalEmoji = document.getElementById('modalEmoji');
    const modalTitle = document.getElementById('modalTitle');
    const modalTags = document.getElementById('modalTags');
    const modalBody = document.getElementById('modalBody');

    const riverAnimation = document.getElementById('riverAnimation');
    const waterWave = document.getElementById('waterWave');
    const riverBanks = document.getElementById('riverBanks');
    const erosionEffect = document.getElementById('erosionEffect');
    const depositEffect = document.getElementById('depositEffect');

    let currentSection = 'upper';
    let particleInterval = null;

    const riverData = {
      upper: {
        name: '上流（山あい）',
        speed: 5,
        erode: 5,
        deposit: 1,
        speedText: '流れ：とても速い',
        erodeText: 'けずる力：とても強い',
        depositText: '積もらせる力：小さい',
        speedSub: '急な坂を一気に流れおちるため、川底の石や岩を強く動かします。',
        erodeSub: '川底・川岸の岩や土をけずり取り、V字谷をつくる力が大きいです。',
        depositSub: '流れが速いので土砂はあまりたまらず、下流へと運ばれていきます。',
        shapeEmoji: '⛰️',
        shapeTitle: '上流の川の形',
        shapeTags: ['急な坂','V字谷','川幅がせまい'],
        shapeBody: '山あいを流れ、川の流れはとても速く、川底や川岸を強くけずりながら深いV字谷をつくります。川幅はせまく、川底には大きな石や岩が多く見られます。',
        sedimentTags: ['大きな岩','角ばった石'],
        sedimentBody: '大きな岩や角ばったごろごろした石が多く見られます。まだあまりくだかれておらず、ごつごつした形をしています。',
        comment: '上流は「けずるはたらき（侵食）」がとても強く、川底や川岸を深くほり下げていきます。'
      },
      middle: {
        name: '中流（谷〜平地）',
        speed: 3,
        erode: 3,
        deposit: 3,
        speedText: '流れ：ふつう〜やや速い',
        erodeText: 'けずる力：中くらい',
        depositText: '積もらせる力：中くらい',
        speedSub: '上流よりゆるやかですが、まだ石や土を動かす力があります。',
        erodeSub: '川底や川岸をけずりながらも、一部では積もらせるはたらきも見られます。',
        depositSub: '流れが少しおそくなる場所では、運んできた土砂がたまって平らな土地ができます。',
        shapeEmoji: '🏞️',
        shapeTitle: '中流の川の形',
        shapeTags: ['ゆるやかな坂','川幅が広がる','ゆるやかな谷'],
        shapeBody: '川の流れは上流ほど急ではなくなり、川幅も広がります。川は曲がりくねりながら流れ、川の外側でけずり、内側では土砂を積もらせて、川のまわりに平らな土地が広がっていきます。',
        sedimentTags: ['丸くなった小石','砂','細かめの石'],
        sedimentBody: '上流から運ばれてきた石は、ぶつかり合って角がとれ、丸みをおびた小石や砂が多くなります。川原にはいろいろな大きさの石が見られます。',
        comment: '中流は「けずる・運ぶ・積もらせる」の3つのはたらきがバランスよくはたらき、川の横に広い平らな土地ができやすくなります。'
      },
      lower: {
        name: '下流（平野・河口）',
        speed: 2,
        erode: 1,
        deposit: 5,
        speedText: '流れ：ゆるやか',
        erodeText: 'けずる力：小さい',
        depositText: '積もらせる力：とても大きい',
        speedSub: '川のまわりが平らになり、流れはゆるやかになります。',
        erodeSub: '川底や川岸をけずる力は小さくなり、主には運んできた土砂を積もらせるはたらきが中心です。',
        depositSub: '細かい土や砂が川底や川のまわりにたまり、広い平野や三角州をつくります。',
        shapeEmoji: '🌊',
        shapeTitle: '下流の川の形',
        shapeTags: ['平らな土地','川幅が広い','ゆったりした流れ'],
        shapeBody: '平野を流れ、川幅が広く、流れはゆったりとしています。川は大きく曲がりながら流れ、洪水のたびに土砂をはこび出して、広い平野や三角州をつくります。',
        sedimentTags: ['細かい砂','泥','栄養をふくんだ土'],
        sedimentBody: 'とても細かい砂や泥が多く、川のまわりには水はけがよくて栄養もふくんだ土地が広がります。田んぼや畑に利用されやすい土地です。',
        comment: '下流は「積もらせるはたらき（堆積）」が大きくはたらき、広い平野や三角州をつくります。'
      }
    };

    function levelLabel(value){
      if (value <= 1) return 'とても小さい';
      if (value === 2) return 'やや小さい';
      if (value === 3) return '中くらい';
      if (value === 4) return 'やや大きい';
      return 'とても大きい';
    }

    function speedLabel(v){
      if (v >= 5) return 'とても速い';
      if (v === 4) return 'かなり速い';
      if (v === 3) return 'ふつう〜やや速い';
      if (v === 2) return 'ゆるやか';
      return 'とてもゆっくり';
    }

    function setBarWidth(el, value){
      const percent = Math.min(100, Math.max(0, value * 20));
      el.style.width = percent + '%';
    }

    function renderTags(container, tags){
      container.innerHTML = '';
      tags.forEach(t=>{
        const span = document.createElement('span');
        span.className = 'shape-tag';
        span.textContent = t;
        container.appendChild(span);
      });
    }

    function showRiverDetail(type){
      const data = riverData[currentSection];
      
      if (type === 'shape') {
        modalEmoji.textContent = data.shapeEmoji;
        modalTitle.textContent = data.shapeTitle;
        renderTags(modalTags, data.shapeTags);
        modalBody.innerHTML = data.shapeBody;
      } else if (type === 'sediment') {
        modalEmoji.textContent = '🪨';
        modalTitle.textContent = '川原の石・土のようす';
        renderTags(modalTags, data.sedimentTags);
        modalBody.innerHTML = data.sedimentBody;
      }
      
      riverDetailModal.classList.add('show');
    }

    function closeRiverDetail(){
      riverDetailModal.classList.remove('show');
    }

    // モーダル外をクリックで閉じる
    riverDetailModal.addEventListener('click', (e) => {
      if (e.target === riverDetailModal) {
        closeRiverDetail();
      }
    });

    function clearParticles(){
      if (particleInterval) {
        if (particleInterval.water) clearInterval(particleInterval.water);
        if (particleInterval.sediment) clearInterval(particleInterval.sediment);
        particleInterval = null;
      }
      const existingParticles = riverAnimation.querySelectorAll('.water-particle, .sediment-particle');
      existingParticles.forEach(p => p.remove());
    }

    function createWaterParticle(section){
      const particle = document.createElement('div');
      particle.className = `water-particle ${section}`;
      const top = Math.random() * 60 + 20;
      particle.style.top = top + 'px';
      particle.style.left = '-10px';
      particle.style.animationDelay = Math.random() * 1 + 's';
      riverAnimation.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) particle.remove();
      }, 12000);
    }

    function createSedimentParticle(section){
      const particle = document.createElement('div');
      particle.className = `sediment-particle ${section}`;
      const top = Math.random() * 35 + 100;
      particle.style.top = top + 'px';
      particle.style.left = '-15px';
      particle.style.animationDelay = Math.random() * 1 + 's';
      riverAnimation.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) particle.remove();
      }, 12000);
    }

    function startParticleAnimation(section){
      clearParticles();
      
      const waterInterval = section === 'upper' ? 600 : section === 'middle' ? 1000 : 1800;
      const sedimentInterval = section === 'upper' ? 1200 : section === 'middle' ? 1800 : 2500;
      
      // 水のパーティクルを生成
      const waterIntervalId = setInterval(() => {
        createWaterParticle(section);
      }, waterInterval);
      
      // 土砂のパーティクルを生成
      const sedimentIntervalId = setInterval(() => {
        if (Math.random() > 0.4) {
          createSedimentParticle(section);
        }
      }, sedimentInterval);
      
      // 両方のインターバルを管理
      particleInterval = {
        water: waterIntervalId,
        sediment: sedimentIntervalId
      };
      
      // 初期パーティクルを生成
      for (let i = 0; i < (section === 'upper' ? 8 : section === 'middle' ? 6 : 4); i++) {
        setTimeout(() => {
          createWaterParticle(section);
          if (i % 2 === 0 && section !== 'lower') {
            createSedimentParticle(section);
          }
        }, i * (section === 'upper' ? 200 : section === 'middle' ? 300 : 400));
      }
    }

    function updateRiverSim(){
      const data = riverData[currentSection];

      setBarWidth(speedBar, data.speed);
      setBarWidth(erodeBar, data.erode);
      setBarWidth(depositBar, data.deposit);

      speedValue.textContent = data.speedText;
      erodeValue.textContent = data.erodeText;
      depositValue.textContent = data.depositText;

      speedSub.textContent = data.speedSub;
      erodeSub.textContent = data.erodeSub;
      depositSub.textContent = data.depositSub;

      // ボタンのエモジを更新
      shapeBtnEmoji.textContent = data.shapeEmoji;

      simCommentEl.innerHTML =
        data.comment + '<br>' +
        '上流・中流・下流で、川の流れの速さが変わると、「けずる」「運ぶ」「積もらせる」のどのはたらきが大きくなるかが変わることをおさえましょう。';

      // アニメーション要素を更新
      riverAnimation.className = `river-animation ${currentSection}`;
      waterWave.className = `water-wave ${currentSection}`;
      riverBanks.className = `river-banks ${currentSection}`;
      
      // 侵食・堆積エフェクトの表示
      if (currentSection === 'upper') {
        erosionEffect.style.display = 'block';
        depositEffect.style.display = 'none';
      } else if (currentSection === 'lower') {
        erosionEffect.style.display = 'none';
        depositEffect.style.display = 'block';
      } else {
        erosionEffect.style.display = 'none';
        depositEffect.style.display = 'none';
      }

      // パーティクルアニメーションを開始
      startParticleAnimation(currentSection);
    }

    riverTabs.forEach(tab=>{
      tab.addEventListener('click', ()=>{
        riverTabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        currentSection = tab.dataset.section || 'upper';
        updateRiverSim();
      });
    });

    updateRiverSim(); // 初期表示

    /* ================================
       ▼ 問題データ（わかる編）
    ================================= */
    const lessonData = {
      id: 'sci.earth.river_work_sim',
      questions: [
        {
          id: 1,
          question: "川の上流・中流・下流のうち、川の流れがとても速く、川底や川岸を強くけずるはたらき（侵食）がもっとも大きいのはどこですか？",
          choices: [
            "上流",
            "中流",
            "下流",
            "どの場所も同じ強さでけずる"
          ],
          correct: 0,
          explanation: "山あいを流れる<strong>上流</strong>では、川の流れがとても速く、川底や川岸の岩や土を強く<strong>けずり取る（侵食する）</strong>はたらきが大きくなります。その結果、深い<strong>V字谷</strong>がつくられます。"
        },
        {
          id: 2,
          question: "川の下流のようすについての説明として、もっとも適切なものはどれですか？",
          choices: [
            "川の流れがとても速く、大きな岩をけずる力がいちばん大きい",
            "川の流れがゆるやかになり、運んできた細かい土や砂が積もりやすい",
            "川の流れがまったく止まっているので、土や砂は動かない",
            "川の流れが速くなったり止まったりをくり返し、谷がどんどん深くなる"
          ],
          correct: 1,
          explanation: "平野を流れる<strong>下流</strong>では、川の流れが<strong>ゆるやか</strong>になり、上流や中流から運ばれてきた<strong>細かい土や砂</strong>が川底や川のまわりに<strong>積もりやすく</strong>なります。その結果、広い<strong>平野</strong>や<strong>三角州</strong>がつくられます。"
        },
        {
          id: 3,
          question: "同じ川の上流と下流をくらべると、下流の川原にはどのような石が多く見られることが多いですか？その理由としてもっとも適切なものはどれですか？",
          choices: [
            "上流よりも、角ばった大きな岩が多い。けずる力が大きいから。",
            "上流よりも、丸く小さくなった石が多い。運ばれるあいだにぶつかり合ってけずられるから。",
            "上流よりも、石がまったくない。川が石を全部とかしてしまうから。",
            "上流よりも、とがった石が多い。流れがゆるやかなので、石が全く動かないから。"
          ],
          correct: 1,
          explanation: "上流でけずり取られた石は、川の流れに運ばれるあいだに<strong>何度もぶつかり合って</strong>角がけずられ、だんだんと<strong>小さく・丸く</strong>なっていきます。このため、下流の川原には<strong>丸くなった小石</strong>が多く見られることが多いのです。"
        }
      ]
    };

    /* ================================
       ▼ LearningTracker & 問題表示
    ================================= */
    class LearningTracker {
      constructor() {
        this.mode = 'wakaru';
        this.historyKey = 'learningHistory_river_work_wakaru';
        this.currentSession = {
          startTime: Date.now(),
          questions: [],
          score: 0,
          totalQuestions: 0,
          mode: 'wakaru'
        };
      }
      recordAnswer(questionId, selectedAnswer, correctAnswer, timeSpent) {
        this.currentSession.questions.push({
          questionId,
          selectedAnswer,
          correctAnswer,
          isCorrect: selectedAnswer === correctAnswer,
          timeSpent,
          timestamp: Date.now()
        });
        if (selectedAnswer === correctAnswer) this.currentSession.score++;
        this.currentSession.totalQuestions++;
      }
      loadHistory() {
        try {
          const data = localStorage.getItem(this.historyKey);
          if (data) return JSON.parse(data);
        } catch(e){ console.error(e); }
        return {
          sessions: [],
          stats: {
            totalSessions:0,
            totalQuestions:0,
            correctAnswers:0,
            averageScore:0,
            bestScore:0
          }
        };
      }
      calculateStats(sessions) {
        const stats = {
          totalSessions: sessions.length,
          totalQuestions: 0,
          correctAnswers: 0,
          averageScore: 0,
          bestScore: 0
        };
        sessions.forEach(s=>{
          stats.totalQuestions += s.totalQuestions;
          stats.correctAnswers += s.score;
          stats.bestScore = Math.max(stats.bestScore, s.score);
        });
        if (stats.totalSessions>0 && stats.totalQuestions>0){
          stats.averageScore = (stats.correctAnswers / stats.totalQuestions *100).toFixed(1);
        }
        return stats;
      }
      saveSession() {
        try {
          const existing = this.loadHistory();
          const totalTime = Date.now() - this.currentSession.startTime;
          this.currentSession.totalTime = totalTime;
          const sessionToSave = {
            ...this.currentSession,
            endTime: Date.now(),
            duration: totalTime,
            totalTime
          };
          existing.sessions.push(sessionToSave);
          existing.stats = this.calculateStats(existing.sessions);
          localStorage.setItem(this.historyKey, JSON.stringify(existing));
          console.log('✅ セッション保存完了', sessionToSave);
          return true;
        } catch(e){
          console.error('セッション保存エラー', e);
          return false;
        }
      }
    }

    const learningTracker = new LearningTracker();
    let currentQuestion = 0;
    let score = 0;
    let questionStartTime = Date.now();

    function generateShuffledIndices(length){
      const idx = Array.from({length},(_,i)=>i);
      for(let i=idx.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
      return idx;
    }

    function showQuestion(index){
      const q = lessonData.questions[index];
      questionStartTime = Date.now();
      const expEl = document.getElementById('explanation');
      expEl.classList.remove('show');

      document.getElementById('question-text').textContent = q.question;
      const choicesContainer = document.getElementById('choices');
      choicesContainer.innerHTML = '';

      const order = generateShuffledIndices(q.choices.length);
      order.forEach(originalIndex=>{
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = q.choices[originalIndex];
        div.dataset.originalIndex = String(originalIndex);
        div.onclick = () => selectAnswer(originalIndex);
        choicesContainer.appendChild(div);
      });

      const progress = ((index+1)/lessonData.questions.length)*100;
      document.getElementById('progress-fill').style.width = progress + '%';

      document.getElementById('prev-btn').disabled = index===0;
      const nextBtn = document.getElementById('next-btn');
      if (index === lessonData.questions.length-1){
        nextBtn.disabled = false;
        nextBtn.textContent = '学習完了';
      } else {
        nextBtn.disabled = false;
        nextBtn.textContent = '次の問題';
      }
    }

    function sendQuestionAnswerToParent(questionData, userAnswer, isCorrect){
      const messageData = {
        type:'question:answered',
        lessonId: lessonData.id,
        questionData:{
          qnum: questionData.id || currentQuestion,
          question: questionData.question,
          choices: questionData.choices,
          answer: questionData.correct,
          explanation: questionData.explanation
        },
        userAnswer,
        correctAnswer: questionData.correct,
        isCorrect,
        timestamp: Date.now()
      };
      console.log('📝 個別問題回答を送信:', messageData);
      try{
        if (window.parent !== window) window.parent.postMessage(messageData,'*');
        if (window.top !== window) window.top.postMessage(messageData,'*');
        const existing = JSON.parse(localStorage.getItem('questionAnswers') || '[]');
        existing.push(messageData);
        localStorage.setItem('questionAnswers', JSON.stringify(existing));
      }catch(e){
        console.log('❌ 個別問題回答送信失敗:', e);
      }
    }

    function selectAnswer(choiceIndex){
      const q = lessonData.questions[currentQuestion];
      const choices = document.querySelectorAll('.choice');
      const timeSpent = Date.now() - questionStartTime;

      choices.forEach(c=>{ c.style.pointerEvents='none'; });

      choices.forEach(c=>{
        c.classList.remove('selected','correct','incorrect');
        const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
        if (originalIndex === choiceIndex){
          c.classList.add('selected');
        }
      });

      setTimeout(()=>{
        const isCorrect = choiceIndex === q.correct;
        choices.forEach(c=>{
          const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
          if (originalIndex === q.correct){
            c.classList.add('correct');
          } else if (originalIndex === choiceIndex && !isCorrect){
            c.classList.add('incorrect');
          }
        });

        const expEl = document.getElementById('explanation');
        expEl.innerHTML = '<h4>解説</h4><p>' + q.explanation + '</p>';
        expEl.classList.add('show');

        if (isCorrect) score++;

        learningTracker.recordAnswer(
          q.id || currentQuestion,
          choiceIndex,
          q.correct,
          Math.round(timeSpent/1000)
        );
        sendQuestionAnswerToParent(q, choiceIndex, isCorrect);
      }, 500);
    }

    function previousQuestion(){
      if (currentQuestion>0){
        currentQuestion--;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function showCurrentSessionResult(){
      const session = learningTracker.currentSession;
      const scorePercent = session.totalQuestions>0
        ? Math.round((session.score/session.totalQuestions)*100)
        : 0;
      let msg = '';
      if (scorePercent >= 90) msg = '🎉 川のはたらきをとてもよく理解できています！';
      else if (scorePercent >= 70) msg = '👍 よくできました！';
      else if (scorePercent >= 50) msg = '📚 上流・中流・下流のちがいをもう一度整理してみよう。';
      else msg = '💪 シミュレーションで、川の場所を切り替えながらはたらきのちがいをもう一度たどってみよう。';

      const totalTime = Date.now() - session.startTime;
      const m = Math.floor(totalTime/60000);
      const s = Math.floor((totalTime%60000)/1000);
      const timeDisp = m>0 ? m+'分'+s+'秒' : s+'秒';

      return `
        <div style="background: linear-gradient(135deg,#64b5f6 0%,#42a5f5 100%); color:white; padding:2rem; border-radius:16px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.3); margin-top:20px;">
          <div style="font-size:1.8rem; font-weight:bold; margin-bottom:1rem;">学習完了！</div>
          <div style="font-size:1.1rem; margin-bottom:1.5rem;">${msg}</div>
          <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
            <div style="font-size:2.5rem; font-weight:bold; margin-bottom:0.5rem;">${session.score}/${session.totalQuestions}問正解</div>
            <div style="font-size:1.5rem; font-weight:600;">${scorePercent}%</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
            <div>学習時間: <strong>${timeDisp}</strong></div>
            <div>完了時刻: <strong>${new Date().toLocaleString('ja-JP',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong></div>
          </div>
        </div>
      `;
    }

    function completeLesson(){
      learningTracker.saveSession();
      const messageData = {
        type:'lesson:complete',
        lessonId: lessonData.id,
        detail:{
          correct: learningTracker.currentSession.score,
          total: learningTracker.currentSession.totalQuestions,
          timeSec: Math.round((Date.now()-learningTracker.currentSession.startTime)/1000)
        }
      };
      console.log('🚀 完了メッセージ送信:', messageData);
      try{ if (window.parent !== window) window.parent.postMessage(messageData,'*'); }catch(e){}
      try{ if (window.top !== window) window.top.postMessage(messageData,'*'); }catch(e){}

      try{
        const storageMessage = { type:'lesson:complete', data:messageData, timestamp:Date.now() };
        localStorage.setItem('lessonCompleteMessage', JSON.stringify(storageMessage));
        if (window.parent && window.parent.saveLessonProgress){
          window.parent.saveLessonProgress(
            messageData.lessonId,
            messageData.detail.correct,
            messageData.detail.total,
            messageData.detail.timeSec
          );
        }
      }catch(e){ console.log('localStorage/saveLessonProgress エラー', e); }

      document.getElementById('question-container').style.display='none';
      const resultContainer = document.createElement('div');
      resultContainer.className='question-container';
      resultContainer.style.display='block';
      resultContainer.innerHTML = showCurrentSessionResult();

      const homeButton = document.createElement('button');
      homeButton.textContent = '🏠 ホームに戻る';
      homeButton.className = 'start-learning-btn';
      homeButton.style.marginTop = '1.5rem';
      homeButton.onclick = ()=>{
        if (window.parent !== window || window.top !== window){
          try{
            window.parent.postMessage({type:'lesson:goBack'}, '*');
            window.top.postMessage({type:'lesson:goBack'}, '*');
            return;
          }catch(e){}
        }
        goHome();
      };
      resultContainer.appendChild(homeButton);
      document.querySelector('.main-container').appendChild(resultContainer);
    }

    function nextQuestion(){
      if (currentQuestion === lessonData.questions.length-1){
        completeLesson();
        return;
      }
      if (currentQuestion < lessonData.questions.length-1){
        currentQuestion++;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function startLearning(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('question-container').style.display = 'block';
      if (lessonData.questions.length > 0){
        showQuestion(0);
      } else {
        alert('問題データがまだ追加されていません。');
      }
    }

    function goHome(){
      window.location.href = '/';
    }
  </script>
</body>
</html>
