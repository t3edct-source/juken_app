<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - é›»æµã®ä½œç”¨â‘ ï¼ˆç™ºç†±ï¼‰</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: linear-gradient(135deg, #ffe29f 0%, #fad0c4 50%, #fbc2eb 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(255,255,255,0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .home-btn {
      background:#ff6b6b;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:20px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .home-btn:hover { background:#ff5252; transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.98); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#333;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥å…¨ä½“ */
    .sim-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      margin-bottom:15px;
      overflow:hidden;
      position:relative;
    }
    .sim-header {
      background:linear-gradient(135deg, #f7971e 0%, #ff5858 100%);
      color:white;
      padding:15px;
      text-align:center;
    }
    .sim-header h2 { font-size:20px; margin-bottom:5px; }
    .sim-header p { font-size:14px; opacity:0.9; }

    .sim-area {
      padding:12px 12px 16px;
      background:#fff3e0;
    }
    .sim-control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .sim-control-label {
      font-size:13px;
      font-weight:bold;
      color:#5d4037;
      min-width:140px;
    }
    .slider {
      flex:1;
      -webkit-appearance:none;
      height:6px;
      border-radius:999px;
      background:#ffe0b2;
      outline:none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance:none;
      width:22px; height:22px;
      border-radius:50%;
      background:#ff7043;
      box-shadow:0 0 0 4px rgba(255,112,67,0.3);
      cursor:pointer;
    }
    .slider::-moz-range-thumb {
      width:22px; height:22px;
      border-radius:50%;
      background:#ff7043;
      box-shadow:0 0 0 4px rgba(255,112,67,0.3);
      cursor:pointer;
    }
    .value-display {
      font-size:13px;
      font-weight:bold;
      color:#6d4c41;
      min-width:90px;
      text-align:right;
    }

    .sim-field {
      position:relative;
      margin-top:0;
      margin-bottom:12px;
      background:linear-gradient(to bottom, #fff8e1 0%, #ffe0b2 60%, #ffcc80 100%);
      border-radius:12px;
      padding:12px;
      overflow:hidden;
      min-height:220px;
    }

    /* â–¼ é›»ç†±ç·šï¼‹å›è·¯ã‚¤ãƒ¡ãƒ¼ã‚¸ */
    .heater-box {
      position:relative;
      width:100%;
      height:140px;
      border-radius:12px;
      background:radial-gradient(circle at 50% 10%, #ffffff 0%, #ffe0b2 30%, #ffcc80 100%);
      box-shadow: inset 0 0 10px rgba(255,183,77,0.6);
    }
    .heater-wire {
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%);
      width:160px;
      height:30px;
      border-radius:18px;
      background:linear-gradient(90deg, #8d6e63, #6d4c41);
      box-shadow:inset 0 0 6px rgba(0,0,0,0.4);
      overflow:hidden;
    }
    .heater-coil {
      position:absolute;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background-image:repeating-linear-gradient(
        90deg,
        rgba(0,0,0,0) 0px,
        rgba(0,0,0,0) 6px,
        rgba(255,255,255,0.4) 6px,
        rgba(255,255,255,0.4) 10px
      );
      mix-blend-mode:screen;
    }
    .heater-glow {
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%);
      width:140px;
      height:22px;
      border-radius:16px;
      background:radial-gradient(circle at 50% 50%, rgba(255,255,255,0.9) 0%, rgba(255,160,0,0.9) 40%, rgba(255,87,34,0.3) 80%);
      opacity:0;
      transition:opacity 0.25s ease, box-shadow 0.25s ease;
      box-shadow:0 0 0 rgba(255,111,0,0.8);
      pointer-events:none;
    }
    .heater-glow.low {
      opacity:0.4;
      box-shadow:0 0 14px rgba(255,167,38,0.9);
    }
    .heater-glow.mid {
      opacity:0.75;
      box-shadow:0 0 22px rgba(255,111,0,1);
    }
    .heater-glow.high {
      opacity:1;
      box-shadow:0 0 30px rgba(255,61,0,1);
    }

    .terminal {
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:16px;
      height:40px;
      border-radius:8px;
      background:linear-gradient(to bottom, #b0bec5, #78909c);
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
    }
    .terminal.left { left:40px; }
    .terminal.right { right:40px; }

    .terminal-label {
      position:absolute;
      top:-16px;
      width:100%;
      text-align:center;
      font-size:11px;
      font-weight:bold;
      color:#4e342e;
    }

    .thermo-panel {
      position:absolute;
      right:10px;
      top:10px;
      width:60px;
      height:120px;
      border-radius:12px;
      background:rgba(255,255,255,0.8);
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      padding:6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      font-size:10px;
      color:#5d4037;
    }
    .thermo-bar {
      width:14px;
      border-radius:10px;
      background:linear-gradient(to top, #d32f2f, #ffb74d);
      height:20%;
      transition:height 0.25s ease;
    }
    .thermo-scale {
      position:absolute;
      left:6px;
      top:6px;
      bottom:6px;
      width:2px;
      background:#d7ccc8;
    }
    .thermo-scale::before,
    .thermo-scale::after {
      content:"";
      position:absolute;
      left:-3px;
      width:8px;
      height:2px;
      background:#a1887f;
    }
    .thermo-scale::before { top:12px; }
    .thermo-scale::after  { bottom:12px; }

    .thermo-minmax {
      position:absolute;
      left:16px;
      right:6px;
      display:flex;
      justify-content:space-between;
      font-size:9px;
    }
    .thermo-minmax.top { top:6px; }
    .thermo-minmax.bottom { bottom:6px; }

    .heat-panel {
      margin-top:8px;
      background:rgba(255,255,255,0.9);
      border-radius:10px;
      padding:8px 10px;
    }
    .heat-title {
      font-size:13px;
      font-weight:bold;
      color:#5d4037;
      margin-bottom:4px;
    }
    .heat-bar {
      position:relative;
      height:12px;
      border-radius:999px;
      overflow:hidden;
      background:#efebe9;
    }
    .heat-fill {
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, #ffe082, #ffb74d, #ff7043);
      transition:width 0.25s ease;
    }
    .heat-label {
      margin-top:4px;
      font-size:11px;
      color:#4e342e;
      text-align:right;
    }

    .sim-comment {
      font-size:13px;
      line-height:1.6;
      color:#4e342e;
      background:#ffecb3;
      border-radius:12px;
      padding:10px 12px;
      border-left:4px solid #fb8c00;
      margin-top:8px;
    }
    .sim-comment strong { color:#e65100; }

    /* â–¼ infoãƒ‘ãƒãƒ« */
    .info-panel {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .info-panel h3 {
      color:#333;
      margin-bottom:15px;
      font-size:18px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:15px;
    }
    .info-item {
      background:#f8f9fa;
      padding:15px;
      border-radius:10px;
      border-left:4px solid #ffb74d;
    }
    .info-item h4 {
      color:#fb8c00;
      margin-bottom:8px;
      font-size:14px;
    }
    .info-item p {
      color:#555;
      font-size:13px;
      line-height:1.4;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background:white;
      border-radius:15px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
      padding:20px;
      margin-bottom:15px;
    }
    .question-text {
      font-size:16px;
      font-weight:bold;
      color:#333;
      margin-bottom:15px;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choice {
      padding:14px 16px;
      background:#f8f9fa;
      border:2px solid #e9ecef;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:14px;
      min-height:48px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .choice:hover {
      background:#e9ecef;
      border-color:#ffb74d;
    }
    .choice.selected {
      background:#ffb74d;
      color:white;
      border-color:#fb8c00;
    }
    .choice.correct {
      background:#28a745;
      color:white;
      border-color:#28a745;
      animation:correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background:#dc3545;
      color:white;
      border-color:#dc3545;
      animation:wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    .explanation {
      margin-top:15px;
      padding:15px;
      background:#f8f9fa;
      border-radius:10px;
      border-left:4px solid #28a745;
      display:none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#28a745;
      margin-bottom:10px;
    }
    .explanation p {
      color:#666;
      line-height:1.5;
    }
    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:20px;
    }
    .nav-btn {
      padding:14px 24px;
      border:none;
      border-radius:25px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:48px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#6c757d;
      color:white;
    }
    .prev-btn:hover:not(:disabled) { background:#5a6268; }
    .next-btn {
      background:#ffb74d;
      color:#4e342e;
    }
    .next-btn:hover:not(:disabled) { background:#ffa726; }

    .start-learning-btn {
      background:linear-gradient(135deg, #ffb74d 0%, #ff8a65 100%);
      color:white;
      border:none;
      padding:16px 30px;
      border-radius:25px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      margin:20px auto;
      display:block;
      min-height:52px;
      width:100%;
      max-width:400px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .start-learning-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(255,183,77,0.35);
    }
    .progress-bar {
      background:#e9ecef;
      border-radius:10px;
      height:8px;
      margin:15px 0;
      overflow:hidden;
    }
    .progress-fill {
      background:linear-gradient(135deg, #ffb74d 0%, #ff8a65 100%);
      height:100%;
      transition:width 0.3s ease;
    }

    * { touch-action:manipulation; }
    .choice, .nav-btn, .home-btn, .start-learning-btn {
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    @media (max-width:768px){
      body { overflow-x:hidden; }
      .header { padding:8px 12px; }
      .home-btn { padding:10px 16px; font-size:13px; }
      .lesson-title { font-size:14px; margin:0 8px; text-align:center; }
      .header > div:last-child { width:80px; }
      .main-container { padding:10px; }
      .info-grid { grid-template-columns:1fr; gap:12px; }
      .info-panel { padding:16px; }
      .info-item { padding:12px; }
      .info-item h4 { font-size:13px; }
      .info-item p { font-size:12px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { min-height:230px; }
      .question-container { padding:16px; }
      .question-text { font-size:15px; margin-bottom:12px; }
      .choice { padding:14px 16px; font-size:14px; min-height:52px; }
      .navigation { flex-direction:column; gap:12px; margin-top:16px; }
      .nav-btn { width:100%; padding:14px 20px; font-size:15px; }
      .start-learning-btn { padding:16px 24px; font-size:15px; max-width:100%; }
      .explanation { padding:12px; font-size:13px; margin-top:12px; }
      .progress-bar { margin:12px 0; }
    }
    @media (max-width:480px){
      .header { padding:6px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:12px; margin:0 6px; }
      .header > div:last-child { width:70px; }
      .main-container { padding:8px; }
      .question-container { padding:12px; }
      .question-text { font-size:14px; }
      .choice { padding:12px 14px; font-size:13px; min-height:48px; }
      .info-panel { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - é›»æµã®ä½œç”¨â‘ ï¼ˆç™ºç†±ï¼‰</div>
    <div style="width:80px;"></div>
  </div>

  <div class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="sim-container">
      <div class="sim-header">
        <h2>ğŸ”¥ é›»æµã®ä½œç”¨â‘  ç™ºç†±ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        <p>é›»æµã®å¼·ã•ã¨æµã™æ™‚é–“ã§ã€é›»ç†±ç·šã®ã‚ãŸãŸã¾ã‚Šæ–¹ãŒã©ã†å¤‰ã‚ã‚‹ã‹ä½“é¨“ã—ã‚ˆã†</p>
      </div>
      <div class="sim-area">
        <div class="sim-field">
          <div class="heater-box">
            <div class="terminal left">
              <div class="terminal-label">ï¼‹</div>
            </div>
            <div class="terminal right">
              <div class="terminal-label">âˆ’</div>
            </div>

            <div class="heater-wire">
              <div class="heater-coil"></div>
              <div class="heater-glow" id="heaterGlow"></div>
            </div>

            <div class="thermo-panel">
              <div class="thermo-scale"></div>
              <div class="thermo-minmax top">
                <span>é«˜</span><span>æ¸©</span>
              </div>
              <div class="thermo-minmax bottom">
                <span>ä½</span><span>æ¸©</span>
              </div>
              <div class="thermo-bar" id="thermoBar"></div>
              <div style="margin-top:4px;">æ¸©åº¦ã‚¤ãƒ¡ãƒ¼ã‚¸</div>
            </div>
          </div>

          <div class="heat-panel">
            <div class="heat-title">é›»ç†±ç·šã‹ã‚‰å‡ºã‚‹ç†±ã®é‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</div>
            <div class="heat-bar">
              <div class="heat-fill" id="heatFill"></div>
            </div>
            <div class="heat-label" id="heatLabel">é›»æµãŒæµã‚Œã¦ã„ãªã„ã®ã§ 0%</div>
          </div>

          <div class="sim-comment" id="simComment">
            ã€Œé›»æµã®å¼·ã•ã€ã¨ã€Œæ™‚é–“ã€ã‚’ã‹ãˆã¦ã¿ã‚ˆã†ã€‚<br>
            é›»æµãŒ<strong>å¼·ã</strong>ã€æµã™æ™‚é–“ãŒ<strong>é•·ã„</strong>ã»ã©ã€é›»ç†±ç·šã‹ã‚‰å‡ºã‚‹ç†±ã®é‡ã¯<strong>å¤§ãã</strong>ãªã‚Šã¾ã™ã€‚<br>
            åå¯¾ã«ã€é›»æµãŒå¼±ã‹ã£ãŸã‚Šã€ã™ãã«ã‚¹ã‚¤ãƒƒãƒã‚’åˆ‡ã£ãŸã‚Šã™ã‚‹ã¨ã€ã‚ã¾ã‚Šã‚ãŸãŸã¾ã‚Šã¾ã›ã‚“ã€‚
          </div>
        </div>

        <!-- æ“ä½œUIã‚’ä¸‹ã«é…ç½® -->
        <div class="sim-control-row">
          <div class="sim-control-label">é›»æµã®å¼·ã•ï¼ˆå° â†’ å¤§ï¼‰</div>
          <input type="range" id="currentSlider" class="slider" min="0" max="3" step="1" value="1">
          <div class="value-display" id="currentDisplay">å¼±ã‚</div>
        </div>

        <div class="sim-control-row">
          <div class="sim-control-label">æµã—ãŸæ™‚é–“ï¼ˆç§’ï¼‰</div>
          <input type="range" id="timeSlider" class="slider" min="0" max="10" step="1" value="3">
          <div class="value-display" id="timeDisplay">3 ç§’</div>
        </div>
      </div>
    </div>

    <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="info-panel" id="info-panel">
      <h3>ğŸ“Š é›»æµã®å¤§ãã•ã¨ç™ºç†±ã®ãã¾ã‚Š</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>é›»æµãŒæµã‚Œã‚‹ã¨ç†±ãŒå‡ºã‚‹</h4>
          <p>é›»ç†±ç·šã‚„é›»æ°—ã‚¹ãƒˆãƒ¼ãƒ–ã®ç·šã«ã¯ã€é›»æµãŒæµã‚Œã‚‹ã¨<strong>ç†±</strong>ãŒå‡ºã‚‹ã¯ãŸã‚‰ããŒã‚ã‚Šã¾ã™ã€‚<br>
             ã“ã®ã‚ˆã†ã«ã€é›»æµã®ã¯ãŸã‚‰ãã«ã‚ˆã£ã¦ç‰©ä½“ã®æ¸©åº¦ãŒä¸ŠãŒã‚‹ã“ã¨ã‚’<strong>é›»æµã®ç™ºç†±ä½œç”¨</strong>ã¨ã„ã„ã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>é›»æµãŒå¼·ã„ã»ã©ã€å‡ºã‚‹ç†±ã¯å¤§ãã„</h4>
          <p>åŒã˜é›»ç†±ç·šã«é›»æµã‚’æµã—ãŸã¨ãã€<br>
             ãƒ»é›»æµãŒ<strong>å¼·ã„</strong>ã»ã©<br>
             ãƒ»é›»æµã‚’æµã™<strong>æ™‚é–“ãŒé•·ã„</strong>ã»ã©<br>
             é›»ç†±ç·šã‹ã‚‰å‡ºã‚‹ç†±ã®é‡ã¯<strong>å¤§ãã</strong>ãªã‚Šã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>å®‰å…¨ã«ä½¿ã†ã“ã¨ã‚‚å¤§äº‹</h4>
          <p>é›»ç†±ç·šãŒç†±ããªã‚Šã™ãã‚‹ã¨ã€ã“ã‚ã‚ŒãŸã‚Šã€ç«äº‹ã®åŸå› ã«ãªã£ãŸã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
             å®šã‚ã‚‰ã‚ŒãŸ<strong>é›»åœ§ã‚„é›»æµ</strong>ã‚’å®ˆã‚Šã€å®‰å…¨ã«é›»æ°—å™¨å…·ã‚’ä½¿ã†ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚</p>
        </div>
      </div>
      <button class="start-learning-btn" onclick="startLearning()">å­¦ç¿’ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <!-- â–¼ å•é¡Œã‚¨ãƒªã‚¢ -->
    <div class="question-container" id="question-container" style="display:none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="explanation" id="explanation"></div>
      <div class="navigation">
        <button class="nav-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>å‰ã®å•é¡Œ</button>
        <button class="nav-btn next-btn" id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       â–¼ ç™ºç†±ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    ================================= */
    const currentSlider = document.getElementById('currentSlider');
    const timeSlider = document.getElementById('timeSlider');
    const currentDisplay = document.getElementById('currentDisplay');
    const timeDisplay = document.getElementById('timeDisplay');
    const heaterGlow = document.getElementById('heaterGlow');
    const thermoBar = document.getElementById('thermoBar');
    const heatFill = document.getElementById('heatFill');
    const heatLabel = document.getElementById('heatLabel');
    const simCommentEl = document.getElementById('simComment');

    function describeCurrent(level) {
      switch(level) {
        case 0: return 'æµã‚Œã¦ã„ãªã„';
        case 1: return 'å¼±ã‚';
        case 2: return 'ãµã¤ã†';
        case 3: return 'å¼·ã‚';
        default: return '';
      }
    }

    function updateDisplayText() {
      const c = parseInt(currentSlider.value, 10);
      const t = parseInt(timeSlider.value, 10);
      currentDisplay.textContent = describeCurrent(c);
      timeDisplay.textContent = t + ' ç§’';
    }

    function calcHeat() {
      const c = parseInt(currentSlider.value, 10);
      const t = parseInt(timeSlider.value, 10);

      if (c === 0 || t === 0) return 0;

      // ã‚¤ãƒ¡ãƒ¼ã‚¸ç”¨ï¼šç†±é‡ âˆ é›»æµ^2 Ã— æ™‚é–“ ã‚’ã–ã£ãã‚Šãƒ¢ãƒ‡ãƒ«åŒ–
      const raw = (c * c) * t; // æœ€å¤§: 3^2*10 = 90
      const percent = Math.min(100, Math.round(raw / 90 * 100));
      return percent;
    }

    function updateHeater() {
      updateDisplayText();
      const heatPercent = calcHeat();

      // ãƒ’ãƒ¼ãƒˆãƒãƒ¼
      heatFill.style.width = heatPercent + '%';
      if (heatPercent === 0) {
        heatLabel.textContent = 'é›»æµãŒæµã‚Œã¦ã„ãªã„ã‹ã€ã™ãã«åˆ‡ã£ãŸã®ã§ 0%';
      } else {
        heatLabel.textContent = 'å‡ºã¦ãã‚‹ç†±ã®é‡ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š' + heatPercent + '%';
      }

      // é›»ç†±ç·šã®å…‰ã‚Šæ–¹
      heaterGlow.classList.remove('low', 'mid', 'high');
      if (heatPercent === 0) {
        heaterGlow.style.opacity = 0;
      } else if (heatPercent <= 40) {
        heaterGlow.classList.add('low');
      } else if (heatPercent <= 75) {
        heaterGlow.classList.add('mid');
      } else {
        heaterGlow.classList.add('high');
      }

      // æ¸©åº¦ãƒãƒ¼ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
      const minHeight = 15; // %
      const maxHeight = 90; // %
      const h = heatPercent === 0
        ? minHeight
        : minHeight + (maxHeight - minHeight) * (heatPercent / 100);
      thermoBar.style.height = h + '%';

      // ã‚³ãƒ¡ãƒ³ãƒˆ
      const c = parseInt(currentSlider.value, 10);
      const t = parseInt(timeSlider.value, 10);
      let comment = '';
      if (c === 0 || t === 0) {
        comment =
          'é›»æµãŒ<strong>æµã‚Œã¦ã„ãªã„</strong>ã‹ã€<strong>ã™ãã«åˆ‡ã£ã¦ã—ã¾ã£ãŸ</strong>ã®ã§ã€é›»ç†±ç·šã¯ã»ã¨ã‚“ã©ã‚ãŸãŸã¾ã‚Šã¾ã›ã‚“ã€‚' +
          'é›»æµã‚’æµã—ã€å°‘ã—é•·ã‚ã«ã‚ˆã†ã™ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
      } else if (c === 1 && t <= 3) {
        comment =
          'é›»æµãŒ<strong>å¼±ã</strong>ã€æ™‚é–“ã‚‚<strong>çŸ­ã„</strong>ã®ã§ã€å°‘ã—ã ã‘ã‚ãŸãŸã¾ã£ã¦ã„ã¾ã™ã€‚' +
          'é›»æµã‚’å¼·ãã—ãŸã‚Šã€æ™‚é–“ã‚’é•·ãã—ãŸã‚Šã™ã‚‹ã¨ã€ã‚‚ã£ã¨ç†±ãŒå‡ºã¾ã™ã€‚';
      } else if (c >= 2 && t >= 4 && t <= 7) {
        comment =
          'é›»æµãŒ<strong>ã‚„ã‚„å¼·ã</strong>ã€æ™‚é–“ã‚‚<strong>ãã“ãã“é•·ã„</strong>ã®ã§ã€é›»ç†±ç·šã¯ã‹ãªã‚Šã‚ãŸãŸã‹ããªã£ã¦ã„ã¾ã™ã€‚' +
          'é›»æµã®å¼·ã•ã¨æ™‚é–“ã®ä¸¡æ–¹ãŒã€å‡ºã¦ãã‚‹ç†±ã®é‡ã«é–¢ä¿‚ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚';
      } else if (c === 3 && t >= 8) {
        comment =
          'ã¨ã¦ã‚‚<strong>å¼·ã„é›»æµ</strong>ã‚’ã€<strong>é•·ã„æ™‚é–“</strong>æµã—ã¦ã„ã¾ã™ã€‚é›»ç†±ç·šã¯ã¨ã¦ã‚‚ç†±ããªã£ã¦ãŠã‚Šã€' +
          'å®Ÿéš›ã®é›»æ°—å™¨å…·ã§ã¯ã“ã®ã‚ˆã†ãªçŠ¶æ…‹ãŒç¶šãã¨å±é™ºã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚';
      } else {
        comment =
          'é›»æµãŒ<strong>' + describeCurrent(c) + '</strong>ã§ã€æ™‚é–“ã¯<strong>' + t + 'ç§’</strong>ã§ã™ã€‚' +
          'é›»æµãŒ<strong>å¼·ã„ã»ã©</strong>ã€æ™‚é–“ãŒ<strong>é•·ã„ã»ã©</strong>ã€é›»ç†±ç·šã‹ã‚‰å‡ºã‚‹ç†±ã®é‡ãŒå¤§ãããªã‚Šã¾ã™ã€‚';
      }
      simCommentEl.innerHTML = comment;
    }

    currentSlider.addEventListener('input', updateHeater);
    timeSlider.addEventListener('input', updateHeater);

    // åˆæœŸè¡¨ç¤º
    updateHeater();

    /* ================================
       â–¼ å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ã‹ã‚‹ç·¨ï¼‰
    ================================= */
    const lessonData = {
      id: 'sci.physics.current_effect_heating_sim',
      questions: [
        {
          id: 1,
          question: "åŒã˜é›»ç†±ç·šã«é›»æµã‚’æµã—ãŸã¨ãã€å‡ºã¦ãã‚‹ç†±ã®é‡ãŒå¤§ãããªã‚‹ã®ã¯ã©ã®ã‚ˆã†ãªã¨ãã§ã™ã‹ï¼Ÿ",
          choices: [
            "é›»æµãŒå¼±ãã€æ™‚é–“ã‚‚çŸ­ã„ã¨ã",
            "é›»æµãŒå¼·ãã€æ™‚é–“ã‚‚é•·ã„ã¨ã",
            "é›»æµã¨æ™‚é–“ã®ã©ã¡ã‚‰ã‚‚é–¢ä¿‚ã—ãªã„ã¨ã",
            "é›»æµãŒå¼±ãã€æ™‚é–“ã ã‘é•·ã„ã¨ã"
          ],
          correct: 1,
          explanation: "åŒã˜é›»ç†±ç·šã§ã¯ã€å‡ºã¦ãã‚‹ç†±ã®é‡ã¯é›»æµã®<strong>å¼·ã•</strong>ã¨<strong>æµã—ãŸæ™‚é–“</strong>ã®ä¸¡æ–¹ã«é–¢ä¿‚ã—ã¾ã™ã€‚é›»æµãŒ<strong>å¼·ã</strong>ã€<strong>é•·ã„æ™‚é–“</strong>æµã™ã»ã©ã€é›»ç†±ç·šã‹ã‚‰å‡ºã‚‹ç†±ã®é‡ã¯<strong>å¤§ãã</strong>ãªã‚Šã¾ã™ã€‚"
        },
        {
          id: 2,
          question: "åŒã˜é›»ç†±ç·šã«ã€ŒåŒã˜å¼·ã•ã®é›»æµã€ã‚’æµã—ãŸã¨ãã€å‡ºã¦ãã‚‹ç†±ã®é‡ã‚’å¤§ããã—ãŸã„å ´åˆã€ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ",
          choices: [
            "é›»æµã‚’æµã™æ™‚é–“ã‚’é•·ãã™ã‚‹",
            "é›»æµã‚’æµã™æ™‚é–“ã‚’çŸ­ãã™ã‚‹",
            "é›»ç†±ç·šã‚’å†·ã‚„ã—ãªãŒã‚‰ä½¿ã†",
            "é›»æ± ã®å‘ãã‚’ã¨ãã©ãå…¥ã‚Œã‹ãˆã‚‹"
          ],
          correct: 0,
          explanation: "åŒã˜å¼·ã•ã®é›»æµã‚’æµã—ã¦ã„ã‚‹ã¨ãã€å‡ºã¦ãã‚‹ç†±ã®é‡ã‚’å¤§ããã™ã‚‹ã«ã¯<strong>æµã™æ™‚é–“</strong>ã‚’<strong>é•·ã</strong>ã—ã¾ã™ã€‚é›»æµã®å¼·ã•ãŒåŒã˜ãªã‚‰ã€æ™‚é–“ãŒé•·ã„ã»ã©é›»ç†±ç·šãŒã†ã‘ã¨ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒãµãˆã€å‡ºã‚‹ç†±ã®é‡ã‚‚å¤§ãããªã‚Šã¾ã™ã€‚"
        },
        {
          id: 3,
          question: "æ¬¡ã®ã†ã¡ã€é›»ç†±ç·šãŒã„ã¡ã°ã‚“ç†±ããªã‚‹æ¡ä»¶ã¨ã—ã¦ã‚‚ã£ã¨ã‚‚é©åˆ‡ãªçµ„ã¿åˆã‚ã›ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿï¼ˆåŒã˜é›»ç†±ç·šã‚’ä½¿ã†ï¼‰",
          choices: [
            "é›»æµï¼šå¼±ã„ã€€æ™‚é–“ï¼šçŸ­ã„",
            "é›»æµï¼šå¼±ã„ã€€æ™‚é–“ï¼šé•·ã„",
            "é›»æµï¼šå¼·ã„ã€€æ™‚é–“ï¼šçŸ­ã„",
            "é›»æµï¼šå¼·ã„ã€€æ™‚é–“ï¼šé•·ã„"
          ],
          correct: 3,
          explanation: "åŒã˜é›»ç†±ç·šã§ã¯ã€å‡ºã¦ãã‚‹ç†±ã®é‡ã¯ã€Œé›»æµã®å¼·ã•ã€ã¨ã€Œæµã—ãŸæ™‚é–“ã€ã®ä¸¡æ–¹ã«é–¢ä¿‚ã—ã¾ã™ã€‚<br>é›»æµãŒ<strong>å¼·ã</strong>ã€æ™‚é–“ã‚‚<strong>é•·ã„</strong>ã¨ãï¼ˆé¸æŠè‚¢4ç•ªï¼‰ãŒã€ã‚‚ã£ã¨ã‚‚å¤§ããªç†±ãŒå‡ºã¦é›»ç†±ç·šã¯ã‚ˆãã‚ãŸãŸã¾ã‚Šã¾ã™ã€‚"
        }
      ]
    };

    /* ================================
       â–¼ LearningTracker & å•é¡Œè¡¨ç¤º
    ================================= */
    class LearningTracker {
      constructor() {
        this.mode = 'wakaru';
        this.historyKey = 'learningHistory_denki_hatsunetsu_wakaru';
        this.currentSession = {
          startTime: Date.now(),
          questions: [],
          score: 0,
          totalQuestions: 0,
          mode: 'wakaru'
        };
      }
      recordAnswer(questionId, selectedAnswer, correctAnswer, timeSpent) {
        this.currentSession.questions.push({
          questionId,
          selectedAnswer,
          correctAnswer,
          isCorrect: selectedAnswer === correctAnswer,
          timeSpent,
          timestamp: Date.now()
        });
        if (selectedAnswer === correctAnswer) this.currentSession.score++;
        this.currentSession.totalQuestions++;
      }
      loadHistory() {
        try {
          const data = localStorage.getItem(this.historyKey);
          if (data) return JSON.parse(data);
        } catch(e){ console.error(e); }
        return {
          sessions: [],
          stats: {
            totalSessions:0,
            totalQuestions:0,
            correctAnswers:0,
            averageScore:0,
            bestScore:0
          }
        };
      }
      calculateStats(sessions) {
        const stats = {
          totalSessions: sessions.length,
          totalQuestions: 0,
          correctAnswers: 0,
          averageScore: 0,
          bestScore: 0
        };
        sessions.forEach(s=>{
          stats.totalQuestions += s.totalQuestions;
          stats.correctAnswers += s.score;
          stats.bestScore = Math.max(stats.bestScore, s.score);
        });
        if (stats.totalSessions>0 && stats.totalQuestions>0){
          stats.averageScore = (stats.correctAnswers / stats.totalQuestions *100).toFixed(1);
        }
        return stats;
      }
      saveSession() {
        try {
          const existing = this.loadHistory();
          const totalTime = Date.now() - this.currentSession.startTime;
          this.currentSession.totalTime = totalTime;
          const sessionToSave = {
            ...this.currentSession,
            endTime: Date.now(),
            duration: totalTime,
            totalTime
          };
          existing.sessions.push(sessionToSave);
          existing.stats = this.calculateStats(existing.sessions);
          localStorage.setItem(this.historyKey, JSON.stringify(existing));
          console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†', sessionToSave);
          return true;
        } catch(e){
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼', e);
          return false;
        }
      }
    }

    const learningTracker = new LearningTracker();
    let currentQuestion = 0;
    let score = 0;
    let questionStartTime = Date.now();

    function generateShuffledIndices(length){
      const idx = Array.from({length},(_,i)=>i);
      for(let i=idx.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
      return idx;
    }

    function showQuestion(index){
      const q = lessonData.questions[index];
      questionStartTime = Date.now();
      const expEl = document.getElementById('explanation');
      expEl.classList.remove('show');

      document.getElementById('question-text').textContent = q.question;
      const choicesContainer = document.getElementById('choices');
      choicesContainer.innerHTML = '';

      const order = generateShuffledIndices(q.choices.length);
      order.forEach(originalIndex=>{
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = q.choices[originalIndex];
        div.dataset.originalIndex = String(originalIndex);
        div.onclick = () => selectAnswer(originalIndex);
        choicesContainer.appendChild(div);
      });

      const progress = ((index+1)/lessonData.questions.length)*100;
      document.getElementById('progress-fill').style.width = progress + '%';

      document.getElementById('prev-btn').disabled = index===0;
      const nextBtn = document.getElementById('next-btn');
      if (index === lessonData.questions.length-1){
        nextBtn.disabled = false;
        nextBtn.textContent = 'å­¦ç¿’å®Œäº†';
      } else {
        nextBtn.disabled = false;
        nextBtn.textContent = 'æ¬¡ã®å•é¡Œ';
      }
    }

    function sendQuestionAnswerToParent(questionData, userAnswer, isCorrect){
      const messageData = {
        type:'question:answered',
        lessonId: lessonData.id,
        questionData:{
          qnum: questionData.id || currentQuestion,
          question: questionData.question,
          choices: questionData.choices,
          answer: questionData.correct,
          explanation: questionData.explanation
        },
        userAnswer,
        correctAnswer: questionData.correct,
        isCorrect,
        timestamp: Date.now()
      };
      console.log('ğŸ“ å€‹åˆ¥å•é¡Œå›ç­”ã‚’é€ä¿¡:', messageData);
      try{
        if (window.parent !== window) window.parent.postMessage(messageData,'*');
        if (window.top !== window) window.top.postMessage(messageData,'*');
        const existing = JSON.parse(localStorage.getItem('questionAnswers') || '[]');
        existing.push(messageData);
        localStorage.setItem('questionAnswers', JSON.stringify(existing));
      }catch(e){
        console.log('âŒ å€‹åˆ¥å•é¡Œå›ç­”é€ä¿¡å¤±æ•—:', e);
      }
    }

    function selectAnswer(choiceIndex){
      const q = lessonData.questions[currentQuestion];
      const choices = document.querySelectorAll('.choice');
      const timeSpent = Date.now() - questionStartTime;

      choices.forEach(c=>{ c.style.pointerEvents='none'; });

      choices.forEach(c=>{
        c.classList.remove('selected','correct','incorrect');
        const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
        if (originalIndex === choiceIndex){
          c.classList.add('selected');
        }
      });

      setTimeout(()=>{
        const isCorrect = choiceIndex === q.correct;
        choices.forEach(c=>{
          const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
          if (originalIndex === q.correct){
            c.classList.add('correct');
          } else if (originalIndex === choiceIndex && !isCorrect){
            c.classList.add('incorrect');
          }
        });

        const expEl = document.getElementById('explanation');
        expEl.innerHTML = '<h4>è§£èª¬</h4><p>' + q.explanation + '</p>';
        expEl.classList.add('show');

        if (isCorrect) score++;

        learningTracker.recordAnswer(
          q.id || currentQuestion,
          choiceIndex,
          q.correct,
          Math.round(timeSpent/1000)
        );
        sendQuestionAnswerToParent(q, choiceIndex, isCorrect);
        
        // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ãŸå ´åˆã€å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        const session = learningTracker.currentSession;
        if (session && session.answered && session.answered.length === lessonData.questions.length) {
          const nextBtn = document.getElementById('next-btn');
          if (nextBtn && nextBtn.textContent === 'å­¦ç¿’å®Œäº†') {
            setTimeout(() => {
              completeLesson();
            }, 1500);
          }
        }
      }, 500);
    }

    function previousQuestion(){
      if (currentQuestion>0){
        currentQuestion--;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function showCurrentSessionResult(){
      const session = learningTracker.currentSession;
      const scorePercent = session.totalQuestions>0
        ? Math.round((session.score/session.totalQuestions)*100)
        : 0;
      let msg = '';
      if (scorePercent >= 90) msg = 'ğŸ‰ ã¨ã¦ã‚‚ã‚ˆãç†è§£ã§ãã¦ã„ã¾ã™ï¼';
      else if (scorePercent >= 70) msg = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
      else if (scorePercent >= 50) msg = 'ğŸ“š å¤§äº‹ãªã¨ã“ã‚ã‚’ã‚‚ã†ä¸€åº¦è¦‹ç›´ã—ã¦ã¿ã‚ˆã†ã€‚';
      else msg = 'ğŸ’ª ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ãªãŒã‚‰ã€ã‚‚ã†ä¸€åº¦ç¢ºã‹ã‚ã¦ã¿ã‚ˆã†ã€‚';

      const totalTime = Date.now() - session.startTime;
      const m = Math.floor(totalTime/60000);
      const s = Math.floor((totalTime%60000)/1000);
      const timeDisp = m>0 ? m+'åˆ†'+s+'ç§’' : s+'ç§’';

      return `
        <div style="background: linear-gradient(135deg,#ffb74d 0%,#ff8a65 100%); color:white; padding:2rem; border-radius:16px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.3); margin-top:20px;">
          <div style="font-size:1.8rem; font-weight:bold; margin-bottom:1rem;">å­¦ç¿’å®Œäº†ï¼</div>
          <div style="font-size:1.1rem; margin-bottom:1.5rem;">${msg}</div>
          <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
            <div style="font-size:2.5rem; font-weight:bold; margin-bottom:0.5rem;">${session.score}/${session.totalQuestions}å•æ­£è§£</div>
            <div style="font-size:1.5rem; font-weight:600;">${scorePercent}%</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
            <div>å­¦ç¿’æ™‚é–“: <strong>${timeDisp}</strong></div>
            <div>å®Œäº†æ™‚åˆ»: <strong>${new Date().toLocaleString('ja-JP',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong></div>
          </div>
        </div>
      `;
    }

    function completeLesson(){
      learningTracker.saveSession();
      const messageData = {
        type:'lesson:complete',
        lessonId: lessonData.id,
        detail:{
          correct: learningTracker.currentSession.score,
          total: learningTracker.currentSession.totalQuestions,
          timeSec: Math.round((Date.now()-learningTracker.currentSession.startTime)/1000)
        }
      };
      console.log('ğŸš€ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', messageData);
      try{ if (window.parent !== window) window.parent.postMessage(messageData,'*'); }catch(e){}
      try{ if (window.top !== window) window.top.postMessage(messageData,'*'); }catch(e){}

      try{
        const storageMessage = { type:'lesson:complete', data:messageData, timestamp:Date.now() };
        localStorage.setItem('lessonCompleteMessage', JSON.stringify(storageMessage));
        if (window.parent && window.parent.saveLessonProgress){
          window.parent.saveLessonProgress(
            messageData.lessonId,
            messageData.detail.correct,
            messageData.detail.total,
            messageData.detail.timeSec
          );
        }
      }catch(e){ console.log('localStorage/saveLessonProgress ã‚¨ãƒ©ãƒ¼', e); }

      document.getElementById('question-container').style.display='none';
      const resultContainer = document.createElement('div');
      resultContainer.className='question-container';
      resultContainer.style.display='block';
      resultContainer.innerHTML = showCurrentSessionResult();

      const homeButton = document.createElement('button');
      homeButton.textContent = 'ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹';
      homeButton.className = 'start-learning-btn';
      homeButton.style.marginTop = '1.5rem';
      homeButton.onclick = ()=>{
        if (window.parent !== window || window.top !== window){
          try{
            window.parent.postMessage({type:'lesson:goBack'}, '*');
            window.top.postMessage({type:'lesson:goBack'}, '*');
            return;
          }catch(e){}
        }
        goHome();
      };
      resultContainer.appendChild(homeButton);
      document.querySelector('.main-container').appendChild(resultContainer);
    }

    function nextQuestion(){
      if (currentQuestion === lessonData.questions.length-1){
        completeLesson();
        return;
      }
      if (currentQuestion < lessonData.questions.length-1){
        currentQuestion++;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function startLearning(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('question-container').style.display = 'block';
      if (lessonData.questions.length > 0){
        showQuestion(0);
      } else {
        alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
    }

    function goHome(){
      window.location.href = '/';
    }
  </script>
</body>
</html>
