<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - æ°´ã®å¤‰åŒ–</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: linear-gradient(135deg, #b2fefa 0%, #0ed2f7 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .home-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .home-btn:hover { background:#ff5252; transform: translateY(-1px); }
    .home-btn:active { transform: scale(0.98); }
    .lesson-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      margin: 0 10px;
    }
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .sim-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
    }
    .sim-header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 15px;
      text-align: center;
    }
    .sim-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }
    .sim-header p {
      font-size: 14px;
      opacity: 0.9;
    }
    .sim-area {
      padding: 12px 12px 16px;
      background: #e0f7fa;
    }
    .sim-control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .sim-control-label {
      font-size: 13px;
      font-weight: bold;
      color: #004d40;
    }
    .temp-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 999px;
      background: #b2ebf2;
      outline: none;
    }
    .temp-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #039be5;
      box-shadow: 0 0 0 4px rgba(3,155,229,0.3);
      cursor: pointer;
    }
    .temp-slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #039be5;
      box-shadow: 0 0 0 4px rgba(3,155,229,0.3);
      cursor: pointer;
    }
    .temp-display {
      font-size: 13px;
      font-weight: bold;
      color: #01579b;
      min-width: 80px;
      text-align: right;
    }

    /* â–¼ æ°´ã®çŠ¶æ…‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    .sim-field {
      position: relative;
      margin-top: 0;
      margin-bottom: 12px;
      background: linear-gradient(to top, #b3e5fc 0%, #e1f5fe 50%, #ffffff 100%);
      border-radius: 12px;
      padding: 12px;
      overflow: hidden;
      height: 230px;
    }
    .thermometer {
      position: absolute;
      right: 16px;
      top: 16px;
      width: 32px;
      height: 130px;
      border-radius: 16px;
      border: 2px solid rgba(0,0,0,0.15);
      background: linear-gradient(to bottom, #ffffff, #f5f5f5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: 8px;
      z-index: 3;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .thermo-mercury {
      width: 12px;
      border-radius: 6px;
      background: linear-gradient(to top, #d32f2f 0%, #f44336 30%, #ff5252 60%, #ff8a65 100%);
      transition: height 0.4s ease, background 0.4s ease;
      box-shadow: 0 0 6px rgba(244,67,54,0.5);
    }
    .thermo-bulb {
      position: absolute;
      bottom: -12px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff8a65 0%, #ff5252 50%, #e53935 80%, #c62828 100%);
      box-shadow: 0 0 12px rgba(244,67,54,0.8), 0 2px 4px rgba(0,0,0,0.2);
      z-index: -1;
      transition: box-shadow 0.4s ease;
    }

    .beaker {
      position: absolute;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      width: 150px;
      height: 150px;
      border-radius: 0 0 18px 18px;
      border: 3px solid rgba(33,150,243,0.8);
      background: linear-gradient(to bottom, rgba(255,255,255,0.85), rgba(255,255,255,0.5));
      overflow: hidden;
      z-index: 2;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15), inset 0 0 20px rgba(255,255,255,0.3);
    }
    .beaker-inner {
      position: absolute;
      inset: 10px;
      border-radius: 0 0 14px 14px;
      overflow: hidden;
    }
    .water {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to top, #0288d1, #4fc3f7);
      transition: height 0.3s ease, background 0.4s ease, box-shadow 0.4s ease;
      box-shadow: inset 0 0 20px rgba(3,169,244,0.3);
    }
    .water.cold {
      background: linear-gradient(to top, #01579b 0%, #0277bd 50%, #0288d1 100%);
      box-shadow: inset 0 0 20px rgba(2,136,209,0.4);
    }
    .water.warm {
      background: linear-gradient(to top, #0288d1 0%, #03a9f4 50%, #4fc3f7 100%);
      box-shadow: inset 0 0 25px rgba(3,169,244,0.5);
    }
    .water.hot {
      background: linear-gradient(to top, #0277bd 0%, #039be5 50%, #29b6f6 100%);
      box-shadow: inset 0 0 30px rgba(41,182,246,0.6), 0 -2px 10px rgba(255,193,7,0.3);
    }
    .ice {
      position: absolute;
      bottom: 10px;
      left: 50%;
      width: 80px;
      height: 50px;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(33,150,243,0.6), inset 0 2px 4px rgba(255,255,255,0.8);
      opacity: 0;
      transition: opacity 0.4s ease, transform 0.4s ease, box-shadow 0.4s ease;
      border: 2px solid rgba(144,202,249,0.8);
      z-index: 3;
    }
    .ice.visible {
      opacity: 1;
      animation: iceShimmer 2s ease-in-out infinite;
    }
    @keyframes iceShimmer {
      0%, 100% { box-shadow: 0 4px 12px rgba(33,150,243,0.6), inset 0 2px 4px rgba(255,255,255,0.8); }
      50% { box-shadow: 0 6px 16px rgba(33,150,243,0.8), inset 0 2px 6px rgba(255,255,255,0.9); }
    }
    @keyframes phaseGlow {
      0%, 100% { 
        filter: brightness(1) drop-shadow(0 0 0 rgba(33,150,243,0));
      }
      50% { 
        filter: brightness(1.4) drop-shadow(0 0 20px rgba(33,150,243,0.8));
      }
    }
    /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .phase-particle {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 20;
    }
    .ice::before,
    .ice::after {
      content: "";
      position: absolute;
      width: 30px;
      height: 22px;
      background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
      border-radius: 8px;
      top: -12px;
      box-shadow: 0 2px 6px rgba(33,150,243,0.5);
      border: 1px solid rgba(144,202,249,0.6);
    }
    .ice::before {
      left: 5px;
    }
    .ice::after {
      right: 5px;
    }

    .steam {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      width: 140px;
      height: 90px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .steam-cloud {
      position: absolute;
      bottom: 0;
      width: 42px;
      height: 32px;
      background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f5f5f5 40%, #e0e0e0 70%, #bdbdbd 100%);
      border-radius: 50%;
      animation: steamMove 2.2s infinite ease-in-out;
      opacity: 0.9;
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
    }
    .steam-cloud:nth-child(1) { left: 5px; animation-delay: 0s; }
    .steam-cloud:nth-child(2) { left: 49px; animation-delay: 0.4s; }
    .steam-cloud:nth-child(3) { left: 93px; animation-delay: 0.8s; }

    @keyframes steamMove {
      0% { transform: translateY(0) scale(0.8); opacity: 0.0; }
      20%{ opacity: 0.7; }
      50% { transform: translateY(-20px) scale(1.1); opacity: 1; }
      100%{ transform: translateY(-40px) scale(1.2); opacity: 0; }
    }

    .bubble {
      position: absolute;
      bottom: 10px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95) 0%, rgba(227,242,253,0.8) 60%, rgba(187,222,251,0.6) 100%);
      border-radius: 50%;
      width: 10px;
      height: 10px;
      opacity: 0;
      animation: none;
      box-shadow: 0 0 4px rgba(255,255,255,0.8), inset 0 1px 2px rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,0.5);
    }
    @keyframes bubbleUp {
      0% { transform: translateY(0) scale(0.7); opacity: 0; }
      15%{ opacity: 0.8; }
      50% { transform: translateY(-35px) scale(1.1); opacity: 1; }
      100%{ transform: translateY(-70px) scale(1.3); opacity: 0; }
    }

    .state-label {
      position: absolute;
      left: 16px;
      top: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: bold;
      color: #01579b;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 0 0 2px rgba(3,169,244,0.2);
      z-index: 3;
      border: 1px solid rgba(3,169,244,0.3);
      transition: all 0.3s ease;
    }
    .state-label.ice-state {
      color: #0277bd;
      border-color: rgba(33,150,243,0.4);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 0 0 2px rgba(33,150,243,0.3);
    }
    .state-label.water-state {
      color: #01579b;
      border-color: rgba(3,169,244,0.4);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 0 0 2px rgba(3,169,244,0.3);
    }
    .state-label.steam-state {
      color: #004d40;
      border-color: rgba(0,150,136,0.4);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 0 0 2px rgba(0,150,136,0.3);
    }

    .sim-comment {
      font-size: 13px;
      line-height: 1.6;
      color: #004d40;
      background: #e0f2f1;
      border-radius: 12px;
      padding: 10px 12px;
      border-left: 4px solid #00838f;
      margin-top: 8px;
    }
    .sim-comment strong {
      color: #006064;
    }

    /* â–¼ infoãƒ‘ãƒãƒ« */
    .info-panel {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 20px;
      margin-bottom: 15px;
    }
    .info-panel h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .info-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #29b6f6;
    }
    .info-item h4 {
      color: #039be5;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .info-item p {
      color: #555;
      font-size: 13px;
      line-height: 1.4;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 20px;
      margin-bottom: 15px;
    }
    .question-text {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .choice {
      padding: 14px 16px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      min-height: 48px;
      display: flex;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .choice:hover {
      background: #e9ecef;
      border-color: #29b6f6;
    }
    .choice.selected {
      background: #29b6f6;
      color: white;
      border-color: #29b6f6;
    }
    .choice.correct {
      background: #28a745;
      color: white;
      border-color: #28a745;
      animation: correctPulse 0.6s ease;
    }
    .choice.incorrect {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
      animation: wrongShake 0.6s ease;
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.05);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    .explanation {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #28a745;
      display: none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color: #28a745;
      margin-bottom: 10px;
    }
    .explanation p {
      color: #666;
      line-height: 1.5;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }
    .nav-btn {
      padding: 14px 24px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 48px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .prev-btn {
      background: #6c757d;
      color: white;
    }
    .prev-btn:hover:not(:disabled) { background:#5a6268; }
    .next-btn {
      background: #29b6f6;
      color: white;
    }
    .next-btn:hover:not(:disabled) { background:#0288d1; }

    .start-learning-btn {
      background: linear-gradient(135deg, #29b6f6 0%, #00bcd4 100%);
      color: white;
      border: none;
      padding: 16px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 20px auto;
      display: block;
      min-height: 52px;
      width: 100%;
      max-width: 400px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .start-learning-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(41,182,246,0.35);
    }
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      height: 8px;
      margin: 15px 0;
      overflow: hidden;
    }
    .progress-fill {
      background: linear-gradient(135deg, #29b6f6 0%, #00bcd4 100%);
      height: 100%;
      transition: width 0.3s ease;
    }

    * { touch-action: manipulation; }
    .choice, .nav-btn, .home-btn, .start-learning-btn {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    @media (max-width: 768px) {
      body { overflow-x: hidden; }
      .header { padding:8px 12px; }
      .home-btn { padding:10px 16px; font-size:13px; }
      .lesson-title { font-size:14px; margin:0 8px; text-align:center; }
      .header > div:last-child { width:80px; }
      .main-container { padding:10px; }
      .info-grid { grid-template-columns:1fr; gap:12px; }
      .info-panel { padding:16px; }
      .info-item { padding:12px; }
      .info-item h4 { font-size:13px; }
      .info-item p { font-size:12px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { height:240px; }
      .question-container { padding:16px; }
      .question-text { font-size:15px; margin-bottom:12px; }
      .choice { padding:14px 16px; font-size:14px; min-height:52px; }
      .navigation { flex-direction:column; gap:12px; margin-top:16px; }
      .nav-btn { width:100%; padding:14px 20px; font-size:15px; }
      .start-learning-btn { padding:16px 24px; font-size:15px; max-width:100%; }
      .explanation { padding:12px; font-size:13px; margin-top:12px; }
      .progress-bar { margin:12px 0; }
    }
    @media (max-width: 480px) {
      .header { padding:6px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:12px; margin:0 6px; }
      .header > div:last-child { width:70px; }
      .main-container { padding:8px; }
      .question-container { padding:12px; }
      .question-text { font-size:14px; }
      .choice { padding:12px 14px; font-size:13px; min-height:48px; }
      .info-panel { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - æ°´ã®å¤‰åŒ–</div>
    <div style="width: 80px;"></div>
  </div>

  <div class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="sim-container">
      <div class="sim-header">
        <h2>ğŸ’§ æ°´ã®å¤‰åŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        <p>æ¸©åº¦ã‚’å¤‰ãˆã¦ã€æ°´ãŒã€Œæ°·ãƒ»æ°´ãƒ»æ°´è’¸æ°—ã€ã¨ã©ã†å¤‰ã‚ã‚‹ã‹ä½“é¨“ã—ã‚ˆã†</p>
      </div>
      <div class="sim-area">
        <div class="sim-field" id="waterField">
          <div class="state-label" id="stateLabel">çŠ¶æ…‹ï¼šæ¶²ä½“ã®æ°´</div>

          <div class="thermometer">
            <div class="thermo-mercury" id="thermoMercury" style="height: 55%;"></div>
            <div class="thermo-bulb"></div>
          </div>

          <div class="beaker">
            <div class="beaker-inner">
              <div class="water" id="water" style="height: 45%;"></div>
              <div class="ice" id="ice"></div>

              <!-- æ³¡ï¼ˆ3ã¤ã¾ã§ï¼‰ -->
              <div class="bubble" id="bubble1"></div>
              <div class="bubble" id="bubble2"></div>
              <div class="bubble" id="bubble3"></div>
            </div>
          </div>

          <div class="steam" id="steam">
            <div class="steam-cloud"></div>
            <div class="steam-cloud"></div>
            <div class="steam-cloud"></div>
          </div>
        </div>

        <div class="sim-comment" id="simComment">
          ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ã¦ã€æ¸©åº¦ãŒ<strong>0â„ƒã‚ˆã‚Šä¸‹</strong>ã€<strong>0ã€œ100â„ƒ</strong>ã€<strong>100â„ƒã‚ˆã‚Šä¸Š</strong>ã®ã¨ãã§<br>
          æ°´ã®ã‚ˆã†ã™ï¼ˆæ°·ãƒ»æ°´ãƒ»æ°´è’¸æ°—ï¼‰ãŒã©ã†å¤‰ã‚ã‚‹ã‹è¦‹ã¦ã¿ã‚ˆã†ã€‚<br>
          ãã‚Œãã‚Œã®æ¸©åº¦ã§ã€æ°´ã®<strong>ç²’ã®ã‚ˆã†ã™</strong>ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã¿ã¦ã­ã€‚
        </div>
      </div>

        <!-- æ“ä½œUIã‚’ä¸‹ã«é…ç½® -->
        <div class="sim-control-row">
          <div class="sim-control-label">æ¸©åº¦ï¼ˆ-20ã€œ120â„ƒï¼‰ã‚’å¤‰ãˆã¦ã¿ã‚ˆã†</div>
          <input type="range" id="tempSlider" class="temp-slider" min="-20" max="120" step="1" value="20">
          <div class="temp-display" id="tempDisplay">20â„ƒ</div>
        </div>
      </div>
    </div>

    <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="info-panel" id="info-panel">
      <h3>ğŸ“Š æ°´ã®å¤‰åŒ–ã¨æ¸©åº¦</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>æ°´ã®3ã¤ã®çŠ¶æ…‹</h4>
          <p>æ°´ã¯ã€æ¸©åº¦ã«ã‚ˆã£ã¦<br>
            ãƒ»å›ºä½“ï¼š<strong>æ°·</strong><br>
            ãƒ»æ¶²ä½“ï¼š<strong>æ°´</strong><br>
            ãƒ»æ°—ä½“ï¼š<strong>æ°´è’¸æ°—</strong><br>
            ã®3ã¤ã®çŠ¶æ…‹ã«å¤‰ã‚ã‚Šã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>0â„ƒã¨100â„ƒã®ãã¾ã‚Š</h4>
          <p>ãµã¤ã†ã®æ°—åœ§ã§ã¯ã€<br>
            ãƒ»æ°´ã¯<strong>0â„ƒ</strong>ã§æ°·ã¨æ°´ãŒå…¥ã‚Œã‹ã‚ã‚Šã¾ã™ã€‚<br>
            ãƒ»æ°´ã¯<strong>100â„ƒ</strong>ã§æ°´ã¨æ°´è’¸æ°—ãŒå…¥ã‚Œã‹ã‚ã‚Šã¾ã™ã€‚<br>
            ã“ã®æ¸©åº¦ã‚’<strong>èç‚¹</strong>ãƒ»<strong>æ²¸ç‚¹</strong>ã¨ã„ã„ã¾ã™ã€‚</p>
        </div>
        <div class="info-item">
          <h4>ç²’ã®å‹•ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸</h4>
          <p>æ°·ã§ã¯æ°´ã®ç²’ãŒ<strong>ãã£ã¡ã‚Šä¸¦ã‚“ã§</strong>å‹•ãã«ããã€<br>
            æ°´ã§ã¯ã‚†ã£ãã‚Š<strong>å‹•ãå›ã‚Š</strong>ã€<br>
            æ°´è’¸æ°—ã§ã¯é ãã¯ãªã‚Œã¦<strong>ã™ã°ã‚„ãå‹•ã„ã¦</strong>ã„ã¾ã™ã€‚</p>
        </div>
      </div>
      <button class="start-learning-btn" onclick="startLearning()">å­¦ç¿’ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <!-- â–¼ å•é¡Œã‚¨ãƒªã‚¢ -->
    <div class="question-container" id="question-container" style="display:none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="explanation" id="explanation"></div>
      <div class="navigation">
        <button class="nav-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>å‰ã®å•é¡Œ</button>
        <button class="nav-btn next-btn" id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       â–¼ æ°´ã®å¤‰åŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    ================================= */
    const tempSlider = document.getElementById('tempSlider');
    const tempDisplay = document.getElementById('tempDisplay');
    const stateLabel = document.getElementById('stateLabel');
    const waterEl = document.getElementById('water');
    const iceEl = document.getElementById('ice');
    const steamEl = document.getElementById('steam');
    const thermoMercuryEl = document.getElementById('thermoMercury');
    const simCommentEl = document.getElementById('simComment');
    const bubbleEls = [
      document.getElementById('bubble1'),
      document.getElementById('bubble2'),
      document.getElementById('bubble3')
    ];
    const beakerInnerRectRef = { width: 0, height: 0 };
    let previousTemp = 20; // å‰å›ã®æ¸©åº¦ã‚’ä¿å­˜
    let previousState = 'water'; // å‰å›ã®çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆ'ice', 'water', 'steam'ï¼‰

    function updateBeakerRect() {
      const inner = document.querySelector('.beaker-inner');
      if (!inner) return;
      const r = inner.getBoundingClientRect();
      beakerInnerRectRef.width = r.width;
      beakerInnerRectRef.height = r.height;
    }

    function setupBubbles() {
      updateBeakerRect();
      const w = beakerInnerRectRef.width || 100;
      bubbleEls.forEach((b, i) => {
        b.style.left = (20 + i * (w / 4)) + 'px';
        b.style.animationDelay = (i * 0.3) + 's';
      });
    }

    function updateWaterState() {
      const t = parseInt(tempSlider.value, 10);
      tempDisplay.textContent = t + 'â„ƒ';

      // æ¸©åº¦ -20ã€œ120 ã‚’ 0ã€œ1 ã«æ­£è¦åŒ–
      const tNorm = (t + 20) / 140;
      const mercuryHeight = 10 + tNorm * 80; // 10ã€œ90%
      thermoMercuryEl.style.height = mercuryHeight + '%';

      // çŠ¶æ…‹ã¨è¦‹ãŸç›®
      let stateText = '';
      let comment = '';
      let currentState = 'water';

      // æ°´ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      waterEl.classList.remove('cold', 'warm', 'hot');
      iceEl.classList.remove('visible');

      if (t < 0) {
        currentState = 'ice';
        stateText = 'çŠ¶æ…‹ï¼šå›ºä½“ï¼ˆæ°·ï¼‰';
        iceEl.classList.add('visible');
        iceEl.style.transform = 'translateX(-50%) translateY(0)';
        waterEl.style.height = '20%';
        waterEl.style.background = 'linear-gradient(to top, #81d4fa, #b3e5fc)';
        waterEl.classList.add('cold');
        steamEl.style.opacity = 0;
        bubbleEls.forEach(b => {
          b.style.opacity = 0;
          b.style.animation = 'none';
        });
        comment =
          'æ¸©åº¦ãŒ<strong>0â„ƒã‚ˆã‚Šä½ã„</strong>ã®ã§ã€æ°´ã¯<strong>æ°·</strong>ã«ãªã£ã¦ã„ã¾ã™ã€‚' +
          'æ°´ã®ç²’ãŒ<strong>ãã£ã¡ã‚Šä¸¦ã‚“ã§</strong>ã„ã¦ã€ã»ã¨ã‚“ã©å‹•ãã¾ã›ã‚“ã€‚';

      } else if (t >= 0 && t < 100) {
        currentState = 'water';
        stateText = 'çŠ¶æ…‹ï¼šæ¶²ä½“ã®æ°´';
        stateLabel.classList.add('water-state');
        if (t < 5) {
          iceEl.classList.add('visible');
          iceEl.style.transform = 'translateX(-50%) translateY(0)';
        } else {
          iceEl.style.transform = 'translateX(-50%) translateY(6px)';
        }

        const waterHeight = 35 + (t / 100) * 15; // 35ã€œ50%
        waterEl.style.height = waterHeight + '%';

        // æ¸©åº¦ã«å¿œã˜ã¦æ°´ã®è‰²ã¨ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
        if (t < 30) {
          waterEl.classList.add('cold');
          waterEl.style.background = 'linear-gradient(to top, #01579b 0%, #0277bd 50%, #0288d1 100%)';
        } else if (t < 70) {
          waterEl.classList.add('warm');
          waterEl.style.background = 'linear-gradient(to top, #0288d1 0%, #03a9f4 50%, #4fc3f7 100%)';
        } else {
          waterEl.classList.add('hot');
          waterEl.style.background = 'linear-gradient(to top, #0277bd 0%, #039be5 50%, #29b6f6 100%)';
        }

        if (t >= 80) {
          steamEl.style.opacity = 0.8;
          bubbleEls.forEach((b, i) => {
            b.style.opacity = 1;
            b.style.animation = 'bubbleUp 1.4s infinite ease-in-out';
            b.style.animationDelay = (i * 0.2) + 's';
          });
        } else {
          steamEl.style.opacity = 0;
          bubbleEls.forEach(b => {
            b.style.opacity = 0;
            b.style.animation = 'none';
          });
        }

        if (t === 0) {
          comment =
            'ã¡ã‚‡ã†ã©<strong>0â„ƒ</strong>ã§ã€æ°·ã¨æ°´ãŒå…¥ã‚Œã‹ã‚ã‚‹æ¸©åº¦ã§ã™ã€‚' +
            'æ°·ã¨æ°´ãŒã„ã£ã—ã‚‡ã«è¦‹ãˆã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®æ¸©åº¦ã‚’<strong>èç‚¹</strong>ã¨ã„ã„ã¾ã™ã€‚';
        } else if (t < 20) {
          comment =
            'ã¾ã ã²ã‚“ã‚„ã‚Šã—ãŸ<strong>æ¶²ä½“ã®æ°´</strong>ã§ã™ã€‚æ°´ã®ç²’ã¯å°‘ã—ãšã¤å‹•ãå›ã£ã¦ã„ã¾ã™ãŒã€' +
            'ã‚ã¾ã‚Šæ¿€ã—ãã¯å‹•ãã¾ã›ã‚“ã€‚';
        } else if (t < 80) {
          comment =
            'æ¸©åº¦ãŒä¸ŠãŒã£ã¦ãã¦ã€æ°´ã®ç²’ã®å‹•ããŒ<strong>ã¯ã’ã—ã</strong>ãªã£ã¦ãã¾ã—ãŸã€‚' +
            'ã¾ã æ°´ã®ã¾ã¾ã§ã™ãŒã€ãŠæ¹¯ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚';
        } else {
          comment =
            'ãŠæ¹¯ãŒã¨ã¦ã‚‚ç†±ããªã£ã¦ã€<strong>è’¸ç™º</strong>ãŒç››ã‚“ã«ãªã£ã¦ãã¾ã—ãŸã€‚' +
            '100â„ƒã«è¿‘ã¥ãã¨ã€æ°´ãŒ<strong>æ²¸é¨°</strong>ã—ã¦ã€ã©ã‚“ã©ã‚“æ°´è’¸æ°—ãŒãµãˆã¦ã„ãã¾ã™ã€‚';
        }

      } else {
        currentState = 'steam';
        stateText = 'çŠ¶æ…‹ï¼šæ°—ä½“ï¼ˆæ°´è’¸æ°—ï¼‰';
        stateLabel.classList.add('steam-state');
        iceEl.style.transform = 'translateX(-50%) translateY(6px)';
        waterEl.style.height = '25%';
        waterEl.style.background = 'linear-gradient(to top, #4fc3f7, #e1f5fe)';
        waterEl.classList.add('hot');
        steamEl.style.opacity = 1;

        bubbleEls.forEach((b, i) => {
          b.style.opacity = 1;
          b.style.animation = 'bubbleUp 1.2s infinite ease-in-out';
          b.style.animationDelay = (i * 0.15) + 's';
        });

        if (t === 100) {
          comment =
            'ã¡ã‚‡ã†ã©<strong>100â„ƒ</strong>ã§ã€æ°´ã¨æ°´è’¸æ°—ãŒå…¥ã‚Œã‹ã‚ã‚‹æ¸©åº¦ã§ã™ã€‚' +
            'æ°´ãŒã©ã‚“ã©ã‚“<strong>æ²¸ã¨ã†</strong>ã—ã¦ã€æ°´è’¸æ°—ã«ãªã£ã¦ã„ãã¾ã™ã€‚ã“ã®æ¸©åº¦ã‚’<strong>æ²¸ç‚¹</strong>ã¨ã„ã„ã¾ã™ã€‚';
        } else {
          comment =
            '100â„ƒã‚ˆã‚Šé«˜ã„ã®ã§ã€æ°´ã¯ã»ã¨ã‚“ã©<strong>æ°´è’¸æ°—</strong>ã«ãªã£ã¦ã„ã¾ã™ã€‚' +
            'æ°´ã®ç²’ã¯é ãã¯ãªã‚Œã¦ã€ã³ã‚…ã‚“ã³ã‚…ã‚“<strong>ã™ã°ã‚„ãå‹•ã„ã¦</strong>ã„ã¾ã™ã€‚';
        }
      }

      stateLabel.textContent = stateText;
      simCommentEl.innerHTML = comment;

      // 0Â°Cã¨100Â°Cã®å¢ƒç•Œã‚’è¶ŠãˆãŸã¨ãã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      if (previousTemp !== null) {
        // 0Â°Cã‚’è¶ŠãˆãŸã¨ãï¼ˆæ°·â†”æ°´ï¼‰
        if ((previousTemp < 0 && t >= 0) || (previousTemp >= 0 && t < 0)) {
          triggerPhaseChangeEffect('ice-water');
        }
        // 100Â°Cã‚’è¶ŠãˆãŸã¨ãï¼ˆæ°´â†”æ°´è’¸æ°—ï¼‰
        if ((previousTemp < 100 && t >= 100) || (previousTemp >= 100 && t < 100)) {
          triggerPhaseChangeEffect('water-steam');
        }
      }

      previousTemp = t;
      previousState = currentState;
    }

    // çŠ¶æ…‹å¤‰åŒ–ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨SE
    function triggerPhaseChangeEffect(type) {
      // è¦–è¦šã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      createPhaseChangeParticleEffect(type);
      
      // éŸ³å£°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      playPhaseChangeSound(type);
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function createPhaseChangeParticleEffect(type) {
      const simField = document.getElementById('waterField');
      const beaker = document.querySelector('.beaker');
      const rect = beaker.getBoundingClientRect();
      const fieldRect = simField.getBoundingClientRect();
      
      const centerX = rect.left - fieldRect.left + rect.width / 2;
      const centerY = rect.top - fieldRect.top + rect.height / 2;

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®è‰²ã¨æ•°
      let particleColor, particleCount;
      if (type === 'ice-water') {
        particleColor = 'rgba(144,202,249,0.9)'; // é’ç³»ï¼ˆæ°·ï¼‰
        particleCount = 20;
      } else {
        particleColor = 'rgba(255,255,255,0.9)'; // ç™½ç³»ï¼ˆæ°´è’¸æ°—ï¼‰
        particleCount = 25;
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’ç”Ÿæˆ
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'phase-particle';
        
        const angle = (Math.PI * 2 * i) / particleCount;
        const distance = 40 + Math.random() * 60;
        const duration = 1000 + Math.random() * 500;
        const endX = Math.cos(angle) * distance;
        const endY = Math.sin(angle) * distance;
        
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.background = `radial-gradient(circle, ${particleColor} 0%, rgba(200,220,255,0.6) 100%)`;
        
        simField.appendChild(particle);
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const startTime = Date.now();
        const animate = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          
          particle.style.transform = `translate(${endX * easeOut}px, ${endY * easeOut}px) scale(${1 - progress * 0.5})`;
          particle.style.opacity = 1 - progress;
          
          if (progress < 1) {
            requestAnimationFrame(animate);
          } else {
            particle.remove();
          }
        };
        requestAnimationFrame(animate);
      }

      // ãƒ“ãƒ¼ã‚«ãƒ¼ã®å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      if (type === 'ice-water') {
        iceEl.style.animation = 'phaseGlow 0.8s ease-out';
        setTimeout(() => {
          iceEl.style.animation = '';
        }, 800);
      } else {
        steamEl.style.animation = 'phaseGlow 0.8s ease-out';
        setTimeout(() => {
          steamEl.style.animation = '';
        }, 800);
      }
    }

    // éŸ³å£°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆWeb Audio APIã§ç”Ÿæˆï¼‰
    function playPhaseChangeSound(type) {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        if (type === 'ice-water') {
          // æ°·â†’æ°´ï¼šæŸ”ã‚‰ã‹ã„éŸ³è‰²
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(350, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(450, audioContext.currentTime + 0.3);
        } else {
          // æ°´â†’æ°´è’¸æ°—ï¼šé«˜ã‚ã®éŸ³è‰²
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(500, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.3);
        }
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.12, audioContext.currentTime + 0.05);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.35);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.35);
      } catch (e) {
        // éŸ³å£°ãŒå†ç”Ÿã§ããªã„å ´åˆã¯ç„¡è¦–
        console.log('Audio not available');
      }
    }

    tempSlider.addEventListener('input', updateWaterState);
    window.addEventListener('resize', () => {
      setupBubbles();
    });

    // åˆæœŸè¨­å®š
    setupBubbles();
    previousTemp = parseInt(tempSlider.value, 10);
    previousState = previousTemp < 0 ? 'ice' : (previousTemp >= 100 ? 'steam' : 'water');
    updateWaterState();

    /* ================================
       â–¼ å•é¡Œãƒ‡ãƒ¼ã‚¿
    ================================= */
    const lessonData = {
      id: 'sci.chemistry.water_three_states_sim',
      questions: [
        {
          id: 1,
          question: "ãµã¤ã†ã®æ°—åœ§ã®ã‚‚ã¨ã§ã€æ°´ãŒã€Œæ°·ã€ã¨ã€Œæ°´ã€ã®ã‚ã„ã ã‚’è¡Œãæ¥ã™ã‚‹æ¸©åº¦ã¯ä½•â„ƒã§ã™ã‹ï¼Ÿ",
          choices: [
            "0â„ƒ",
            "50â„ƒ",
            "100â„ƒ",
            "200â„ƒ"
          ],
          correct: 0,
          explanation: "ãµã¤ã†ã®æ°—åœ§ã§ã¯ã€æ°´ã¯<strong>0â„ƒ</strong>ã§æ°·ã¨æ°´ã®çŠ¶æ…‹ãŒå…¥ã‚Œã‹ã‚ã‚Šã¾ã™ã€‚ã“ã®æ¸©åº¦ã‚’æ°´ã®<strong>èç‚¹</strong>ã¨ã„ã„ã¾ã™ã€‚"
        },
        {
          id: 2,
          question: "æ°´ãŒã€Œæ°´ã€ã¨ã€Œæ°´è’¸æ°—ã€ã®ã‚ã„ã ã‚’è¡Œãæ¥ã™ã‚‹æ¸©åº¦ï¼ˆæ²¸ç‚¹ï¼‰ã¯ã€ãµã¤ã†ä½•â„ƒã§ã™ã‹ï¼Ÿ",
          choices: [
            "0â„ƒ",
            "50â„ƒ",
            "80â„ƒ",
            "100â„ƒ"
          ],
          correct: 3,
          explanation: "ãµã¤ã†ã®æ°—åœ§ã§ã¯ã€æ°´ã¯<strong>100â„ƒ</strong>ã§æ°´ã¨æ°´è’¸æ°—ã®çŠ¶æ…‹ãŒå…¥ã‚Œã‹ã‚ã‚Šã¾ã™ã€‚ã“ã®æ¸©åº¦ã‚’æ°´ã®<strong>æ²¸ç‚¹</strong>ã¨ã„ã„ã¾ã™ã€‚"
        },
        {
          id: 3,
          question: "æ¬¡ã®ã†ã¡ã€æ°´ãŒ<strong>æ°—ä½“ï¼ˆæ°´è’¸æ°—ï¼‰</strong>ã«ãªã£ã¦ã„ã‚‹ã¨ãã®ã‚ˆã†ã™ã¨ã—ã¦ã€ã‚‚ã£ã¨ã‚‚è¿‘ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
          choices: [
            "æ°´ã®ç²’ãŒãã£ã¡ã‚Šä¸¦ã‚“ã§ã»ã¨ã‚“ã©å‹•ã‹ãªã„",
            "æ°´ã®ç²’ãŒã‚†ã£ãã‚Šã¨å‹•ãå›ã£ã¦ã„ã‚‹",
            "æ°´ã®ç²’ãŒé›¢ã‚Œã‚ã£ã¦ã™ã°ã‚„ãå‹•ãå›ã£ã¦ã„ã‚‹",
            "æ°´ã®ç²’ãŒã¾ã£ãŸãå‹•ã‹ãªããªã‚‹"
          ],
          correct: 2,
          explanation: "æ°´è’¸æ°—ã¯æ°´ã®<strong>æ°—ä½“ã®çŠ¶æ…‹</strong>ã§ã™ã€‚æ°´ã®ç²’ã¯ãŠãŸãŒã„ã‹ã‚‰<strong>é ãã¯ãªã‚Œã¦</strong>ã€ã³ã‚…ã‚“ã³ã‚…ã‚“<strong>ã™ã°ã‚„ãå‹•ãå›ã£ã¦</strong>ã„ã¾ã™ã€‚"
        }
      ]
    };

    /* ================================
       â–¼ LearningTracker & å•é¡Œè¡¨ç¤º
    ================================= */
    class LearningTracker {
      constructor() {
        this.mode = 'wakaru';
        this.historyKey = 'learningHistory_mizu_no_henka_wakaru';
        this.currentSession = {
          startTime: Date.now(),
          questions: [],
          score: 0,
          totalQuestions: 0,
          mode: 'wakaru'
        };
      }
      recordAnswer(questionId, selectedAnswer, correctAnswer, timeSpent) {
        this.currentSession.questions.push({
          questionId,
          selectedAnswer,
          correctAnswer,
          isCorrect: selectedAnswer === correctAnswer,
          timeSpent,
          timestamp: Date.now()
        });
        if (selectedAnswer === correctAnswer) this.currentSession.score++;
        this.currentSession.totalQuestions++;
      }
      loadHistory() {
        try {
          const data = localStorage.getItem(this.historyKey);
          if (data) return JSON.parse(data);
        } catch(e){ console.error(e); }
        return {
          sessions: [],
          stats: {
            totalSessions:0,
            totalQuestions:0,
            correctAnswers:0,
            averageScore:0,
            bestScore:0
          }
        };
      }
      calculateStats(sessions) {
        const stats = {
          totalSessions: sessions.length,
          totalQuestions: 0,
          correctAnswers: 0,
          averageScore: 0,
          bestScore: 0
        };
        sessions.forEach(s=>{
          stats.totalQuestions += s.totalQuestions;
          stats.correctAnswers += s.score;
          stats.bestScore = Math.max(stats.bestScore, s.score);
        });
        if (stats.totalSessions>0 && stats.totalQuestions>0){
          stats.averageScore = (stats.correctAnswers / stats.totalQuestions *100).toFixed(1);
        }
        return stats;
      }
      saveSession() {
        try {
          const existing = this.loadHistory();
          const totalTime = Date.now() - this.currentSession.startTime;
          this.currentSession.totalTime = totalTime;
          const sessionToSave = {
            ...this.currentSession,
            endTime: Date.now(),
            duration: totalTime,
            totalTime
          };
          existing.sessions.push(sessionToSave);
          existing.stats = this.calculateStats(existing.sessions);
          localStorage.setItem(this.historyKey, JSON.stringify(existing));
          console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†', sessionToSave);
          return true;
        } catch(e){
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼', e);
          return false;
        }
      }
    }

    const learningTracker = new LearningTracker();
    let currentQuestion = 0;
    let score = 0;
    let questionStartTime = Date.now();

    function generateShuffledIndices(length){
      const idx = Array.from({length},(_,i)=>i);
      for(let i=idx.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
      return idx;
    }

    function showQuestion(index){
      const q = lessonData.questions[index];
      questionStartTime = Date.now();
      const expEl = document.getElementById('explanation');
      expEl.classList.remove('show');

      document.getElementById('question-text').textContent = q.question;
      const choicesContainer = document.getElementById('choices');
      choicesContainer.innerHTML = '';

      const order = generateShuffledIndices(q.choices.length);
      order.forEach(originalIndex=>{
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = q.choices[originalIndex];
        div.dataset.originalIndex = String(originalIndex);
        div.onclick = () => selectAnswer(originalIndex);
        choicesContainer.appendChild(div);
      });

      const progress = ((index+1)/lessonData.questions.length)*100;
      document.getElementById('progress-fill').style.width = progress + '%';

      document.getElementById('prev-btn').disabled = index===0;
      const nextBtn = document.getElementById('next-btn');
      if (index === lessonData.questions.length-1){
        nextBtn.disabled = false;
        nextBtn.textContent = 'å­¦ç¿’å®Œäº†';
      } else {
        nextBtn.disabled = false;
        nextBtn.textContent = 'æ¬¡ã®å•é¡Œ';
      }
    }

    function sendQuestionAnswerToParent(questionData, userAnswer, isCorrect){
      const messageData = {
        type:'question:answered',
        lessonId: lessonData.id,
        questionData:{
          qnum: questionData.id || currentQuestion,
          question: questionData.question,
          choices: questionData.choices,
          answer: questionData.correct,
          explanation: questionData.explanation
        },
        userAnswer,
        correctAnswer: questionData.correct,
        isCorrect,
        timestamp: Date.now()
      };
      console.log('ğŸ“ å€‹åˆ¥å•é¡Œå›ç­”ã‚’é€ä¿¡:', messageData);
      try{
        if (window.parent !== window) window.parent.postMessage(messageData,'*');
        if (window.top !== window) window.top.postMessage(messageData,'*');
        const existing = JSON.parse(localStorage.getItem('questionAnswers') || '[]');
        existing.push(messageData);
        localStorage.setItem('questionAnswers', JSON.stringify(existing));
      }catch(e){
        console.log('âŒ å€‹åˆ¥å•é¡Œå›ç­”é€ä¿¡å¤±æ•—:', e);
      }
    }

    function selectAnswer(choiceIndex){
      const q = lessonData.questions[currentQuestion];
      const choices = document.querySelectorAll('.choice');
      const timeSpent = Date.now() - questionStartTime;

      choices.forEach(c=>{ c.style.pointerEvents='none'; });

      choices.forEach(c=>{
        c.classList.remove('selected','correct','incorrect');
        const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
        if (originalIndex === choiceIndex){
          c.classList.add('selected');
        }
      });

      setTimeout(()=>{
        const isCorrect = choiceIndex === q.correct;
        choices.forEach(c=>{
          const originalIndex = parseInt(c.dataset.originalIndex || "-1",10);
          if (originalIndex === q.correct){
            c.classList.add('correct');
          } else if (originalIndex === choiceIndex && !isCorrect){
            c.classList.add('incorrect');
          }
        });

        const expEl = document.getElementById('explanation');
        expEl.innerHTML = '<h4>è§£èª¬</h4><p>' + q.explanation + '</p>';
        expEl.classList.add('show');

        if (isCorrect) score++;

        learningTracker.recordAnswer(
          q.id || currentQuestion,
          choiceIndex,
          q.correct,
          Math.round(timeSpent/1000)
        );
        sendQuestionAnswerToParent(q, choiceIndex, isCorrect);
        
        // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ãŸå ´åˆã€å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        const session = learningTracker.currentSession;
        if (session && session.answered && session.answered.length === lessonData.questions.length) {
          const nextBtn = document.getElementById('next-btn');
          if (nextBtn && nextBtn.textContent === 'å­¦ç¿’å®Œäº†') {
            setTimeout(() => {
              completeLesson();
            }, 1500);
          }
        }
      }, 500);
    }

    function previousQuestion(){
      if (currentQuestion>0){
        currentQuestion--;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function showCurrentSessionResult(){
      const session = learningTracker.currentSession;
      const scorePercent = session.totalQuestions>0
        ? Math.round((session.score/session.totalQuestions)*100)
        : 0;
      let msg = '';
      if (scorePercent >= 90) msg = 'ğŸ‰ ã¨ã¦ã‚‚ã‚ˆãç†è§£ã§ãã¦ã„ã¾ã™ï¼';
      else if (scorePercent >= 70) msg = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
      else if (scorePercent >= 50) msg = 'ğŸ“š å¤§äº‹ãªã¨ã“ã‚ã‚’ã‚‚ã†ä¸€åº¦è¦‹ç›´ã—ã¦ã¿ã‚ˆã†ã€‚';
      else msg = 'ğŸ’ª æ¸©åº¦ã‚’å‹•ã‹ã—ãªãŒã‚‰ã€ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚';

      const totalTime = Date.now() - session.startTime;
      const m = Math.floor(totalTime/60000);
      const s = Math.floor((totalTime%60000)/1000);
      const timeDisp = m>0 ? m+'åˆ†'+s+'ç§’' : s+'ç§’';

      return `
        <div style="background: linear-gradient(135deg,#29b6f6 0%,#00bcd4 100%); color:white; padding:2rem; border-radius:16px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.3); margin-top:20px;">
          <div style="font-size:1.8rem; font-weight:bold; margin-bottom:1rem;">å­¦ç¿’å®Œäº†ï¼</div>
          <div style="font-size:1.1rem; margin-bottom:1.5rem;">${msg}</div>
          <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
            <div style="font-size:2.5rem; font-weight:bold; margin-bottom:0.5rem;">${session.score}/${session.totalQuestions}å•æ­£è§£</div>
            <div style="font-size:1.5rem; font-weight:600;">${scorePercent}%</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
            <div>å­¦ç¿’æ™‚é–“: <strong>${timeDisp}</strong></div>
            <div>å®Œäº†æ™‚åˆ»: <strong>${new Date().toLocaleString('ja-JP',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong></div>
          </div>
        </div>
      `;
    }

    function completeLesson(){
      learningTracker.saveSession();
      const messageData = {
        type:'lesson:complete',
        lessonId: lessonData.id,
        detail:{
          correct: learningTracker.currentSession.score,
          total: learningTracker.currentSession.totalQuestions,
          timeSec: Math.round((Date.now()-learningTracker.currentSession.startTime)/1000)
        }
      };
      console.log('ğŸš€ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', messageData);
      try{ if (window.parent !== window) window.parent.postMessage(messageData,'*'); }catch(e){}
      try{ if (window.top !== window) window.top.postMessage(messageData,'*'); }catch(e){}

      try{
        const storageMessage = { type:'lesson:complete', data:messageData, timestamp:Date.now() };
        localStorage.setItem('lessonCompleteMessage', JSON.stringify(storageMessage));
        if (window.parent && window.parent.saveLessonProgress){
          window.parent.saveLessonProgress(
            messageData.lessonId,
            messageData.detail.correct,
            messageData.detail.total,
            messageData.detail.timeSec
          );
        }
      }catch(e){ console.log('localStorage/saveLessonProgress ã‚¨ãƒ©ãƒ¼', e); }

      document.getElementById('question-container').style.display='none';
      const resultContainer = document.createElement('div');
      resultContainer.className='question-container';
      resultContainer.style.display='block';
      resultContainer.innerHTML = showCurrentSessionResult();

      const homeButton = document.createElement('button');
      homeButton.textContent = 'ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹';
      homeButton.className = 'start-learning-btn';
      homeButton.style.marginTop = '1.5rem';
      homeButton.onclick = ()=>{
        if (window.parent !== window || window.top !== window){
          try{
            window.parent.postMessage({type:'lesson:goBack'}, '*');
            window.top.postMessage({type:'lesson:goBack'}, '*');
            return;
          }catch(e){}
        }
        goHome();
      };
      resultContainer.appendChild(homeButton);
      document.querySelector('.main-container').appendChild(resultContainer);
    }

    function nextQuestion(){
      if (currentQuestion === lessonData.questions.length-1){
        completeLesson();
        return;
      }
      if (currentQuestion < lessonData.questions.length-1){
        currentQuestion++;
        showQuestion(currentQuestion);
        document.getElementById('explanation').classList.remove('show');
      }
    }

    function startLearning(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('question-container').style.display = 'block';
      if (lessonData.questions.length > 0){
        showQuestion(0);
      } else {
        alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
    }

    function goHome(){
      window.location.href = '/';
    }
  </script>
</body>
</html>
