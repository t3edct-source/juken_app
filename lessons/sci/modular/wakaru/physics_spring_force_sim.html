<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - ã°ã­ã¨åŠ›</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 45%, #000 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color:#e5e7eb;
    }
    .header {
      background: rgba(15,23,42,0.95);
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 14px rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
    }
    .home-btn {
      background:linear-gradient(135deg,#38bdf8,#22c55e);
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:999px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 3px 10px rgba(56,189,248,0.7);
    }
    .home-btn:hover { filter:brightness(1.05); transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.97); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#e0f2fe;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
      text-align:center;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
      gap:12px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥å…¨ä½“ */
    .sim-container {
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.8);
      margin-bottom:8px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,0.6);
    }
    .sim-header {
      background:radial-gradient(circle at top, #f97316 0%, #0f172a 60%, #020617 100%);
      color:#e0f2fe;
      padding:14px 15px;
      text-align:center;
      border-bottom:1px solid rgba(148,163,184,0.5);
    }
    .sim-header h2 { font-size:20px; margin-bottom:4px; }
    .sim-header p { font-size:13px; opacity:0.9; }

    .sim-area {
      padding:12px 12px 16px;
    }

    .control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .control-label {
      font-size:13px;
      font-weight:bold;
      color:#fed7aa;
      min-width:90px;
    }

    /* ã°ã­ã‚¿ãƒ– */
    .spring-tabs {
      display:flex;
      gap:8px;
      flex:1;
    }
    .spring-btn {
      flex:1;
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:#e2e8f0;
      font-weight:bold;
      min-height:40px;
      transition:all 0.25s ease;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 2px 8px rgba(0,0,0,0.5);
      border:1px solid rgba(148, 163, 184, 0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    .spring-btn.active {
      background:linear-gradient(135deg,#fb923c,#facc15);
      color:#0b1120;
      box-shadow:0 4px 14px rgba(248,181,70,0.7);
      transform:translateY(-1px);
      border-color:transparent;
    }
    .emoji-icon {
      font-size:16px;
      filter:drop-shadow(0 1px 2px rgba(0,0,0,0.7));
    }
    .mode-desc {
      font-size:11px;
      color:#cbd5f5;
      min-width:120px;
      text-align:right;
    }

    .control-row.bottom {
      margin-top:6px;
    }
    .force-slider-wrap {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .force-slider {
      width:100%;
      -webkit-appearance:none;
      height:6px;
      border-radius:999px;
      background:#020617;
      outline:none;
      box-shadow:inset 0 0 4px rgba(15,23,42,0.9);
    }
    .force-slider::-webkit-slider-thumb {
      -webkit-appearance:none;
      appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      background:radial-gradient(circle,#fb923c 0%,#f97316 45%,#c2410c 100%);
      box-shadow:0 0 10px rgba(248,181,70,0.9);
      cursor:pointer;
      border:2px solid #fffbeb;
      margin-top:-8px;
    }
    .force-slider::-moz-range-thumb {
      width:22px;
      height:22px;
      border-radius:50%;
      background:#fb923c;
      border:2px solid #fffbeb;
      cursor:pointer;
    }
    .force-steps {
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color:#cbd5f5;
    }

    /* â–¼ ã‚·ãƒ¼ãƒ³ */
    .sim-field {
      position:relative;
      margin-top:6px;
      border-radius:16px;
      padding:12px;
      overflow:hidden;
      min-height:260px;
      background:radial-gradient(circle at top, #020617 0%, #020617 45%, #020617 100%);
      box-shadow:0 6px 20px rgba(0,0,0,0.85), inset 0 0 22px rgba(15,23,42,0.9);
    }

    .spring-scene {
      position:relative;
      width:100%;
      height:190px;
      border-radius:14px;
      overflow:hidden;
      background:
        radial-gradient(circle at 10% 0%, rgba(248,250,252,0.15), transparent 55%),
        radial-gradient(circle at 90% 15%, rgba(248,181,70,0.25), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(249,115,22,0.12), transparent 70%),
        linear-gradient(180deg, #0a0f1a 0%, #020617 50%, #0a0f1a 100%);
      box-shadow:inset 0 0 40px rgba(15,23,42,0.95), 0 4px 18px rgba(0,0,0,0.9);
      border:1px solid rgba(148,163,184,0.6);
    }

    .ceiling {
      position:absolute;
      left:20%;
      right:20%;
      top:10px;
      height:10px;
      border-radius:999px;
      background:linear-gradient(90deg,#4b5563,#6b7280,#9ca3af);
      box-shadow:0 4px 12px rgba(0,0,0,0.9), inset 0 2px 4px rgba(255,255,255,0.1);
      border:1px solid rgba(148,163,184,0.3);
    }

    .spring {
      position:absolute;
      left:50%;
      top:20px;
      width:20px;
      height:100px;
      transform:translateX(-50%);
      background:
        repeating-linear-gradient(
          180deg,
          transparent 0px,
          transparent 5px,
          rgba(254,243,199,0.98) 5px,
          rgba(254,243,199,0.98) 10px
        ),
        linear-gradient(180deg, rgba(252,211,77,0.3) 0%, rgba(254,243,199,0.95) 50%, rgba(252,211,77,0.3) 100%);
      border-radius:999px;
      filter:drop-shadow(0 0 12px rgba(252,211,77,0.95)) drop-shadow(0 2px 4px rgba(0,0,0,0.5));
      transform-origin:top center;
      transition:height 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border:1px solid rgba(252,211,77,0.4);
      box-shadow:inset 0 0 10px rgba(252,211,77,0.3);
    }
    
    .spring::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:radial-gradient(ellipse at center, rgba(252,211,77,0.2) 0%, transparent 70%);
      border-radius:999px;
    }

    .mass {
      position:absolute;
      left:50%;
      width:75px;
      height:42px;
      background:
        linear-gradient(135deg,#fb923c 0%,#f97316 50%,#ea580c 100%),
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%);
      border-radius:10px;
      transform:translateX(-50%);
      box-shadow:
        0 8px 20px rgba(0,0,0,0.9),
        0 4px 8px rgba(249,115,22,0.5),
        inset 0 2px 4px rgba(255,255,255,0.2),
        inset 0 -2px 4px rgba(0,0,0,0.3);
      border:2px solid rgba(251,146,60,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fffbeb;
      font-weight:bold;
      font-size:15px;
      text-shadow:0 2px 4px rgba(0,0,0,0.8);
      transition:top 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.2s ease;
    }
    
    .mass:hover {
      transform:translateX(-50%) scale(1.05);
    }

    .weight-icons {
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:8px;
      display:flex;
      gap:4px;
      font-size:14px;
      filter:drop-shadow(0 2px 3px rgba(0,0,0,0.9));
    }
    
    /* åŠ›ã®çŸ¢å° */
    .force-arrow {
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      pointer-events:none;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    
    .force-arrow-down {
      top:50%;
      margin-top:20px;
    }
    
    .force-arrow.show {
      opacity:1;
      animation:forcePulse 1.5s ease-in-out infinite;
    }
    
    @keyframes forcePulse {
      0%, 100% { transform:translateX(-50%) translateY(0) scale(1); }
      50% { transform:translateX(-50%) translateY(3px) scale(1.1); }
    }

    /* ä¼¸ã³ã®ãƒãƒ¼ */
    .stretch-bar-wrap {
      position:absolute;
      right:16px;
      top:24px;
      width:12px;
      height:120px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      box-shadow:0 0 12px rgba(0,0,0,0.8);
      overflow:hidden;
      border:1px solid rgba(148,163,184,0.7);
    }
    .stretch-bar-fill {
      position:absolute;
      left:2px;
      right:2px;
      bottom:2px;
      height:0;
      border-radius:999px;
      background:
        linear-gradient(180deg,#22c55e 0%,#facc15 50%,#f97316 100%),
        radial-gradient(ellipse at center, rgba(255,255,255,0.3) 0%, transparent 70%);
      box-shadow:
        0 0 12px rgba(34,197,94,0.95),
        0 0 8px rgba(250,204,21,0.6),
        inset 0 0 8px rgba(255,255,255,0.2);
      transition:height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border:1px solid rgba(34,197,94,0.5);
    }
    
    .stretch-bar-fill::after {
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:4px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      animation:shine 2s ease-in-out infinite;
    }
    
    @keyframes shine {
      0%, 100% { opacity:0; }
      50% { opacity:1; }
    }
    .stretch-label {
      position:absolute;
      right:16px;
      bottom:22px;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.7);
      box-shadow:0 2px 6px rgba(0,0,0,0.8);
    }

    .sky-tag {
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 10px;
      font-size:11px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#fed7aa;
      box-shadow:0 2px 8px rgba(0,0,0,0.8);
      border:1px solid rgba(248,181,70,0.6);
    }
    .sky-label {
      position:absolute;
      bottom:10px;
      left:10px;
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#e0f2fe;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 8px rgba(0,0,0,0.8);
      border:1px solid rgba(148,163,184,0.6);
    }
    .sky-label span.icon {
      font-size:16px;
      filter:drop-shadow(0 2px 3px rgba(0,0,0,0.8));
    }

    /* infoã‚«ãƒ¼ãƒ‰ */
    .env-panel {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .env-card {
      flex:1 1 120px;
      background:rgba(15,23,42,0.95);
      border-radius:12px;
      padding:8px 10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.8);
      border:1px solid rgba(148,163,184,0.6);
    }
    .env-title {
      font-size:13px;
      font-weight:bold;
      margin-bottom:3px;
      color:#e0f2fe;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .env-title span.emoji {
      font-size:17px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.8));
      animation:float 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-3px);} }
    .env-value {
      font-size:14px;
      font-weight:bold;
      margin-bottom:2px;
      color:#fee2e2;
    }
    .env-sub {
      font-size:11px;
      color:#cbd5f5;
    }

    .sim-comment {
      margin-top:10px;
      font-size:13px;
      line-height:1.6;
      color:#e5e7eb;
      background:rgba(15,23,42,0.95);
      border-radius:12px;
      padding:10px 12px;
      border-left:3px solid #fb923c;
      box-shadow:0 3px 10px rgba(0,0,0,0.85);
    }
    .sim-comment strong {
      color:#fed7aa;
      text-shadow:0 1px 2px rgba(0,0,0,0.8);
    }

    /* â–¼ infoãƒ‘ãƒãƒ«ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .info-panel {
      background:rgba(15,23,42,0.96);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(0,0,0,0.8);
      padding:14px;
      border:1px solid rgba(148,163,184,0.6);
    }
    .info-panel h3 {
      color:#e0f2fe;
      margin-bottom:8px;
      font-size:16px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(210px, 1fr));
      gap:10px;
    }
    .info-item {
      background:rgba(15,23,42,0.95);
      padding:10px;
      border-radius:10px;
      border-left:3px solid #fb923c;
    }
    .info-item h4 {
      color:#fed7aa;
      margin-bottom:4px;
      font-size:13px;
    }
    .info-item p {
      color:#e5e7eb;
      font-size:12px;
      line-height:1.4;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background:rgba(15,23,42,0.96);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(0,0,0,0.8);
      padding:16px;
      border:1px solid rgba(148,163,184,0.6);
      margin-bottom:8px;
    }
    .question-text {
      font-size:15px;
      font-weight:bold;
      color:#e5e7eb;
      margin-bottom:10px;
    }
    .progress-bar {
      background:#020617;
      border-radius:999px;
      height:7px;
      margin:8px 0 12px;
      overflow:hidden;
      box-shadow:inset 0 0 4px rgba(15,23,42,0.95);
    }
    .progress-fill {
      background:linear-gradient(135deg, #fb923c 0%, #22c55e 100%);
      height:100%;
      width:0%;
      transition:width 0.3s ease;
      box-shadow:0 0 10px rgba(248,181,70,0.8);
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .choice {
      padding:11px 13px;
      background:rgba(15,23,42,0.92);
      border:1.5px solid rgba(55,65,81,0.9);
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:13px;
      min-height:44px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      color:#e5e7eb;
    }
    .choice:hover {
      background:rgba(31,41,55,0.95);
      border-color:#fb923c;
    }
    .choice.correct {
      background:#16a34a;
      color:white;
      border-color:#16a34a;
      animation:correctPulse 0.6s ease;
      box-shadow:0 0 12px rgba(22,163,74,0.9);
    }
    .choice.incorrect {
      background:#b91c1c;
      color:white;
      border-color:#b91c1c;
      animation:wrongShake 0.6s ease;
      box-shadow:0 0 12px rgba(185,28,28,0.9);
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.04);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-8px);}
      75%{transform:translateX(8px);}
    }

    .explanation {
      margin-top:12px;
      padding:10px;
      background:rgba(15,23,42,0.95);
      border-radius:10px;
      border-left:3px solid #22c55e;
      display:none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#bbf7d0;
      margin-bottom:6px;
      font-size:13px;
    }
    .explanation p {
      color:#e5e7eb;
      line-height:1.5;
      font-size:12px;
    }

    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:14px;
    }
    .nav-btn {
      padding:11px 18px;
      border:none;
      border-radius:999px;
      font-size:13px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#4b5563;
      color:#e5e7eb;
    }
    .prev-btn:hover:not(:disabled) { background:#374151; }
    .next-btn {
      background:linear-gradient(135deg,#fb923c,#22c55e);
      color:#0b1120;
      box-shadow:0 3px 10px rgba(248,181,70,0.7);
    }
    .next-btn:hover:not(:disabled) { filter:brightness(1.05); }

    * { touch-action:manipulation; }
    .choice, .nav-btn, .home-btn, .spring-btn {
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    @media (max-width:768px){
      body { overflow-x:hidden; }
      .header { padding:8px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:14px; margin:0 6px; }
      .main-container { padding:10px; gap:10px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { min-height:240px; padding:10px; }
      .spring-scene { height:180px; }
      .info-panel { padding:12px; }
      .info-grid { grid-template-columns:1fr; }
      .info-item { padding:9px; }
      .question-container { padding:14px; }
      .question-text { font-size:14px; }
      .choice { font-size:12px; padding:9px 11px; }
      .nav-btn { font-size:12px; padding:9px 14px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <button class="home-btn" onclick="goHome()">ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">ã°ã­ã¨åŠ›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div>
    <div style="width:80px;"></div>
  </header>

  <main class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <section class="sim-container">
      <div class="sim-header">
        <h2>ã°ã­ã®ã®ã³ã¨åŠ›</h2>
        <p>ã°ã­ã®ç¨®é¡ã¨ãŠã‚‚ã‚Šã®æ•°ã‚’å¤‰ãˆã¦ã€ã€ŒåŠ›ãŒå¤§ãã„ã»ã©ä¼¸ã³ãŒå¤§ãã„ã€ã“ã¨ã‚’ç›®ã§ç¢ºã‹ã‚ã‚ˆã†ã€‚</p>
      </div>

      <div class="sim-area">
        <div class="control-row">
          <div class="control-label">ã°ã­ã®ç¨®é¡</div>
          <div class="spring-tabs">
            <button class="spring-btn active" data-spring="soft" id="btnSoft">
              <span class="emoji-icon">ğŸŒ€</span>ã°ã­Aï¼ˆã‚„ã‚ã‚‰ã‹ã„ï¼‰
            </button>
            <button class="spring-btn" data-spring="hard" id="btnHard">
              <span class="emoji-icon">ğŸ§·</span>ã°ã­Bï¼ˆã‹ãŸã„ï¼‰
            </button>
          </div>
          <div class="mode-desc" id="springDesc">ã°ã­Aï¼šåŒã˜åŠ›ã§ã‚‚å¤§ããã®ã³ã‚‹</div>
        </div>

        <div class="control-row bottom">
          <div class="control-label">ãŠã‚‚ã‚Šã®æ•°</div>
          <div class="force-slider-wrap">
            <input type="range" min="0" max="3" step="1" value="1" class="force-slider" id="forceSlider" />
            <div class="force-steps">
              <span>0ã“</span>
              <span>1ã“</span>
              <span>2ã“</span>
              <span>3ã“</span>
            </div>
          </div>
          <div class="mode-desc" id="forceDesc">1ã“ã®ãŠã‚‚ã‚Šï¼ˆç´„1Nï¼‰</div>
        </div>

        <div class="sim-field">
          <div class="spring-scene">
            <div class="ceiling"></div>

            <div class="spring" id="springBody"></div>
            <div class="mass" id="massBlock">1ã“</div>
            
            <!-- åŠ›ã®çŸ¢å°ï¼ˆå¯è¦–åŒ–ï¼‰ -->
            <div class="force-arrow force-arrow-down" id="forceArrowDown">
              <svg width="40" height="30" viewBox="0 0 40 30">
                <defs>
                  <linearGradient id="forceGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f97316;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
                  </linearGradient>
                  <filter id="forceGlow">
                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                    <feMerge>
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>
                <line x1="20" y1="0" x2="20" y2="25" stroke="url(#forceGradient)" stroke-width="3" stroke-linecap="round" filter="url(#forceGlow)"/>
                <polygon points="20,25 15,20 25,20" fill="url(#forceGradient)" filter="url(#forceGlow)"/>
              </svg>
            </div>

            <div class="weight-icons" id="weightIcons">
              <span>âš«</span>
            </div>

            <div class="stretch-bar-wrap">
              <div class="stretch-bar-fill" id="stretchBar"></div>
            </div>
            <div class="stretch-label" id="stretchLabel">ã®ã³ï¼š2cm</div>

            <div class="sky-tag" id="skyTag">ã°ã­Aãƒ»1ã“ï¼šã‚†ã£ãŸã‚Šã¨ã®ã³ã‚‹</div>
            <div class="sky-label">
              <span class="icon" id="skyIcon">ğŸ“</span>
              <span id="skyLabelText">ãŠã‚‚ã‚ŠãŒå¤šã„ã»ã©ã€ã°ã­ã®ã®ã³ã¯å¤§ãããªã‚‹</span>
            </div>
          </div>

          <div class="env-panel">
            <div class="env-card">
              <div class="env-title"><span class="emoji">ğŸ’ª</span>åŠ›ã®å¤§ãã•</div>
              <div class="env-value" id="forceText">ç´„ 1Nï¼ˆãŠã‚‚ã‚Š1ã“ï¼‰</div>
              <div class="env-sub">ã“ã“ã§ã¯ã€ãŠã‚‚ã‚Š1ã“åˆ†ã®é‡ã•ã‚’ãŠã‚ˆã1Nã®åŠ›ã¨è€ƒãˆã‚‹ã€‚</div>
            </div>
            <div class="env-card">
              <div class="env-title"><span class="emoji">ğŸ“</span>ã°ã­ã®ã®ã³</div>
              <div class="env-value" id="stretchText">ã°ã­Aï¼š2cm ã®ã³ã‚‹</div>
              <div class="env-sub">åŒã˜ã°ã­ã§ã¯ã€åŠ›ãŒ2å€ãƒ»3å€ã«ãªã‚‹ã¨ã€ã®ã³ã‚‚2å€ãƒ»3å€ã«ãªã‚‹ã€‚</div>
            </div>
            <div class="env-card">
              <div class="env-title"><span class="emoji">âš–ï¸</span>Aã¨Bã®ã¡ãŒã„</div>
              <div class="env-value" id="compareText">ã°ã­Aã®ã»ã†ãŒã‚ˆãã®ã³ã‚‹</div>
              <div class="env-sub">åŒã˜åŠ›ã§ã‚‚ã€ã‚„ã‚ã‚‰ã‹ã„ã°ã­ã®ã»ã†ãŒå¤§ããã®ã³ã‚‹ã€‚</div>
            </div>
          </div>

          <div class="sim-comment" id="simComment">
            <strong>ã°ã­ã®ã®ã³ã¯ã€ãã®ã°ã­ã«åŠ ã‚ã‚‹åŠ›ã®å¤§ãã•ã«æ¯”ä¾‹ã—ã¾ã™ã€‚</strong>åŒã˜ã°ã­ãªã‚‰ã€åŠ›ãŒ2å€ãƒ»3å€ã«ãªã‚‹ã¨ã€ã®ã³ã‚‚2å€ãƒ»3å€ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ã°ã­ã®ç¨®é¡ã«ã‚ˆã£ã¦ã€åŒã˜åŠ›ã§ã‚‚ã®ã³æ–¹ãŒã¡ãŒã„ã¾ã™ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- â–¼ å°å…¥ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¦ç‚¹ï¼‰ -->
    <section class="info-panel">
      <h3>ã°ã­ã¨åŠ›ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>â‘  åŠ›ãŒå¤§ãã„ã»ã©ã€ã°ã­ã¯ã‚ˆãã®ã³ã‚‹</h4>
          <p>
            åŒã˜ã°ã­ã«ã‹ã‹ã‚‹<strong>åŠ›</strong>ã‚’å¤§ããã™ã‚‹ã¨ã€ãã®ã°ã­ã®<strong>ã®ã³</strong>ã‚‚å¤§ãããªã‚‹ã€‚ãŠã‚‚ã‚Šã®æ•°ã‚’ãµã‚„ã™ã¨ã€ã°ã­ãŒã‚ˆã‚Šé•·ããªã‚‹ã€‚
          </p>
        </div>
        <div class="info-item">
          <h4>â‘¡ åŒã˜ã°ã­ã§ã¯ã€æ¯”ä¾‹ã®é–¢ä¿‚</h4>
          <p>
            åŒã˜ã°ã­ã‚’ä½¿ã†ã¨ãã€åŠ›ãŒ2å€ãƒ»3å€ã«ãªã‚‹ã¨ã€ã°ã­ã®<strong>ã®ã³ã‚‚2å€ãƒ»3å€</strong>ã«ãªã‚‹ã‚ˆã†ãª<strong>æ¯”ä¾‹</strong>ã®é–¢ä¿‚ã«ãªã£ã¦ã„ã‚‹ã€‚
          </p>
        </div>
        <div class="info-item">
          <h4>â‘¢ ã°ã­ã®ç¨®é¡ã«ã‚ˆã£ã¦ã€ã®ã³æ–¹ãŒã¡ãŒã†</h4>
          <p>
            ã‚„ã‚ã‚‰ã‹ã„ã°ã­ã¨ã€ã‹ãŸã„ã°ã­ã‚’ãã‚‰ã¹ã‚‹ã¨ã€åŒã˜åŠ›ã§ã‚‚<strong>ã‚„ã‚ã‚‰ã‹ã„ã°ã­ã®ã»ã†ãŒã‚ˆãã®ã³ã‚‹</strong>ã€‚ã°ã­ã®æ€§è³ªã«ã‚ˆã£ã¦ã€ã‚°ãƒ©ãƒ•ã®å‚¾ããŒå¤‰ã‚ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚
          </p>
        </div>
      </div>
    </section>

    <!-- â–¼ ã‚ã‹ã‚‹ç·¨ 3å• -->
    <section class="question-container">
      <div class="question-text" id="questionText"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="choices" id="choicesContainer"></div>
      <div class="explanation" id="explanationBox">
        <h4>è§£èª¬</h4>
        <p id="explanationText"></p>
      </div>

      <div class="navigation">
        <button class="nav-btn prev-btn" id="prevBtn">å‰ã®å•é¡Œã¸</button>
        <button class="nav-btn next-btn" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>
      </div>
      <div id="historyDisplay"></div>
    </section>
  </main>

  <script>
    /************ LearningTracker ************/
    class LearningTracker {
      constructor(lessonId) {
        this.lessonId = lessonId;
        this.storageKey = "stepnavi_science_" + lessonId;
        this.currentSession = null;
        this.history = this.loadHistory();
      }

      loadHistory() {
        try {
          const raw = localStorage.getItem(this.storageKey);
          return raw ? JSON.parse(raw) : { sessions: [] };
        } catch (e) {
          console.warn("Failed to load history:", e);
          return { sessions: [] };
        }
      }

      startSession() {
        this.currentSession = {
          startedAt: Date.now(),
          answered: 0,
          correct: 0,
          records: []
        };
      }

      recordAnswer(questionIndex, isCorrect) {
        if (!this.currentSession) this.startSession();
        const now = Date.now();
        this.currentSession.answered += 1;
        if (isCorrect) this.currentSession.correct += 1;
        this.currentSession.records.push({
          questionIndex,
          isCorrect,
          answeredAt: now
        });

        this.postToParent("question:answered", {
          lessonId: this.lessonId,
          questionIndex,
          isCorrect,
          timestamp: now
        });
      }

      completeLesson(totalQuestions) {
        if (!this.currentSession) return;
        const now = Date.now();
        const durationMs = now - this.currentSession.startedAt;
        const summary = {
          ...this.currentSession,
          finishedAt: now,
          durationMs,
          totalQuestions
        };
        this.history.sessions.push(summary);
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.history));
        } catch (e) {
          console.warn("Failed to save history:", e);
        }

        this.postToParent("lesson:complete", {
          lessonId: this.lessonId,
          totalQuestions,
          answered: this.currentSession.answered,
          correct: this.currentSession.correct,
          durationMs
        });

        this.currentSession = null;
      }

      postToParent(type, payload) {
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type, payload }, "*");
          }
        } catch (e) {
          console.warn("postMessage failed:", e);
        }
      }
    }

    const LESSON_ID = "sci.physics.spring_force_sim";
    const tracker = new LearningTracker(LESSON_ID);

    /************ ã°ã­ã‚·ãƒŸãƒ¥åˆ¶å¾¡ ************/
    const btnSoft = document.getElementById("btnSoft");
    const btnHard = document.getElementById("btnHard");
    const springButtons = [btnSoft, btnHard];
    const springDesc = document.getElementById("springDesc");

    const forceSlider = document.getElementById("forceSlider");
    const forceDesc = document.getElementById("forceDesc");

    const springBody = document.getElementById("springBody");
    const massBlock = document.getElementById("massBlock");
    const weightIcons = document.getElementById("weightIcons");
    const stretchBar = document.getElementById("stretchBar");
    const stretchLabel = document.getElementById("stretchLabel");
    const forceArrowDown = document.getElementById("forceArrowDown");

    const forceText = document.getElementById("forceText");
    const stretchText = document.getElementById("stretchText");
    const compareText = document.getElementById("compareText");
    const skyTag = document.getElementById("skyTag");
    const skyIcon = document.getElementById("skyIcon");
    const skyLabelText = document.getElementById("skyLabelText");
    const simComment = document.getElementById("simComment");

    let currentSpring = "soft"; // "soft" or "hard"

    // ç°¡æ˜“ãƒ‡ãƒ¼ã‚¿ï¼ˆå˜ä½ã¯cmã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
    // index: ãŠã‚‚ã‚Š0,1,2,3ã“
    const extensionData = {
      soft: [0, 2, 4, 6],
      hard: [0, 1, 2, 3]
    };

    function setSpring(type) {
      currentSpring = type;
      springButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.spring === type);
      });
      if (type === "soft") {
        springDesc.textContent = "ã°ã­Aï¼šåŒã˜åŠ›ã§ã‚‚å¤§ããã®ã³ã‚‹ï¼ˆã‚„ã‚ã‚‰ã‹ã„ã°ã­ï¼‰";
        compareText.textContent = "ã°ã­Aã®ã»ã†ãŒå¤§ããã®ã³ã‚‹";
      } else {
        springDesc.textContent = "ã°ã­Bï¼šåŒã˜åŠ›ã§ã‚‚ã‚ã¾ã‚Šã®ã³ãªã„ï¼ˆã‹ãŸã„ã°ã­ï¼‰";
        compareText.textContent = "ã°ã­Bã¯ã®ã³ãŒå°ã•ã„";
      }
      updateSpringScene();
    }

    springButtons.forEach(btn => {
      btn.addEventListener("click", () => setSpring(btn.dataset.spring));
    });

    forceSlider.addEventListener("input", () => {
      updateSpringScene();
    });

    function updateSpringScene() {
      const n = parseInt(forceSlider.value, 10); // ãŠã‚‚ã‚Šã®æ•°
      const ext = extensionData[currentSpring][n]; // ä¼¸ã³ï¼ˆcmã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

      // ãƒ†ã‚­ã‚¹ãƒˆé¡
      const forceN = n; // ã“ã“ã§ã¯ã€Œ1ã“ â‰’ 1Nã€ã§å˜ç´”åŒ–
      const weightLabel = (n === 0) ? "0ã“" : n + "ã“";
      forceDesc.textContent = weightLabel + "ã®ãŠã‚‚ã‚Šï¼ˆç´„ " + forceN + "Nï¼‰";
      forceText.textContent = "ç´„ " + forceN + "Nï¼ˆãŠã‚‚ã‚Š" + weightLabel + "ï¼‰";

      massBlock.textContent = weightLabel;
      updateWeightIcons(n);

      stretchLabel.textContent = "ã®ã³ï¼š" + ext + "cm";
      const springName = (currentSpring === "soft") ? "ã°ã­A" : "ã°ã­B";
      stretchText.textContent = springName + "ï¼š" + ext + "cm ã®ã³ã‚‹";

      skyTag.textContent =
        springName + "ãƒ»" + weightLabel + "ï¼šåŠ›ãŒå¤§ãã„ã»ã©ã‚ˆãã®ã³ã‚‹";

      if (currentSpring === "soft") {
        skyIcon.textContent = "ğŸŒ€";
        skyLabelText.textContent = "ã‚„ã‚ã‚‰ã‹ã„ã°ã­Aã¯ã€åŒã˜åŠ›ã§ã‚‚å¤§ããã®ã³ã‚‹";
        simComment.innerHTML =
          "<strong>ã°ã­Aï¼ˆã‚„ã‚ã‚‰ã‹ã„ã°ã­ï¼‰</strong>ã¯ã€åŒã˜ãŠã‚‚ã‚Šã®æ•°ã§ã‚‚<strong>ã°ã­Bã‚ˆã‚Šå¤§ããã®ã³</strong>ã¾ã™ã€‚åŒã˜ã°ã­ã®ä¸­ã§ã¯ã€åŠ›ãŒ2å€ãƒ»3å€ã«ãªã‚‹ã¨ã€ã®ã³ã‚‚2å€ãƒ»3å€ã«ãªã‚Šã¾ã™ã€‚";
      } else {
        skyIcon.textContent = "ğŸ§·";
        skyLabelText.textContent = "ã‹ãŸã„ã°ã­Bã¯ã€åŒã˜åŠ›ã§ã‚‚ã®ã³ãŒå°ã•ã„";
        simComment.innerHTML =
          "<strong>ã°ã­Bï¼ˆã‹ãŸã„ã°ã­ï¼‰</strong>ã¯ã€åŒã˜ãŠã‚‚ã‚Šã®æ•°ã§ã‚‚<strong>ã°ã­Aã‚ˆã‚Šã®ã³ãŒå°ã•ã</strong>ãªã‚Šã¾ã™ã€‚ã°ã­ã®æ€§è³ªã«ã‚ˆã£ã¦ã€ã®ã³ã‚„ã™ã•ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚";
      }

      // ã°ã­ã®é•·ã•ãƒ»ãŠã‚‚ã‚Šã®ä½ç½®
      const baseLength = 80; // åŸºæœ¬é•·ã•
      const extra = ext * 4; // ã®ã³ã«å¿œã˜ã¦ä¼¸ã°ã™px
      const totalLength = baseLength + extra;
      springBody.style.height = totalLength + "px";
      
      // ã°ã­ã®è‰²ã‚’ä¼¸ã³ã«å¿œã˜ã¦å¤‰åŒ–ï¼ˆè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
      if (springBody) {
        const stretchRatio = ext / 6; // æœ€å¤§ä¼¸ã³ã«å¯¾ã™ã‚‹æ¯”ç‡
        if (stretchRatio > 0.7) {
          springBody.style.filter = 'drop-shadow(0 0 15px rgba(249,115,22,0.9)) drop-shadow(0 2px 4px rgba(0,0,0,0.5))';
          springBody.style.background = `
            repeating-linear-gradient(
              180deg,
              transparent 0px,
              transparent 5px,
              rgba(254,202,202,0.98) 5px,
              rgba(254,202,202,0.98) 10px
            ),
            linear-gradient(180deg, rgba(249,115,22,0.4) 0%, rgba(254,243,199,0.95) 50%, rgba(249,115,22,0.4) 100%)
          `;
        } else if (stretchRatio > 0.4) {
          springBody.style.filter = 'drop-shadow(0 0 12px rgba(252,211,77,0.9)) drop-shadow(0 2px 4px rgba(0,0,0,0.5))';
          springBody.style.background = `
            repeating-linear-gradient(
              180deg,
              transparent 0px,
              transparent 5px,
              rgba(254,243,199,0.98) 5px,
              rgba(254,243,199,0.98) 10px
            ),
            linear-gradient(180deg, rgba(252,211,77,0.3) 0%, rgba(254,243,199,0.95) 50%, rgba(252,211,77,0.3) 100%)
          `;
        } else {
          springBody.style.filter = 'drop-shadow(0 0 12px rgba(252,211,77,0.95)) drop-shadow(0 2px 4px rgba(0,0,0,0.5))';
          springBody.style.background = `
            repeating-linear-gradient(
              180deg,
              transparent 0px,
              transparent 5px,
              rgba(254,243,199,0.98) 5px,
              rgba(254,243,199,0.98) 10px
            ),
            linear-gradient(180deg, rgba(252,211,77,0.3) 0%, rgba(254,243,199,0.95) 50%, rgba(252,211,77,0.3) 100%)
          `;
        }
      }

      const massTop = 20 + totalLength;
      massBlock.style.top = massTop + "px";
      
      // é‡ã‚Šã®è‰²ã‚‚ä¼¸ã³ã«å¿œã˜ã¦å¤‰åŒ–
      if (massBlock) {
        const stretchRatio = ext / 6;
        if (stretchRatio > 0.7) {
          massBlock.style.background = `
            linear-gradient(135deg,#dc2626 0%,#b91c1c 50%,#991b1b 100%),
            radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%)
          `;
          massBlock.style.boxShadow = `
            0 8px 20px rgba(0,0,0,0.9),
            0 4px 8px rgba(220,38,38,0.6),
            inset 0 2px 4px rgba(255,255,255,0.2),
            inset 0 -2px 4px rgba(0,0,0,0.3)
          `;
        } else {
          massBlock.style.background = `
            linear-gradient(135deg,#fb923c 0%,#f97316 50%,#ea580c 100%),
            radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%)
          `;
          massBlock.style.boxShadow = `
            0 8px 20px rgba(0,0,0,0.9),
            0 4px 8px rgba(249,115,22,0.5),
            inset 0 2px 4px rgba(255,255,255,0.2),
            inset 0 -2px 4px rgba(0,0,0,0.3)
          `;
        }
      }
      
      // åŠ›ã®çŸ¢å°ã‚’è¡¨ç¤ºï¼ˆãŠã‚‚ã‚ŠãŒã‚ã‚‹å ´åˆï¼‰
      if (forceArrowDown) {
        if (n > 0) {
          forceArrowDown.style.top = (massTop + 42) + "px";
          forceArrowDown.classList.add("show");
        } else {
          forceArrowDown.classList.remove("show");
        }
      }

      // ä¼¸ã³ãƒãƒ¼(0ã€œ100px)
      const maxExt = 6; // softã®æœ€å¤§
      const barHeight = (ext / maxExt) * 100;
      stretchBar.style.height = barHeight + "%";
      
      // ã°ã­ã®æŒ¯å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤‰åŒ–æ™‚ï¼‰
      if (springBody) {
        springBody.style.animation = 'none';
        setTimeout(() => {
          springBody.style.animation = 'springBounce 0.3s ease-out';
        }, 10);
      }
      
      // é‡ã‚Šã®è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      if (massBlock) {
        massBlock.style.animation = 'none';
        setTimeout(() => {
          massBlock.style.animation = 'massBounce 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        }, 10);
      }
    }
    
    // é‡ã‚Šã®ãƒã‚¦ãƒ³ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const massBounceStyle = document.createElement('style');
    massBounceStyle.textContent += `
      @keyframes massBounce {
        0% { transform: translateX(-50%) translateY(-5px) scale(1); }
        50% { transform: translateX(-50%) translateY(2px) scale(1.02); }
        100% { transform: translateX(-50%) translateY(0) scale(1); }
      }
    `;
    document.head.appendChild(massBounceStyle);
    
    // ã°ã­ã®ãƒã‚¦ãƒ³ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const springBounceStyle = document.createElement('style');
    springBounceStyle.textContent = `
      @keyframes springBounce {
        0% { transform: translateX(-50%) scaleY(1); }
        50% { transform: translateX(-50%) scaleY(1.05); }
        100% { transform: translateX(-50%) scaleY(1); }
      }
    `;
    document.head.appendChild(springBounceStyle);

    function updateWeightIcons(count) {
      weightIcons.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const span = document.createElement("span");
        span.textContent = "âš«";
        weightIcons.appendChild(span);
      }
      // 0ã“ã®ã¨ãã¯ã†ã£ã™ã‚‰ç°è‰²ã§1å€‹ã ã‘è¡¨ç¤ºã—ã¦ã‚‚è‰¯ã„ãŒã€ã“ã“ã§ã¯ç©ºã«
    }

    // åˆæœŸçŠ¶æ…‹
    setSpring("soft");
    forceSlider.value = 1;
    updateSpringScene();

    /************ ã‚ã‹ã‚‹ç·¨ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿ ************/
    const questions = [
      {
        id: "q1",
        text: "åŒã˜ã°ã­ã«ã‹ã‘ã‚‹åŠ›ï¼ˆãŠã‚‚ã‚Šã®æ•°ï¼‰ã‚’ãµã‚„ã—ã¦ã„ãã¨ã€ã°ã­ã®ã®ã³ã¯ãµã¤ã†ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ",
        choices: [
          "åŠ›ãŒå¤§ãã„ã»ã©ã€ã°ã­ã®ã®ã³ã‚‚å¤§ãããªã‚‹",
          "åŠ›ãŒå¤§ãã„ã»ã©ã€ã°ã­ã®ã®ã³ã¯å°ã•ããªã‚‹",
          "åŠ›ã‚’å¤‰ãˆã¦ã‚‚ã€ã®ã³ã¯ã„ã¤ã‚‚åŒã˜",
          "åŠ›ãŒå¤§ãã„ã¨ã€ã°ã­ã¯ã¾ã£ãŸãã®ã³ãªããªã‚‹"
        ],
        correct: 0,
        explanation:
          "åŒã˜ã°ã­ã«ã‹ã‘ã‚‹<strong>åŠ›</strong>ã‚’å¤§ããã™ã‚‹ã¨ã€ãã®ã°ã­ã®<strong>ã®ã³</strong>ã‚‚å¤§ãããªã‚Šã¾ã™ã€‚ãŠã‚‚ã‚Š1ã“ã‚ˆã‚Š2ã“ã€2ã“ã‚ˆã‚Š3ã“ã®ã»ã†ãŒã€ã°ã­ã¯é•·ãã®ã³ã¾ã™ã€‚"
      },
      {
        id: "q2",
        text: "ã°ã­Aã«ãŠã‚‚ã‚Šã‚’1ã“ã¤ã‚‹ã—ãŸã¨ãã®ã®ã³ã‚’1ã¨ã™ã‚‹ã¨ã€åŒã˜ã°ã­Aã«ãŠã‚‚ã‚Š3ã“ã‚’ã¤ã‚‹ã—ãŸã¨ãã®ã®ã³ã¨ã—ã¦ã€ã‚‚ã£ã¨ã‚‚è¿‘ã„è€ƒãˆæ–¹ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
        choices: [
          "ã ã„ãŸã„3å€ãã‚‰ã„ã®ã³ã‚‹",
          "ã ã„ãŸã„2å€ãã‚‰ã„ã®ã³ã‚‹",
          "ã ã„ãŸã„åŠåˆ†ãã‚‰ã„ã«ãªã‚‹",
          "ã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ãªã„"
        ],
        correct: 0,
        explanation:
          "åŒã˜ã°ã­ã§ã¯ã€ã‹ã‘ã‚‹åŠ›ã¨ã°ã­ã®ã®ã³ãŒ<strong>æ¯”ä¾‹</strong>ã®é–¢ä¿‚ã«ãªã‚Šã¾ã™ã€‚ãŠã‚‚ã‚ŠãŒ3å€ã«ãªã‚‹ã¨ã€ã®ã³ã‚‚ãŠã‚ˆã3å€ã«ãªã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ï¼ˆå®Ÿé¨“ã§ã¯å°‘ã—ãšã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ï¼‰ã€‚"
      },
      {
        id: "q3",
        text: "åŒã˜åŠ›ï¼ˆåŒã˜æ•°ã®ãŠã‚‚ã‚Šï¼‰ã‚’ã‹ã‘ãŸã¨ãã€ã°ã­Aã¨ã°ã­Bã‚’ãã‚‰ã¹ã‚‹ã¨ã€ã©ã®ã‚ˆã†ã«è¨€ãˆã¾ã™ã‹ï¼Ÿ",
        choices: [
          "ã‚„ã‚ã‚‰ã‹ã„ã°ã­Aã®ã»ã†ãŒã€ã°ã­Bã‚ˆã‚Šå¤§ããã®ã³ã‚‹",
          "ã‹ãŸã„ã°ã­Bã®ã»ã†ãŒã€ã°ã­Aã‚ˆã‚Šå¤§ããã®ã³ã‚‹",
          "ã°ã­Aã‚‚ã°ã­Bã‚‚ã®ã³ã¯ã¾ã£ãŸãåŒã˜",
          "ã©ã¡ã‚‰ã®ã°ã­ã‚‚ã®ã³ã¦ã„ã‚‹ã‚ˆã†ã«ã¯è¦‹ãˆãªã„"
        ],
        correct: 0,
        explanation:
          "ã°ã­ã®æ€§è³ªã«ã‚ˆã£ã¦ã€åŒã˜åŠ›ã§ã‚‚<strong>ã®ã³ã‚„ã™ã•</strong>ãŒã¡ãŒã„ã¾ã™ã€‚ã‚„ã‚ã‚‰ã‹ã„<strong>ã°ã­A</strong>ã®ã»ã†ãŒã€ã‹ãŸã„<strong>ã°ã­B</strong>ã‚ˆã‚Šå¤§ããã®ã³ã‚‹ã®ã§ã€ã‚°ãƒ©ãƒ•ã«ã™ã‚‹ã¨Aã®ç·šã®ã»ã†ãŒå‚¾ããŒå¤§ãããªã‚Šã¾ã™ã€‚"
      }
    ];

    let currentQuestionIndex = 0;
    let answeredFlags = new Array(questions.length).fill(false);

    const questionTextEl = document.getElementById("questionText");
    const choicesContainer = document.getElementById("choicesContainer");
    const explanationBox = document.getElementById("explanationBox");
    const explanationText = document.getElementById("explanationText");
    const progressFill = document.getElementById("progressFill");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    function renderQuestion(index) {
      const q = questions[index];
      questionTextEl.textContent = "Q" + (index + 1) + ". " + q.text;
      choicesContainer.innerHTML = "";
      explanationBox.classList.remove("show");
      explanationText.innerHTML = "";

      q.choices.forEach((choiceText, i) => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = choiceText;
        btn.dataset.index = i;
        btn.addEventListener("click", () => handleChoiceClick(index, i, btn));
        choicesContainer.appendChild(btn);
      });

      updateProgress();
      updateNavButtons();
    }

    function handleChoiceClick(qIndex, choiceIndex, btnEl) {
      const q = questions[qIndex];

      if (answeredFlags[qIndex]) return;

      const allChoices = choicesContainer.querySelectorAll(".choice");
      allChoices.forEach(el => el.disabled = true);

      const isCorrect = (choiceIndex === q.correct);
      answeredFlags[qIndex] = true;

      if (isCorrect) {
        btnEl.classList.add("correct");
      } else {
        btnEl.classList.add("incorrect");
        const correctBtn = allChoices[q.correct];
        if (correctBtn) correctBtn.classList.add("correct");
      }

      explanationBox.classList.add("show");
      explanationText.innerHTML = q.explanation;

      tracker.recordAnswer(qIndex, isCorrect);

      updateProgress();
      updateNavButtons();

      if (answeredFlags.every(f => f)) {
        // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ãŸå ´åˆã€å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        nextBtn.disabled = true;
        prevBtn.disabled = true;
        nextBtn.style.opacity = "0.5";
        prevBtn.style.opacity = "0.5";
        
        setTimeout(() => {
          if (answeredFlags.every(f => f)) {
            showCompletionScreen();
          }
        }, 2000);
      }
    }

    function updateProgress() {
      const answeredCount = answeredFlags.filter(f => f).length;
      const ratio = answeredCount / questions.length;
      progressFill.style.width = (ratio * 100) + "%";
    }

    function updateNavButtons() {
      // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”æ¸ˆã¿ã®å ´åˆã¯ã€å®Œäº†ç”»é¢è¡¨ç¤ºä¸­ãªã®ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (answeredFlags.every(f => f)) {
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      prevBtn.disabled = (currentQuestionIndex === 0);
      nextBtn.disabled = (currentQuestionIndex === questions.length - 1);
    }

    prevBtn.addEventListener("click", () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion(currentQuestionIndex);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion(currentQuestionIndex);
      } else {
        // æœ€å¾Œã®å•é¡Œã§ã€Œæ¬¡ã®å•é¡Œã¸ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
        if (answeredFlags.every(f => f)) {
          showCompletionScreen();
        }
      }
    });

    tracker.startSession();
    renderQuestion(currentQuestionIndex);

    function showCompletionScreen() {
      // å­¦ç¿’å±¥æ­´ã‚’ä¿å­˜
      tracker.saveSession();
      
      // ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤
      clearCheckpoint();
      
      // UIã‚’å®Œäº†ç”»é¢ã«å¤‰æ›´
      questionTextEl.textContent = "å­¦ç¿’å®Œäº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
      choicesContainer.innerHTML = "";
      explanationBox.classList.remove("show");
      explanationText.innerHTML = "";
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      nextBtn.style.display = "none";
      prevBtn.style.display = "none";
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
      progressFill.style.width = "100%";
      
      // ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœã‚’è¡¨ç¤º
      const historyDisplay = document.getElementById("historyDisplay");
      if (historyDisplay) {
        historyDisplay.innerHTML = showCurrentSessionResult();
        historyDisplay.style.display = "block";
        historyDisplay.style.visibility = "visible";
        historyDisplay.style.opacity = "1";
      }
      
      // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ªãƒ•ãƒ¬ãƒ¼ãƒ ã«é€ä¿¡
      const totalQuestions = questions.length;
      const messageData = {
        type: 'lesson:complete',
        lessonId: LESSON_ID,
        detail: {
          correct: tracker.currentSession ? tracker.currentSession.correct : 0,
          total: totalQuestions,
          timeSec: tracker.currentSession ? Math.floor((Date.now() - tracker.currentSession.startedAt) / 1000) : 0
        }
      };
      
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(messageData, "*");
        } else {
          window.parent.postMessage(messageData, "*");
        }
      } catch (e) {
        console.warn("postMessage failed:", e);
      }
      
      // completeLessonã‚‚å‘¼ã³å‡ºã—ã¦å±¥æ­´ã«è¨˜éŒ²
      tracker.completeLesson(totalQuestions);
    }

    function clearCheckpoint() {
      try {
        const checkpointKey = `checkpoint:${LESSON_ID}`;
        localStorage.removeItem(checkpointKey);
        return true;
      } catch (error) {
        console.error('âŒ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        return false;
      }
    }

    function showCurrentSessionResult() {
      const session = tracker.currentSession;
      if (!session) return '';
      
      const totalQuestions = questions.length;
      const correct = session.correct || 0;
      const scorePercent = totalQuestions > 0 ? 
        Math.round((correct / totalQuestions) * 100) : 0;
      
      // æˆç¸¾ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let resultMessage = '';
      if (scorePercent >= 90) {
        resultMessage = 'ğŸ‰ ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼';
      } else if (scorePercent >= 70) {
        resultMessage = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
      } else if (scorePercent >= 50) {
        resultMessage = 'ğŸ’ª ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
      } else {
        resultMessage = 'ğŸ“š å¾©ç¿’ã—ã¦å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼';
      }
      
      return `
        <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; margin-top: 12px;">
          <h3 style="margin-bottom: 12px; color: #333; font-size: 16px;">ä»Šå›ã®çµæœ</h3>
          <p style="margin: 8px 0; color: #555; font-size: 14px;">
            <strong>æ­£è§£æ•°:</strong> ${correct} / ${totalQuestions} å•
          </p>
          <p style="margin: 8px 0; color: #555; font-size: 14px;">
            <strong>æ­£ç­”ç‡:</strong> ${scorePercent}%
          </p>
          <p style="margin: 12px 0 0 0; color: #1976d2; font-size: 15px; font-weight: bold;">
            ${resultMessage}
          </p>
        </div>
      `;
    }

    /************ ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ ************/
    function goHome() {
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: "navigate:home", payload: { from: LESSON_ID }}, "*");
        } else {
          console.log("goHome called (standalone)");
        }
      } catch (e) {
        console.warn("goHome failed:", e);
      }
    }
    window.goHome = goHome;
  </script>
</body>
</html>
