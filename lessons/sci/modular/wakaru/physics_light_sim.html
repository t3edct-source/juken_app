<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å­¦ã¶ç†ç§‘ - å…‰ã®æ€§è³ªï¼ˆåå°„ã¨å±ˆæŠ˜ï¼‰</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color:#333;
    }
    .header {
      background: #fff;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-bottom: 1px solid #e0e0e0;
    }
    .home-btn {
      background:linear-gradient(135deg,#38bdf8,#22c55e);
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:999px;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:0 3px 10px rgba(56,189,248,0.7);
    }
    .home-btn:hover { filter:brightness(1.05); transform:translateY(-1px); }
    .home-btn:active { transform:scale(0.97); }
    .lesson-title {
      font-size:18px;
      font-weight:bold;
      color:#333;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      margin:0 10px;
      text-align:center;
    }
    .main-container {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:15px;
      gap:12px;
    }

    /* â–¼ ã‚·ãƒŸãƒ¥å…¨ä½“ */
    .sim-container {
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      margin-bottom:8px;
      overflow:hidden;
      border:1px solid #e0e0e0;
    }
    .sim-header {
      background:#fff;
      color:#333;
      padding:14px 15px;
      text-align:center;
      border-bottom:1px solid #e0e0e0;
    }
    .sim-header h2 { font-size:20px; margin-bottom:4px; color:#1976d2; }
    .sim-header p { font-size:13px; color:#666; }

    .sim-area {
      padding:12px 12px 16px;
    }

    .control-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .control-label {
      font-size:13px;
      font-weight:bold;
      color:#333;
      min-width:90px;
    }

    /* åª’è³ªã‚¿ãƒ– */
    .medium-tabs {
      display:flex;
      gap:8px;
      flex:1;
    }
    .medium-btn {
      flex:1;
      border:none;
      border-radius:8px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      background:#f5f5f5;
      color:#333;
      font-weight:bold;
      min-height:40px;
      transition:all 0.25s ease;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      box-shadow:none;
      border:1px solid #ddd;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    .medium-btn.active {
      background:#1976d2;
      color:#fff;
      box-shadow:0 2px 4px rgba(25,118,210,0.3);
      transform:none;
      border-color:#1976d2;
    }

    .emoji-icon {
      font-size:16px;
      filter:drop-shadow(0 1px 2px rgba(0,0,0,0.7));
    }

    .mode-desc {
      font-size:11px;
      color:#666;
      min-width:120px;
      text-align:right;
    }

    .control-row.bottom {
      margin-top:6px;
    }
    .angle-slider-wrap {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .angle-slider {
      width:100%;
      -webkit-appearance:none;
      height:6px;
      border-radius:999px;
      background:#e0e0e0;
      outline:none;
      box-shadow:none;
    }
    .angle-slider::-webkit-slider-thumb {
      -webkit-appearance:none;
      appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      background:#1976d2;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
      cursor:pointer;
      border:2px solid #fff;
      margin-top:-8px;
    }
    .angle-slider::-moz-range-thumb {
      width:22px;
      height:22px;
      border-radius:50%;
      background:#1976d2;
      border:2px solid #fff;
      cursor:pointer;
    }
    .angle-steps {
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color:#666;
    }

    /* â–¼ å…‰ã‚·ãƒ¼ãƒ³ */
    .sim-field {
      position:relative;
      margin-top:0;
      margin-bottom:12px;
      border-radius:12px;
      padding:12px;
      overflow:hidden;
      min-height:260px;
      background:#f9f9f9;
      box-shadow:inset 0 0 0 1px #e0e0e0;
    }

    .light-scene {
      position:relative;
      width:100%;
      height:190px;
      border-radius:12px;
      overflow:hidden;
      background:#f0f0f0;
      box-shadow:inset 0 0 0 1px #ddd;
      border:1px solid #ddd;
    }
    

    .medium-label-top,
    .medium-label-bottom {
      position:absolute;
      left:10px;
      padding:3px 8px;
      font-size:11px;
      border-radius:4px;
      background:#fff;
      color:#333;
      border:1px solid #ddd;
      box-shadow:0 1px 2px rgba(0,0,0,0.1);
    }
    .medium-label-top { top:10px; }
    .medium-label-bottom { bottom:10px; }

    /* SVG ã¯ãã®ã¾ã¾æ‹¡å¤§ç¸®å° */
    .light-svg {
      width:100%;
      height:100%;
      display:block;
    }

    /* infoã‚«ãƒ¼ãƒ‰ */
    .env-panel {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .env-card {
      flex:1 1 120px;
      background:rgba(15,23,42,0.95);
      border-radius:12px;
      padding:8px 10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.8);
      border:1px solid rgba(148,163,184,0.6);
    }
    .env-title {
      font-size:13px;
      font-weight:bold;
      margin-bottom:3px;
      color:#e0f2fe;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .env-title span.emoji {
      font-size:17px;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.8));
      animation:float 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-3px);} }
    .env-value {
      font-size:14px;
      font-weight:bold;
      margin-bottom:2px;
      color:#bae6fd;
    }
    .env-sub {
      font-size:11px;
      color:#cbd5f5;
    }

    .sim-comment {
      margin-top:10px;
      font-size:13px;
      line-height:1.6;
      color:#333;
      background:#fff;
      border-radius:8px;
      padding:10px 12px;
      border-left:3px solid #1976d2;
      box-shadow:0 1px 2px rgba(0,0,0,0.1);
      border:1px solid #e0e0e0;
    }
    .sim-comment strong {
      color:#1976d2;
      text-shadow:none;
    }

    .sky-tag {
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 10px;
      font-size:11px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#bae6fd;
      box-shadow:0 2px 8px rgba(0,0,0,0.8);
      border:1px solid rgba(148,163,184,0.6);
    }
    .sky-label {
      position:absolute;
      bottom:10px;
      right:10px;
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#e0f2fe;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 8px rgba(0,0,0,0.8);
      border:1px solid rgba(148,163,184,0.6);
    }
    .sky-label span.icon {
      font-size:16px;
      filter:drop-shadow(0 2px 3px rgba(0,0,0,0.8));
    }

    /* â–¼ infoãƒ‘ãƒãƒ«ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .info-panel {
      background:rgba(15,23,42,0.96);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(0,0,0,0.8);
      padding:14px;
      border:1px solid rgba(148,163,184,0.6);
    }
    .info-panel h3 {
      color:#e0f2fe;
      margin-bottom:8px;
      font-size:16px;
    }
    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(210px, 1fr));
      gap:10px;
    }
    .info-item {
      background:rgba(15,23,42,0.95);
      padding:10px;
      border-radius:10px;
      border-left:3px solid #38bdf8;
    }
    .info-item h4 {
      color:#bfdbfe;
      margin-bottom:4px;
      font-size:13px;
    }
    .info-item p {
      color:#e5e7eb;
      font-size:12px;
      line-height:1.4;
    }

    /* â–¼ å•é¡Œãƒ‘ãƒãƒ« */
    .question-container {
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px;
      border:1px solid #e0e0e0;
      margin-bottom:8px;
    }
    .question-text {
      font-size:15px;
      font-weight:bold;
      color:#333;
      margin-bottom:10px;
    }
    .progress-bar {
      background:#e0e0e0;
      border-radius:999px;
      height:7px;
      margin:8px 0 12px;
      overflow:hidden;
      box-shadow:none;
    }
    .progress-fill {
      background:#1976d2;
      height:100%;
      width:0%;
      transition:width 0.3s ease;
      box-shadow:none;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .choice {
      padding:11px 13px;
      background:#fff;
      border:1.5px solid #ddd;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:13px;
      min-height:44px;
      display:flex;
      align-items:center;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      color:#333;
    }
    .choice:hover {
      background:#f5f5f5;
      border-color:#1976d2;
    }
    .choice.correct {
      background:#4caf50;
      color:white;
      border-color:#4caf50;
      animation:correctPulse 0.6s ease;
      box-shadow:0 2px 4px rgba(76,175,80,0.3);
    }
    .choice.incorrect {
      background:#f44336;
      color:white;
      border-color:#f44336;
      animation:wrongShake 0.6s ease;
      box-shadow:0 2px 4px rgba(244,67,54,0.3);
    }
    @keyframes correctPulse {
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.04);}
    }
    @keyframes wrongShake {
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-8px);}
      75%{transform:translateX(8px);}
    }

    .explanation {
      margin-top:12px;
      padding:10px;
      background:#fff;
      border-radius:8px;
      border-left:3px solid #4caf50;
      border:1px solid #e0e0e0;
      display:none;
    }
    .explanation.show { display:block; }
    .explanation h4 {
      color:#333;
      margin-bottom:6px;
      font-size:13px;
    }
    .explanation p {
      color:#333;
      line-height:1.5;
      font-size:12px;
    }

    .navigation {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:14px;
    }
    .nav-btn {
      padding:11px 18px;
      border:none;
      border-radius:999px;
      font-size:13px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.3s ease;
      min-height:44px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .nav-btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    .prev-btn {
      background:#f5f5f5;
      color:#333;
      border:1px solid #ddd;
    }
    .prev-btn:hover:not(:disabled) { background:#e0e0e0; }
    .next-btn {
      background:#1976d2;
      color:#fff;
      box-shadow:0 2px 4px rgba(25,118,210,0.3);
    }
    .next-btn:hover:not(:disabled) { background:#1565c0; }

    * { touch-action:manipulation; }
    .choice, .nav-btn, .home-btn, .medium-btn {
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    @media (max-width:768px){
      body { overflow-x:hidden; }
      .header { padding:8px 10px; }
      .home-btn { padding:8px 14px; font-size:12px; }
      .lesson-title { font-size:14px; margin:0 6px; }
      .main-container { padding:10px; gap:10px; }
      .sim-area { padding:10px 10px 14px; }
      .sim-field { min-height:240px; padding:10px; }
      .light-scene { height:180px; }
      .info-panel { padding:12px; }
      .info-grid { grid-template-columns:1fr; }
      .info-item { padding:9px; }
      .question-container { padding:14px; }
      .question-text { font-size:14px; }
      .choice { font-size:12px; padding:9px 11px; }
      .nav-btn { font-size:12px; padding:9px 14px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <button class="home-btn" onclick="goHome()">ãƒ›ãƒ¼ãƒ </button>
    <div class="lesson-title">å…‰ã®æ€§è³ªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåå°„ã¨å±ˆæŠ˜ï¼‰</div>
    <div style="width:80px;"></div>
  </header>

  <main class="main-container">
    <!-- â–¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <section class="sim-container">
      <div class="sim-header">
        <h2>å…‰ã®é€²ã¿æ–¹ã¨ åå°„ãƒ»å±ˆæŠ˜</h2>
        <p>å…¥å°„è§’ã‚’å‹•ã‹ã—ã¦ã€é¡ã§ã®åå°„ã¨æ°´ãƒ»ã‚¬ãƒ©ã‚¹ã§ã®å±ˆæŠ˜ã®ã‚ˆã†ã™ã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚</p>
      </div>

      <div class="sim-area">
        <div class="sim-field">
          <div class="light-scene" id="lightScene">
            <div class="medium-label-top">ç©ºæ°—</div>
            <div class="medium-label-bottom" id="mediumLabelBottom">æ°´</div>

            <!-- SVGã§å…‰ã®ç·šã‚’æç”» -->
            <svg class="light-svg" viewBox="0 0 300 200" id="lightSvg">
              <!-- èƒŒæ™¯ï¼šç©ºæ°—ã¨åª’è³ªã®é ˜åŸŸã‚’è¦–è¦šçš„ã«åŒºåˆ¥ -->
              <defs>
                <!-- ç©ºæ°—ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <linearGradient id="airGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:rgba(240,248,255,0.5);stop-opacity:1" />
                  <stop offset="100%" style="stop-color:rgba(230,240,250,0.3);stop-opacity:1" />
                </linearGradient>
                
                <!-- æ°´ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé’ã¿ãŒã‹ã£ãŸï¼‰ -->
                <linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:rgba(173,216,230,0.4);stop-opacity:1" />
                  <stop offset="50%" style="stop-color:rgba(135,206,250,0.5);stop-opacity:1" />
                  <stop offset="100%" style="stop-color:rgba(100,149,237,0.6);stop-opacity:1" />
                </linearGradient>
                
                <!-- ã‚¬ãƒ©ã‚¹ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé€æ˜æ„Ÿã®ã‚ã‚‹ï¼‰ -->
                <linearGradient id="glassGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:rgba(220,220,220,0.3);stop-opacity:1" />
                  <stop offset="50%" style="stop-color:rgba(200,200,200,0.4);stop-opacity:1" />
                  <stop offset="100%" style="stop-color:rgba(180,180,180,0.5);stop-opacity:1" />
                </linearGradient>
                
                <!-- æ°´ã®æ³¢ç´‹ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                <pattern id="waterPattern" x="0" y="0" width="40" height="8" patternUnits="userSpaceOnUse">
                  <path d="M 0 4 Q 10 2, 20 4 T 40 4" stroke="rgba(100,149,237,0.4)" stroke-width="1" fill="none" />
                  <path d="M 0 6 Q 10 4, 20 6 T 40 6" stroke="rgba(135,206,250,0.3)" stroke-width="1" fill="none" />
                  <animate attributeName="y" values="0;8;0" dur="3s" repeatCount="indefinite"/>
                </pattern>
                
                <!-- ã‚¬ãƒ©ã‚¹ã®å…‰æ²¢ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                <pattern id="glassPattern" x="0" y="0" width="60" height="100" patternUnits="userSpaceOnUse">
                  <rect x="0" y="0" width="60" height="100" fill="rgba(203,213,225,0.1)"/>
                  <line x1="0" y1="0" x2="60" y2="100" stroke="rgba(255,255,255,0.15)" stroke-width="1"/>
                  <line x1="30" y1="0" x2="30" y2="100" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/>
                </pattern>
                
                <!-- æ°´ã®åå°„åŠ¹æœãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <filter id="waterReflection" x="0%" y="0%" width="100%" height="100%">
                  <feGaussianBlur in="SourceAlpha" stdDeviation="1" result="blur"/>
                  <feOffset in="blur" dx="0" dy="1" result="offsetBlur"/>
                  <feComponentTransfer>
                    <feFuncA type="linear" slope="0.3"/>
                  </feComponentTransfer>
                  <feMerge>
                    <feMergeNode/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
                
                <!-- ã‚¬ãƒ©ã‚¹ã®å…‰ã®å±ˆæŠ˜åŠ¹æœãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <filter id="glassRefraction" x="0%" y="0%" width="100%" height="100%">
                  <feGaussianBlur in="SourceGraphic" stdDeviation="0.5" result="blur"/>
                  <feOffset in="blur" dx="0" dy="0" result="offsetBlur"/>
                  <feMerge>
                    <feMergeNode in="SourceGraphic"/>
                    <feMergeNode in="offsetBlur"/>
                  </feMerge>
                </filter>
              </defs>
              
              <!-- ç©ºæ°—é ˜åŸŸï¼ˆä¸Šéƒ¨ï¼‰ -->
              <rect x="0" y="0" width="300" height="100" fill="url(#airGradient)" opacity="0.3" />
              
              <!-- åª’è³ªé ˜åŸŸï¼ˆä¸‹éƒ¨ï¼‰ - æ°´ã¾ãŸã¯ã‚¬ãƒ©ã‚¹ -->
              <g id="mediumGroup">
                <!-- ãƒ™ãƒ¼ã‚¹ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <rect id="mediumRect" x="0" y="100" width="300" height="100" fill="url(#waterGradient)" opacity="0.4" />
                
                <!-- æ°´ã®æ³¢ç´‹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ°´ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                <rect id="waterPatternRect" x="0" y="100" width="300" height="100" fill="url(#waterPattern)" opacity="0.6" />
                
                <!-- ã‚¬ãƒ©ã‚¹ã®å…‰æ²¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¬ãƒ©ã‚¹ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                <rect id="glassPatternRect" x="0" y="100" width="300" height="100" fill="url(#glassPattern)" opacity="0.4" style="display:none;" />
                
                <!-- æ°´ã®è¡¨é¢ã®åå°„ãƒã‚¤ãƒ©ã‚¤ãƒˆ -->
                <ellipse id="waterHighlight" cx="150" cy="100" rx="120" ry="8" fill="rgba(255,255,255,0.2)" opacity="0.5" />
                
                <!-- ã‚¬ãƒ©ã‚¹ã®å…‰ã®å±ˆæŠ˜åŠ¹æœ -->
                <rect id="glassRefractionRect" x="0" y="100" width="300" height="100" fill="rgba(255,255,255,0.05)" opacity="0.3" style="display:none;" />
              </g>
              
              <!-- å¢ƒç•Œé¢ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœï¼‰ -->
              <defs>
                <!-- æ°´ã®å¢ƒç•Œé¢ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé’ã¿ãŒã‹ã£ãŸï¼‰ -->
                <linearGradient id="waterBoundaryGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:rgba(135,206,250,0.5);stop-opacity:1" />
                  <stop offset="50%" style="stop-color:rgba(100,149,237,0.7);stop-opacity:1" />
                  <stop offset="100%" style="stop-color:rgba(135,206,250,0.5);stop-opacity:1" />
                </linearGradient>
                <!-- ã‚¬ãƒ©ã‚¹ã®å¢ƒç•Œé¢ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé€æ˜æ„Ÿã®ã‚ã‚‹ï¼‰ -->
                <linearGradient id="glassBoundaryGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:rgba(200,200,200,0.5);stop-opacity:1" />
                  <stop offset="50%" style="stop-color:rgba(150,150,150,0.8);stop-opacity:1" />
                  <stop offset="100%" style="stop-color:rgba(200,200,200,0.5);stop-opacity:1" />
                </linearGradient>
              </defs>
              <!-- å¢ƒç•Œé¢ã®ç·šï¼ˆæ°´ç”¨ï¼‰ -->
              <line id="waterBoundaryLine" x1="0" y1="100" x2="300" y2="100"
                    stroke="url(#waterBoundaryGradient)" stroke-width="3"
                    stroke-linecap="round" opacity="0.9" />
              <!-- å¢ƒç•Œé¢ã®ç·šï¼ˆã‚¬ãƒ©ã‚¹ç”¨ï¼‰ -->
              <line id="glassBoundaryLine" x1="0" y1="100" x2="300" y2="100"
                    stroke="url(#glassBoundaryGradient)" stroke-width="3"
                    stroke-linecap="round" opacity="0.9" style="display:none;" />
              <!-- å¢ƒç•Œé¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆæ°´ç”¨ï¼‰ -->
              <line id="waterBoundaryHighlight" x1="0" y1="100" x2="300" y2="100"
                    stroke="rgba(173,216,230,0.6)" stroke-width="1.5"
                    stroke-linecap="round" />
              <!-- å¢ƒç•Œé¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¬ãƒ©ã‚¹ç”¨ï¼‰ -->
              <line id="glassBoundaryHighlight" x1="0" y1="100" x2="300" y2="100"
                    stroke="rgba(200,200,200,0.5)" stroke-width="1.5"
                    stroke-linecap="round" style="display:none;" />

              <!-- æ³•ç·šï¼ˆç‚¹ç·šã€ã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«ï¼‰ -->
              <line x1="150" y1="20" x2="150" y2="180"
                    stroke="rgba(100,100,100,0.6)" stroke-width="1.5"
                    stroke-dasharray="5,5" opacity="0.7" />
              <!-- æ³•ç·šã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ -->
              <line x1="150" y1="20" x2="150" y2="180"
                    stroke="rgba(150,150,150,0.3)" stroke-width="0.5"
                    stroke-dasharray="5,5" />

              <!-- çŸ¢å°ãƒãƒ¼ã‚«ãƒ¼ã®å®šç¾© -->
              <defs>
                <marker id="simpleArrow" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto" markerUnits="userSpaceOnUse">
                  <path d="M0,0 L0,10 L10,5 z" fill="#94a3b8" stroke="#64748b" stroke-width="0.5" />
                </marker>
              </defs>
              
              <!-- å…‰ã®è¡¨ç¾ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã€åŠ å·¥ãªã—ï¼‰ -->
              <!-- å…¥å°„å…‰ï¼ˆçŸ¢å°ä»˜ãï¼‰ -->
              <line id="incidentRay"
                    x1="150" y1="100" x2="80" y2="40"
                    stroke="#fef08a" stroke-width="3"
                    stroke-linecap="round"
                    marker-end="url(#simpleArrow)" />
              <!-- åå°„å…‰ï¼ˆçŸ¢å°ä»˜ãï¼‰ -->
              <line id="reflectedRay"
                    x1="150" y1="100" x2="220" y2="40"
                    stroke="#fef08a" stroke-width="3"
                    stroke-linecap="round"
                    marker-end="url(#simpleArrow)" />
              <!-- å±ˆæŠ˜å…‰ï¼ˆçŸ¢å°ä»˜ãï¼‰ -->
              <line id="refractedRay"
                    x1="150" y1="100" x2="90" y2="160"
                    stroke="#fef08a" stroke-width="3"
                    stroke-linecap="round"
                    marker-end="url(#simpleArrow)" />

              <!-- å…¥å°„ç‚¹ãƒãƒ¼ã‚«ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ -->
              <circle cx="150" cy="100" r="4"
                      fill="#facc15" stroke="#666" stroke-width="1" opacity="0.9" />
            </svg>
          </div>

          <div class="sim-comment" id="simComment">
            <strong>å…‰ã¯åŒã˜ç‰©è³ªã®ä¸­ã§ã¯ã¾ã£ã™ãé€²ã¿ã¾ã™ã€‚</strong>å¢ƒç•Œé¢ã§ä¸€éƒ¨ã¯é¡ã®ã‚ˆã†ã«<strong>åå°„</strong>ã—ã€ä¸€éƒ¨ã¯æ°´ã‚„ã‚¬ãƒ©ã‚¹ã®ä¸­ã¸<strong>å±ˆæŠ˜</strong>ã—ã¦é€²ã¿ã¾ã™ã€‚
          </div>
        </div>

        <!-- æ“ä½œUIã‚’ä¸‹ã«é…ç½® -->
        <div class="control-row">
          <div class="control-label">ä¸‹ã®ç‰©è³ª</div>
          <div class="medium-tabs">
            <button class="medium-btn active" data-medium="water" id="btnWater">
              <span class="emoji-icon">ğŸ’§</span>æ°´
            </button>
            <button class="medium-btn" data-medium="glass" id="btnGlass">
              <span class="emoji-icon">ğŸªŸ</span>ã‚¬ãƒ©ã‚¹
            </button>
          </div>
          <div class="mode-desc" id="mediumDesc">ç©ºæ°—ã‹ã‚‰æ°´ã¸é€²ã‚€å…‰ï¼ˆå±ˆæŠ˜ã¯å°‘ã—æ›²ãŒã‚‹ï¼‰</div>
        </div>

        <div class="control-row bottom">
          <div class="control-label">å…¥å°„è§’</div>
          <div class="angle-slider-wrap">
            <input type="range" min="10" max="70" step="1" value="40" class="angle-slider" id="angleSlider" />
            <div class="angle-steps">
              <span>10Â°</span>
              <span>40Â°</span>
              <span>70Â°</span>
            </div>
          </div>
          <div class="mode-desc" id="angleDesc">æ³•ç·šã‹ã‚‰ 40Â° ã®è§’åº¦ã§å…¥ã‚‹å…‰</div>
        </div>
      </div>
    </section>

    <!-- â–¼ ã‚ã‹ã‚‹ç·¨ 3å• -->
    <section class="question-container">
      <div class="question-text" id="questionText"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="choices" id="choicesContainer"></div>
      <div class="explanation" id="explanationBox">
        <h4>è§£èª¬</h4>
        <p id="explanationText"></p>
      </div>

      <div class="navigation">
        <button class="nav-btn prev-btn" id="prevBtn">å‰ã®å•é¡Œã¸</button>
        <button class="nav-btn next-btn" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>
      </div>
      <div id="historyDisplay"></div>
    </section>
  </main>

  <script>
    /************ LearningTracker ************/
    class LearningTracker {
      constructor(lessonId) {
        this.lessonId = lessonId;
        this.storageKey = "stepnavi_science_" + lessonId;
        this.currentSession = null;
        this.history = this.loadHistory();
      }

      loadHistory() {
        try {
          const raw = localStorage.getItem(this.storageKey);
          return raw ? JSON.parse(raw) : { sessions: [] };
        } catch (e) {
          console.warn("Failed to load history:", e);
          return { sessions: [] };
        }
      }

      startSession() {
        this.currentSession = {
          startedAt: Date.now(),
          answered: 0,
          correct: 0,
          records: []
        };
      }

      recordAnswer(questionIndex, isCorrect) {
        if (!this.currentSession) this.startSession();
        const now = Date.now();
        this.currentSession.answered += 1;
        if (isCorrect) this.currentSession.correct += 1;
        this.currentSession.records.push({
          questionIndex,
          isCorrect,
          answeredAt: now
        });

        this.postToParent("question:answered", {
          lessonId: this.lessonId,
          questionIndex,
          isCorrect,
          timestamp: now
        });
      }

      completeLesson(totalQuestions) {
        if (!this.currentSession) return;
        const now = Date.now();
        const durationMs = now - this.currentSession.startedAt;
        const summary = {
          ...this.currentSession,
          finishedAt: now,
          durationMs,
          totalQuestions
        };
        this.history.sessions.push(summary);
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.history));
        } catch (e) {
          console.warn("Failed to save history:", e);
        }

        this.postToParent("lesson:complete", {
          lessonId: this.lessonId,
          totalQuestions,
          answered: this.currentSession.answered,
          correct: this.currentSession.correct,
          durationMs
        });

        this.currentSession = null;
      }

      postToParent(type, payload) {
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type, payload }, "*");
          }
        } catch (e) {
          console.warn("postMessage failed:", e);
        }
      }
    }

    const LESSON_ID = "sci.physics.light_properties_sim";
    const tracker = new LearningTracker(LESSON_ID);

    /************ å…‰ã‚·ãƒŸãƒ¥åˆ¶å¾¡ï¼ˆSVGã§åå°„ãƒ»å±ˆæŠ˜ï¼‰ ************/
    const btnWater = document.getElementById("btnWater");
    const btnGlass = document.getElementById("btnGlass");
    const mediumButtons = [btnWater, btnGlass];
    const mediumDesc = document.getElementById("mediumDesc");
    const mediumLabelBottom = document.getElementById("mediumLabelBottom");

    const angleSlider = document.getElementById("angleSlider");
    const angleDesc = document.getElementById("angleDesc");

    const incidentRay = document.getElementById("incidentRay");
    const reflectedRay = document.getElementById("reflectedRay");
    const refractedRay = document.getElementById("refractedRay");

    const simComment = document.getElementById("simComment");

    const lightSvg = document.getElementById("lightSvg");

    let currentMedium = "water"; // "water" or "glass"

    function setMedium(medium) {
      currentMedium = medium;
      mediumButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.medium === medium);
      });

      if (medium === "water") {
        mediumDesc.textContent = "ç©ºæ°—ã‹ã‚‰æ°´ã¸é€²ã‚€å…‰ï¼ˆå±ˆæŠ˜ã¯å°‘ã—æ›²ãŒã‚‹ï¼‰";
        mediumLabelBottom.textContent = "æ°´";
        // åª’è³ªé ˜åŸŸã‚’æ°´ã®è¡¨ç¾ã«å¤‰æ›´
        const mediumRect = document.getElementById("mediumRect");
        const waterPatternRect = document.getElementById("waterPatternRect");
        const glassPatternRect = document.getElementById("glassPatternRect");
        const waterHighlight = document.getElementById("waterHighlight");
        const glassRefractionRect = document.getElementById("glassRefractionRect");
        
        if (mediumRect) {
          mediumRect.setAttribute("fill", "url(#waterGradient)");
          mediumRect.setAttribute("opacity", "0.4");
        }
        if (waterPatternRect) {
          waterPatternRect.style.display = "block";
        }
        if (glassPatternRect) {
          glassPatternRect.style.display = "none";
        }
        if (waterHighlight) {
          waterHighlight.style.display = "block";
        }
        if (glassRefractionRect) {
          glassRefractionRect.style.display = "none";
        }
        
        // å¢ƒç•Œé¢ã‚’æ°´ç”¨ã«å¤‰æ›´
        const waterBoundaryLine = document.getElementById("waterBoundaryLine");
        const glassBoundaryLine = document.getElementById("glassBoundaryLine");
        const waterBoundaryHighlight = document.getElementById("waterBoundaryHighlight");
        const glassBoundaryHighlight = document.getElementById("glassBoundaryHighlight");
        if (waterBoundaryLine) waterBoundaryLine.style.display = "block";
        if (glassBoundaryLine) glassBoundaryLine.style.display = "none";
        if (waterBoundaryHighlight) waterBoundaryHighlight.style.display = "block";
        if (glassBoundaryHighlight) glassBoundaryHighlight.style.display = "none";
      } else {
        mediumDesc.textContent = "ç©ºæ°—ã‹ã‚‰ã‚¬ãƒ©ã‚¹ã¸é€²ã‚€å…‰ï¼ˆã‚‚ã£ã¨å¤§ããæ›²ãŒã‚‹ï¼‰";
        mediumLabelBottom.textContent = "ã‚¬ãƒ©ã‚¹";
        // åª’è³ªé ˜åŸŸã‚’ã‚¬ãƒ©ã‚¹ã®è¡¨ç¾ã«å¤‰æ›´
        const mediumRect = document.getElementById("mediumRect");
        const waterPatternRect = document.getElementById("waterPatternRect");
        const glassPatternRect = document.getElementById("glassPatternRect");
        const waterHighlight = document.getElementById("waterHighlight");
        const glassRefractionRect = document.getElementById("glassRefractionRect");
        
        if (mediumRect) {
          mediumRect.setAttribute("fill", "url(#glassGradient)");
          mediumRect.setAttribute("opacity", "0.35");
        }
        if (waterPatternRect) {
          waterPatternRect.style.display = "none";
        }
        if (glassPatternRect) {
          glassPatternRect.style.display = "block";
        }
        if (waterHighlight) {
          waterHighlight.style.display = "none";
        }
        if (glassRefractionRect) {
          glassRefractionRect.style.display = "block";
        }
        
        // å¢ƒç•Œé¢ã‚’ã‚¬ãƒ©ã‚¹ç”¨ã«å¤‰æ›´
        const waterBoundaryLine = document.getElementById("waterBoundaryLine");
        const glassBoundaryLine = document.getElementById("glassBoundaryLine");
        const waterBoundaryHighlight = document.getElementById("waterBoundaryHighlight");
        const glassBoundaryHighlight = document.getElementById("glassBoundaryHighlight");
        if (waterBoundaryLine) waterBoundaryLine.style.display = "none";
        if (glassBoundaryLine) glassBoundaryLine.style.display = "block";
        if (waterBoundaryHighlight) waterBoundaryHighlight.style.display = "none";
        if (glassBoundaryHighlight) glassBoundaryHighlight.style.display = "block";
      }

      updateLightScene();
    }

    mediumButtons.forEach(btn => {
      btn.addEventListener("click", () => setMedium(btn.dataset.medium));
    });

    angleSlider.addEventListener("input", () => {
      updateLightScene();
    });

    function updateLightScene() {
      const angleDeg = parseInt(angleSlider.value, 10); // æ³•ç·šã‹ã‚‰ã®å…¥å°„è§’
      angleDesc.textContent = "æ³•ç·šã‹ã‚‰ " + angleDeg + "Â° ã®è§’åº¦ã§å…¥ã‚‹å…‰";

      // SVGåº§æ¨™ã®ä¸­å¿ƒï¼ˆå¢ƒç•Œé¢ã¨æ³•ç·šã®äº¤ç‚¹ï¼‰
      const cx = 150;
      const cy = 100;

      const lengthAir = 90;    // ç©ºæ°—å´ã®å…‰ã®é•·ã•
      const lengthMedium = 90; // åª’è³ªå´ã®å…‰ã®é•·ã•

      // æ³•ç·šã‹ã‚‰ã®è§’åº¦ â†’ ãƒ©ã‚¸ã‚¢ãƒ³
      const a = angleDeg * Math.PI / 180;

      // n1: ç©ºæ°—ã€n2: æ°´ or ã‚¬ãƒ©ã‚¹ï¼ˆå˜ç´”ãƒ¢ãƒ‡ãƒ«ï¼‰
      const n1 = 1.0;
      const n2 = (currentMedium === "water") ? 1.33 : 1.5;

      // å…¥å°„å…‰ï¼ˆç©ºæ°—å´ï¼‰: å³ä¸Šã‹ã‚‰å·¦ä¸‹ã«å…¥ã£ã¦ãã‚‹
      // æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ï¼ˆç©ºæ°—å´ï¼‰ã¯ (0, -1)ã€‚å³å´ã‹ã‚‰æ¥ã‚‹ã®ã§ã€æ™‚è¨ˆå›ã‚Šã« a å›è»¢ã€‚
      const dx_in = Math.sin(a);
      const dy_in = -Math.cos(a);
      const x1_in = cx + dx_in * lengthAir;
      const y1_in = cy + dy_in * lengthAir;
      // å…¥å°„å…‰ã®åº§æ¨™ã‚’è¨­å®šï¼ˆçŸ¢å°ã¯ãƒãƒ¼ã‚«ãƒ¼ã§è‡ªå‹•çš„ã«çµ‚ç‚¹ã«é…ç½®ã•ã‚Œã‚‹ï¼‰
      incidentRay.setAttribute("x1", x1_in);
      incidentRay.setAttribute("y1", y1_in);
      incidentRay.setAttribute("x2", cx);
      incidentRay.setAttribute("y2", cy);

      // åå°„å…‰ï¼ˆç©ºæ°—å´ï¼‰: æ³•ç·šã«å¯¾ã—ã¦å¯¾ç§°ï¼ˆå…¥å°„è§’ = åå°„è§’ï¼‰
      // å³ä¸Šã‹ã‚‰æ¥ãŸå…‰ã¯ã€å·¦ä¸Šã«åå°„ã™ã‚‹ï¼ˆå·¦å´ã«å‡ºã‚‹ï¼‰
      const dx_ref = -Math.sin(a);
      const dy_ref = -Math.cos(a);
      const x2_ref = cx + dx_ref * lengthAir;
      const y2_ref = cy + dy_ref * lengthAir;
      // åå°„å…‰ã®åº§æ¨™ã‚’è¨­å®šï¼ˆçŸ¢å°ã¯ãƒãƒ¼ã‚«ãƒ¼ã§è‡ªå‹•çš„ã«çµ‚ç‚¹ã«é…ç½®ã•ã‚Œã‚‹ï¼‰
      reflectedRay.setAttribute("x1", cx);
      reflectedRay.setAttribute("y1", cy);
      reflectedRay.setAttribute("x2", x2_ref);
      reflectedRay.setAttribute("y2", y2_ref);

      // å±ˆæŠ˜å…‰ï¼ˆåª’è³ªå´ï¼‰: ã‚¹ãƒãƒ«ã®æ³•å‰‡ n1 sinÎ¸1 = n2 sinÎ¸2
      const sinA = Math.sin(a);
      let sinB = n1 / n2 * sinA;
      if (sinB > 1) sinB = 1;  // å®‰å…¨å¯¾ç­–ï¼ˆã“ã®ç¯„å›²ã§ã¯ã»ã¼èµ·ããªã„ï¼‰

      const b = Math.asin(sinB); // åª’è³ªå´ã®å±ˆæŠ˜è§’ï¼ˆæ³•ç·šã‹ã‚‰ï¼‰

      // åª’è³ªå´ã®æ³•ç·šã¯ (0, 1)ï¼ˆä¸‹å‘ãï¼‰ã€‚ãã“ã‹ã‚‰å·¦å´ã¸åæ™‚è¨ˆå›ã‚Šã« b å›è»¢ã€‚
      const dx_re = -Math.sin(b);
      const dy_re = Math.cos(b);
      const x2_re = cx + dx_re * lengthMedium;
      const y2_re = cy + dy_re * lengthMedium;
      refractedRay.setAttribute("x1", cx);
      refractedRay.setAttribute("y1", cy);
      refractedRay.setAttribute("x2", x2_re);
      refractedRay.setAttribute("y2", y2_re);

      // èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
      if (currentMedium === "water") {
        simComment.innerHTML =
          "å…‰ã¯ç©ºæ°—ä¸­ã§ã¯<strong>ã¾ã£ã™ã</strong>é€²ã¿ã€å¢ƒç•Œã§ä¸€éƒ¨ãŒ<strong>åå°„</strong>ã—ã€ä¸€éƒ¨ãŒæ°´ã®ä¸­ã¸<strong>å±ˆæŠ˜</strong>ã—ã¦é€²ã¿ã¾ã™ã€‚æ°´ã§ã¯ã€ç©ºæ°—ã‚ˆã‚Šå°‘ã—<strong>æ³•ç·šã®æ–¹å‘</strong>ã¸æ›²ãŒã‚Šã¾ã™ã€‚";
      } else {
        simComment.innerHTML =
          "ã‚¬ãƒ©ã‚¹ã¯æ°´ã‚ˆã‚Šå…‰ã‚’<strong>å¼·ãæ›²ã’ã‚‹</strong>ç‰©è³ªã§ã™ã€‚ç©ºæ°—ã‹ã‚‰ã‚¬ãƒ©ã‚¹ã«å…¥ã‚‹å…‰ã¯ã€æ°´ã®å ´åˆã‚ˆã‚Šå¤§ãã<strong>æ³•ç·šã®æ–¹å‘ã¸</strong>æŠ˜ã‚Œæ›²ãŒã‚Šã¾ã™ã€‚";
      }
    }

    // åˆæœŸåŒ–
    setMedium("water");
    angleSlider.value = 40;
    updateLightScene();

    /************ ã‚ã‹ã‚‹ç·¨ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿ ************/
    const questions = [
      {
        id: "q1",
        text: "å…‰ã®é€²ã¿æ–¹ã«ã¤ã„ã¦ã€åŒã˜ç‰©è³ªã®ä¸­ã§ã¯ã©ã®ã‚ˆã†ã«é€²ã‚€ã¨è€ƒãˆã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ",
        choices: [
          "ã„ã¤ã‚‚ã¾ã£ã™ãé€²ã‚€",
          "ã‚†ã£ãã‚Šæ›²ãŒã‚ŠãªãŒã‚‰é€²ã‚€",
          "ã‚¸ã‚°ã‚¶ã‚°ã«é€²ã‚€",
          "æ­¢ã¾ã£ãŸã‚Šå‹•ã„ãŸã‚Šã‚’ãã‚Šè¿”ã™"
        ],
        correct: 0,
        explanation:
          "å…‰ã¯ã€ç©ºæ°—ã®ä¸­ãƒ»æ°´ã®ä¸­ãƒ»ã‚¬ãƒ©ã‚¹ã®ä¸­ãªã©ã€<strong>åŒã˜ç‰©è³ªã®ä¸­ã§ã¯ã„ã¤ã‚‚ã¾ã£ã™ã</strong>é€²ã‚€ã¨è€ƒãˆã¾ã™ã€‚å½±ã®å½¢ã‚„æ‡ä¸­é›»ç¯ã®å…‰ã®ç­‹ãŒã¾ã£ã™ããªã®ã¯ã“ã®ãŸã‚ã§ã™ã€‚"
      },
      {
        id: "q2",
        text: "é¡ã§å…‰ãŒåå°„ã™ã‚‹ã¨ãã€å…¥å°„è§’ã¨åå°„è§’ã«ã¤ã„ã¦æ­£ã—ãè¨€ãˆã‚‹ã“ã¨ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿï¼ˆè§’åº¦ã¯æ³•ç·šã‹ã‚‰ã®å¤§ãã•ã§ãã‚‰ã¹ã¾ã™ï¼‰",
        choices: [
          "å…¥å°„è§’ã¨åå°„è§’ã¯ã„ã¤ã‚‚ç­‰ã—ã„",
          "å…¥å°„è§’ã®ã»ã†ãŒå¿…ãšå¤§ãã„",
          "åå°„è§’ã®ã»ã†ãŒå¿…ãšå¤§ãã„",
          "å…¥å°„è§’ã¨åå°„è§’ã¯é–¢ä¿‚ãªã„"
        ],
        correct: 0,
        explanation:
          "é¡ã§ã®<strong>åå°„</strong>ã§ã¯ã€å…‰ãŒå…¥ã£ã¦ãã‚‹è§’åº¦ï¼ˆå…¥å°„è§’ï¼‰ã¨ã€ã¯ã­è¿”ã‚‹è§’åº¦ï¼ˆåå°„è§’ï¼‰ãŒ<strong>æ³•ç·šã‹ã‚‰è¦‹ã¦åŒã˜å¤§ãã•</strong>ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’ã€Œå…¥å°„è§’ = åå°„è§’ã€ã¨ã„ã„ã¾ã™ã€‚"
      },
      {
        id: "q3",
        text: "ç©ºæ°—ä¸­ã‚’é€²ã‚“ã§ããŸå…‰ãŒæ°´ã‚„ã‚¬ãƒ©ã‚¹ã®ä¸­ã«å…¥ã‚‹ã¨ãï¼ˆå±ˆæŠ˜ã™ã‚‹ã¨ãï¼‰ã€å…‰ã®å‘ãã¯ã©ã†å¤‰ã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿ",
        choices: [
          "æ³•ç·šã®æ–¹å‘ã¸å°‘ã—æ›²ãŒã‚‹",
          "æ³•ç·šã‹ã‚‰é ã–ã‹ã‚‹ã‚ˆã†ã«æ›²ãŒã‚‹",
          "ã¾ã£ãŸãæ›²ãŒã‚‰ãšã€ãã®ã¾ã¾é€²ã‚€",
          "å¿…ãšå…ƒã®æ–¹å‘ã«ã‚‚ã©ã‚‹"
        ],
        correct: 0,
        explanation:
          "ç©ºæ°—ã‹ã‚‰æ°´ã‚„ã‚¬ãƒ©ã‚¹ã®ã‚ˆã†ãªç‰©è³ªã«å…¥ã‚‹ã¨ãã€å…‰ã¯å¢ƒç•Œã§<strong>å±ˆæŠ˜</strong>ã—ã¦ã€ãµã¤ã†<strong>æ³•ç·šã®æ–¹å‘ï¼ˆå¢ƒç•Œã«å‚ç›´ãªç·šï¼‰ã¸</strong>å°‘ã—æ›²ãŒã‚Šã¾ã™ã€‚é€†ã«ã€æ°´ã‚„ã‚¬ãƒ©ã‚¹ã‹ã‚‰ç©ºæ°—ã¸å‡ºã‚‹ã¨ãã¯ã€æ³•ç·šã‹ã‚‰é ã–ã‹ã‚‹ã‚ˆã†ã«æ›²ãŒã‚Šã¾ã™ã€‚"
      }
    ];

    let currentQuestionIndex = 0;
    let answeredFlags = new Array(questions.length).fill(false);

    const questionTextEl = document.getElementById("questionText");
    const choicesContainer = document.getElementById("choicesContainer");
    const explanationBox = document.getElementById("explanationBox");
    const explanationText = document.getElementById("explanationText");
    const progressFill = document.getElementById("progressFill");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    function renderQuestion(index) {
      const q = questions[index];
      questionTextEl.textContent = "Q" + (index + 1) + ". " + q.text;
      choicesContainer.innerHTML = "";
      explanationBox.classList.remove("show");
      explanationText.innerHTML = "";

      q.choices.forEach((choiceText, i) => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = choiceText;
        btn.dataset.index = i;
        btn.addEventListener("click", () => handleChoiceClick(index, i, btn));
        choicesContainer.appendChild(btn);
      });

      updateProgress();
      updateNavButtons();
    }

    function handleChoiceClick(qIndex, choiceIndex, btnEl) {
      const q = questions[qIndex];

      if (answeredFlags[qIndex]) return;

      const allChoices = choicesContainer.querySelectorAll(".choice");
      allChoices.forEach(el => el.disabled = true);

      const isCorrect = (choiceIndex === q.correct);
      answeredFlags[qIndex] = true;

      if (isCorrect) {
        btnEl.classList.add("correct");
      } else {
        btnEl.classList.add("incorrect");
        const correctBtn = allChoices[q.correct];
        if (correctBtn) correctBtn.classList.add("correct");
      }

      explanationBox.classList.add("show");
      explanationText.innerHTML = q.explanation;

      tracker.recordAnswer(qIndex, isCorrect);

      updateProgress();
      updateNavButtons();

      if (answeredFlags.every(f => f)) {
        // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ãŸå ´åˆã€å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        nextBtn.disabled = true;
        prevBtn.disabled = true;
        nextBtn.style.opacity = "0.5";
        prevBtn.style.opacity = "0.5";
        
        setTimeout(() => {
          if (answeredFlags.every(f => f)) {
            showCompletionScreen();
          }
        }, 2000);
      }
    }

    function updateProgress() {
      const answeredCount = answeredFlags.filter(f => f).length;
      const ratio = answeredCount / questions.length;
      progressFill.style.width = (ratio * 100) + "%";
    }

    function updateNavButtons() {
      // ã™ã¹ã¦ã®å•é¡Œã«å›ç­”æ¸ˆã¿ã®å ´åˆã¯ã€å®Œäº†ç”»é¢è¡¨ç¤ºä¸­ãªã®ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (answeredFlags.every(f => f)) {
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      prevBtn.disabled = (currentQuestionIndex === 0);
      nextBtn.disabled = (currentQuestionIndex === questions.length - 1);
    }

    prevBtn.addEventListener("click", () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion(currentQuestionIndex);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion(currentQuestionIndex);
      } else {
        // æœ€å¾Œã®å•é¡Œã§ã€Œæ¬¡ã®å•é¡Œã¸ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
        if (answeredFlags.every(f => f)) {
          showCompletionScreen();
        }
      }
    });

    tracker.startSession();
    renderQuestion(currentQuestionIndex);

    function showCompletionScreen() {
      // å­¦ç¿’å±¥æ­´ã‚’ä¿å­˜
      tracker.saveSession();
      
      // ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤
      clearCheckpoint();
      
      // UIã‚’å®Œäº†ç”»é¢ã«å¤‰æ›´
      questionTextEl.textContent = "å­¦ç¿’å®Œäº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
      choicesContainer.innerHTML = "";
      explanationBox.classList.remove("show");
      explanationText.innerHTML = "";
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      nextBtn.style.display = "none";
      prevBtn.style.display = "none";
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
      progressFill.style.width = "100%";
      
      // ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœã‚’è¡¨ç¤º
      const historyDisplay = document.getElementById("historyDisplay");
      if (historyDisplay) {
        historyDisplay.innerHTML = showCurrentSessionResult();
        historyDisplay.style.display = "block";
        historyDisplay.style.visibility = "visible";
        historyDisplay.style.opacity = "1";
      }
      
      // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ªãƒ•ãƒ¬ãƒ¼ãƒ ã«é€ä¿¡
      const totalQuestions = questions.length;
      const messageData = {
        type: 'lesson:complete',
        lessonId: LESSON_ID,
        detail: {
          correct: tracker.currentSession ? tracker.currentSession.correct : 0,
          total: totalQuestions,
          timeSec: tracker.currentSession ? Math.floor((Date.now() - tracker.currentSession.startedAt) / 1000) : 0
        }
      };
      
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(messageData, "*");
        } else {
          window.parent.postMessage(messageData, "*");
        }
      } catch (e) {
        console.warn("postMessage failed:", e);
      }
      
      // completeLessonã‚‚å‘¼ã³å‡ºã—ã¦å±¥æ­´ã«è¨˜éŒ²
      tracker.completeLesson(totalQuestions);
    }

    function clearCheckpoint() {
      try {
        const checkpointKey = `checkpoint:${LESSON_ID}`;
        localStorage.removeItem(checkpointKey);
        return true;
      } catch (error) {
        console.error('âŒ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        return false;
      }
    }

    function showCurrentSessionResult() {
      const session = tracker.currentSession;
      if (!session) return '';
      
      const totalQuestions = questions.length;
      const correct = session.correct || 0;
      const scorePercent = totalQuestions > 0 ? 
        Math.round((correct / totalQuestions) * 100) : 0;
      
      // æˆç¸¾ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let resultMessage = '';
      if (scorePercent >= 90) {
        resultMessage = 'ğŸ‰ ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼';
      } else if (scorePercent >= 70) {
        resultMessage = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
      } else if (scorePercent >= 50) {
        resultMessage = 'ğŸ’ª ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
      } else {
        resultMessage = 'ğŸ“š å¾©ç¿’ã—ã¦å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼';
      }
      
      return `
        <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; margin-top: 12px;">
          <h3 style="margin-bottom: 12px; color: #333; font-size: 16px;">ä»Šå›ã®çµæœ</h3>
          <p style="margin: 8px 0; color: #555; font-size: 14px;">
            <strong>æ­£è§£æ•°:</strong> ${correct} / ${totalQuestions} å•
          </p>
          <p style="margin: 8px 0; color: #555; font-size: 14px;">
            <strong>æ­£ç­”ç‡:</strong> ${scorePercent}%
          </p>
          <p style="margin: 12px 0 0 0; color: #1976d2; font-size: 15px; font-weight: bold;">
            ${resultMessage}
          </p>
        </div>
      `;
    }

    /************ ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ ************/
    function goHome(){
      window.location.href = '/';
    }
  </script>
</body>
</html>
